{"createdAt":"2024-12-24T17:03:06.444Z","updatedAt":"2025-05-10T13:57:29.082Z","id":"2UiJL5Os60wdjyg8","name":"AGENTE QEVA","active":false,"nodes":[{"parameters":{"content":"## Convierte el mensaje de voz a texto","height":340.7809833809103,"width":540},"type":"n8n-nodes-base.stickyNote","position":[1860,380],"typeVersion":1,"id":"c665ff2c-ee6e-4758-a539-00c04322d481","name":"Sticky Note1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cb14635-2673-408e-86db-ce9e0373674b","leftValue":"={{ $('Webhook').first().json.body.data.messageType }}","rightValue":"conversation","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"60065893-74f7-4b64-bc1a-d891202efa78","leftValue":"={{ $('Webhook').first().json.body.data.messageType }}","rightValue":"imageMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').first().json.body.data.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"},"id":"5037a8d1-9744-4ec5-8065-ee85bf6aa0b0"}],"combinator":"and"},"renameOutput":true,"outputKey":"√Åudio"}]},"options":{}},"id":"0079489a-0d75-424e-866c-d3389dbec400","name":"Switch1","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[3360,2265]},{"parameters":{"assignments":{"assignments":[{"id":"9d2e510b-11ce-4c6b-ab0b-8ad4d2baa523","name":"server_url","value":"={{ $('Webhook').item.json.body.server_url }}","type":"string"},{"id":"04b113c5-f9c4-41d6-aceb-e982fb8183c5","name":"apikey","value":"={{ $('Webhook').item.json.body.apikey }}","type":"string"},{"id":"c0bb2f4b-8c12-46fd-a27c-edd73f79bf96","name":"instance","value":"={{ $('Webhook').item.json.body.instance }}","type":"string"},{"id":"06b8f4ae-6dbe-42ac-a8dc-30bdb385f680","name":"remoteJid","value":"={{ $('getClientes').item.json.Telefono }}","type":"string"},{"id":"09e165cd-9899-42a4-869c-d075090c31eb","name":"msg","value":"={{ $('Webhook').first()?.json?.body?.data?.message?.conversation || $('Webhook').item.json.body.data.message.listResponseMessage.title }}","type":"string"},{"id":"eeabeb89-2983-405e-accd-48153b99d5c5","name":"idmsg","value":"={{ $('Webhook').first().json.body.data.key.id }}","type":"string"},{"id":"16327967-c890-40a3-8adb-cf2ad08d49f3","name":"Id","value":"={{ $('getClientes').first().json.Id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[240,3040],"id":"e2cac8b4-6329-4c91-b59d-2740a6749371","name":"vars"},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1600,2365],"id":"cb1bb325-4e20-42ab-b4d3-d50be58b7e9f","name":"Wait","webhookId":"3014d4e8-c867-4029-ac75-1c2a42043a3b"},{"parameters":{"operation":"get","propertyName":"obtieneMSG","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}","options":{}},"id":"1454dc09-c118-4ece-be6c-8900b8ab6433","name":"Return Redis","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1380,2365],"credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"delete","key":"=usuario:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3020,1905],"id":"991a03f9-eae2-46e9-b57c-8e03951c0f44","name":"Redis7","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"push","list":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}","messageData":"={{ $('vars').first().json.msg || \"\" }}","tail":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1160,2365],"id":"ecdc7908-83ba-4858-9a6e-b90ae500f68f","name":"MSG","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"incr","key":"=contador:{{ $('vars').item.json.remoteJid }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[940,2365],"id":"3f7d7ea2-696c-4be7-ba89-cb76ebe1d8ec","name":"contador","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"set","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}","value":"={{ $('Return Redis').item.json.obtieneMSG[0] }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3360,2465],"id":"7ce7a7ed-624f-40a7-9e77-65fd7f6d9a00","name":"Redis4","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"assignments":{"assignments":[{"id":"b7d210f0-6a18-456d-9e89-aa28f548b2a0","name":"body.data.message.base64","value":"={{ $('Webhook').item.json.body.data.message.base64 }}","type":"string"}]},"includeOtherFields":true,"options":{}},"id":"53113a19-ba3f-4375-a874-df3532afde2b","name":"Edit Fields1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[720,2165]},{"parameters":{"operation":"toBinary","sourceProperty":"body.data.message.base64","options":{"mimeType":"audio/mp3"}},"id":"809bb6f2-6d09-4bc0-8aed-9281cfe3550b","name":"Convert to File1","type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[940,2165]},{"parameters":{"httpMethod":"POST","path":"qeva","options":{}},"id":"1b983077-f5df-44d4-988c-09e6b085219e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3580,3000],"webhookId":"3cdd40ed-a48c-411c-96d6-3679c5894079"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"60065893-74f7-4b64-bc1a-d891202efa78","leftValue":"={{ $('Webhook').item.json.body.data.messageType }}","rightValue":"imageMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cb14635-2673-408e-86db-ce9e0373674b","leftValue":"={{ $('Webhook').item.json.body.data.messageType }}","rightValue":"conversation","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body.data.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"},"id":"d909b323-cc09-45bf-bdb4-49c5d1ffa6e7"}],"combinator":"and"},"renameOutput":true,"outputKey":"√Åudio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ea42d6d8-1f8b-40ec-b23e-af984a097795","leftValue":"={{ $('Webhook').item.json.body.data.message.listResponseMessage.singleSelectReply.selectedRowId }}","rightValue":"agendar-si","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Agendar si"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"330b2797-cf11-4463-b0bf-cec1fbd6e59b","leftValue":"={{ $('Webhook').item.json.body.data.message.listResponseMessage.singleSelectReply.selectedRowId }}","rightValue":"agendar-no","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Agendar no"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a0393799-5a16-47e6-9de6-b3289bf71d1f","leftValue":"={{ /^üïí \\d{1,2} de (?:Enero|Febrero|Marzo|Abril|Mayo|Junio|Julio|Agosto|Septiembre|Octubre|Noviembre|Diciembre) : \\d{2}:\\d{2} a \\d{2}:\\d{2}$/.test($('Webhook').item.json.body.data.message.listResponseMessage.title) }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"Fecha agendar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"48e665ac-790f-4ed2-9236-183f0e91bf88","leftValue":"={{ $('Webhook').item.json.body.data.message.listResponseMessage.singleSelectReply.selectedRowId }}","rightValue":"confirm_yes","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Confirma visita"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fa29c9d4-7888-4063-a5e3-f147de1b9eec","leftValue":"={{ $('Webhook').item.json.body.data.message.listResponseMessage.singleSelectReply.selectedRowId }}","rightValue":"confirm_no","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"No asiste"}]},"options":{}},"id":"46d900f8-f1b1-4e7c-8460-daf5a46749ea","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[500,2960]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1160,2165],"id":"e1d8a406-81ce-48b8-96c1-f5d8677376a0","name":"Transcribir","credentials":{"openAiApi":{"id":"UfA35dBDzEebw8zR","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/message/sendReaction/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={   \n    \"key\": {\n        \"remoteJid\": \"{{ $json.key.remoteJid }}\",\n        \"fromMe\":{{ $json.key.fromMe }} ,\n        \"id\": \"{{ $json.key.id }}\"\n    },\n    \"reaction\": \"üî•\"\n} ","options":{}},"id":"215f2bc2-82eb-4f9c-925b-00a5f37bedf5","name":"MESSAGE2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1820,2165]},{"parameters":{"amount":2},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1600,2165],"id":"a8389e9e-7913-4082-8b59-13c2c235921a","name":"Wait2","webhookId":"4912af54-17ab-4b5f-b27c-70fcbca49f65"},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/chat/sendPresence/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"number\": \"{{ $node['Webhook'].json.body.data.key.remoteJid }}\",\n    \"delay\": 3000,\n    \"presence\": \"composing\"\n}","options":{}},"id":"d5a56987-f5a2-4624-aaf2-ef632ac03b13","name":"Escribiendo...4","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3580,2465]},{"parameters":{"method":"POST","url":"={{ $('vars').item.json.server_url }}/message/sendText/{{ $('vars').item.json.instance }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"apikey","value":"={{ $('vars').item.json.apikey }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('vars').item.json.remoteJid }}"},{"name":"text","value":"=üìã ```Hola Bienvenido a Qeva Solutions:```\n\nüöÄ ```Podemos ayudarte```\n\nü§ñ *Atenci√≥n al cliente*\nüõí *Agentes de venta por WhatsApp*\nüîó *Integraci√≥n de sistemas y CRMs*\n\nüè¢ *_Hacemos tu solucion a medida_*"}]},"options":{}},"name":"FERNANDO3","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[3800,2465],"id":"70b6784f-4517-4e72-ad6a-72293ad9eb28","credentials":{"httpBasicAuth":{"id":"OpgdvMlLy6Zxc6ii","name":"NOCODB"}}},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/chat/sendPresence/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"number\": \"{{ $node['Webhook'].json.body.data.key.remoteJid }}\",\n    \"delay\": 3000,\n    \"presence\": \"composing\"\n}","options":{}},"id":"dc32ad5a-5e81-437c-b20f-80acb6295a0e","name":"Escribiendo...5","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4240,2465]},{"parameters":{"jsCode":"function generarListaAgendar(remoteJid) {\n  const sections = [\n    {\n      title: \"üìÖ Quer√©s agendar una reuni√≥n personalizada?\",\n      rows: [\n        {\n          title: \"‚òëÔ∏è S√≠, quiero üìÜ\",\n          description: \"Reserv√° tu cita y recib√≠ asesoramiento a medida üöÄ\",\n          rowId: \"agendar-si\"\n        },\n        {\n          title: \"‚ùå No, gracias\",\n          description: \"Prefiero no agendar por el momento\",\n          rowId: \"agendar-no\"\n        }\n      ]\n    }\n  ];\n\n  const requestBody = {\n  number: remoteJid,\n  title: \"üåü *¬øC√≥mo podemos ayudarte hoy?*\",\n  description: \" üëá\",\n  buttonText: \"Agendar reuni√≥n üü¢\",\n  footerText: \"‚ú® Transformamos y automatizamos tus procesos de negocio\",\n  sections\n};\n\n  return {\n    json: requestBody\n  };\n}\n\n// C√≥digo principal\nconst remoteJid = $input.first().json.remoteJid;\n\n// Generar lista de agendar\nconst menuResponse = generarListaAgendar(remoteJid);\n\n// Devolver el JSON para el siguiente nodo HTTP\nreturn [menuResponse];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4900,2465],"id":"ca3643a7-5e95-47e4-aad2-6cd8336a0e41","name":"Lista1"},{"parameters":{"method":"POST","url":"={{ $('vars').item.json.server_url }}/message/sendList/{{ $('vars').item.json.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $('Webhook').item.json.body.apikey }}"}]},"sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"number","value":"={{ $('vars').item.json.remoteJid }}"},{"name":"title","value":"={{ $json.title }}"},{"name":"description","value":"={{ $json.description }}"},{"name":"buttonText","value":"={{ $json.buttonText }}"},{"name":"footerText","value":"={{ $json.footerText }}"},{"name":"sections","value":"={{ $json.sections }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5120,2465],"id":"b00319f7-ba41-4efe-b2e9-c923ca80202b","name":"Agendar","alwaysOutputData":true,"onError":"continueRegularOutput"},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/message/sendReaction/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={   \n    \"key\": {\n        \"remoteJid\": \"{{ $json.key.remoteJid }}\",\n        \"fromMe\":{{ $json.key.fromMe }} ,\n        \"composing\":3000,\n        \"id\": \"{{ $json.key.id }}\"\n    },\n    \"reaction\": \"üî•\"\n} ","options":{}},"id":"4137fe8d-ba1c-42db-83e2-3a8baeb1dd0a","name":"MESSAGE3","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4020,2465]},{"parameters":{"method":"POST","url":"={{ $('vars').item.json.server_url }}/message/sendText/{{ $('vars').item.json.instance }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"apikey","value":"={{ $('vars').item.json.apikey }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('vars').first().json.remoteJid }}"},{"name":"text","value":"=üìÖ ```Agendamos una reuni√≥n?```\n\n_Te ayudamos con una asesor√≠a personalizada para tu comercio._\n"},{"name":"delay","value":"={{1200}}"}]},"options":{}},"name":"Agendamos?","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[4460,2465],"id":"3ab05b7f-1602-4ca0-a1d0-471609497030","credentials":{"httpBasicAuth":{"id":"OpgdvMlLy6Zxc6ii","name":"NOCODB"}}},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/message/sendReaction/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={   \n    \"key\": {\n        \"remoteJid\": \"{{ $json.key.remoteJid }}\",\n        \"fromMe\":{{ $json.key.fromMe }} ,\n        \"id\": \"{{ $json.key.id }}\"\n    },\n    \"reaction\": \"üöÄ\"\n} ","options":{}},"id":"dadf728b-4be8-4760-b57c-c435531c01e2","name":"MESSAGE4","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4680,2465]},{"parameters":{"operation":"delete","key":"=status:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3480,3300],"id":"12e01d4f-33c4-4933-acce-eef5a7730884","name":"Redis5","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"af7b33c3-4bf4-4b03-84cf-c910b0fc6c4b","leftValue":"={{ $('contador').first().json['contador:' + $('vars').first().json.remoteJid] > 1 }}","rightValue":1,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3140,2365],"id":"1b3415b7-b71b-41a4-8e7d-b6572aebf0bd","name":"If"},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/message/sendText/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n   \"delay\": 1600,\n  \"number\": \"{{ $('vars').first().json.remoteJid }}\",\n  \"text\": \"*En breve lo atendera un agente Humano* üë®üèº‚Äçüíº\",\n  \"quoted\": {\n    \"key\": {\n      \"id\": \"{{ $('vars').first().json.apikey }}\",\n      \"remoteJid\": \"{{ $('vars').first()\n.json.remoteJid }}\",\n      \"fromMe\": false\n    }\n  }\n}\n","options":{}},"id":"687774f1-05b5-4eac-9785-526de87191d7","name":"MESSAGE1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4020,2260]},{"parameters":{"operation":"incr","key":"=primermsg:{{ $('vars').first().json.remoteJid }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3580,2265],"id":"0ed3615d-e689-4daf-8f4d-0570d9aef54d","name":"contador1","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5635d538-5603-4987-90e1-21d689baff79","leftValue":"={{ $('contador').first().json['contador:' + $('vars').first().json.remoteJid] > 1 }}","rightValue":1,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3800,2265],"id":"d02be655-4e13-4617-ae18-d25472e69830","name":"If3"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"7945ebf6c7d23dc703489bb4cd4179232c74b1bc605ba4c3b96d3ce73b036a69@group.calendar.google.com","mode":"list","cachedResultName":"Reuniones"},"returnAll":true,"options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[720,2665],"id":"eff27d1b-ba78-40a7-a788-3a6314366e15","name":"Google Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"248CSUaxOr8MEWUN","name":"Google Calendar account"}}},{"parameters":{"assignments":{"assignments":[{"id":"39c2f302-03be-4464-a17a-d7cc481d6d44","name":"=response","value":"=No hay evento cargados para esta propiedad","type":"string"}]},"options":{}},"id":"a273c98e-1da3-4b73-be76-f4992c341e54","name":"Success2","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1600,2565]},{"parameters":{"method":"POST","url":"={{ $('Webhook').first().json.body.server_url }}/message/sendList/{{ $('Webhook').first().json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $('Webhook').first().json.body.apikey }}"}]},"sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"number","value":"={{ $('Webhook').first().json.body.data.key.remoteJid }}"},{"name":"title","value":"={{ $json.title }}"},{"name":"description","value":"={{ $json.description }}"},{"name":"buttonText","value":"={{ $json.buttonText }}"},{"name":"footerText","value":"="},{"name":"sections","value":"={{ $json.sections }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1820,2765],"id":"5aa9b2a5-4d04-437a-9b8a-6a1d96e76d3f","name":"HTTP Request","alwaysOutputData":true,"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// üöÄ Leer todos los eventos\nconst eventos = $input.all();\n\n// üöÄ Funciones auxiliares para manejar tiempo\nconst extraerMinutos = (isoString) => {\n  if (!isoString) return null;\n  const hora = isoString.substring(11,16).split(':');\n  return parseInt(hora[0]) * 60 + parseInt(hora[1]);\n};\n\nconst minutosAHora = (totalMinutos) => {\n  const horas = Math.floor(totalMinutos / 60);\n  const minutos = totalMinutos % 60;\n  return `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;\n};\n\nconst crearFechaISO = (fechaBase, horaStr) => {\n  return fechaBase.substring(0, 11) + horaStr + fechaBase.substring(16);\n};\n\n// üöÄ Clasificar eventos\nconst eventosVerdes = [];\nconst eventosRojos = [];\n\nfor (const item of eventos) {\n  const ev = item.json;\n  const start = ev.start?.dateTime || ev.start?.date || ev.start;\n  const end = ev.end?.dateTime || ev.end?.date || ev.end;\n  if (!start || !end) continue;\n  \n  const summary = ev.summary?.toLowerCase() || \"\";\n  const location = ev.location?.toLowerCase() || \"\";\n  const description = ev.description?.toLowerCase() || \"\";\n  const colorId = ev.colorId?.toString();\n  \n  if (colorId === \"2\") {\n    eventosVerdes.push({ start, end, summary, location });\n  } else if (colorId === \"11\") {\n    eventosRojos.push({ start, end });\n  }\n}\n\n// üöÄ Procesar horarios disponibles (intervalos de 30 minutos que no se solapan con rojos)\nconst resultados = eventosVerdes.map(evento => {\n  const inicioVerdeMin = extraerMinutos(evento.start);\n  const finVerdeMin = extraerMinutos(evento.end);\n  const bloques = [];\n  \n  // Crear bloques de 30 minutos dentro del evento verde\n  for (let m = inicioVerdeMin; m + 30 <= finVerdeMin; m += 30) {\n    let bloqueDisponible = true;\n    \n    // Verificar si este bloque se solapa con alg√∫n evento rojo\n    for (const rojo of eventosRojos) {\n      const inicioRojoMin = extraerMinutos(rojo.start);\n      const finRojoMin = extraerMinutos(rojo.end);\n      \n      if (inicioRojoMin === null || finRojoMin === null) continue;\n      \n      // Verificar solapamiento - un bloque est√° solapado si:\n      // NO es que (el bloque termina antes de que empiece el rojo O el bloque empieza despu√©s de que termine el rojo)\n      if (!(m + 30 <= inicioRojoMin || m >= finRojoMin)) {\n        bloqueDisponible = false;\n        break;\n      }\n    }\n    \n    // Si el bloque no se solapa con ning√∫n evento rojo, a√±adirlo a los disponibles\n    if (bloqueDisponible) {\n      const horaInicio = minutosAHora(m);\n      const horaFin = minutosAHora(m + 30);\n      bloques.push({\n        horaInicio: horaInicio,\n        horaFin: horaFin,\n        inicio: crearFechaISO(evento.start, horaInicio),\n        fin: crearFechaISO(evento.start, horaFin)\n      });\n    }\n  }\n  \n  return {\n    eventoPrincipal: {\n      resumen: evento.summary,\n      location: evento.location,\n      inicio: evento.start,\n      fin: evento.end,\n      horaInicio: minutosAHora(inicioVerdeMin),\n      horaFin: minutosAHora(finVerdeMin)\n    },\n    horariosDisponibles: bloques\n  };\n});\n\n// üöÄ Devolver la respuesta\nreturn [{\n  json: {\n    resultados: resultados\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1160,2665],"id":"b87b9a4b-e38d-4b61-82ff-67f493527b09","name":"getForCode1"},{"parameters":{"fieldToSplitOut":"summary, start, end, location, colorId, description, id","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[940,2665],"id":"7ad642ac-cec1-4f5a-8225-8d9cb423edfb","name":"Split Out1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b272870f-2db7-43e9-b82f-131ed3160b38","leftValue":"={{ $json.message }}","rightValue":"=No se encontraron eventos disponibles para la propiedad.","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1380,2665],"id":"b4a7ae6b-d52d-463e-ba16-b844d67f4a46","name":"If5"},{"parameters":{"jsCode":"// Obtener los datos del nodo anterior\nconst datos = $input.first()?.json?.resultados || [];\nconsole.log(\"DEBUG - Datos recibidos:\", JSON.stringify(datos).substring(0, 200) + \"...\");\n\n// Verificar si tenemos datos\nif (!datos || !datos.length) {\n  console.log(\"DEBUG - No hay datos disponibles\");\n  return [{\n    json: {\n      error: \"No se encontraron eventos\",\n      message: \"El nodo anterior no devolvi√≥ ning√∫n horario disponible\"\n    },\n    pairedItem: 0\n  }];\n}\n\n// Funci√≥n para obtener el emoji estacional seg√∫n el mes (hemisferio sur)\nfunction getEmojiEstacional(mes) {\n  if (mes >= 3 && mes <= 5) return \"üçÇ\"; // Oto√±o\n  if (mes >= 6 && mes <= 8) return \"‚ùÑÔ∏è\"; // Invierno\n  if (mes >= 9 && mes <= 11) return \"üå∏\"; // Primavera\n  return \"‚òÄÔ∏è\"; // Verano\n}\n\n// Nombres de los meses\nconst nombresMeses = {\n  1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril',\n  5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto',\n  9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'\n};\n\n// Nombres de los d√≠as de la semana\nconst nombresDias = {\n  0: 'Domingo',\n  1: 'Lunes',\n  2: 'Martes',\n  3: 'Mi√©rcoles',\n  4: 'Jueves',\n  5: 'Viernes',\n  6: 'S√°bado'\n};\n\n// Extraer fecha de una cadena ISO\nfunction extraerFechaYHora(isoString) {\n  if (!isoString) return null;\n  \n  const match = isoString.match(/(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2})/);\n  if (match) {\n    const fechaCompleta = new Date(`${match[1]}-${match[2]}-${match[3]}T${match[4]}:${match[5]}:00`);\n    const diaSemana = nombresDias[fechaCompleta.getDay()];\n    \n    return {\n      anio: parseInt(match[1], 10),\n      mes: parseInt(match[2], 10),\n      dia: parseInt(match[3], 10),\n      hora: `${match[4]}:${match[5]}`,\n      fechaCompleta: fechaCompleta,\n      diaSemana: diaSemana\n    };\n  }\n  return null;\n}\n\n// Funci√≥n para formatear el rango de hora correctamente (12:00 a 12:30)\nfunction formatearRangoHora(horaInicio, horaFin) {\n  // Extraer horas y minutos de ambos horarios\n  const inicioMatch = horaInicio.match(/^(\\d+):(\\d+)/);\n  const finMatch = horaFin.match(/^(\\d+):(\\d+)/);\n  \n  // Formatear correctamente con horas y minutos\n  const horaInicioFormateada = inicioMatch ? `${inicioMatch[1]}:${inicioMatch[2]}` : horaInicio;\n  const horaFinFormateada = finMatch ? `${finMatch[1]}:${finMatch[2]}` : horaFin;\n  \n  return `${horaInicioFormateada} a ${horaFinFormateada}`;\n}\n\n// Obtener la fecha y hora actual\nconst ahora = new Date();\nconsole.log(`DEBUG - Fecha actual: ${ahora.toISOString()}`);\nconsole.log(`DEBUG - Fecha local: ${ahora.toString()}`);\n\n// Agrupar horarios por mes y d√≠a\nconst mesesAgrupados = {};\n\n// Procesar los horarios disponibles de todos los eventos\ndatos.forEach(evento => {\n  if (!evento.horariosDisponibles || !evento.horariosDisponibles.length) return;\n  \n  evento.horariosDisponibles.forEach(horario => {\n    try {\n      // Obtener la fecha de inicio del horario\n      const fechaHorario = new Date(horario.inicio);\n      \n      // Para debug\n      console.log(`DEBUG - Evaluando horario: ${horario.inicio}`);\n      \n      // COMPARACI√ìN SIMPLE: Verificar si la fecha ya pas√≥\n      if (fechaHorario <= ahora) {\n        console.log(`DEBUG - FILTRADA: Fecha ya pas√≥`);\n        return; // Saltar este horario porque ya pas√≥\n      }\n      \n      // Extraer componentes de la fecha para agrupar\n      const fechaInicio = extraerFechaYHora(horario.inicio);\n      if (!fechaInicio) {\n        console.log(`DEBUG - Error al extraer fecha y hora de: ${horario.inicio}`);\n        return;\n      }\n      \n      const mes = fechaInicio.mes;\n      const dia = fechaInicio.dia;\n      const nombreMes = nombresMeses[mes];\n      const diaSemana = fechaInicio.diaSemana;\n      \n      // Inicializar el grupo del mes si no existe\n      if (!mesesAgrupados[nombreMes]) {\n        mesesAgrupados[nombreMes] = {\n          mes: mes,\n          fechas: []\n        };\n      }\n      \n      // Evitar duplicados\n      const yaExiste = mesesAgrupados[nombreMes].fechas.some(\n        e => e.dia === dia && e.horaInicio === horario.horaInicio\n      );\n      \n      if (!yaExiste) {\n        mesesAgrupados[nombreMes].fechas.push({\n          dia,\n          horaInicio: horario.horaInicio,\n          horaFin: horario.horaFin,\n          mes,\n          diaSemana,\n          resumen: evento.eventoPrincipal.resumen,\n          rowId: `${mes}-${dia}-${horario.horaInicio.replace(\":\", \"\")}`\n        });\n      }\n    } catch (error) {\n      console.log(`ERROR procesando horario: ${error.message}`);\n    }\n  });\n});\n\n// Armar la estructura para WhatsApp SendList\nconst sections = [];\n\n// Crear una secci√≥n para cada mes\nfor (const [nombreMes, datosMes] of Object.entries(mesesAgrupados)) {\n  const filas = datosMes.fechas;\n  if (filas.length === 0) continue;\n  \n  // Obtener el emoji estacional para este mes\n  const emoji = getEmojiEstacional(datosMes.mes);\n  \n  // Ordenar filas por d√≠a y hora\n  filas.sort((a, b) => {\n    if (a.dia !== b.dia) return a.dia - b.dia;\n    return a.horaInicio.localeCompare(b.horaInicio);\n  });\n  \n  const rowsDelMes = [];\n  filas.forEach(f => {\n    const horaFormateada = formatearRangoHora(f.horaInicio, f.horaFin);\n    rowsDelMes.push({\n      title: `üïí ${f.dia} de ${nombreMes} : ${horaFormateada}`,\n      description: `${f.diaSemana}`,\n      rowId: f.rowId\n    });\n  });\n  \n  // Agregar la secci√≥n del mes con el emoji estacional\n  if (rowsDelMes.length > 0) {\n    sections.push({\n      title: `${emoji} ${nombreMes}`,\n      rows: rowsDelMes\n    });\n  }\n}\n\n// Secci√≥n por defecto si no hay nada\nif (sections.length === 0) {\n  sections.push({\n    title: \"‚ö†Ô∏è Sin horarios disponibles\",\n    rows: [{\n      title: \"No hay horarios disponibles\",\n      description: \"Intenta m√°s tarde\",\n      rowId: \"no-disponible\"\n    }]\n  });\n}\n\n// Obtener n√∫mero de cliente desde otro nodo o poner uno por defecto\nconst remoteJid =$('Webhook').first().json.body.data.key.remoteJid ;\n\n// JSON final para enviar por WhatsApp\nconst requestBody = {\n  number: remoteJid,\n  title: \"üìÖ Fechas Disponibles\",\n  description: \"Seleccion√° una fecha y hora para agendar tu visita\\nüïí Cada visita tiene una duraci√≥n de 30 minutos aprox.\",\n  buttonText: \"Seleccion√° üëÜ\",\n  footerText: \"\", // Ya incluimos la informaci√≥n de duraci√≥n en la descripci√≥n\n  sections\n};\n\n// Retornar el mensaje final en el formato que espera n8n\nreturn [{\n  json: requestBody,\n  pairedItem: 0 // Agregamos pairedItem para mantener el enlace con el elemento de entrada\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1600,2765],"id":"c24ea093-af2c-4b59-a07a-8d0229136c4f","name":"Lista2"},{"parameters":{"authentication":"nocoDbApiToken","operation":"create","projectId":"pgzahexmtqessds","table":"mf6beq5bszvx882","fieldsUi":{"fieldValues":[{"fieldName":"Nombre","fieldValue":"={{ $('Webhook').item.json.body.data.pushName }}"},{"fieldName":"Telefono","fieldValue":"={{ $('vars').item.json.remoteJid }}"},{"fieldName":"Fecha","fieldValue":"={{ $('Webhook').item.json.body.data.message.listResponseMessage.title }}"},{"fieldName":"fecha_cita","fieldValue":"={{ $json.fecha_cita }}"},{"fieldName":"recordatorio_1h","fieldValue":"={{ $json.recordatorio_1h }}"},{"fieldName":"estado","fieldValue":"no enviado"}]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[1380,3265],"id":"4f32c2b9-0a29-4386-84eb-7406298f0bf1","name":"NocoDB","credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pgzahexmtqessds","table":"mf6beq5bszvx882","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $('vars').item.json.remoteJid }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[760,3060],"id":"ae34cb4a-c4cd-4796-886a-0bdc73fd625a","name":"obtener cliente","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7f20c936-8e6d-44d7-aabb-e304d7426030","leftValue":"={{ $json.estado_cita }}","rightValue":"Finalizada","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[940,3060],"id":"0522f6a9-755b-48ea-b16d-2399de605054","name":"If6"},{"parameters":{"method":"POST","url":"={{ $('vars').item.json.server_url }}/message/sendText/{{ $('vars').item.json.instance }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"apikey","value":"={{ $('vars').item.json.apikey }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('vars').item.json.remoteJid }}"},{"name":"text","value":"=ü§ñ *_Cita agendada_*\n\n*{{ $('If4').item.json.body.data.message.listResponseMessage.title }}*"}]},"options":{}},"name":"FERNANDO5","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1600,3265],"id":"ca1417bb-dcfd-4f83-b533-6946fc533685","credentials":{"httpBasicAuth":{"id":"OpgdvMlLy6Zxc6ii","name":"NOCODB"}}},{"parameters":{"operation":"delete","key":"=contador:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3260,3300],"id":"95622cac-68a0-44e7-b5ba-15553e761993","name":"Redis8","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"delete","key":"=primermsg:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3040,3300],"id":"25feed1f-4aab-4afe-9f2e-2709a163a563","name":"Redis9","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-3760,3300],"id":"586698e9-c760-43ca-91b6-d380ddc5a210","name":"When clicking ‚ÄòTest workflow‚Äô"},{"parameters":{},"type":"n8n-nodes-base.limit","typeVersion":1,"position":[1160,2965],"id":"369e757c-7fb9-4a99-8e93-b957d647e203","name":"Limit"},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/chat/sendPresence/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"number\": \"{{ $node['Webhook'].json.body.data.key.remoteJid }}\",\n    \"delay\": 3000,\n    \"presence\": \"composing\"\n}","options":{}},"id":"2195aa45-5522-4ac7-a8a0-b00381973072","name":"Escribiendo...6","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2700,2365]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"d5a342e9-585b-42ea-be44-644adae10199","leftValue":"={{ $json.msg_whatsapp }}","rightValue":"={{ $json.Redis1 }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"id":"b447f677-77df-4845-8065-b41aa405da4f","name":"Compara Get Memory1","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2260,2365]},{"parameters":{"jsCode":"const data =$input.first().json.Redis1 ;\n\n// Verifica si data es un array directamente\nlet array;\n\nif (Array.isArray(data)) {\n    array = data;\n} else {\n    try {\n        // Intenta parsear si es una cadena JSON v√°lida\n        array = JSON.parse(data);\n    } catch (error) {\n        // Si no es JSON, considera que es un texto plano\n        array = [data];\n    }\n}\n\n// Une los elementos del array en un string\nconst message_completo = array.join(\", \");\n\nreturn [{ json: { message_completo } }];\n"},"id":"1adac85e-8308-4da5-b22f-46aa857a5fba","name":"Compara igualdad de memorias","type":"n8n-nodes-base.code","typeVersion":2,"position":[2480,2365]},{"parameters":{"operation":"delete","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2920,2365],"id":"52a840d8-c0d5-4185-99bc-007d4caa50da","name":"Redis10","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"assignments":{"assignments":[{"id":"255cac8e-6b72-4bbf-a4b4-a005540c821f","name":"msg_whatsapp","value":"={{ $('Return Redis').item.json.obtieneMSG }}","type":"string"},{"id":"e65cd104-a301-462e-9c36-9bdd3769472e","name":"Redis1","value":"={{ $json.Messages }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2040,2365],"id":"84cb0666-b0ca-45b2-9fdb-d17029c8179b","name":"redis1"},{"parameters":{"operation":"get","propertyName":"Messages","key":"=usuario:{{ $('vars').item.json.remoteJid }}","options":{}},"id":"40bd2edd-fc32-4078-b666-6f8ac0d1376d","name":"Get redis","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1820,2365],"credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/message/sendText/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n   \"delay\": 1600,\n  \"number\": \"{{ $('vars').item.json.remoteJid }}\",\n  \"text\": \"```En breve lo atendera un agente Humano```...\",\n  \"quoted\": {\n    \"key\": {\n      \"id\": \"{{ $('vars').item.json.apikey }}\",\n      \"remoteJid\": \"{{ $('vars').item.json.remoteJid }}\",\n      \"fromMe\": false\n    }\n  }\n}\n","options":{}},"id":"9c1bb8dc-2cd2-424c-89f2-24d489819e70","name":"MESSAGE5","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1160,3665]},{"parameters":{"operation":"incr","key":"=primermsg:{{ $('vars').item.json.remoteJid }}","expire":true,"ttl":1800},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[720,3665],"id":"c7b56bd4-0c9c-4255-85b1-8c3143a34b7e","name":"contador2","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5635d538-5603-4987-90e1-21d689baff79","leftValue":"={{ $json['primermsg:5492254423359'] }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[940,3665],"id":"ab2ca81f-d6ca-4327-8a96-9cc40d5c6295","name":"If7"},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/message/sendText/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n   \"delay\": 1600,\n  \"number\": \"{{ $('Edit Fields1').item.json.remoteJid }}\",\n  \"text\": \"ü§ñüí¨ *Transcripcion:* ```{{ $json.text }}```\",\n  \"quoted\": {\n    \"key\": {\n      \"id\": \"{{ $('Edit Fields1').item.json.idmsg }}\",\n      \"remoteJid\": \"{{ $('Edit Fields1').item.json.remoteJid }}\",\n      \"fromMe\": false\n    }\n  }\n}\n","options":{}},"id":"34be1ac6-f806-4594-a0e1-181e75f8e238","name":"MESSAGE","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1380,2165]},{"parameters":{"operation":"delete","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1380,3665],"id":"a90063d5-2a98-4d85-a383-f149bf3b499d","name":"Redis","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"delete","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1820,3265],"id":"eb1b74d3-a86f-4e25-84fe-bafb7ef50835","name":"Redis1","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"delete","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1820,2965],"id":"9b028ad2-e26a-4229-ad22-f231a912604b","name":"Redis2","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"delete","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4240,2265],"id":"8af906b7-8d1e-4537-bbf2-e783adb7f637","name":"Redis3","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"delete","key":"=usuario:{{ $('vars').first().json.remoteJid.replace(/\\D/g, '') }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[5340,2465],"id":"03a91228-0910-472e-ae30-488e0ded0645","name":"Redis6","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"jsCode":"// Obtener el texto con el formato \"üïí 1 de Mayo : 09:00 a 09:30\"\nconst textoFecha = $('If6').first().json.body.data.message.listResponseMessage.title;\nconsole.log(`Texto original: ${textoFecha}`);\n\n// Parsear el texto para extraer fecha y horas\nfunction parsearFechaHora(texto) {\n  try {\n    // Extraer la parte de la fecha y el rango de horas\n    // Este regex busca patrones como \"1 de Mayo : 09:00 a 09:30\"\n    const regex = /(\\d+)\\s+de\\s+(\\w+)\\s*:\\s*(\\d{1,2}:\\d{2})\\s*a\\s*(\\d{1,2}:\\d{2})/i;\n    const match = texto.match(regex);\n    \n    if (!match) {\n      console.log(\"No se pudo parsear el formato de fecha y hora\");\n      return null;\n    }\n    \n    const dia = parseInt(match[1], 10);\n    const mes = match[2].toLowerCase();\n    const horaInicio = match[3];\n    const horaFin = match[4];\n    \n    // Mapear nombres de meses en espa√±ol a n√∫meros\n    const mapaMeses = {\n      'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5,\n      'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11\n    };\n    \n    const mesNumero = mapaMeses[mes];\n    if (mesNumero === undefined) {\n      console.log(`Mes no reconocido: ${mes}`);\n      return null;\n    }\n    \n    // Obtener el a√±o actual (asumiendo que la cita es para el a√±o actual)\n    const anioActual = new Date().getFullYear();\n    \n    // Crear objetos Date para las horas de inicio y fin\n    const [horasInicio, minutosInicio] = horaInicio.split(':').map(num => parseInt(num, 10));\n    const [horasFin, minutosFin] = horaFin.split(':').map(num => parseInt(num, 10));\n    \n    const fechaInicio = new Date(anioActual, mesNumero, dia, horasInicio, minutosInicio);\n    const fechaFin = new Date(anioActual, mesNumero, dia, horasFin, minutosFin);\n    \n    return {\n      desde: fechaInicio,\n      hasta: fechaFin\n    };\n  } catch (error) {\n    console.log(`Error al parsear la fecha: ${error.message}`);\n    return null;\n  }\n}\n\n// Funci√≥n para formatear fechas en formato YYYY-MM-DDTHH:MM\nfunction formatearFechaSimplificada(fecha) {\n  // Obtener componentes de la fecha\n  const year = fecha.getFullYear();\n  const month = String(fecha.getMonth() + 1).padStart(2, '0');\n  const day = String(fecha.getDate()).padStart(2, '0');\n  const hours = String(fecha.getHours()).padStart(2, '0');\n  const minutes = String(fecha.getMinutes()).padStart(2, '0');\n  \n  // Construir el string con formato YYYY-MM-DDTHH:MM\n  return `${year}-${month}-${day}T${hours}:${minutes}`;\n}\n\n// Parsear el texto\nconst fechas = parsearFechaHora(textoFecha);\n\nif (!fechas) {\n  // Si no se pudo parsear, devolver valores por defecto\n  return {\n    json: {\n      fecha_desde: null,\n      fecha_hasta: null,\n      error: \"No se pudo parsear el formato de fecha y hora\"\n    }\n  };\n}\n\n// Formatear las fechas\nconst fechaDesde = formatearFechaSimplificada(fechas.desde);\nconst fechaHasta = formatearFechaSimplificada(fechas.hasta);\n\n// Calcular recordatorios basados en la fecha de inicio\nconst recordatorio24hDate = new Date(fechas.desde);\nrecordatorio24hDate.setDate(recordatorio24hDate.getDate() - 1);\n\nconst recordatorio1hDate = new Date(fechas.desde);\nrecordatorio1hDate.setHours(recordatorio1hDate.getHours() - 1);\n\nconst recordatorio24h = formatearFechaSimplificada(recordatorio24hDate);\nconst recordatorio1h = formatearFechaSimplificada(recordatorio1hDate);\n\n// Log para verificar los resultados\nconsole.log(`Fecha desde: ${fechaDesde}`);\nconsole.log(`Fecha hasta: ${fechaHasta}`);\nconsole.log(`Recordatorio 24h: ${recordatorio24h}`);\nconsole.log(`Recordatorio 1h: ${recordatorio1h}`);\n\n// Retornar los resultados\nreturn {\n  json: {\n    fecha_cita: fechaDesde,\n    fecha_desde: fechaDesde,\n    fecha_hasta: fechaHasta,\n    recordatorio_24h: recordatorio24h,\n    recordatorio_1h: recordatorio1h,\n    texto_original: textoFecha\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1160,3260],"id":"61ddc2f3-b982-40d1-a5eb-8af13f2d0809","name":"Code1"},{"parameters":{"method":"POST","url":"={{ $('vars').item.json.server_url }}/message/sendText/{{ $('vars').item.json.instance }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"apikey","value":"={{ $('vars').item.json.apikey }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('vars').item.json.remoteJid }}"},{"name":"text","value":"=üëâüîó _Gracias por su confirmaci√≥n 10 min antes le enviaremos el link de la llamada_"}]},"options":{}},"name":"FERNANDO6","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[720,3465],"id":"2593f426-c70c-4228-9632-85ea809f5453","credentials":{"httpBasicAuth":{"id":"OpgdvMlLy6Zxc6ii","name":"NOCODB"}}},{"parameters":{"method":"POST","url":"={{ $('vars').item.json.server_url }}/message/sendText/{{ $('vars').item.json.instance }}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"apikey","value":"={{ $('vars').item.json.apikey }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('vars').item.json.remoteJid }}"},{"name":"text","value":"=_Lamento que no pueda asistir, lo volveremos a llamar en otro momento_ üëãüèªü§ñ"}]},"options":{}},"name":"FERNANDO7","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[720,3265],"id":"9e4150cf-8c8b-42be-bb20-c2eb96cb6fbd","credentials":{"httpBasicAuth":{"id":"OpgdvMlLy6Zxc6ii","name":"NOCODB"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pgzahexmtqessds","table":"mpg9mfycr0pp0x5","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $json.remoteJid }})~and(estado,eq,on)"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[720,2360],"id":"340c5c09-31b4-424c-821c-7857ac0e8fc8","name":"NocoDB1","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}},"onError":"continueRegularOutput"},{"parameters":{"action":"generate"},"type":"n8n-nodes-base.crypto","typeVersion":1,"position":[-160,3140],"id":"c9ed2993-589a-4635-98b9-cf68d3e104da","name":"Crypto"},{"parameters":{"authentication":"nocoDbApiToken","operation":"create","projectId":"pgzahexmtqessds","table":"mpg9mfycr0pp0x5","fieldsUi":{"fieldValues":[{"fieldName":"pushname","fieldValue":"={{ $('If4').item.json.body.data.pushName }}"},{"fieldName":"Telefono","fieldValue":"={{ $('If4').item.json.body.data.key.remoteJid.replace(/\\D/g, '') }}"},{"fieldName":"key","fieldValue":"={{ $json.data }}"},{"fieldName":"estado","fieldValue":"on"}]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[60,3140],"id":"97205392-979b-4235-860a-ad967866efa5","name":"InsertarCliente","credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pgzahexmtqessds","table":"mpg9mfycr0pp0x5","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $('Webhook').item.json.body.data.key.remoteJid.replace(/\\D/g, '')  }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-1820,3020],"id":"c497a62f-c72f-4174-acfd-1ed3349187d8","name":"getClientes","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e02fa309-efdc-4424-a35e-232970a746cf","leftValue":"={{ $json.Telefono }}","rightValue":"=","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-380,3060],"id":"609da1ad-da53-412d-a62a-7d65b42fab1c","name":"If1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pgzahexmtqessds","table":"mf6beq5bszvx882","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $json.Telefono }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[1380,2965],"id":"e2e16d68-5426-44a4-ade7-b48b3fff3ae2","name":"NocoDB2","credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}}},{"parameters":{"method":"POST","url":"={{ $node['Webhook'].json.body.server_url }}/message/sendText/{{ $node['Webhook'].json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $node['Webhook'].json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n   \"delay\": 1600,\n  \"number\": \"{{ $('vars').first().json.remoteJid }}\",\n  \"text\": \"{{ $json.Nombre }} ya tenes una cita agendada para el {{ $json.Fecha }}\",\n  \"quoted\": {\n    \"key\": {\n      \"id\": \"{{ $('vars').first().json.apikey }}\",\n      \"remoteJid\": \"{{ $('vars').first()\n.json.remoteJid }}\",\n      \"fromMe\": false\n    }\n  }\n}\n","options":{}},"id":"8f5a2664-8db8-400b-ae1b-24539779d893","name":"MESSAGE7","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1600,2965]},{"parameters":{"authentication":"nocoDbApiToken","operation":"update","projectId":"pgzahexmtqessds","table":"mpg9mfycr0pp0x5","fieldsUi":{"fieldValues":[{"fieldName":"Id","fieldValue":"={{ $('vars').item.json.Id }}"},{"fieldName":"estado","fieldValue":"off"}]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[4460,2265],"id":"f935853c-38ed-41aa-87f2-c108c8afa7fa","name":"NocoDB3","credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}}},{"parameters":{"operation":"set","key":"=status:{{ $('Webhook').item.json.body.data.key.remoteJid.replace(/\\D/g, '') }}","value":"@bot_off","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2040,3260],"id":"c55872c7-9bd5-44cf-b64d-61b6a6903044","name":"Frenamos","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"get","propertyName":"bot","key":"=status:{{ $('Webhook').item.json.body.data.key.remoteJid.replace(/\\D/g, '') }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-3340,3000],"id":"4be38706-5dfc-44ce-a3ed-75cad2cd4783","name":"Obtiene el estado","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"assignments":{"assignments":[{"id":"0b4f0505-ffd5-4d85-a00c-82dedd175510","name":"humano","value":"=üôãüèª‚Äç‚ôÇÔ∏è","type":"string"},{"id":"7aebe232-8418-4c8f-a2a4-23cddd0243eb","name":"sender","value":"={{ $('Webhook').item.json.body.sender.replace(/\\D/g, '') }}","type":"string"},{"id":"2542304d-c7ee-4814-aa6e-b9591916a458","name":"robot","value":"ü§ñ","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2740,3500],"id":"bdaafbe5-d340-41c7-92b3-2f0c9f7b66d7","name":"msg"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.humano }}","rightValue":"üôãüèª‚Äç‚ôÇÔ∏è","operator":{"type":"string","operation":"equals"},"id":"0d1b8d7e-17ff-4865-8af9-970b22ca3a21"}],"combinator":"and"},"renameOutput":true,"outputKey":"Humano"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"67267789-27a2-4927-a2f0-46757e29cfc0","leftValue":"={{ $json.robot }}","rightValue":"ü§ñ","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2520,3560],"id":"e4a06e33-baa4-4c65-ae87-3cc679944dd0","name":"Switch2"},{"parameters":{"operation":"set","key":"=status:{{ $('Webhook').item.json.body.data.key.remoteJid.replace(/\\D/g, '') }}","value":"@bot_on","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-2040,3440],"id":"31b635d9-394c-4046-930c-47291c71e110","name":"Activa robot","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"jsCode":"// Funci√≥n para detectar intenci√≥n de ver los bots disponibles\nfunction detectarSolicitudBots(mensaje) {\n  if (!mensaje) return false;\n  \n  const mensajeLC = mensaje.toLowerCase().trim();\n  \n  // Patrones para detectar solicitud de ver bots\n  const patronesBots = [\n    'ver tus bots', 'mostrar bots', 'bots disponibles', 'que bots tienes',\n    'ver agentes', 'mostrar agentes', 'agentes disponibles', 'quiero ver tus bots',\n    'lista de bots', 'cuales son tus bots'\n  ];\n  \n  for (const patron of patronesBots) {\n    if (mensajeLC.includes(patron)) {\n      return true;\n    }\n  }\n  \n  return false;\n}\n\n// Funci√≥n para obtener bots disponibles\nfunction obtenerBotsDisponibles() {\n  // Lista predefinida de bots \n  const botsPredefinidos = [\n    {\n      id: \"ventas\",\n      nombre: \"Asistente de Ventas\",\n      descripcion: \"Te ayuda con precios y productos\",\n      imagen: \"üõí\"\n    },\n    {\n      id: \"soporte\",\n      nombre: \"Soporte T√©cnico\",\n      descripcion: \"Resuelve problemas t√©cnicos\",\n      imagen: \"üîß\"\n    },\n    {\n      id: \"agenda\",\n      nombre: \"Asistente de Citas\",\n      descripcion: \"Agenda reuniones y demos\",\n      imagen: \"üìÖ\"\n    }\n  ];\n  \n  // Generar mensaje formateado\n  let mensaje = \"ü§ñ *BOTS DISPONIBLES* ü§ñ\\n\\n\";\n  \n  botsPredefinidos.forEach(bot => {\n    mensaje += `${bot.imagen || 'ü§ñ'} *${bot.nombre}*\\n`;\n    mensaje += `${bot.descripcion || 'Sin descripci√≥n'}\\n`;\n    mensaje += `Para activar: @${bot.id}\\n\\n`;\n  });\n  \n  mensaje += \"Para activar un bot, escribe su comando correspondiente.\";\n  \n  return {\n    bots: botsPredefinidos,\n    formatoMensaje: mensaje\n  };\n}\n\n// Funci√≥n para procesar comandos\nfunction procesarComando(mensaje) {\n  if (!mensaje) return { esComando: false };\n  \n  const mensajeLC = mensaje.toLowerCase().trim();\n  \n  // Comandos de activaci√≥n/desactivaci√≥n\n  if (mensajeLC === '@on') {\n    return {\n      esComando: true,\n      tipoComando: 'activacion',\n      nuevoEstado: 'activo',\n      mensajeRespuesta: \"ü§ñ *Asistente IA activado* - Ahora responder√© a los mensajes autom√°ticamente.\"\n    };\n  }\n  \n  if (mensajeLC === '@off') {\n    return {\n      esComando: true,\n      tipoComando: 'desactivacion',\n      nuevoEstado: 'inactivo',\n      mensajeRespuesta: \"üîï *Asistente IA desactivado* - Un agente humano atender√° la conversaci√≥n.\"\n    };\n  }\n  \n  // Verificar si es un comando de activaci√≥n de bot espec√≠fico\n  if (mensajeLC.startsWith('@') && mensajeLC.length > 1) {\n    const botId = mensajeLC.substring(1); // Quita el @ del inicio\n    \n    return {\n      esComando: true,\n      tipoComando: 'bot_especifico',\n      botId: botId,\n      mensajeRespuesta: `ü§ñ *Bot ${botId} activado* - Ahora te atender√© con este asistente especializado.`\n    };\n  }\n  \n  // No es un comando\n  return {\n    esComando: false\n  };\n}\n\n// Funci√≥n para verificar estado del asistente\nasync function verificarEstadoAsistente(remoteJid) {\n  try {\n    if (!remoteJid) {\n      console.log(\"RemoteJid no proporcionado para verificar estado\");\n      return {\n        activo: true,\n        razon: \"RemoteJid no disponible, asumiendo activo por defecto\"\n      };\n    }\n    \n    const remoteJidClean = remoteJid.replace(/\\D/g, '');\n    console.log(`Verificando estado para: ${remoteJidClean}`);\n    \n    // Intentar obtener estado actual desde Redis\n    let estadoActual;\n    try {\n      // Usar get para obtener el estado\n      estadoActual = await $node['Obtiene el estado'].json.bot;\n      console.log(`Estado obtenido del nodo Redis: ${estadoActual}`);\n    } catch (redisError) {\n      console.error(`Error al leer estado: ${redisError?.message || 'Error desconocido'}`);\n      return {\n        activo: true,\n        razon: `Error al leer estado: ${redisError?.message || 'Error desconocido'}. Asumiendo activo.`\n      };\n    }\n    \n    // Si no hay estado o es null/undefined, asumimos activo\n    if (estadoActual === null || estadoActual === undefined) {\n      return {\n        activo: true,\n        razon: \"No hay configuraci√≥n previa, activo por defecto\"\n      };\n    }\n    \n    // Si el estado es '@bot_off', est√° inactivo\n    const estaActivo = estadoActual !== '@bot_off';\n    return {\n      activo: estaActivo,\n      razon: estaActivo ? \"Bot activo\" : \"Bot desactivado\"\n    };\n    \n  } catch (error) {\n    console.error(`Error al verificar estado: ${error?.message || 'Error desconocido'}`);\n    return {\n      activo: true,\n      error: true,\n      razon: `Error global: ${error?.message || 'Error desconocido'}. Asumiendo activo.`\n    };\n  }\n}\n\n// --- C√ìDIGO PRINCIPAL ---\n\n// Obtener los datos de entrada con validaci√≥n\nlet webhook;\ntry {\n  webhook = $('Webhook').first()?.json;\n  console.log(\"Datos de Webhook: \" + (webhook ? \"disponibles\" : \"no disponibles\"));\n} catch (error) {\n  console.error(\"Error al acceder a Webhook:\", error?.message);\n  webhook = null;\n}\n\n// Si no hay datos de Webhook, usar un valor por defecto\nif (!webhook || !webhook.body || !webhook.body.data) {\n  console.log(\"Estructura de webhook incompleta o no disponible\");\n  \n  // Tratar de obtener el estado del bot directamente\n  let estadoBot;\n  try {\n    estadoBot = $('Obtiene el estado').first()?.json?.bot;\n    console.log(`Estado del bot obtenido: ${estadoBot}`);\n  } catch (error) {\n    console.error(\"Error al obtener estado del bot:\", error?.message);\n    estadoBot = '@bot_off'; // Por defecto desactivado si hay error\n  }\n  \n  return {\n    json: {\n      error: \"Estructura de datos incompleta\",\n      asistenteActivo: estadoBot !== '@bot_off',\n      razonEstado: \"Determinado por par√°metro directo\",\n      shouldReply: estadoBot !== '@bot_off',\n      mensaje: \"N/A\"\n    }\n  };\n}\n\n// Si llegamos aqu√≠, tenemos datos de webhook v√°lidos\nconst datos = webhook;\nconst mensaje = datos.body.data.message?.conversation || \"\";\nconst remoteJid = datos.body.data.key?.remoteJid || \"\";\nconst remoteJidClean = remoteJid.replace(/\\D/g, '');\n\nconsole.log(`Mensaje recibido: \"${mensaje}\"`);\nconsole.log(`RemoteJid: ${remoteJid}`);\n\n// 1. Verificar si es un comando (@on/@off/@botID)\nconst resultadoComando = procesarComando(mensaje);\nconsole.log(`¬øEs un comando? ${resultadoComando.esComando}`);\n\n// 2. Verificar si es una solicitud para ver bots\nconst esSolicitudBots = detectarSolicitudBots(mensaje);\nconsole.log(`¬øEs solicitud de bots? ${esSolicitudBots}`);\n\n// 3. Si es un comando de control, guardar en Redis\nif (resultadoComando.esComando && \n    (resultadoComando.tipoComando === 'activacion' || resultadoComando.tipoComando === 'desactivacion')) {\n  try {\n    // Aqu√≠ podr√≠amos guardar en Redis, pero en esta implementaci√≥n inicial\n    // lo haremos en el siguiente nodo para mantener el c√≥digo m√°s simple\n    console.log(`Comando detectado: ${resultadoComando.tipoComando}`);\n  } catch (error) {\n    console.error(`Error al procesar comando: ${error?.message}`);\n  }\n}\n\n// 4. Verificar estado actual del asistente\nlet estadoAsistente;\ntry {\n  estadoAsistente = await verificarEstadoAsistente(remoteJid);\n} catch (error) {\n  console.error(`Error al verificar estado: ${error?.message}`);\n  estadoAsistente = {\n    activo: true,\n    razon: `Error en verificaci√≥n: ${error?.message}. Asumiendo activo.`\n  };\n}\n\nconsole.log(`Estado asistente: ${JSON.stringify(estadoAsistente)}`);\n\n// 5. Si es una solicitud de ver bots, obtener informaci√≥n\nlet infoBots = {};\nif (esSolicitudBots) {\n  infoBots = obtenerBotsDisponibles();\n  console.log(`Informaci√≥n de bots obtenida: ${infoBots.bots.length} bots disponibles`);\n}\n\n// 6. Determinar si debe responder\nconst shouldReply = estadoAsistente.activo && !resultadoComando.esComando && !esSolicitudBots;\n\n// Devolver resultado\nreturn {\n  json: {\n    remoteJid: remoteJid,\n    remoteJidClean: remoteJidClean,\n    mensaje: mensaje,\n    esComando: resultadoComando.esComando,\n    tipoComando: resultadoComando.tipoComando || 'ninguno',\n    mensajeComando: resultadoComando.mensajeRespuesta,\n    esSolicitudBots: esSolicitudBots,\n    mensajeBots: esSolicitudBots ? infoBots.formatoMensaje : '',\n    asistenteActivo: estadoAsistente.activo,\n    razonEstado: estadoAsistente.razon,\n    shouldReply: shouldReply,\n    senderInfo: {\n      jid: datos.body.sender,\n      isInstance: datos.body.sender !== datos.body.data.key.remoteJid\n    }\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3060,3000],"id":"43a97a86-e68a-4501-bb10-c67aae8267a8","name":"Code"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb8838ec-b7a3-4e56-87c4-3cebab2cc77b","leftValue":"={{ $json.shouldReply }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2800,3000],"id":"6291bb87-8305-4d6a-87ad-1a081b6672f4","name":"If4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bfd8e386-bd62-4c4d-8cb4-9211f7091965","leftValue":"={{ $('Webhook').item.json.body.data.key.fromMe }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2360,2940],"id":"1a17ec7b-cf81-43e5-963f-82ed1da4e930","name":"If8"}],"connections":{"Switch1":{"main":[[{"node":"contador1","type":"main","index":0}],[],[]]},"vars":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Get redis","type":"main","index":0}]]},"Return Redis":{"main":[[{"node":"Wait","type":"main","index":0}]]},"MSG":{"main":[[{"node":"Return Redis","type":"main","index":0}]]},"contador":{"main":[[{"node":"MSG","type":"main","index":0}]]},"Redis4":{"main":[[{"node":"Escribiendo...4","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Convert to File1","type":"main","index":0}]]},"Convert to File1":{"main":[[{"node":"Transcribir","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Obtiene el estado","type":"main","index":0}]]},"Switch":{"main":[[],[{"node":"NocoDB1","type":"main","index":0}],[{"node":"Edit Fields1","type":"main","index":0}],[{"node":"Google Calendar","type":"main","index":0}],[{"node":"contador2","type":"main","index":0}],[{"node":"obtener cliente","type":"main","index":0}],[{"node":"FERNANDO6","type":"main","index":0}],[{"node":"FERNANDO7","type":"main","index":0}]]},"Transcribir":{"main":[[{"node":"MESSAGE","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"MESSAGE2","type":"main","index":0}]]},"Escribiendo...4":{"main":[[{"node":"FERNANDO3","type":"main","index":0}]]},"FERNANDO3":{"main":[[{"node":"MESSAGE3","type":"main","index":0}]]},"Escribiendo...5":{"main":[[{"node":"Agendamos?","type":"main","index":0}]]},"Lista1":{"main":[[{"node":"Agendar","type":"main","index":0}]]},"Agendar":{"main":[[{"node":"Redis6","type":"main","index":0}]]},"MESSAGE3":{"main":[[{"node":"Escribiendo...5","type":"main","index":0}]]},"Agendamos?":{"main":[[{"node":"MESSAGE4","type":"main","index":0}]]},"MESSAGE4":{"main":[[{"node":"Lista1","type":"main","index":0}]]},"If":{"main":[[{"node":"Switch1","type":"main","index":0}],[{"node":"Redis4","type":"main","index":0}]]},"contador1":{"main":[[{"node":"If3","type":"main","index":0}]]},"If3":{"main":[[{"node":"MESSAGE1","type":"main","index":0}]]},"Google Calendar":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"HTTP Request":{"main":[[]]},"getForCode1":{"main":[[{"node":"If5","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"getForCode1","type":"main","index":0}]]},"If5":{"main":[[{"node":"Success2","type":"main","index":0}],[{"node":"Lista2","type":"main","index":0}]]},"Lista2":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"obtener cliente":{"main":[[{"node":"If6","type":"main","index":0}]]},"If6":{"main":[[{"node":"Limit","type":"main","index":0}],[{"node":"Code1","type":"main","index":0}]]},"NocoDB":{"main":[[{"node":"FERNANDO5","type":"main","index":0}]]},"Redis5":{"main":[[{"node":"Redis8","type":"main","index":0}]]},"Redis8":{"main":[[{"node":"Redis9","type":"main","index":0}]]},"When clicking ‚ÄòTest workflow‚Äô":{"main":[[{"node":"Redis5","type":"main","index":0}]]},"Limit":{"main":[[{"node":"NocoDB2","type":"main","index":0}]]},"MESSAGE1":{"main":[[{"node":"Redis3","type":"main","index":0}]]},"Escribiendo...6":{"main":[[{"node":"Redis10","type":"main","index":0}]]},"Compara Get Memory1":{"main":[[{"node":"Compara igualdad de memorias","type":"main","index":0}]]},"Compara igualdad de memorias":{"main":[[{"node":"Escribiendo...6","type":"main","index":0}]]},"redis1":{"main":[[{"node":"Compara Get Memory1","type":"main","index":0}]]},"Redis10":{"main":[[{"node":"If","type":"main","index":0}]]},"Get redis":{"main":[[{"node":"redis1","type":"main","index":0}]]},"contador2":{"main":[[{"node":"If7","type":"main","index":0}]]},"If7":{"main":[[{"node":"MESSAGE5","type":"main","index":0}]]},"MESSAGE5":{"main":[[{"node":"Redis","type":"main","index":0}]]},"FERNANDO5":{"main":[[{"node":"Redis1","type":"main","index":0}]]},"MESSAGE":{"main":[[{"node":"Wait2","type":"main","index":0}]]},"Code1":{"main":[[{"node":"NocoDB","type":"main","index":0}]]},"NocoDB1":{"main":[[{"node":"contador","type":"main","index":0}]]},"Crypto":{"main":[[{"node":"InsertarCliente","type":"main","index":0}]]},"InsertarCliente":{"main":[[{"node":"vars","type":"main","index":0}]]},"getClientes":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"vars","type":"main","index":0}],[{"node":"Crypto","type":"main","index":0}]]},"NocoDB2":{"main":[[{"node":"MESSAGE7","type":"main","index":0}]]},"MESSAGE7":{"main":[[{"node":"Redis2","type":"main","index":0}]]},"Redis3":{"main":[[{"node":"NocoDB3","type":"main","index":0}]]},"Frenamos":{"main":[[]]},"Obtiene el estado":{"main":[[{"node":"Code","type":"main","index":0}]]},"msg":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"Code":{"main":[[{"node":"If4","type":"main","index":0}]]},"If4":{"main":[[],[]]},"If8":{"main":[[],[{"node":"getClientes","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","errorWorkflow":"2kOn0Oz7c2uvczPK","timezone":"America/Argentina/Buenos_Aires","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Frenamos":[{"json":{"conversation":"üôãüèª‚Äç‚ôÇÔ∏è","sender":"5492254596618"}}],"msg":[{"json":{"conversation":"üôãüèª‚Äç‚ôÇÔ∏è","sender":"5492254596618"}}],"Webhook":[{"json":{"headers":{"host":"n8n.innovasoftpro.dev","user-agent":"axios/1.7.9","content-length":"958","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"3.236.85.138","x-forwarded-host":"n8n.innovasoftpro.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"575dad520f0e","x-real-ip":"3.236.85.138"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"tester","data":{"key":{"remoteJid":"5492254423359@s.whatsapp.net","fromMe":false,"id":"3EB03EC029C20A360A8D95"},"pushName":"Fer { }","status":"DELIVERY_ACK","message":{"conversation":"hola quiero ver tus bots","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"a0ebFmt5jO2yzg==","senderTimestamp":"1746748763","senderAccountType":"E2EE","receiverAccountType":"E2EE","recipientKeyHash":"YtP4sRhXLhV5fg==","recipientTimestamp":"1746043888"},"deviceListMetadataVersion":2,"messageSecret":"tWE1rDsL0mXwle95mGmpzaTJ7arjheUUxfGiNl++1MQ="}},"messageType":"conversation","messageTimestamp":1746856149,"instanceId":"17397cdb-a498-4f14-ac42-db31546caee9","source":"web"},"destination":"https://n8n.innovasoftpro.dev/webhook/qeva","date_time":"2025-05-10T02:49:09.669Z","sender":"5492254596618@s.whatsapp.net","server_url":"https://n8n-evolution-api.ea1y7g.easypanel.host","apikey":"FEFC629ADE3D-4720-A67F-6B927CFEC8CA"},"webhookUrl":"https://n8n.innovasoftpro.dev/webhook/qeva","executionMode":"production"}}]},"versionId":"c96cb853-2bad-4194-9ddd-80daa01cd8c8","triggerCount":1,"tags":[]}