{
  "active": false,
  "connections": {
    "Calendario": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener eventos": {
      "main": [
        [
          {
            "node": "Split Out2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Obtener eventos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response null Codigo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "getForCode": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Datos de la propiedad",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcula fecha": {
      "main": [
        [
          {
            "node": "Propietario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Agente inmobiliario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out2": {
      "main": [
        [
          {
            "node": "getForCode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verificador": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpia fecha": {
      "main": [
        [
          {
            "node": "Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "verificador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recordatorio de cita": {
      "main": [
        []
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "NocoDB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NocoDB": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "NocoDB1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Recordatorio de cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NocoDB1": {
      "main": [
        []
      ]
    },
    "Datos de la propiedad": {
      "main": [
        [
          {
            "node": "Calcula fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Propietario": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Agente inmobiliario": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cliente": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Limpia fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-03-19T13:21:24.791Z",
  "id": "WeP6wQkgz8h3964y",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "AGENTE INMO - Agendar_cita",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "numero_cliente",
              "type": "any"
            },
            {
              "name": "fecha_cita",
              "type": "any"
            },
            {
              "name": "Nombre"
            },
            {
              "name": "Evento"
            },
            {
              "name": "correo_electronico",
              "type": "any"
            },
            {
              "name": "nombre_inmobiliaria"
            },
            {
              "name": "session_id"
            },
            {
              "name": "idMensaje"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -3020,
        -560
      ],
      "id": "f8832bdf-6990-44c3-892a-4fe2812aaeef",
      "name": "Calendario"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "Codigo_propiedad",
        "key": "=propiedades_historial_analisis",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2800,
        -560
      ],
      "id": "a0b60582-4a37-4771-a774-f79b4a0ece4c",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "JMklVOvkU7koL2UG",
          "name": "Redis"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "004dfd8dfad8cab59884aa5afbe99b4943ba96c971d4eb480405c7595b8160b1@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Francisco"
        },
        "returnAll": true,
        "timeMax": "={{ $now.plus({ week: 2 }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -2140,
        -660
      ],
      "id": "6577b176-2582-4c7d-beff-b5bd7b14e523",
      "name": "Obtener eventos",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "248CSUaxOr8MEWUN",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c358838a-4034-4100-a5cd-e89f533161b0",
              "leftValue": "={{ $json.ultimoCodigo }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2360,
        -560
      ],
      "id": "d4113959-30d1-4acd-a3b1-0852ab674e1a",
      "name": "If1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ef619c87-8996-4278-805f-187d5e1e672a",
              "name": "response",
              "value": "Codigo propiedad vacio",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2140,
        -460
      ],
      "id": "c7a1b1f3-6e09-4f5a-8cf0-0b0cd2b3eb31",
      "name": "Response null Codigo"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el c√≥digo de propiedad que queremos buscar\nconst codigoPropiedad = $('Code').first().json.ultimoCodigo;\n\n// Procesar todos los eventos de entrada\nconst events = $input.all();\n\n// Para debugging\nconsole.log(\"N√∫mero total de eventos a procesar:\", events.length);\nconsole.log(\"C√≥digo de propiedad a buscar:\", codigoPropiedad);\n\n// Arrays para almacenar los eventos filtrados\nconst eventosVerdes = [];\nconst eventosRojos = [];\n\n// Mapa para almacenar las relaciones entre ubicaciones y c√≥digos\n// Esto nos ayudar√° a relacionar eventos rojos con c√≥digos de propiedad\nconst relacionUbicacionCodigo = new Map();\n\n// PASO 1: Escanear eventos verdes para recopilar relaciones ubicaci√≥n->c√≥digo\nconsole.log(\"\\n=== FASE 1: ESCANEO DE UBICACIONES Y C√ìDIGOS ===\");\nevents.forEach(item => {\n  const event = item.json;\n  \n  // Ignorar objetos que son solo timezone\n  if (event.start === \"America/Argentina/Buenos_Aires\" && \n      event.end === \"America/Argentina/Buenos_Aires\") {\n    return;\n  }\n  \n  // Detectar eventos verdes con \"Codigo:XXX\"\n  if ((event.colorId === \"10\" || event.colorId === 10) && \n      event.summary && \n      event.summary.includes(\"Codigo:\") && \n      event.location) {\n    \n    // Extraer el c√≥digo de la propiedad\n    const codigoMatch = event.summary.match(/Codigo:([A-Za-z0-9-_]+)/i);\n    if (codigoMatch) {\n      const codigo = codigoMatch[1];\n      // Guardar la relaci√≥n ubicaci√≥n -> c√≥digo\n      relacionUbicacionCodigo.set(event.location, codigo);\n      console.log(`Ubicaci√≥n ${event.location} asociada con c√≥digo ${codigo}`);\n    }\n  }\n});\n\n// PASO 2: Procesar todos los eventos\nconsole.log(\"\\n=== FASE 2: PROCESAMIENTO DE EVENTOS ===\");\nevents.forEach(item => {\n  const event = item.json;\n  \n  // Ignorar objetos que son solo timezone\n  if (event.start === \"America/Argentina/Buenos_Aires\" && \n      event.end === \"America/Argentina/Buenos_Aires\") {\n    return;\n  }\n  \n  // CASO 1: Eventos verdes (colorId=2)\n  if (event.colorId === \"10\" || event.colorId === 10) {\n    // Extraer c√≥digo directamente del summary\n    let codigoEvento = null;\n    const codigoMatch = event.summary && event.summary.match(/Codigo:([A-Za-z0-9-_]+)/i);\n    \n    if (codigoMatch) {\n      codigoEvento = codigoMatch[1];\n    }\n    \n    // Verificar si el c√≥digo coincide con el buscado\n    if (codigoEvento === codigoPropiedad) {\n      console.log(`Evento VERDE con c√≥digo coincidente: ${event.summary}`);\n      eventosVerdes.push({\n        ...event,\n        tipo: \"verde\"\n      });\n    }\n  }\n  // CASO 2: Eventos rojos (colorId=11)\n  else if (event.colorId === \"11\" || event.colorId === 11) {\n    // Para eventos rojos, verificar:\n    // 1. Si tiene un formato \"Direccion: XXX\" y la ubicaci√≥n coincide con un c√≥digo conocido\n    // 2. O si contiene directamente el c√≥digo de propiedad\n    \n    let coincideRojo = false;\n    \n    // Verificar si su ubicaci√≥n est√° asociada con el c√≥digo buscado\n    if (event.location && relacionUbicacionCodigo.has(event.location)) {\n      const codigoAsociado = relacionUbicacionCodigo.get(event.location);\n      if (codigoAsociado === codigoPropiedad) {\n        coincideRojo = true;\n        console.log(`Evento ROJO coincide por ubicaci√≥n ${event.location}`);\n      }\n    }\n    \n    // Tambi√©n verificar si el summary contiene el c√≥digo directamente\n    if (event.summary && event.summary.includes(codigoPropiedad)) {\n      coincideRojo = true;\n      console.log(`Evento ROJO coincide por menci√≥n directa del c√≥digo`);\n    }\n    \n    if (coincideRojo) {\n      eventosRojos.push({\n        ...event,\n        tipo: \"rojo\"\n      });\n    }\n  }\n});\n\n// Si no encontramos eventos, hacer una segunda pasada m√°s flexible\nif (eventosVerdes.length === 0 && eventosRojos.length === 0) {\n  console.log(\"\\n=== NO SE ENCONTRARON EVENTOS EXACTOS, BUSCANDO POR UBICACI√ìN ===\");\n  \n  // Si hay eventos rojos pero no se relacionaron correctamente,\n  // intentar buscar por coincidencia exacta de ubicaci√≥n\n  const eventosVerdesBuscados = events.filter(item => {\n    const event = item.json;\n    return (event.colorId === \"10\" || event.colorId === 10) && \n           event.summary && \n           event.summary.includes(`Codigo:${codigoPropiedad}`);\n  }).map(item => item.json);\n  \n  // Si encontramos eventos verdes con el c√≥digo buscado...\n  if (eventosVerdesBuscados.length > 0) {\n    console.log(`Encontrados ${eventosVerdesBuscados.length} eventos verdes con el c√≥digo buscado`);\n    \n    // Extraer las ubicaciones de estos eventos verdes\n    const ubicacionesBuscadas = eventosVerdesBuscados\n      .filter(event => event.location)\n      .map(event => event.location);\n    \n    console.log(\"Ubicaciones asociadas al c√≥digo:\", ubicacionesBuscadas);\n    \n    // Buscar eventos rojos con estas ubicaciones\n    events.forEach(item => {\n      const event = item.json;\n      \n      // Verificar si es un evento rojo con ubicaci√≥n coincidente\n      if ((event.colorId === \"11\" || event.colorId === 11) && \n          event.location && \n          ubicacionesBuscadas.includes(event.location)) {\n        \n        console.log(`Evento ROJO coincide por ubicaci√≥n (segunda pasada): ${event.summary}`);\n        eventosRojos.push({\n          ...event,\n          tipo: \"rojo\"\n        });\n      }\n    });\n    \n    // A√±adir los eventos verdes encontrados\n    eventosVerdesBuscados.forEach(event => {\n      eventosVerdes.push({\n        ...event,\n        tipo: \"verde\"\n      });\n    });\n  }\n}\n\n// Si todav√≠a no encontramos eventos, mostrar todos los eventos coloreados\nif (eventosVerdes.length === 0 && eventosRojos.length === 0) {\n  console.log(\"\\n=== √öLTIMO RECURSO: DEVOLVIENDO TODOS LOS EVENTOS COLOREADOS ===\");\n  \n  // Capturar todos los eventos verdes (colorId=10)\n  events.forEach(item => {\n    const event = item.json;\n    \n    // Ignorar objetos timezone\n    if (event.start === \"America/Argentina/Buenos_Aires\" && \n        event.end === \"America/Argentina/Buenos_Aires\") {\n      return;\n    }\n    \n    if (event.colorId === \"10\" || event.colorId === 10) {\n      eventosVerdes.push({\n        ...event,\n        tipo: \"verde\"\n      });\n    }\n    else if (event.colorId === \"11\" || event.colorId === 11) {\n      eventosRojos.push({\n        ...event,\n        tipo: \"rojo\"\n      });\n    }\n  });\n}\n\n// Registrar el resultado final\nconsole.log(`\\nResultado final: ${eventosVerdes.length} eventos verdes y ${eventosRojos.length} eventos rojos para el c√≥digo ${codigoPropiedad}`);\n\n// Devolver eventos encontrados\nreturn [{\n  json: {\n    codigo: codigoPropiedad,\n    eventosVerdes: eventosVerdes,\n    eventosRojos: eventosRojos,\n    totalEventos: eventosVerdes.length + eventosRojos.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1700,
        -660
      ],
      "id": "e062fcaa-7da7-4c9a-a720-cdad728bf552",
      "name": "getForCode"
    },
    {
      "parameters": {
        "jsCode": "// C√≥digo para obtener el √∫ltimo c√≥digo de propiedad\n// Obtenemos todos los √≠tems de Redis\nconst redisItems =$input.first().json.Codigo_propiedad ;\n\n// Verificamos si existe la propiedad y es un array\nif (!Array.isArray(redisItems)) {\n  console.log(\"Error: No se encontr√≥ un array de c√≥digos de propiedad\");\n  return $input.all();\n}\n\n// Obtenemos el √∫ltimo elemento del array\nconst ultimoCodigo = redisItems[redisItems.length - 1];\nconsole.log(\"√öltimo c√≥digo de propiedad:\", ultimoCodigo);\n\n// A√±adimos el √∫ltimo c√≥digo a todos los √≠tems de entrada\nconst items = $input.all();\nfor (const item of items) {\n  item.json.ultimoCodigo = ultimoCodigo;\n}\n\n// Devolvemos los √≠tems con el nuevo campo\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2580,
        -560
      ],
      "id": "2310ca3c-9fba-4713-80a9-ce66c1e5bad9",
      "name": "Code"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b6f87eba-894b-45bd-a4a1-9e1c8e34aba6",
              "leftValue": "={{ $json.disponible }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1040,
        -660
      ],
      "id": "56ee1482-9d3d-4b7f-94f9-88c935b68166",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// 1. Obtener los datos\nconst datosCalendario = $('Calendario').first().json;\n\n// Obtener datos de la propiedad (Google Sheets)\nconst datosPropiedad = $('Datos de la propiedad').first().json;\n\n// Verificar que existen los datos necesarios en getForCode\nlet eventosVerdes = null;\ntry {\n  // Intentar obtener el primer evento verde\n  const getForCodeResult = $('getForCode').first().json;\n  if (getForCodeResult && getForCodeResult.eventosVerdes && getForCodeResult.eventosVerdes.length > 0) {\n    eventosVerdes = getForCodeResult.eventosVerdes[0];\n  } else {\n    console.log(\"No se encontraron eventos verdes\");\n  }\n} catch (error) {\n  console.log(\"Error al obtener eventos verdes:\", error);\n}\n\n// 2. Extraer variables con valores predeterminados para evitar errores\nconst nombreCliente = datosCalendario?.Nombre || \"\";\nconst telefono = datosCalendario?.numero_cliente || \"\";\nconst nombreInmobiliaria = datosCalendario?.nombre_inmobiliaria || \"\";\nconst tipoPropiedad = datosCalendario?.Tipo || \"\";\n\n// Usar valores predeterminados si eventosVerdes es null o sus propiedades no existen\nconst ubicacion = eventosVerdes?.location || \"Direcci√≥n no especificada\";\nconst idInput = eventosVerdes?.id || \"\";\nconst idEvento = eventosVerdes?.id || \"\";\nconst summary = eventosVerdes?.summary || \"\";\n\n// 3. Obtener tiempo din√°mico desde Google Sheets\n// Convertir el valor de tiempo a minutos\nlet tiempoVisitaMinutos = 30; // Valor por defecto\n\nif (datosPropiedad?.Tiempo) {\n  const tiempoTexto = datosPropiedad.Tiempo.toString().toLowerCase();\n  \n  // Extraer n√∫mero del texto (ej: \"1hs\" -> 1, \"30mins\" -> 30)\n  const numeroMatch = tiempoTexto.match(/\\d+/);\n  \n  if (numeroMatch) {\n    const numero = parseInt(numeroMatch[0]);\n    \n    // Determinar si son horas o minutos\n    if (tiempoTexto.includes('h') || tiempoTexto.includes('hora')) {\n      tiempoVisitaMinutos = numero * 60; // Convertir horas a minutos\n    } else if (tiempoTexto.includes('min')) {\n      tiempoVisitaMinutos = numero;\n    } else {\n      // Si no especifica unidad, asumir que son minutos\n      tiempoVisitaMinutos = numero;\n    }\n  }\n}\n\nconsole.log(`Tiempo de visita configurado: ${tiempoVisitaMinutos} minutos`);\n\n// 4. Tomar la **fecha elegida por el usuario** con verificaci√≥n\nif (!datosCalendario?.fecha_cita) {\n  return [{\n    json: {\n      error: \"No se proporcion√≥ una fecha de cita v√°lida\"\n    }\n  }];\n}\n\nconst fechaCitaOriginal = datosCalendario.fecha_cita; // EJ: 2025-04-08T14:30:00-03:00\n\n// 5. Parseo correcto SIN cambio de zona\nconst [fechaParte, horaParteCompleta] = fechaCitaOriginal.split('T');\nconst [horaParte] = horaParteCompleta.split('-'); // Agarra solo la hora limpia\n\n// Crear la fecha base\nconst [anio, mes, dia] = fechaParte.split('-').map(Number);\nconst [hora, minutos, segundos] = horaParte.split(':').map(Number);\nconst fechaInicio = new Date(anio, mes - 1, dia, hora, minutos, segundos);\n\n// 6. Sumar el tiempo din√°mico de la visita\nconst fechaFin = new Date(fechaInicio.getTime() + tiempoVisitaMinutos * 60000);\n\n// 7. Formatear fecha\nconst formatDate = (date) => {\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const hour = String(date.getHours()).padStart(2, '0');\n  const minute = String(date.getMinutes()).padStart(2, '0');\n  const second = String(date.getSeconds()).padStart(2, '0');\n  \n  return `${year}-${month}-${day}T${hour}:${minute}:${second}.000-03:00`;\n};\n\nconst fechaInicioFormateada = formatDate(fechaInicio);\nconst fechaFinFormateada = formatDate(fechaFin);\n\n// 8. Crear el objeto de salida\nreturn [{\n  json: {\n    idInput,\n    idEvento,\n    colorId: \"10\", // A√±adido expl√≠citamente el colorId 10\n    summary: `Direcci√≥n: ${ubicacion} - Interesado: ${nombreCliente}${nombreInmobiliaria ? ' - ' + nombreInmobiliaria : ''}`,\n    description: ubicacion,\n    tipoPropiedad,\n    nombreCliente,\n    telefono,\n    nombreInmobiliaria,\n    fechaInicio: fechaInicioFormateada,\n    fechaFin: fechaFinFormateada,\n    tiempoVisita: `${tiempoVisitaMinutos} minutos` // Para debugging\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -460,
        -740
      ],
      "id": "0f599010-4717-4fab-8541-1ce9b78e01d5",
      "name": "Calcula fecha"
    },
    {
      "parameters": {
        "fieldToSplitOut": "summary, start, end, location, colorId, id, description",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -1920,
        -660
      ],
      "id": "ca3ccbdf-786c-46a5-985d-b90613b81e5f",
      "name": "Split Out2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "39c2f302-03be-4464-a17a-d7cc481d6d44",
              "name": "=response",
              "value": "=ya existe una fecha",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "033ce52a-e02a-4571-88ee-75530c3adc8c",
      "name": "Success1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -740,
        -500
      ]
    },
    {
      "parameters": {
        "jsCode": "// Obtener TODOS los eventos rojos y la fecha que est√° intentando reservar\nlet eventosRojosData = $input.first().json.eventosRojos;\nconst fechaCitaUsuario = $('Calendario').first().json.fecha_cita;\n\nconsole.log(\"=== VERIFICADOR DE DISPONIBILIDAD ===\");\nconsole.log(\"Fecha solicitada por el usuario:\", fechaCitaUsuario);\nconsole.log(\"Eventos rojos recibidos:\", JSON.stringify(eventosRojosData, null, 2));\n\n// Validar que tenemos datos\nif (!eventosRojosData) {\n    console.log(\"‚ùå No hay eventos rojos para verificar\");\n    return [{\n        json: {\n            disponible: true,\n            mensaje: \"‚úÖ Horario disponible (no hay eventos para verificar).\",\n            debug: { razon: \"eventosRojosData est√° vac√≠o o undefined\" }\n        }\n    }];\n}\n\nif (!fechaCitaUsuario) {\n    console.log(\"‚ùå No se proporcion√≥ fecha de cita\");\n    return [{\n        json: {\n            disponible: false,\n            mensaje: \"üö´ Error: No se proporcion√≥ fecha de cita.\",\n            debug: { razon: \"fechaCitaUsuario est√° vac√≠o o undefined\" }\n        }\n    }];\n}\n\n// Parsear la fecha de la cita del usuario (formato: 2025-05-30T12:00:00-03:00)\nconst fechaCitaDate = new Date(fechaCitaUsuario);\nif (isNaN(fechaCitaDate.getTime())) {\n    console.log(\"‚ùå Fecha de cita inv√°lida:\", fechaCitaUsuario);\n    return [{\n        json: {\n            disponible: false,\n            mensaje: \"üö´ Error: Fecha de cita inv√°lida.\",\n            debug: { razon: \"No se pudo parsear fechaCitaUsuario\", fechaOriginal: fechaCitaUsuario }\n        }\n    }];\n}\n\nconsole.log(\"Fecha de cita original:\", fechaCitaUsuario);\nconsole.log(\"Fecha de cita parseada a UTC:\", fechaCitaDate.toISOString());\nconsole.log(\"Fecha de cita en timestamp:\", fechaCitaDate.getTime());\n\n// Normalizar los eventos a un array\nlet todosLosEventos = [];\nif (Array.isArray(eventosRojosData)) {\n    todosLosEventos = eventosRojosData;\n} else if (eventosRojosData && typeof eventosRojosData === 'object') {\n    todosLosEventos = [eventosRojosData];\n}\n\nconsole.log(`\\nTotal de eventos a analizar: ${todosLosEventos.length}`);\n\n// Variables para el an√°lisis\nlet conflictoEncontrado = false;\nlet eventosAnalizados = 0;\nlet eventosRojosEncontrados = 0;\nlet eventosConConflicto = [];\nlet todosLosDetalles = [];\n\n// Analizar CADA evento\ntodosLosEventos.forEach((evento, index) => {\n    eventosAnalizados++;\n    \n    console.log(`\\n--- EVENTO ${index + 1} ---`);\n    \n    // Guardar detalles del evento para debug\n    const detalleEvento = {\n        index: index + 1,\n        colorId: evento.colorId,\n        tipo: evento.tipo,\n        summary: evento.summary || \"Sin t√≠tulo\",\n        start: evento.start,\n        end: evento.end,\n        esEventoRojo: false,\n        tieneConflictoTiempo: false,\n        razonDescarte: null\n    };\n    \n    // Verificar si es un evento rojo (sin filtrar por color a√∫n)\n    const tipo = evento.tipo;\n    const esRojo = tipo === \"rojo\" || tipo === \"Rojo\" || String(tipo).toLowerCase() === \"rojo\";\n    \n    console.log(`Tipo del evento: \"${tipo}\" -> ¬øEs rojo? ${esRojo}`);\n    \n    if (!esRojo) {\n        detalleEvento.razonDescarte = `Tipo \"${tipo}\" no es \"rojo\"`;\n        console.log(`‚ùå Descartado: ${detalleEvento.razonDescarte}`);\n        todosLosDetalles.push(detalleEvento);\n        return; // Siguiente evento\n    }\n    \n    // Es un evento rojo\n    eventosRojosEncontrados++;\n    detalleEvento.esEventoRojo = true;\n    \n    console.log(\"‚úÖ Es un evento ROJO, verificando horarios...\");\n    console.log(\"Detalles del evento:\", JSON.stringify(evento, null, 2));\n    \n    // Obtener fechas del evento\n    let fechaEventoInicio, fechaEventoFin;\n    \n    // Intentar m√∫ltiples formatos de fecha\n    if (evento.start && evento.start.dateTime) {\n        fechaEventoInicio = new Date(evento.start.dateTime);\n        console.log(\"Fecha inicio desde start.dateTime:\", evento.start.dateTime);\n    } else if (evento.start && typeof evento.start === 'string') {\n        fechaEventoInicio = new Date(evento.start);\n        console.log(\"Fecha inicio desde start (string):\", evento.start);\n    } else if (evento.start && evento.start.date) {\n        fechaEventoInicio = new Date(evento.start.date);\n        console.log(\"Fecha inicio desde start.date:\", evento.start.date);\n    }\n    \n    if (evento.end && evento.end.dateTime) {\n        fechaEventoFin = new Date(evento.end.dateTime);\n        console.log(\"Fecha fin desde end.dateTime:\", evento.end.dateTime);\n    } else if (evento.end && typeof evento.end === 'string') {\n        fechaEventoFin = new Date(evento.end);\n        console.log(\"Fecha fin desde end (string):\", evento.end);\n    } else if (evento.end && evento.end.date) {\n        fechaEventoFin = new Date(evento.end.date);\n        console.log(\"Fecha fin desde end.date:\", evento.end.date);\n    }\n    \n    // Validar que se pudieron obtener las fechas\n    if (!fechaEventoInicio || isNaN(fechaEventoInicio.getTime())) {\n        detalleEvento.razonDescarte = \"No se pudo parsear fecha de inicio\";\n        console.log(`‚ùå ${detalleEvento.razonDescarte}`);\n        todosLosDetalles.push(detalleEvento);\n        return;\n    }\n    \n    if (!fechaEventoFin || isNaN(fechaEventoFin.getTime())) {\n        detalleEvento.razonDescarte = \"No se pudo parsear fecha de fin\";\n        console.log(`‚ùå ${detalleEvento.razonDescarte}`);\n        todosLosDetalles.push(detalleEvento);\n        return;\n    }\n    \n    // Guardar fechas parseadas en el detalle\n    detalleEvento.fechaInicioParsed = fechaEventoInicio.toISOString();\n    detalleEvento.fechaFinParsed = fechaEventoFin.toISOString();\n    \n    console.log(`Evento inicia: ${fechaEventoInicio.toISOString()} (timestamp: ${fechaEventoInicio.getTime()})`);\n    console.log(`Evento termina: ${fechaEventoFin.toISOString()} (timestamp: ${fechaEventoFin.getTime()})`);\n    console.log(`Cita solicitada: ${fechaCitaDate.toISOString()} (timestamp: ${fechaCitaDate.getTime()})`);\n    \n    // Verificar superposici√≥n de tiempo con comparaci√≥n de timestamps para mayor precisi√≥n\n    // La cita conflicta si:\n    // 1. La cita est√° dentro del rango del evento existente\n    // 2. La cita empieza exactamente cuando empieza el evento\n    \n    const timestampCita = fechaCitaDate.getTime();\n    const timestampEventoInicio = fechaEventoInicio.getTime();\n    const timestampEventoFin = fechaEventoFin.getTime();\n    \n    const citaDentroDelEvento = timestampCita >= timestampEventoInicio && timestampCita < timestampEventoFin;\n    const citaEsMismaHoraInicio = timestampCita === timestampEventoInicio;\n    \n    console.log(`¬øCita dentro del evento? ${citaDentroDelEvento} (${timestampCita} >= ${timestampEventoInicio} && ${timestampCita} < ${timestampEventoFin})`);\n    console.log(`¬øCita es misma hora de inicio? ${citaEsMismaHoraInicio} (${timestampCita} === ${timestampEventoInicio})`);\n    \n    const hayConflicto = citaDentroDelEvento || citaEsMismaHoraInicio;\n    detalleEvento.tieneConflictoTiempo = hayConflicto;\n    \n    if (hayConflicto) {\n        console.log(\"üö® ¬°CONFLICTO DETECTADO!\");\n        conflictoEncontrado = true;\n        eventosConConflicto.push({\n            evento: index + 1,\n            summary: evento.summary || \"Sin t√≠tulo\",\n            tipo: evento.tipo,\n            colorId: evento.colorId,\n            inicioEvento: fechaEventoInicio.toISOString(),\n            finEvento: fechaEventoFin.toISOString(),\n            citaSolicitada: fechaCitaDate.toISOString()\n        });\n    } else {\n        console.log(\"‚úÖ No hay conflicto de tiempo\");\n    }\n    \n    todosLosDetalles.push(detalleEvento);\n});\n\n// Resultado final\nconst disponible = !conflictoEncontrado;\n\nconsole.log(\"\\n=== RESUMEN FINAL ===\");\nconsole.log(`Eventos analizados: ${eventosAnalizados}`);\nconsole.log(`Eventos rojos encontrados: ${eventosRojosEncontrados}`);\nconsole.log(`Conflictos detectados: ${eventosConConflicto.length}`);\nconsole.log(`Resultado: ${disponible ? \"DISPONIBLE\" : \"NO DISPONIBLE\"}`);\n\nif (eventosConConflicto.length > 0) {\n    console.log(\"Detalles de conflictos:\");\n    eventosConConflicto.forEach(conflicto => {\n        console.log(`- Evento \"${conflicto.summary}\" del ${conflicto.inicioEvento} al ${conflicto.finEvento}`);\n    });\n}\n\nreturn [{\n    json: {\n        disponible: disponible,\n        mensaje: disponible \n            ? \"‚úÖ Horario disponible, se puede agendar.\"\n            : `üö´ El horario ya est√° ocupado por ${eventosConConflicto.length} evento(s). Eleg√≠ otra fecha.`,\n        debug: {\n            fechaCitaSolicitada: fechaCitaDate.toISOString(),\n            totalEventosAnalizados: eventosAnalizados,\n            eventosRojosEncontrados: eventosRojosEncontrados,\n            conflictosDetectados: eventosConConflicto.length,\n            detallesConflictos: eventosConConflicto,\n            todosLosEventosAnalizados: todosLosDetalles\n        }\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1260,
        -660
      ],
      "id": "daec7129-5083-4ba2-b889-5c6e2f068533",
      "name": "verificador"
    },
    {
      "parameters": {
        "sendTo": "={{ $('Calendario').first().json.correo_electronico }}",
        "subject": "=Visita a la propiedad: {{ $json.direccion }}",
        "message": "=<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>Confirmaci√≥n de Visita Agendada</title>\n<style>\n    /* Estilos generales para el cuerpo del correo */\n    body {\n        margin: 0;\n        padding: 0;\n        font-family: Arial, sans-serif;\n        background-color: #f4f4f4;\n    }\n    /* Contenedor principal */\n    .email-container {\n        max-width: 600px;\n        margin: 20px auto;\n        background-color: #ffffff;\n        border: 1px solid #dddddd;\n        overflow: hidden; /* Para contener bordes redondeados si se a√±aden */\n    }\n    /* Cabecera */\n    .header {\n        background-color: #0056b3; /* Azul corporativo, puedes cambiarlo */\n        color: #ffffff;\n        padding: 20px;\n        text-align: center;\n    }\n    .header h1 {\n        margin: 0;\n        font-size: 24px;\n    }\n    /* Contenido principal */\n    .content {\n        padding: 30px;\n        font-size: 16px;\n        line-height: 1.6;\n        color: #333333;\n    }\n    .content p {\n        margin-bottom: 20px;\n    }\n    /* Tabla de detalles */\n    .details-table {\n        width: 100%;\n        border-collapse: collapse; /* Une los bordes de las celdas */\n        margin-bottom: 20px;\n    }\n    .details-table th, .details-table td {\n        border: 1px solid #dddddd;\n        padding: 12px;\n        text-align: left;\n        font-size: 14px;\n    }\n    .details-table th {\n        background-color: #f8f8f8; /* Fondo claro para las cabeceras */\n        width: 120px; /* Ancho fijo para etiquetas */\n        font-weight: bold;\n        color: #555555;\n    }\n    .details-table td {\n        color: #555555;\n    }\n    /* Informaci√≥n del agente */\n    .agent-info {\n        margin-top: 20px;\n        padding: 15px;\n        background-color: #eef7ff; /* Fondo sutil para destacar */\n        border-left: 4px solid #0056b3; /* L√≠nea decorativa */\n    }\n    .agent-info strong {\n        color: #333333;\n    }\n    /* Pie de p√°gina */\n    .footer {\n        background-color: #f4f4f4;\n        color: #888888;\n        text-align: center;\n        padding: 20px;\n        font-size: 12px;\n    }\n    .footer a {\n        color: #0056b3;\n        text-decoration: none;\n    }\n</style>\n</head>\n<body>\n    <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" bgcolor=\"#f4f4f4\">\n        <tr>\n            <td align=\"center\">\n                <table class=\"email-container\" width=\"600\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"max-width: 600px; margin: 20px auto; background-color: #ffffff; border: 1px solid #dddddd;\">\n                    <tr>\n                        <td class=\"header\" style=\"background-color: #0056b3; color: #ffffff; padding: 20px; text-align: center;\">\n                            <h1 style=\"margin: 0; font-size: 24px; font-family: Arial, sans-serif;\">Confirmaci√≥n de Visita</h1>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td class=\"content\" style=\"padding: 30px; font-size: 16px; line-height: 1.6; color: #333333; font-family: Arial, sans-serif;\">\n                            <p>Hola <strong>{{ $('Calendario').first().json.Nombre }}</strong>,</p>\n                            <p>¬°Buenas noticias! Confirmamos que tu visita a la propiedad ha sido agendada con √©xito. A continuaci√≥n, encontrar√°s todos los detalles:</p>\n\n                            <table class=\"details-table\" width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: collapse; margin-bottom: 20px; width: 100%;\">\n                                <tr>\n                                    <th style=\"border: 1px solid #dddddd; padding: 12px; text-align: left; font-size: 14px; background-color: #f8f8f8; width: 120px; font-weight: bold; color: #555555; font-family: Arial, sans-serif;\">Fecha:</th>\n                                    <td style=\"border: 1px solid #dddddd; padding: 12px; text-align: left; font-size: 14px; color: #555555; font-family: Arial, sans-serif;\">{{ $json.dia_semana }} {{ $json.fecha }}</td>\n                                </tr>\n                                <tr>\n                                    <th style=\"border: 1px solid #dddddd; padding: 12px; text-align: left; font-size: 14px; background-color: #f8f8f8; width: 120px; font-weight: bold; color: #555555; font-family: Arial, sans-serif;\">Hora:</th>\n                                    <td style=\"border: 1px solid #dddddd; padding: 12px; text-align: left; font-size: 14px; color: #555555; font-family: Arial, sans-serif;\">{{ $json.hora }}</td>\n                                </tr>\n                                <tr>\n                                    <th style=\"border: 1px solid #dddddd; padding: 12px; text-align: left; font-size: 14px; background-color: #f8f8f8; width: 120px; font-weight: bold; color: #555555; font-family: Arial, sans-serif; vertical-align: top;\">Direcci√≥n:</th>\n                                    <td style=\"border: 1px solid #dddddd; padding: 12px; text-align: left; font-size: 14px; color: #555555; font-family: Arial, sans-serif;\">\n                                        {{ $json.direccion }}\n                                        </td>\n                                </tr>\n                            </table>\n\n                            <div class=\"agent-info\" style=\"margin-top: 20px; padding: 15px; background-color: #eef7ff; border-left: 4px solid #0056b3;\">\n                                <p style=\"margin-bottom: 10px; font-family: Arial, sans-serif;\"><strong>Tu agente asignado para esta visita es:</strong></p>\n                                <p style=\"margin-bottom: 5px; font-family: Arial, sans-serif;\"><strong style=\"color: #333333;\">Nombre:</strong>Francisco</p>\n                                <p style=\"margin-bottom: 5px; font-family: Arial, sans-serif;\"><strong style=\"color: #333333;\">Tel√©fono:</strong>5491140841598</p>\n                                <p style=\"margin-bottom: 15px; font-family: Arial, sans-serif;\"><strong style=\"color: #333333;\">Email:</strong>francisco@realstateiq.com</p>\n                                <p style=\"margin-bottom: 0; font-family: Arial, sans-serif; font-size: 14px; color: #555555;\">Por favor, no dudes en contactar a Francisco si tienes alguna consulta previa o necesitas realizar alg√∫n cambio.</p>\n                            </div>\n\n                            <p style=\"margin-top: 30px;\">Te recomendamos llegar unos minutos antes de la hora programada. ¬°Esperamos que la propiedad sea de tu agrado!</p>\n                            <p>Saludos cordiales,<br>El equipo de <strong>RealState IQ</strong></p>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td class=\"footer\" style=\"background-color: #f4f4f4; color: #888888; text-align: center; padding: 20px; font-size: 12px; font-family: Arial, sans-serif;\">\n                            <p style=\"margin: 0;\">[Nombre de tu Inmobiliaria] | [Direcci√≥n de la Oficina] | [Tel√©fono General]</p>\n                            <p style=\"margin: 5px 0 0 0;\">\n                                <a href=\"https://donweb.com/es-int/\" style=\"color: #0056b3; text-decoration: none;\">Visita nuestro sitio web</a>\n                                </p>\n                        </td>\n                    </tr>\n                </table>\n            </td>\n        </tr>\n    </table>\n</body>\n</html>",
        "options": {
          "appendAttribution": false
        }
      },
      "id": "8164b6e9-0661-4934-ae03-657b51f316a5",
      "name": "Gmail",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        380,
        -740
      ],
      "webhookId": "f8eebafe-721f-448a-8ae9-4c7d9301d1ba",
      "credentials": {
        "gmailOAuth2": {
          "id": "6zOcYXVP3tGHKFoB",
          "name": "Qeva Solutions"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener la fecha ISO y la direcci√≥n\nconst fechaISO = $('Calendario').first().json.fecha_cita;\nconst direccionCompleta = $('Propietario').first().json.location;\n\n// Obtener datos adicionales\nconst nombreInteresado = $('Calendario').first().json.Nombre || \"No disponible\";\nconst telefonoCliente = $('Calendario').first().json.numero_cliente || \"No disponible\";\nconst nombreInmobiliaria = $('Calendario').first().json.nombre_inmobiliaria || \"No especificada\";\n\n// Funci√≥n para extraer todos los componentes de la fecha\nfunction extraerComponentesFecha(fechaISO) {\n  // Si no hay fecha, devolver valores predeterminados\n  if (!fechaISO) return {\n    dia: \"No disponible\",\n    fecha: \"No disponible\",\n    hora: \"No disponible\"\n  };\n  \n  try {\n    // Crear un objeto Date a partir de la fecha ISO\n    const fecha = new Date(fechaISO);\n    \n    // Extraer d√≠a de la semana\n    const diasSemana = [\"Domingo\", \"Lunes\", \"Martes\", \"Mi√©rcoles\", \"Jueves\", \"Viernes\", \"S√°bado\"];\n    const diaSemana = diasSemana[fecha.getDay()];\n    \n    // Extraer componentes de fecha\n    const dia = fecha.getDate().toString().padStart(2, '0');\n    const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');\n    const anio = fecha.getFullYear();\n    \n    // Extraer componentes de hora\n    const horas = fecha.getHours();\n    const minutos = fecha.getMinutes().toString().padStart(2, '0');\n    \n    // Formatear cada componente\n    return {\n      dia: diaSemana,\n      fecha: `${dia}-${mes}-${anio}`,\n      hora: `${horas}:${minutos}hs`\n    };\n  } catch (error) {\n    console.error(\"Error al extraer componentes de la fecha:\", error);\n    return {\n      dia: \"Error\",\n      fecha: \"Error\",\n      hora: \"Error\"\n    };\n  }\n}\n\n// Extraer componentes de la fecha\nconst componentes = extraerComponentesFecha(fechaISO);\n\n// Procesar direcci√≥n\nfunction procesarDireccion(direccionCompleta) {\n  if (!direccionCompleta) return \"Direcci√≥n no disponible\";\n  \n  // Aqu√≠ puedes agregar l√≥gica adicional para formatear la direcci√≥n si es necesario\n  return direccionCompleta;\n}\n\n// Obtener la direcci√≥n formateada\nconst direccion = procesarDireccion(direccionCompleta);\n\n// Formatear tel√©fono (si es necesario)\nfunction formatearTelefono(telefono) {\n  if (!telefono) return \"No disponible\";\n  \n  // Aqu√≠ puedes agregar l√≥gica para formatear el tel√©fono si es necesario\n  return telefono;\n}\n\n// Tel√©fono formateado\nconst telefono = formatearTelefono(telefonoCliente);\n\n// Mostrar los resultados\nconsole.log(\"D√≠a de la semana:\", componentes.dia);\nconsole.log(\"Fecha:\", componentes.fecha);\nconsole.log(\"Hora:\", componentes.hora);\nconsole.log(\"Direcci√≥n:\", direccion);\nconsole.log(\"Interesado:\", nombreInteresado);\nconsole.log(\"Tel√©fono:\", telefono);\nconsole.log(\"Inmobiliaria:\", nombreInmobiliaria);\n\n// Para usar directamente en tu flujo\nreturn [{\n  json: {\n    dia_semana: componentes.dia,\n    fecha: componentes.fecha,\n    hora: componentes.hora,\n    direccion: direccion,\n    interesado: nombreInteresado,\n    telefono: telefono,\n    inmobiliaria: nombreInmobiliaria\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        200,
        -740
      ],
      "id": "b201e50f-ebc5-4cc3-9416-fc4980ddbb59",
      "name": "Limpia fecha"
    },
    {
      "parameters": {
        "fieldToSplitOut": "eventosVerdes, eventosRojos",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -1480,
        -660
      ],
      "id": "d5f03c51-a01e-48a5-ad68-30d679124d68",
      "name": "Split Out",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3e1ac94e-2430-4b1c-b8c1-72a2c637d09f",
              "name": "response",
              "value": "=true",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3020,
        -1220
      ],
      "id": "226b2d88-fb2e-4c47-b9ae-964e0ef976da",
      "name": "response true"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "create",
        "projectId": "p311nqyjsnx0fqq",
        "table": "mdyqlno73gz7aly",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Nombre",
              "fieldValue": "={{ $('Calendario').first().json.Nombre }}"
            },
            {
              "fieldName": "Telefono",
              "fieldValue": "={{ $('Calendario').first().json.numero_cliente }}"
            },
            {
              "fieldName": "Fecha_cita",
              "fieldValue": "={{ $('Code1').item.json.fecha_cita }}"
            },
            {
              "fieldName": "Propiedad",
              "fieldValue": "={{ $('Limpia fecha').item.json.direccion }}"
            },
            {
              "fieldName": "Estado",
              "fieldValue": "ocupado"
            },
            {
              "fieldName": "recordatorio_24h_enviado",
              "fieldValue": "={{ $('Code1').item.json.recordatorio_24h }}"
            },
            {
              "fieldName": "recordatorio_1h_enviado",
              "fieldValue": "={{ $('Code1').item.json.recordatorio_1h }}"
            },
            {
              "fieldName": "recordatorio_1h",
              "fieldValue": "no enviado"
            },
            {
              "fieldName": "recordatorio_24h",
              "fieldValue": "no enviado"
            },
            {
              "fieldName": "id_mensaje",
              "fieldValue": "={{ $node['Calendario'].json.idMensaje }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        1260,
        -640
      ],
      "id": "f6f33091-87a1-478b-8690-c0b8297bb445",
      "name": "Recordatorio de cita",
      "credentials": {
        "nocoDbApiToken": {
          "id": "CawnXo6TfhLoivTw",
          "name": "NocoDB Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Este c√≥digo toma una fecha de cita y calcula cu√°ndo deben enviarse los recordatorios\n// Obtener la fecha de cita del input\nconst fechaCita = $('Calendario').first().json.fecha_cita;\nconsole.log(`Fecha de cita original: ${fechaCita}`);\n\n// Crear objetos Date para poder manipular las fechas\nconst citaDate = new Date(fechaCita);\n\n// Calcular momento para recordatorio de 24 horas (1 d√≠a antes, misma hora)\nconst recordatorio24hDate = new Date(citaDate);\nrecordatorio24hDate.setDate(recordatorio24hDate.getDate() - 1);\n\n// Calcular momento para recordatorio de 1 hora (misma fecha, 1 hora antes)\nconst recordatorio1hDate = new Date(citaDate);\nrecordatorio1hDate.setHours(recordatorio1hDate.getHours() - 1);\n\n// Funci√≥n para formatear fechas en formato YYYY-MM-DDTHH:MM\nfunction formatearFechaSimplificada(fecha) {\n  // Obtener componentes de la fecha\n  const year = fecha.getFullYear();\n  const month = String(fecha.getMonth() + 1).padStart(2, '0');\n  const day = String(fecha.getDate()).padStart(2, '0');\n  const hours = String(fecha.getHours()).padStart(2, '0');\n  const minutes = String(fecha.getMinutes()).padStart(2, '0');\n  \n  // Construir el string con formato YYYY-MM-DDTHH:MM\n  return `${year}-${month}-${day}T${hours}:${minutes}`;\n}\n\n// Formatear las fechas al formato simplificado\nconst fechaCitaFormateada = formatearFechaSimplificada(citaDate);\nconst recordatorio24h = formatearFechaSimplificada(recordatorio24hDate);\nconst recordatorio1h = formatearFechaSimplificada(recordatorio1hDate);\n\n// Log para verificar los c√°lculos\nconsole.log(`Fecha de cita: ${fechaCitaFormateada}`);\nconsole.log(`Momento para recordatorio 24h: ${recordatorio24h}`);\nconsole.log(`Momento para recordatorio 1h: ${recordatorio1h}`);\n\n// Retornar los resultados\nreturn {\n  json: {\n    fecha_cita: fechaCitaFormateada,\n    recordatorio_24h: recordatorio24h,\n    recordatorio_1h: recordatorio1h\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        -740
      ],
      "id": "e048dd66-1dcf-4873-a001-b66b9874ba84",
      "name": "Code1"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p311nqyjsnx0fqq",
        "table": "mdyqlno73gz7aly",
        "returnAll": true,
        "options": {
          "where": "=(Fecha_cita,eq,{{ $json.fecha_cita }})"
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        820,
        -740
      ],
      "id": "5698e204-9e5a-4232-abc6-358a84faee67",
      "name": "NocoDB",
      "alwaysOutputData": true,
      "credentials": {
        "nocoDbApiToken": {
          "id": "CawnXo6TfhLoivTw",
          "name": "NocoDB Token account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "04ba47e5-a15b-4db9-a9f7-fdad3dc6013d",
              "leftValue": "={{ $json.Id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1040,
        -740
      ],
      "id": "e481df27-f88c-408a-99a5-47f1d177e2c5",
      "name": "If2"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "projectId": "p311nqyjsnx0fqq",
        "table": "mdyqlno73gz7aly",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "recordatorio_24h_enviado",
              "fieldValue": "={{ $('Code1').item.json.recordatorio_24h }}"
            },
            {
              "fieldName": "recordatorio_1h_enviado",
              "fieldValue": "={{ $('Code1').item.json.recordatorio_1h }}"
            },
            {
              "fieldName": "Fecha_cita",
              "fieldValue": "={{ $('Code1').item.json.fecha_cita }}"
            },
            {
              "fieldName": "Id",
              "fieldValue": "={{ $('NocoDB').item.json.Id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        1260,
        -840
      ],
      "id": "6b86ab52-f008-4852-a490-37a7f0c32ecd",
      "name": "NocoDB1",
      "credentials": {
        "nocoDbApiToken": {
          "id": "CawnXo6TfhLoivTw",
          "name": "NocoDB Token account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1vxULMw6IdEF03hfs2a-svqJUTEuSWbW5wVUQkk88eU4",
          "mode": "list",
          "cachedResultName": "Cliente:00_urls_francisco",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vxULMw6IdEF03hfs2a-svqJUTEuSWbW5wVUQkk88eU4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1vxULMw6IdEF03hfs2a-svqJUTEuSWbW5wVUQkk88eU4/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "CODIGO",
              "lookupValue": "={{ $('Code').first().json.ultimoCodigo }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -740,
        -740
      ],
      "id": "e30607f9-993d-4c67-9650-38b8ea951534",
      "name": "Datos de la propiedad",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "lRj57XPEqOXW9kOd",
          "name": "Qeva Solutions Sheet"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "004dfd8dfad8cab59884aa5afbe99b4943ba96c971d4eb480405c7595b8160b1@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Francisco"
        },
        "start": "={{ $json.fechaInicio }}",
        "end": "={{ $json.fechaFin }}",
        "useDefaultReminders": false,
        "additionalFields": {
          "attendees": [
            "={{ $('Datos de la propiedad').item.json.Mail }}"
          ],
          "color": "1",
          "description": "=",
          "location": "={{ $json.description }}",
          "showMeAs": "opaque",
          "summary": "=Agente inmobiliario: {{ $('Datos de la propiedad').item.json[\"Agente inmobiliario\"] }}\nInmobiliaria: {{ $('Datos de la propiedad').item.json[\"Nombre inmobiliaria\"] }}\n"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -220,
        -740
      ],
      "id": "a45d84e9-941a-47f7-8459-666b71d21ecb",
      "name": "Propietario",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "248CSUaxOr8MEWUN",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "004dfd8dfad8cab59884aa5afbe99b4943ba96c971d4eb480405c7595b8160b1@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Francisco"
        },
        "start": "={{ $json.fechaInicio }}",
        "end": "={{ $json.fechaFin }}",
        "useDefaultReminders": false,
        "additionalFields": {
          "attendees": [
            "={{ $('Calendario').first().json.correo_electronico }}"
          ],
          "color": "11",
          "description": "=",
          "location": "={{ $json.description }}",
          "showMeAs": "opaque",
          "summary": "=Interesado:{{ $json.nombreCliente }}\nTel√©fono:{{ $('Calendario').first().json.numero_cliente }}\nC√≥digo:{{ $('getForCode').item.json.codigo }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -220,
        -900
      ],
      "id": "c89b803d-d206-4fef-a638-b39ee576ee59",
      "name": "Agente inmobiliario",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "248CSUaxOr8MEWUN",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "004dfd8dfad8cab59884aa5afbe99b4943ba96c971d4eb480405c7595b8160b1@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Francisco"
        },
        "start": "={{ $json.fechaInicio }}",
        "end": "={{ $json.fechaFin }}",
        "useDefaultReminders": false,
        "additionalFields": {
          "attendees": [
            "={{ $('Calendario').first().json.correo_electronico }}"
          ],
          "color": "11",
          "description": "=Telefono: https://wa.me/{{ $json.telefono }}\nCodigo propiedad: {{ $('getForCode').first().json.codigo }}",
          "location": "={{ $json.description }}",
          "showMeAs": "opaque",
          "summary": "=Direccion: {{ $json.description }} - Interesado: {{ $json.nombreCliente }} - {{ $json.nombreInmobiliaria }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -220,
        -560
      ],
      "id": "c4691b9b-71ca-49a2-a8f2-7c0e9125fa7e",
      "name": "Cliente",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "248CSUaxOr8MEWUN",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        20,
        -740
      ],
      "id": "a15e6e3a-2e7e-41b6-b7ad-8a8aa3542468",
      "name": "Merge"
    }
  ],
  "pinData": {
    "Calendario": [
      {
        "json": {
          "numero_cliente": "5492254423359",
          "fecha_cita": "2025-05-30T12:00:00",
          "Nombre": "Juan pelotas",
          "Evento": "agendar",
          "correo_electronico": "casserafernando@gmail.com",
          "nombre_inmobiliaria": "Dinamismo",
          "session_id": null,
          "idMensaje": "E8B6061CFC26B8EA4D72366ADA91A780"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Argentina/Buenos_Aires",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "2kOn0Oz7c2uvczPK"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-03-23T17:49:20.946Z",
      "updatedAt": "2025-03-23T17:49:20.946Z",
      "id": "UdWAGpsQzroykED6",
      "name": "AGENTES INMO"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-05-27T22:18:11.769Z",
  "versionId": "b874bbc7-6c5f-4933-aaa8-b9729e1519cf"
}