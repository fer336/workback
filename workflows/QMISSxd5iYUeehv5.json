{
  "active": false,
  "connections": {
    "Code": {
      "main": [
        []
      ]
    },
    "datos": {
      "main": [
        [
          {
            "node": "var",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "var": {
      "main": [
        [
          {
            "node": "Buttons ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        []
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "button",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buttons ": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-28T03:56:03.903Z",
  "id": "QMISSxd5iYUeehv5",
  "isArchived": false,
  "meta": null,
  "name": "AGENTE CITAS - Button confirm",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// OBTENER DATOS DEL INPUT\nconst editFields = $('var').item.json;\n\n// EXTRAER DATOS DEL TURNO\nconst paciente = editFields.nombre || \"Paciente\";\nconst email = editFields.correo || \"email@ejemplo.com\";\nconst fecha = editFields.fecha || \"Fecha a confirmar\";\nconst hora = editFields.hora || \"Hora a confirmar\";\nconst motivo = editFields.motivo || \"Consulta\";\nconst telefono = editFields.telefono || \"5492254423359\";\n\n// CONFIGURACIÓN DEL MENSAJE\nconst phoneNumber = telefono;\nconst tipoAccion = \"confirmar\"; // Puede ser: confirmar, recordatorio, cancelado, reprogramar, nuevo\n\n// CONFIGURAR MENSAJE SEGÚN TIPO\nlet msgConfig = {};\n\nif (tipoAccion === \"confirmar\") {\n  msgConfig = {\n    header: \"📅 RESUMEN DE TU TURNO 📅\",\n    body: \"👤 Paciente: \" + paciente + \"\\n📧 Email: \" + email + \"\\n📆 Fecha: \" + fecha + \"\\n🕐 Hora: \" + hora + \"\\n🏥 Motivo: \" + motivo ,\n    footer: \"¿Confirmás tu turno?\",\n    buttons: [\n      { type: \"quick_reply\", title: \"✅ Confirmar\", id: \"confirmar_turno\" }\n    ]\n  };\n} else if (tipoAccion === \"recordatorio\") {\n  msgConfig = {\n    header: \"🔔 RECORDATORIO DE TURNO\",\n    body: \"Hola \" + paciente + \"!\\n\\n⏰ Te recordamos que tenés turno:\\n📆 \" + fecha + \"\\n🕐 \" + hora + \"\\n🏥 Motivo: \" + motivo + \"\\n\\n📍 Dirección: [Dirección del consultorio]\\n💡 Recordá traer DNI y estudios previos si los tenés\",\n    footer: \"¿Necesitás algo más?\",\n    buttons: [\n      { type: \"quick_reply\", title: \"✅ Asistiré\", id: \"confirmar_asistencia\" },\n      { type: \"quick_reply\", title: \"❌ No podré ir\", id: \"cancelar_ultimo_momento\" },\n      { type: \"quick_reply\", title: \"📍 Ver ubicación\", id: \"ver_ubicacion\" }\n    ]\n  };\n} else if (tipoAccion === \"cancelado\") {\n  msgConfig = {\n    header: \"❌ TURNO CANCELADO\",\n    body: \"Hola \" + paciente + \",\\n\\nTu turno del \" + fecha + \" a las \" + hora + \" ha sido cancelado.\\n\\n📞 Si querés reprogramar, podés:\\n• Responder este mensaje\\n• Llamarnos al [teléfono]\\n• Agendar online en [web]\",\n    footer: \"¿Querés agendar un nuevo turno?\",\n    buttons: [\n      { type: \"quick_reply\", title: \"📅 Nuevo turno\", id: \"agendar_nuevo\" },\n      { type: \"quick_reply\", title: \"📞 Llamar\", id: \"llamar_consultorio\" },\n      { type: \"quick_reply\", title: \"💬 Consultar\", id: \"hacer_consulta\" }\n    ]\n  };\n} else if (tipoAccion === \"reprogramar\") {\n  msgConfig = {\n    header: \"🔄 REPROGRAMACIÓN DE TURNO\",\n    body: \"Hola \" + paciente + \"!\\n\\nTu turno original:\\n📆 \" + fecha + \" - \" + hora + \"\\n\\nHa sido reprogramado para:\\n📆 [Nueva fecha] - [Nueva hora]\\n🏥 Motivo: \" + motivo,\n    footer: \"¿Te viene bien el nuevo horario?\",\n    buttons: [\n      { type: \"quick_reply\", title: \"✅ Perfecto\", id: \"confirmar_reprogramacion\" },\n      { type: \"quick_reply\", title: \"❌ No puedo\", id: \"rechazar_reprogramacion\" },\n      { type: \"quick_reply\", title: \"📅 Ver otros\", id: \"ver_otros_horarios\" }\n    ]\n  };\n} else if (tipoAccion === \"nuevo\") {\n  msgConfig = {\n    header: \"✅ TURNO AGENDADO\",\n    body: \"¡Hola \" + paciente + \"!\\n\\n✅ Tu turno fue agendado exitosamente:\\n\\n📆 Fecha: \" + fecha + \"\\n🕐 Hora: \" + hora + \"\\n🏥 Motivo: \" + motivo + \"\\n📧 Confirmación enviada a: \" + email + \"\\n\\n⏰ Te enviaremos un recordatorio 24hs antes\",\n    footer: \"¿Necesitás algo más?\",\n    buttons: [\n      { type: \"quick_reply\", title: \"📋 Ver detalles\", id: \"ver_detalles\" },\n      { type: \"quick_reply\", title: \"📅 Agendar otro\", id: \"agendar_otro\" },\n      { type: \"quick_reply\", title: \"✅ Listo\", id: \"finalizar\" }\n    ]\n  };\n} else {\n  // Mensaje genérico de bienvenida\n  msgConfig = {\n    header: \"👋 BIENVENIDO/A\",\n    body: \"Hola! Soy el asistente virtual del consultorio.\\n\\n¿En qué puedo ayudarte hoy?\",\n    footer: \"Seleccioná una opción:\",\n    buttons: [\n      { type: \"quick_reply\", title: \"📅 Agendar turno\", id: \"agendar_turno\" },\n      { type: \"quick_reply\", title: \"🔍 Consultar turno\", id: \"consultar_turno\" },\n      { type: \"quick_reply\", title: \"💬 Hacer consulta\", id: \"hacer_consulta\" }\n    ]\n  };\n}\n\n// CONSTRUIR PAYLOAD EN FORMATO WHAPI\nconst whapiPayload = {\n  to: phoneNumber,\n  type: \"button\",\n  header: {\n    text: msgConfig.header\n  },\n  body: {\n    text: msgConfig.body\n  },\n  footer: {\n    text: msgConfig.footer\n  },\n  action: {\n    buttons: msgConfig.buttons\n  }\n};\n\n// CONFIGURACIÓN DE LA PETICIÓN HTTP\nconst httpRequest = {\n  method: 'POST',\n  url: 'https://gate.whapi.cloud/messages/interactive',\n  headers: {\n    'accept': 'application/json',\n    'authorization': 'Bearer B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410',\n    'content-type': 'application/json'\n  },\n  body: JSON.stringify(whapiPayload)\n};\n\n// RETORNAR PARA N8N\nreturn [{\n  json: {\n    payload: whapiPayload,\n    httpRequest: httpRequest\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        192
      ],
      "id": "7670f97c-d482-4c84-8457-18a138089bca",
      "name": "Code"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "nombre"
            },
            {
              "name": "fecha"
            },
            {
              "name": "hora"
            },
            {
              "name": "servicio"
            },
            {
              "name": "telefono"
            }
          ]
        }
      },
      "id": "dc9f40ba-2f3a-4b19-903c-f57d3548e0cc",
      "typeVersion": 1.1,
      "name": "datos",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        0,
        -48
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://gate.whapi.cloud/messages/interactive",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "header",
              "value": "={{ $json.payload.header }}"
            },
            {
              "name": "body",
              "value": "={{ $json.payload.body }}"
            },
            {
              "name": "footer",
              "value": "={{ $json.payload.footer }}"
            },
            {
              "name": "action",
              "value": "={{ $json.payload.action }}"
            },
            {
              "name": "type",
              "value": "={{ $json.payload.type }}"
            },
            {
              "name": "to",
              "value": "={{ $json.payload.to }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1024,
        176
      ],
      "id": "4bea10f7-541e-4ccb-9bd9-a91b4dbe627a",
      "name": "HTTP Request",
      "credentials": {
        "httpHeaderAuth": {
          "id": "ekaTMbiKps3wYx80",
          "name": "Whapi - Agente inmobiliario"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8fd5e7a2-2acb-41ea-b8e5-4089765dfea7",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "d77f58ff-fc3b-4646-82aa-19b37f7a6632",
              "name": "fecha",
              "value": "={{ $json.fecha }}",
              "type": "string"
            },
            {
              "id": "7fb26fb1-e320-4a5c-bd4c-5c462ed12b24",
              "name": "hora",
              "value": "={{ $json.hora }}",
              "type": "string"
            },
            {
              "id": "13ed22d1-01fd-4d41-bba4-9af5f34cddbc",
              "name": "servicio",
              "value": "={{ $json.servicio }}",
              "type": "string"
            },
            {
              "id": "69f2dc55-9626-4f0f-9521-b2de136cb450",
              "name": "telefono",
              "value": "={{ $json.telefono }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        -48
      ],
      "id": "59a66595-192d-4f24-9c0e-6994f4cb63ed",
      "name": "var"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/button_reply",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.to }}"
            },
            {
              "name": "header",
              "value": "={{ $json.header }}"
            },
            {
              "name": "text",
              "value": "={{ $json.text }}"
            },
            {
              "name": "footer",
              "value": "={{ $json.footer }}"
            },
            {
              "name": "buttons",
              "value": "={{ $json.buttons }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        720,
        -48
      ],
      "id": "2d62e346-a47b-4d2e-8019-af9b96fc3959",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "046a9531-d8f0-430f-addc-ffb6a6e82c0b",
              "name": "response",
              "value": "`button_confirm`",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        976,
        -48
      ],
      "id": "d54faa56-5d11-4667-a708-1e7cdc74fd08",
      "name": "button"
    },
    {
      "parameters": {
        "jsCode": "// OBTENER DATOS DEL INPUT\nconst editFields = $('var').item.json;\n\n// EXTRAER DATOS DEL TURNO\nconst paciente = editFields.nombre;\nconst fecha = editFields.fecha;\nconst hora = editFields.hora;\nconst motivo = editFields.servicio;\nconst telefono = editFields.telefono;\n\n// CONFIGURACIÓN DEL MENSAJE DE CONFIRMACIÓN\nconst phoneNumber = telefono;\n\nconst msgConfig = {\n  title: \"📅 Consultorio Médico - Confirmar Turno\",\n  text: \"🎯 *Resumen de tu turno*\\n👤 Paciente: \" + paciente + \"\\n📆 Fecha: \" + fecha + \"\\n🕐 Hora: \" + hora + \"\\n🏥 Motivo: \" + motivo + \"\\n📍 Recordá traer DNI y estudios previos\",\n  footer: \"¿Confirmás tu turno?\",\n  btns: [\n    { type: \"quick_reply\", id: \"confirmar_turno\", text: \"✅ Confirmar\" }\n  ]\n};\n\n// CONSTRUIR PAYLOAD FINAL\nconst result = {\n  to: phoneNumber,\n  header: {\n    title: msgConfig.title,\n    hasMediaAttachment: false\n  },\n  text: msgConfig.text,\n  footer: msgConfig.footer,\n  buttons: msgConfig.btns\n};\n\n// RETORNAR RESULTADO\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        480,
        -48
      ],
      "id": "b665d3ed-9504-49a6-8e9e-880a5e49762a",
      "name": "Buttons "
    }
  ],
  "pinData": {
    "datos": [
      {
        "json": {
          "nombre": "cliente",
          "fecha": "2025-07-29",
          "hora": "09:00",
          "servicio": "Blanqueamiento",
          "telefono": "5492254596618"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-07-25T06:49:44.669Z",
  "versionId": "e68e5cd7-52fb-4554-891e-aa767adecfb1"
}