{
  "active": true,
  "connections": {
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "escribiendo...",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Separa datos": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type": {
      "main": [
        [
          {
            "node": "Encolado de msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Encolado de msg",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Encolado de msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "chatInput",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Turno confirmado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DELETE TURNO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Elimina la cita - Reagendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Encolado de msg": {
      "main": [
        [
          {
            "node": "Sort",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "chatInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "chatInput": {
      "main": [
        [
          {
            "node": "Juli",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Variables globales": {
      "main": [
        [
          {
            "node": "Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "Separa datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "CreateCITA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreateCITA": {
      "main": [
        [
          {
            "node": "Turno creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Juli": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Turno creado": {
      "main": [
        []
      ]
    },
    "escribiendo...": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tool_agendar": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "tool_cancelar": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "get_paciente": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "gemini2": {
      "ai_languageModel": [
        [
          {
            "node": "Juli",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "memory1": {
      "ai_memory": [
        [
          {
            "node": "Juli",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Chat Memory Manager",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Elimina la cita - Reagendar": {
      "main": [
        [
          {
            "node": "Cancelar turno1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar turno": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar turno1": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tool_think": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Cancelar turno",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar turno2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar turno2": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tool_reagendar": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "get_fechas": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Turno confirmado": {
      "main": [
        [
          {
            "node": "Confirmacion de turno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmacion de turno": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Turno eliminado": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DELETE TURNO": {
      "main": [
        [
          {
            "node": "Turno eliminado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Es Grupo?": {
      "main": [
        [],
        [
          {
            "node": "From Me?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "From Me?": {
      "main": [
        [
          {
            "node": "ultimoMsg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Estado Usuario": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Activar Usuario (24h)": {
      "main": [
        [
          {
            "node": "Contador Mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contador Mensajes": {
      "main": [
        [
          {
            "node": "Confirmacion de turno2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usuario Activo?": {
      "main": [
        [
          {
            "node": "Obtener Contador Mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Contador Mensajes": {
      "main": [
        [
          {
            "node": "L√≠mite Alcanzado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L√≠mite Alcanzado?": {
      "main": [
        [
          {
            "node": "Enviar L√≠mite Alcanzado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validar Cliente y Continuar Bot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Cliente y Continuar Bot": {
      "main": [
        [
          {
            "node": "Variables globales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "V1": {
      "main": [
        [
          {
            "node": "Es Grupo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "V1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Es Primera Vez y #inicio?": {
      "main": [
        [
          {
            "node": "Activar Usuario (24h)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "inicio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Es Primera Vez y #inicio?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Usuario Activo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_turnos_agendados": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "get_turnos_disponibles": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Redis Trigger": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [],
        []
      ]
    },
    "ultimoMsg": {
      "main": [
        [
          {
            "node": "Obtener Estado Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Chat Memory Manager1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Memory Manager1": {
      "main": [
        [
          {
            "node": "limpiamos msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "limpiamos msg": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [],
        [
          {
            "node": "escribiendo...1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out1": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Separa datos1": {
      "main": [
        [
          {
            "node": "Split Out1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "escribiendo...1": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [],
        [
          {
            "node": "Separa datos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "memory2": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "memory": {
      "ai_memory": [
        [
          {
            "node": "Chat Memory Manager1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-13T13:37:22.933Z",
  "id": "yXXT6AF8oCDe0vcE",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "AGENTE CITAS - MASTER estable instancia QEVA",
  "nodes": [
    {
      "parameters": {
        "batchSize": "=1",
        "options": {
          "reset": false
        }
      },
      "id": "fef6a29f-d537-4886-8230-6ff912bc4d03",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        5952,
        1072
      ],
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "fieldToSplitOut": "messages",
        "options": {}
      },
      "id": "049c6bed-bfc5-4ec4-8cb1-d41ad4693a90",
      "name": "Split Out",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        5440,
        1120
      ]
    },
    {
      "parameters": {
        "jsCode": "// --- Funciones de procesamiento de texto ---\n\n// Funci√≥n para dividir texto en fragmentos con tiempo de lectura\nfunction splitTextIntoChunks(text, maxChars = 200) {\n  // Si el texto es muy corto, devolvemos un solo fragmento\n  if (!text || text.length <= maxChars) {\n    return [{\n      parte: 1,\n      texto: text || '',\n      time: calculateReadingTime(text || '')\n    }];\n  }\n\n  const chunks = [];\n  let currentChunk = '';\n  let partNumber = 1;\n  \n  // Dividimos por palabras para no cortar palabras a la mitad\n  const words = text.split(' ');\n  \n  for (let i = 0; i < words.length; i++) {\n    const word = words[i];\n    const potentialChunk = currentChunk ? currentChunk + ' ' + word : word;\n    \n    // Si agregar la siguiente palabra excede el l√≠mite\n    if (potentialChunk.length > maxChars) {\n      // Si la palabra sola es m√°s larga que maxChars, la cortamos\n      if (word.length > maxChars) {\n        // Guardamos el chunk actual si tiene contenido\n        if (currentChunk) {\n          chunks.push({\n            parte: partNumber++,\n            texto: currentChunk.trim(),\n            time: calculateReadingTime(currentChunk.trim())\n          });\n        }\n        \n        // Cortamos la palabra larga en pedazos\n        let remainingWord = word;\n        while (remainingWord.length > maxChars) {\n          chunks.push({\n            parte: partNumber++,\n            texto: remainingWord.substring(0, maxChars),\n            time: calculateReadingTime(remainingWord.substring(0, maxChars))\n          });\n          remainingWord = remainingWord.substring(maxChars);\n        }\n        \n        // El resto de la palabra se convierte en el nuevo currentChunk\n        currentChunk = remainingWord;\n      } else {\n        // Guardamos el chunk actual y empezamos uno nuevo con esta palabra\n        chunks.push({\n          parte: partNumber++,\n          texto: currentChunk.trim(),\n          time: calculateReadingTime(currentChunk.trim())\n        });\n        currentChunk = word;\n      }\n    } else {\n      // Si cabe, agregamos la palabra al chunk actual\n      currentChunk = potentialChunk;\n    }\n  }\n  \n  // Agregar el √∫ltimo chunk si queda algo\n  if (currentChunk.trim()) {\n    chunks.push({\n      parte: partNumber,\n      texto: currentChunk.trim(),\n      time: calculateReadingTime(currentChunk.trim())\n    });\n  }\n  \n  return chunks;\n}\n\n// Funci√≥n para calcular el tiempo de lectura basado en la longitud del texto\nfunction calculateReadingTime(text) {\n  const length = text.length;\n  \n  if (length > 150) {\n    return 4; // segundos\n  } else if (length >= 50) {\n    return 3; // segundos\n  } else {\n    return 1; // segundo\n  }\n}\n\n// Funci√≥n para determinar si un texto necesita ser dividido\nfunction needsSplitting(text) {\n  if (!text || typeof text !== 'string') return false;\n  \n  // Criterios: m√°s de 500 caracteres o m√°s de 100 palabras\n  const charCount = text.length;\n  const wordCount = text.split(/\\s+/).filter(word => word.length > 0).length;\n  \n  return charCount > 500 || wordCount > 100;\n}\n\n// Funci√≥n para procesar el texto y dividirlo inteligentemente (funci√≥n original mejorada)\nfunction processAndSplitText(textInput) {\n  // Aseg√∫rate de que textInput sea un string o pueda ser convertido\n  let text = textInput;\n\n  // Si la entrada no es un string\n  if (typeof text !== 'string') {\n    // Si es null o undefined, simplemente devolvemos un array vac√≠o\n    if (text === null || text === undefined) {\n      return [];\n    }\n\n    // Si es un objeto, intentamos encontrar campos comunes que contengan texto\n    if (typeof text === 'object') {\n      if (text.text) {\n        text = text.text;\n      } else if (text.message) {\n        text = text.message;\n      } else if (text.type === 'text' && text.text) {\n        text = text.text;\n      } else if (text.output) {\n        // Si output es un string, lo usamos\n        if (typeof text.output === 'string') {\n          text = text.output;\n        } else {\n          // Si output es un objeto o array, intentamos extraer de ah√≠\n          const extracted = extractTextContent(text.output);\n          if (extracted) {\n            text = extracted;\n          } else {\n            // Si no pudimos extraer, intentamos convertir todo el objeto a string\n            try {\n              text = JSON.stringify(text);\n            } catch (e) {\n              console.error(\"No se pudo serializar el objeto a string:\", e);\n              return [];\n            }\n          }\n        }\n      } else {\n        // Si no encontramos campos de texto comunes ni 'output', intentamos convertir a string\n        try {\n          text = JSON.stringify(text);\n        } catch (e) {\n          console.error(\"No se pudo serializar el objeto a string:\", e);\n          return [];\n        }\n      }\n    } else {\n      // Si no es string, objeto, null o undefined, devolvemos vac√≠o\n      console.warn(\"Entrada a processAndSplitText no es string, objeto, null o undefined:\", typeof text);\n      return [];\n    }\n  }\n\n  // Si despu√©s de los intentos no tenemos un string v√°lido, devolvemos vac√≠o\n  if (typeof text !== 'string' || text.trim() === '') {\n    return [];\n  }\n\n  // Ahora que tenemos un string, procesamos el formato\n  const processedText = text\n    .replace(/\\*\\*(.+?)\\*\\*/g, '*$1*') // **texto** -> *texto*\n    .replace(/###\\s*/g, '')         // Elimina encabezados ###\n    .replace(/[¬°¬ø!]/g, '');         // Elimina signos de exclamaci√≥n e interrogaci√≥n iniciales y finales\n\n  // Divide en l√≠neas para an√°lisis\n  const lines = processedText.split('\\n');\n\n  // Grupos para almacenar los mensajes\n  const messages = [];\n  let currentMessage = [];\n  let inNumberedSection = false;\n  let currentSectionNumber = null;\n\n  // Detectar secciones numeradas y agrupables\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    // Detecta si la l√≠nea es un encabezado numerado (ej: \"1. Tipo de propiedad:\")\n    const numberedHeaderMatch = line.match(/^\\s*(\\d+)\\.\\s+([^:]+):/);\n\n    if (numberedHeaderMatch) {\n      const sectionNumber = parseInt(numberedHeaderMatch[1]);\n\n      // Si estamos empezando una nueva secci√≥n numerada O si el n√∫mero no es el siguiente esperado\n      if (!inNumberedSection || (inNumberedSection && sectionNumber !== currentSectionNumber + 1)) {\n        // Si tenemos contenido previo, guardamos como mensaje separado\n        if (currentMessage.length > 0) {\n          messages.push(currentMessage.join('\\n').trim());\n          currentMessage = [];\n        }\n        inNumberedSection = true;\n      }\n      currentSectionNumber = sectionNumber;\n      currentMessage.push(line);\n\n    } else if (line.trim() === '') {\n      // Una l√≠nea vac√≠a puede terminar una secci√≥n si hay contenido previo\n      if (currentMessage.length > 0) {\n        // Si no estamos en una secci√≥n numerada, una l√≠nea vac√≠a termina el mensaje actual\n        if (!inNumberedSection) {\n          messages.push(currentMessage.join('\\n').trim());\n          currentMessage = [];\n        } else {\n          // Si estamos en una secci√≥n numerada, una l√≠nea vac√≠a se agrega al mensaje actual\n          currentMessage.push(line);\n        }\n      }\n\n    } else {\n      // L√≠nea con contenido que no es un encabezado numerado\n      currentMessage.push(line);\n      inNumberedSection = false;\n    }\n  }\n\n  // Agregar el √∫ltimo mensaje si queda algo\n  if (currentMessage.length > 0) {\n    messages.push(currentMessage.join('\\n').trim());\n  }\n\n  // Filtrar mensajes vac√≠os y limpiar l√≠neas vac√≠as extra\n  return messages\n    .filter(msg => msg.length > 0)\n    .map(msg => {\n      // Eliminar l√≠neas vac√≠as m√∫ltiples dentro del mensaje\n      return msg.replace(/\\n{2,}/g, '\\n\\n');\n    });\n}\n\n// Funci√≥n para extraer texto de diferentes estructuras de datos\nfunction extractTextContent(data) {\n  // Si la data es null o undefined, retornamos null inmediatamente\n  if (data === null || data === undefined) {\n    return null;\n  }\n\n  // Si es un string, lo retornamos directamente\n  if (typeof data === 'string') {\n    return data;\n  }\n\n  // Si es un array\n  if (Array.isArray(data)) {\n    // Iteramos sobre el array e intentamos extraer texto de cada elemento\n    for (const item of data) {\n      const extracted = extractTextContent(item);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    return null;\n  }\n\n  // Si es un objeto\n  if (typeof data === 'object') {\n    // Priorizamos campos comunes que suelen contener texto\n    if (data.text) {\n      return data.text;\n    }\n    if (data.message) {\n      return data.message;\n    }\n    // Si tiene un campo 'output', intentamos extraer texto de √©l\n    if (data.output !== undefined && data.output !== null) {\n      const extracted = extractTextContent(data.output);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si tiene un campo 'response', intentamos extraer texto de √©l\n    if (data.response !== undefined && data.response !== null) {\n      const extracted = extractTextContent(data.response);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si tiene un campo 'json', intentamos extraer texto de √©l\n    if (data.json !== undefined && data.json !== null) {\n      const extracted = extractTextContent(data.json);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si no encontramos campos de texto comunes ni estructuras anidadas esperadas,\n    // intentamos convertir el objeto completo a string como √∫ltimo recurso\n    try {\n      return JSON.stringify(data);\n    } catch (e) {\n      console.error(\"No se pudo serializar el objeto a string en extractTextContent:\", e);\n      return null;\n    }\n  }\n\n  // Si el tipo de dato no es manejado, retornamos null\n  console.warn(\"Tipo de dato no manejado en extractTextContent:\", typeof data);\n  return null;\n}\n\n// --- L√≥gica Principal con manejo seguro de nodos ---\nlet textToProcess = null;\n\ntry {\n  // Verificar si el nodo \"Cancelar evento\" existe y tiene datos\n  let cancelarEventoData = null;\n  try {\n    // Usamos try-catch para capturar errores si el nodo no existe\n    cancelarEventoData = $('Cancelar evento');\n    if (cancelarEventoData && cancelarEventoData.first() && cancelarEventoData.first().json) {\n      if (cancelarEventoData.first().json.response !== undefined) {\n        textToProcess = extractTextContent(cancelarEventoData.first().json.response);\n      } else {\n        textToProcess = extractTextContent(cancelarEventoData.first().json);\n      }\n    }\n  } catch (e) {\n    // Silenciosamente ignoramos errores si el nodo no existe\n    console.log(\"Nodo 'Cancelar evento' no disponible o sin datos v√°lidos\");\n  }\n  \n  // Solo intentamos acceder a AGE3 si a√∫n no hemos encontrado texto para procesar\n  if (!textToProcess) {\n    try {\n      // Usamos try-catch para capturar errores si el nodo no existe\n      const age3Data = $('AGE3');\n      if (age3Data && age3Data.first() && age3Data.first().json) {\n        if (age3Data.first().json.output !== undefined) {\n          textToProcess = extractTextContent(age3Data.first().json.output);\n        } else {\n          textToProcess = extractTextContent(age3Data.first().json);\n        }\n      }\n    } catch (e) {\n      // Silenciosamente ignoramos errores si el nodo no existe\n      console.log(\"Nodo 'AGE3' no disponible o sin datos v√°lidos\");\n    }\n  }\n  \n  // Si no hemos encontrado datos en los nodos espec√≠ficos, intentamos con $input directamente\n  if (!textToProcess) {\n    try {\n      const inputItems = $input.all();\n      if (inputItems && inputItems.length > 0 && inputItems[0].json) {\n        textToProcess = extractTextContent(inputItems[0].json);\n      }\n    } catch (e) {\n      console.log(\"No se pudo acceder a los datos de entrada directamente:\", e.message);\n    }\n  }\n  \n  // Procesar y retornar el resultado\n  if (textToProcess) {\n    const textArray = processAndSplitText(textToProcess);\n    \n    // Procesar cada mensaje y dividirlo en chunks si es necesario\n    const processedMessages = [];\n    \n    for (const message of textArray) {\n      if (needsSplitting(message)) {\n        // Si el mensaje es largo, lo dividimos en chunks\n        const chunks = splitTextIntoChunks(message);\n        processedMessages.push(...chunks);\n      } else {\n        // Si el mensaje es corto, lo agregamos tal cual con tiempo de lectura\n        processedMessages.push({\n          parte: processedMessages.length + 1,\n          texto: message,\n          time: calculateReadingTime(message)\n        });\n      }\n    }\n    \n    // Re-numerar las partes para que sean consecutivas\n    processedMessages.forEach((msg, index) => {\n      msg.parte = index + 1;\n    });\n    \n    // Devolvemos la estructura con los mensajes procesados\n    return [{json: {messages: processedMessages, totalParts: processedMessages.length}}];\n  } else {\n    // Si no se pudo obtener ni procesar texto, devolvemos un array vac√≠o\n    return [{json: {messages: [], totalParts: 0}}];\n  }\n} catch (error) {\n  // Capturamos cualquier error no manejado y devolvemos un objeto con informaci√≥n del error\n  console.error(\"Error general en el nodo:\", error.message);\n  return [{json: {messages: [], totalParts: 0, error: error.message}}];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5232,
        1120
      ],
      "id": "8a215275-5a95-40f8-bcc8-0688ef0f50d8",
      "name": "Separa datos"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c203e3f3-cdae-4308-b7ca-2300800248e7"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0cb14635-2673-408e-86db-ce9e0373674b",
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "462a2dc9-b455-4b67-a55b-15ce1554f0e8",
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "reply",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "button"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "61909e38-68a6-46cc-9287-bd79d0b95854",
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "extendedTextMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "89191595-e9ab-4d53-881b-ed5247811e44",
                    "leftValue": "={{ $json.msg.content === 'Quiero cambiar mi fecha' }}",
                    "rightValue": "Quiero cambiar mi fecha",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Modificar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d1365037-6336-4f42-ad67-111b60828b07",
                    "leftValue": "={{ $('Webhook').first().json.body.data.msgContent.listResponseMessage.contextInfo.quotedMessage.listMessage.buttonText === 'Confirmar ‚úÖ' }}",
                    "rightValue": "Confirmar ‚úÖ",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirmar ‚úÖ"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "06ff860d-976d-4fdc-9dd3-8c9483137f8d",
                    "leftValue": "={{ $('Webhook').first().json.body.data.msgContent.listResponseMessage.contextInfo.quotedMessage.listMessage.buttonText === 'Cancelar turno ‚ùå' }}",
                    "rightValue": " ‚ùå Cancelar cita",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b64bdc33-47da-4c94-988d-1ba19386a5a2",
                    "leftValue": "={{ $('Webhook').first().json.body.data.msgContent.listResponseMessage.singleSelectReply.selectedRowId == '‚úÖ TURNO CONFIRMADO' }}",
                    "rightValue": "üìÜ Elegir cita",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "‚úÖ TURNO CONFIRMADO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b90b24f3-c0b9-4bda-addd-c595e3a99cb4",
                    "leftValue": "={{ $('Webhook').first().json.body.data.msgContent.listResponseMessage.singleSelectReply.selectedRowId == '‚ùå CANCELAR TURNO' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "‚ùå CANCELAR TURNO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "79032457-2ad1-4ff3-baef-b638cff374d7",
                    "leftValue": "={{ $('Webhook').first().json.body.data.msgContent.listResponseMessage.contextInfo.quotedMessage.listMessage.buttonText === 'üìã REAGENDAR CONSULTA'}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "üìã REAGENDAR CONSULTA"
            }
          ]
        },
        "options": {}
      },
      "id": "9a76834b-55cf-444b-867e-e37f24b419e5",
      "name": "Message Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2704,
        1472
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "tD2EBk1RhsCBSSkb",
          "mode": "list",
          "cachedResultName": "SUB TAREA - ENLOCAR MSG Citas"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "mode": "each",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2864,
        912
      ],
      "id": "3401a1cb-f2df-4da5-a3e5-b81d5ba430c5",
      "name": "Encolado de msg"
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        3104,
        912
      ],
      "id": "67d66507-2423-4efa-a029-b19a18097203",
      "name": "Sort"
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "text",
              "renameField": true,
              "outputFieldName": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        3344,
        912
      ],
      "id": "4c80a0a4-8594-4306-83d7-a5013e58ae23",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0fae28c9-d30a-4250-9a50-5b68c61164cf",
              "name": "message",
              "value": "={{ $json?.text?.join(\"\\n\") || $json.msg.content }}",
              "type": "string"
            },
            {
              "id": "d5b09385-d3b2-4a98-ab34-48b786de7354",
              "name": "fecha",
              "value": "={{ $now.setLocale('es').toFormat('EEEE d \\'de\\' MMMM yyyy \\'a las\\' H:mm') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3568,
        912
      ],
      "id": "65f720e1-0797-40a1-9363-d56010aa06b6",
      "name": "chatInput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "79a702ff-5f8c-4814-bddf-5e3acb5a5f2e",
              "name": "msg",
              "value": "={{ JSON.stringify($('V1').first().json.msg)}}",
              "type": "object"
            },
            {
              "id": "9337176e-e568-4efa-8c05-3bdb12ecfb61",
              "name": "id_cliente",
              "value": "={{ $json.list.Id }}",
              "type": "string"
            },
            {
              "id": "08b235c8-58cc-48d1-a1c4-dd76a89ea7cc",
              "name": "clientebd",
              "value": "={{ JSON.stringify($json.list) }}",
              "type": "object"
            },
            {
              "id": "40cb2db6-1a0b-486b-b2dd-3680515eb92a",
              "name": "msg.id_admini",
              "value": "35",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "93a68d77-5a4d-4d94-b10a-cdf4357557e9",
      "name": "Variables globales",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2320,
        1600
      ],
      "notesInFlow": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9a858fa6-8f70-4ce7-a956-8c0209fbb10f",
              "leftValue": "={{ $json.output }}",
              "rightValue": "button_confirm",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4912,
        1136
      ],
      "id": "ef538d99-9080-43bd-b3de-569960b4db41",
      "name": "If"
    },
    {
      "parameters": {
        "content": "## RESET BBDD",
        "height": 240,
        "width": 260,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2224,
        880
      ],
      "typeVersion": 1,
      "id": "420f8173-79e9-4d68-8931-08a959f0bc49",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "5492254423359"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2304,
        960
      ],
      "id": "21fae1c1-981e-467f-b3f3-f680ab3e0aa5",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "={{ $('Split Out').item.json.texto }}"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6736,
        1168
      ],
      "id": "3d3a6293-ef06-4d17-a301-24b4b8737c11",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "jsCode": "// OBTENER EL TEXTO DEL MENSAJE\nconst messageText = $input.first().json.msg.content;\n\n// FUNCI√ìN PARA LIMPIAR TEXTO\nfunction cleanText(text) {\n  return text.replace(/\\s+/g, ' ').trim();\n}\n\n// OBTENER ID Y TEL√âFONO DESDE EL INPUT\nfunction obtenerDatosInput() {\n  const inputData = $input.first().json;\n  return {\n    id: inputData.id_cliente || '1',\n    telefono: inputData.telefono || ''\n  };\n}\n\n// PARSEAR EL MENSAJE DE CONFIRMACI√ìN\nfunction parseConfirmationMessage(text) {\n  // El formato es: ‚úÖ CONFIRMADO - [nombre] | [fecha]T[hora] | [servicio]\n  \n  // Remover el emoji y \"CONFIRMADO -\"\n  const sinEmoji = text.replace(/‚úÖ\\s*CONFIRMADO\\s*-\\s*/, '');\n  \n  // Dividir por el pipe (|)\n  const partes = sinEmoji.split('|').map(parte => parte.trim());\n  \n  if (partes.length >= 3) {\n    // Extraer nombre\n    const nombre = partes[0];\n    \n    // Extraer fecha y hora (mantener el formato ISO completo: YYYY-MM-DDThh:mm)\n    const fechaHora = partes[1];\n    \n    // Extraer servicio\n    const servicio = partes[2];\n    \n    return {\n      nombre: nombre,\n      fecha: fechaHora, // Mantener el formato completo ISO\n      servicio: servicio\n    };\n  }\n  \n  // Si el formato no coincide, retornar valores vac√≠os\n  return {\n    nombre: '',\n    fecha: '',\n    servicio: ''\n  };\n}\n\n// PROCESAR LOS DATOS\nconst datosExtraidos = parseConfirmationMessage(messageText);\nconst datosInput = obtenerDatosInput();\n\n// RETORNAR LOS DATOS EN EL FORMATO ESPERADO PARA NOCODB\nconst resultado = {\n  NOMBRE: datosExtraidos.nombre,\n  ID_USUARIO: datosInput.id,\n  FECHA: datosExtraidos.fecha, // Ahora contiene fecha y hora: \"2025-08-01T10:00\"\n  SERVICIO: datosExtraidos.servicio,\n  CONFIRMACION_CITA: messageText, // El mensaje completo\n  TELEFONO: datosInput.telefono\n};\n\n// LOG PARA DEBUGGING\nconsole.log('Mensaje recibido:', messageText);\nconsole.log('Datos extra√≠dos:', resultado);\n\nreturn [{ json: resultado }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3088,
        1520
      ],
      "id": "a41c6102-8a1c-4e27-905f-8a386d0ded75",
      "name": "Code"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "create",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "TELEFONO",
              "fieldValue": "={{ $('Variables globales').first().json.msg.telefono }}"
            },
            {
              "fieldName": "NOMBRE",
              "fieldValue": "={{ $json.NOMBRE }}"
            },
            {
              "fieldName": "FECHA",
              "fieldValue": "={{ $json.FECHA }}"
            },
            {
              "fieldName": "SERVICIO",
              "fieldValue": "={{ $json.SERVICIO }}"
            },
            {
              "fieldName": "Usuario_id",
              "fieldValue": "35"
            },
            {
              "fieldName": "FECHA_RECORDATORIO",
              "fieldValue": "={{ new Date($json.FECHA + ':00').toISOString().substring(0, 16).replace(new Date($json.FECHA + ':00').toISOString().substring(11, 16), String(parseInt($json.FECHA.substring(11, 13)) - 1).padStart(2, '0') + $json.FECHA.substring(13, 16)) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        3328,
        1520
      ],
      "id": "540b1602-af64-482b-beb8-8ee4f0ddc8b7",
      "name": "CreateCITA",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=‚úÖ Perfecto {{ $json.NOMBRE.split(' ')[0] }} ya quedo agendado el turno, te estaremos enviando un mensajito unas horas antes para la confirmaci√≥n. Qu√© tengas un lindo dia"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3584,
        1520
      ],
      "id": "13ef39b8-fdd1-4e87-b0a5-eeffb5964c14",
      "name": "Turno creado"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        6528,
        1104
      ],
      "id": "90b81162-9f59-442d-90d8-d1a8102354d0",
      "name": "Wait",
      "webhookId": "2e6c7e9b-0d64-4c7b-90f7-adde5868bc94"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json?.message || $json.chatInput }}",
        "options": {
          "systemMessage": "=## JULI - RECEPCIONISTA VIRTUAL ODONTOL√ìGICA\n\nEres **Juli**, recepcionista virtual de consultorio odontol√≥gico.\n\n## HOY ES: {{ $json.fecha }}\n\n**PERSONALIDAD**: Mujer simp√°tica, profesional, voseo argentino. Sin \"che\", sin emojis.\n\n---\n\n## FLUJOS DE ACCI√ìN R√ÅPIDA\n\n### üîß AGENDAR TURNO\n**Cuando el usuario quiere agendar:**\n1. **üö® OBLIGATORIO**: **EJECUTAR**: `tool_think` PRIMERO (analizar situaci√≥n y determinar pasos)\n2. Mostrar servicios disponibles\n3. Recolectar: NOMBRE + SERVICIO + FECHA + HORA\n4. **L√ìGICA INTELIGENTE**:\n   - Si solo dice D√çA ‚Üí preguntar \"¬øPara qu√© hora?\"\n   - Si solo dice HORA ‚Üí preguntar \"¬øPara qu√© d√≠a?\"\n   - Si da ambos ‚Üí continuar\n5. **VERIFICACI√ìN DE DISPONIBILIDAD**:\n   - **EJECUTAR**: `get_turnos_disponibles` para verificar fechas ocupadas\n   - Si la fecha/hora est√° **DISPONIBLE** ‚Üí continuar con `tool_agendar`\n   - Si la fecha/hora est√° **OCUPADA** ‚Üí mostrar horarios alternativos disponibles y pedir nueva selecci√≥n\n6. Una vez verificada la disponibilidad ‚Üí **EJECUTAR**: `tool_agendar`\n7. **RESPONDER SOLO**: `button_confirm`\n\n**Servicios disponibles:**\n```\nü™• Limpieza\nüíé Blanqueamiento  \nüõ†Ô∏è Tratamiento de caries\nüö´ Extracci√≥n\nüìã Consulta general\nüìê Ortodoncia\nüîß Implante\nü¶∑ Pr√≥tesis\n```\n\n### ‚ùå CANCELAR TURNO\n**Cuando el usuario quiere cancelar:**\n1. **üö® OBLIGATORIO**: **EJECUTAR**: `tool_think` PRIMERO (analizar situaci√≥n y determinar pasos)\n2. **AUTOM√ÅTICAMENTE** preguntar: \"Dale, ¬øquer√©s que te pase las fechas agendadas?\"\n3. Si dice S√ç ‚Üí **EJECUTAR**: `tool_cancelar` (esto mostrar√° las fechas disponibles)\n4. Usuario elige cu√°l cancelar ‚Üí **EJECUTAR**: `tool_cancelar` con la fecha espec√≠fica luego devuelve solo `button_confirm`\n\n\n### üîÑ REPROGRAMAR TURNO\n**Cuando el usuario quiere reprogramar:**\n\n1. **üö® OBLIGATORIO**: **EJECUTAR**: `tool_think` PRIMERO (analizar situaci√≥n y determinar pasos)\n\n**L√ìGICA INTELIGENTE DE CONTEXTO:**\n- Si acaba de confirmar una cita y dice \"cambiarla a [HORA]\" ‚Üí **MANTENER** la misma fecha, cambiar solo la hora\n- Si dice \"no puedo a las 9, pod√©s cambi√°rmela a las 10\" ‚Üí **MISMO D√çA**, nueva hora\n- Si no hay contexto de cita reciente ‚Üí preguntar fecha completa\n\n**FLUJO:**\n2. **DETECTAR CONTEXTO**:\n   - ¬øHay una cita reci√©n confirmada en la conversaci√≥n?\n   - ¬øEl usuario solo menciona una hora nueva?\n   \n3. **SI SOLO CAMBIA HORA** (contexto de cita reciente):\n   - **VERIFICAR DISPONIBILIDAD**: `get_turnos_disponibles` para la nueva hora\n   - Si **DISPONIBLE** ‚Üí **EJECUTAR**: `tool_reagendar` manteniendo fecha original + nueva hora ‚Üí **RESPONDER**: \"Perfecto, ah√≠ te cambi√© el turno para la misma fecha a las [nueva hora]. ¬øAlgo m√°s?\"\n   - Si **OCUPADA** ‚Üí **RESPONDER**: \"Esa hora ya est√° ocupada. ¬øQuer√©s probar con otro horario?\"\n\n4. **SI NO HAY CONTEXTO**:\n   - **PREGUNTAR**: \"Dale, ¬øpara qu√© fecha quer√©s cambiarlo?\"\n   - Usuario da nueva fecha ‚Üí **CONVERTIR** a formato ISO\n   - **VERIFICAR DISPONIBILIDAD**: `get_turnos_disponibles` para la fecha solicitada\n   - Si **DISPONIBLE** ‚Üí **EJECUTAR**: `tool_reagendar` con JSON completo ‚Üí **RESPONDER**: \"Listo, ah√≠ ya cambi√© tu turno para [nueva fecha/hora]. ¬øNecesit√°s algo m√°s?\"\n   - Si **OCUPADA** ‚Üí **RESPONDER**: \"Esa fecha ya est√° ocupada. ¬øQuer√©s probar con otra fecha?\"\n\n**Ejemplo conversi√≥n:**\n- Usuario dice: \"viernes 15 de agosto a las 2\" ‚Üí `2025-08-15T14:00`\n- Usuario dice: \"para este jueves mismo horario\" ‚Üí  `2025-08-15T14:00` interpreta que dia esta, y si es lunes debe sumarle los dias correspondientes sabiendo la fecha {{ $json.fecha }}\n- Usuario dice: \"pod√©s cambi√°rmela a las 10\" (despu√©s de confirmar cita) ‚Üí mantener fecha original + `T10:00`\n\n**Ejemplos interpretaci√≥n inteligente de horarios:**\n- Usuario dice: \"quiero un turno para √∫ltima hora del viernes\" ‚Üí viernes a las 18:30\n- Usuario dice: \"√∫ltima hora de la ma√±ana del martes\" ‚Üí martes a las 12:30\n- Usuario dice: \"primera hora del jueves\" ‚Üí jueves a las 08:00\n- Usuario dice: \"primera hora de la tarde\" ‚Üí 15:00\n\n### üìÖ CONSULTAR FECHAS DISPONIBLES\n**Cuando el usuario pregunta por fechas disponibles:**\n1. **üö® OBLIGATORIO**: **EJECUTAR**: `tool_think` PRIMERO (analizar situaci√≥n y determinar pasos)\n2. **EJECUTAR**: `get_turnos_disponibles` para obtener fechas ocupadas\n3. **CALCULAR** fechas disponibles en los pr√≥ximos 7 d√≠as:\n   - Tomar fecha actual desde `{{ $json.fecha }}`\n   - Generar rango de 7 d√≠as (solo lunes a viernes, 08:00-13:00 y 15:00-19:00)\n   - **RESTAR** las fechas/horarios ya ocupados obtenidos en paso 2\n4. **MOSTRAR** fechas disponibles en formato lista bonito (una fecha por l√≠nea)\n5. **PREGUNTAR**: \"¬øQuer√©s ver fechas para la pr√≥xima semana tambi√©n?\"\n6. Si dice S√ç ‚Üí repetir proceso para pr√≥ximos 7 d√≠as\n\n**FORMATO DE PRESENTACI√ìN:**\n```\nüìÖ **Lunes 20/01**\n   ‚Ä¢ 08:30  ‚Ä¢ 10:00  ‚Ä¢ 15:30  ‚Ä¢ 16:00\n\nüìÖ **Martes 21/01**\n   ‚Ä¢ 09:00  ‚Ä¢ 11:30  ‚Ä¢ 15:00  ‚Ä¢ 17:00\n\nüìÖ **Mi√©rcoles 22/01**\n   ‚Ä¢ 08:00  ‚Ä¢ 10:30  ‚Ä¢ 16:30  ‚Ä¢ 18:00\n```\n\n### üö® URGENCIAS M√âDICAS\n**Cuando el usuario tiene urgencia m√©dica:**\n1. **üö® OBLIGATORIO**: **EJECUTAR**: `tool_think` PRIMERO (analizar situaci√≥n y determinar pasos)\n2. **DETECTAR** palabras clave: dolor intenso, sangrado, urgencia, emergencia\n3. **EJECUTAR**: `tool_urgencias` inmediatamente\n4. **RESPONDER**: \"Entiendo. Voy a pasarte con recepci√≥n para que puedan ayudarte de inmediato.\"\n\n---\n\n## HERRAMIENTAS DISPONIBLES\n\n- **üö® OBLIGATORIO SIEMPRE PRIMERO**: `tool_think` - **INDISCUTIBLE** - Debe ejecutarse ANTES que cualquier otra acci√≥n\n- **Para obtener datos del paciente**: `get_paciente`\n- **Para reagendar turno**: `update_fecha`\n- **Para agendar turno**: `tool_agendar`\n- **Para cancelar turno**: `tool_cancelar`\n- **Para urgencias m√©dicas**: `tool_urgencias`\n- **Para revisar si se puede agendar un turno**: `get_fechas`\n- **Para ver turnos del usuario**: `get_turnos_agendados`\n- **Para obtener fechas ocupadas (calcular disponibles)**: `get_turnos_disponibles`\n\n\n---\n\n## DATOS REQUERIDOS PARA AGENDAR\n\n- **NOMBRE**: Nombre completo\n- **SERVICIO**: De la lista disponible\n- **FECHA**: Formato DD-MM-AAAA (convertir expresiones como \"ma√±ana\", \"pr√≥ximo jueves\")\n- **HORA**: Formato HH:MM\n\n**L√ìGICA DE RECOLECCI√ìN**:\n- Si usuario dice solo \"jueves\" ‚Üí preguntar \"¬øPara qu√© hora?\"\n- Si usuario dice solo \"10:30\" ‚Üí preguntar \"¬øPara qu√© d√≠a?\"\n- Si usuario dice \"jueves a las 10:30\" ‚Üí continuar con confirmaci√≥n\n\n**INTERPRETACI√ìN INTELIGENTE DE HORARIOS**:\n- **\"√öltima hora\"** o **\"√∫ltimo turno\"** ‚Üí 18:30 (media hora antes del cierre de 19:00)\n- **\"√öltima hora de la ma√±ana\"** ‚Üí 12:30 (media hora antes del cierre de 13:00)\n- **\"Primera hora\"** ‚Üí 08:00 (primer turno del d√≠a)\n- **\"Primera hora de la tarde\"** ‚Üí 15:00 (primer turno de la tarde)\n\n**Horarios**: Lunes-Viernes 08:00-13:00 y 15:00-19:00 (turnos de 30 min), no atendemos sabados y domingos\n\n\n---\n\n## CONVERSI√ìN DE FECHAS\n\n### Interpretaci√≥n de fechas relativas\n\nSi el paciente usa expresiones vagas que abarcan varios d√≠as (ej.: \"la semana que viene\", \"la pr√≥xima semana\"), Juli debe pedir un d√≠a espec√≠fico:  \n¬´Perfecto, ¬øqu√© d√≠a de la pr√≥xima semana te vendr√≠a bien?¬ª\n\nJuli entiende expresiones como \"ma√±ana\", \"pasado ma√±ana\", \"la semana que viene\", \"el martes que viene\", \"el jueves que viene\", etc., y las traduce a la fecha concreta en formato DD-MM-AAAA tomando como referencia la fecha actual disponible en `{{ $json.fecha }}`. cuando obtengas la fecha que el cliente te brinde debes identificar primero que nada si es sabado o domingo, si cae en esa fecha automaticamente decirle que no se atiende sabados y domingos que solo de lunes a viernes.\n\n**Expresiones del usuario ‚Üí Fecha exacta:**\n- \"Ma√±ana\" ‚Üí calcular desde {{ $json.fecha }}\n- \"Pr√≥ximo jueves\" ‚Üí buscar pr√≥ximo jueves disponible\n- \"La semana que viene\" ‚Üí pedir d√≠a espec√≠fico\n\n**Para reprogramar ‚Üí Formato JSON ISO:**\n- Usuario: \"viernes 15 de agosto a las 2\" ‚Üí `{\"FECHA\": \"2025-08-15T14:00\"}`\n- Usuario: \"martes que viene a las 10:30\" ‚Üí `{\"FECHA\": \"2025-XX-XXT10:30\"}`\n- Usuario: \"el 12 de mayo a las 10\" ‚Üí `{\"FECHA\": \"2025-05-12T10:00\"}`\n\n---\n\n## EJEMPLOS DE DI√ÅLOGO\n\n### 1. Agendar\n\nPaciente: Hola, me gustar√≠a pedir un turno.\nJuli: Hola, ¬øc√≥mo est√°s? S√≠, contame para qu√© necesitabas el turno. Te podemos ayudar con lo siguiente:\n\n```\nü™• Limpieza\nüíé Blanqueamiento  \nüõ†Ô∏è Tratamiento de caries\nüö´ Extracci√≥n\nüìã Consulta general\nüìê Ortodoncia\nüîß Implante\nü¶∑ Pr√≥tesis\n```\n\nPaciente: Para limpieza.\nJuli: Perfecto. ¬øMe pasas tu nombre completo?\nPaciente: Luc√≠a Fern√°ndez.\nJuli: Gracias, Luc√≠a. ¬øQu√© d√≠a y hora te vendr√≠a bien?\nPaciente: El pr√≥ximo jueves. (analizar que no sea sabado o domingo)\nJuli: ¬øPara qu√© hora?\nPaciente: 10:30.\n*(Juli ejecuta `get_turnos_disponibles` para verificar disponibilidad)*\n*(Si est√° disponible, Juli ejecuta `tool_agendar`)*\nJuli:\n```\nbutton_confirm\n```\n\n### 1b. Agendar (usuario da solo hora)\n\nPaciente: Quiero un turno para limpieza.\nJuli: Perfecto. ¬øMe pasas tu nombre completo?\nPaciente: Fernando Cassera.\nJuli: Gracias, Fernando. ¬øQu√© d√≠a y hora te vendr√≠a bien?\nPaciente: A las 2 de la tarde.\nJuli: ¬øPara qu√© d√≠a?\nPaciente: El viernes que viene.\n*(Juli ejecuta `get_turnos_disponibles` para verificar disponibilidad)*\n*(Si est√° disponible, Juli ejecuta `tool_agendar`)*\nJuli:\n```\nbutton_confirm\n```\n\n### 1c. Agendar (interpretaci√≥n inteligente)\n\nPaciente: Quiero un turno para limpieza.\nJuli: Perfecto. ¬øMe pasas tu nombre completo?\nPaciente: Mar√≠a Gonz√°lez.\nJuli: Gracias, Mar√≠a. ¬øQu√© d√≠a y hora te vendr√≠a bien?\nPaciente: Para √∫ltima hora del viernes.\n*(Juli interpreta: viernes 18:30)*\n*(Juli ejecuta `get_turnos_disponibles` para verificar disponibilidad)*\n*(Si est√° disponible, Juli ejecuta `tool_agendar` con viernes 18:30)*\nJuli:\n```\nbutton_confirm\n```\n\n### 2. Cancelar\n\nPaciente: Quiero cancelar un turno.\nJuli: Dale, ¬øquer√©s que te pase las fechas agendadas?\nPaciente: S√≠.\nJuli: [Ejecuta tool_cancelar - muestra fechas disponibles]\nluego devuelve solo `button_confirm`\n\n### 3. Reprogramar\n\nPaciente: Necesito cambiar mi turno.\nJuli: Dale, ¬øpara qu√© fecha quer√©s cambiarlo?\nPaciente: Para el viernes 15 de agosto a las 2 de la tarde.\n*(Juli ejecuta `get_turnos_disponibles` para verificar disponibilidad)*\n*(Si est√° disponible, Juli ejecuta `tool_reagendar` con {\"FECHA\": \"2025-08-15T14:00\"})*\nJuli: Listo, Fernando, ah√≠ ya cambi√© tu turno para el 15 de agosto a las 14:00. ¬øNecesit√°s algo m√°s?\n*(Si est√° ocupada, Juli responde: \"Esa fecha ya est√° ocupada. ¬øQuer√©s probar con otra fecha?\")*\n\n### 4. Reprogramar (cambio de hora mismo d√≠a)\n\n*(Despu√©s de confirmar cita para las 9:00)*\nPaciente: Me acord√© que a las 9 no puedo, ¬øpod√©s cambiarla a las 10?\n*(Juli detecta contexto de cita reci√©n confirmada + solo menciona hora nueva)*\n*(Juli ejecuta `get_turnos_agendados` para verificar las 10:00)*\n*(Si est√° disponible, Juli ejecuta `tool_reagendar` manteniendo fecha original pero cambiando hora a 10:00)*\n*(Si est√° ocupada, Juli responde: \"Esa hora ya est√° ocupada. ¬øQuer√©s probar con otro horario?\")*\nJuli: Perfecto, ah√≠ te cambi√© el turno para la misma fecha a las 10:00. Algo m√°s necesitabas?\n\n### 5. Reprogramar (sin contexto)\n\nPaciente: Necesito cambiar mi turno del martes.\nJuli: Dale, ¬øpara qu√© fecha quer√©s cambiarlo?\nPaciente: Para el jueves a las 10.\nJuli busca `get_fecha` y si coincide con la del usuario le sugiere otra sino\nPaciente: Pasa fecha nueva correcta sin coincidencia\n*(Juli ejecuta `tool_reagendar` con {\"FECHA\": \"2025-XX-XXT10:00\"})*\nJuli: Listo, Mar√≠a, ah√≠ ya cambi√© tu turno para el jueves a las 10:00. ¬øNecesit√°s algo m√°s?\n\n### 6. Actualizar tel√©fono\n\nPaciente: Cambi√© mi n√∫mero de tel√©fono.\nJuli: Claro, ¬øcu√°l es tu nuevo tel√©fono?\nPaciente: 11‚Äë3456‚Äë7890.\nJuli: dale ahi lo cambi√©. Gracias por avisar\n\n### 7. Urgencia\n\nPaciente: Me duele much√≠simo una muela, necesito que me atiendan ya.\n*(Juli ejecuta `tool_urgencias`)*\nJuli: Entiendo. Voy a pasarte con recepci√≥n para que puedan ayudarte de inmediato.\n\n### 8. VER TURNOS AGENDADOS\nPaciente: ¬øQu√© turnos tengo agendados?\nPaciente: No me acuerdo que turnos tengo.\n*(Juli ejecuta `tool_think`)*\n*(Juli ejecuta `get_turnos_agendados`)*\nJuli: Estos son tus turnos agendados:\n\nüìÖ **Lunes 20/01**\n   üïò 10:30 - Limpieza\n\nüìÖ **Viernes 24/01**\n   üïí 15:00 - Consulta general\n\n¬øNecesit√°s cambiar alguno? \n\n### 8b. CONSULTAR FECHAS DISPONIBLES\nPaciente: ¬øQu√© fechas ten√©s disponibles?\nPaciente: ¬øCu√°les son los horarios libres?\n*(Juli ejecuta `tool_think`)*\n*(Juli ejecuta `get_turnos_disponibles` para ver fechas ocupadas)*\n*(Juli calcula fechas disponibles en pr√≥ximos 7 d√≠as restando las ocupadas)*\nJuli: Estas son las fechas disponibles para esta semana:\n\nüìÖ **Lunes 20/01**\n   ‚Ä¢ 08:30  ‚Ä¢ 10:00  ‚Ä¢ 15:30  ‚Ä¢ 16:00\n\nüìÖ **Martes 21/01**\n   ‚Ä¢ 09:00  ‚Ä¢ 11:30  ‚Ä¢ 15:00  ‚Ä¢ 17:00\n\nüìÖ **Mi√©rcoles 22/01**\n   ‚Ä¢ 08:00  ‚Ä¢ 10:30  ‚Ä¢ 16:30  ‚Ä¢ 18:00\n\nüìÖ **Jueves 23/01**\n   ‚Ä¢ 09:30  ‚Ä¢ 11:00  ‚Ä¢ 15:30  ‚Ä¢ 17:30\n\nüìÖ **Viernes 24/01**\n   ‚Ä¢ 08:00  ‚Ä¢ 12:30  ‚Ä¢ 16:00  ‚Ä¢ 18:30\n\n¬øQuer√©s ver fechas para la pr√≥xima semana tambi√©n? \n\n### 9. Despedidas m√∫ltiples (ejemplo)\n\nJuli: Perfecto, ah√≠ te cambi√© el turno para la misma fecha a las 10:00. Algo m√°s necesitabas?\nPaciente: Nada m√°s.\nJuli: B√°rbaro, nos vemos.\nPaciente: Dale gracias.\nJuli: ¬°Saludos!\nPaciente: Chau.\nJuli: üëã\n\n---\n\n## üëã DESPEDIDAS INTELIGENTES\n\n**Cuando el usuario dice \"nada m√°s\", \"no, gracias\", \"listo\", etc.:**\n\n**PRIMERA DESPEDIDA** (rotar entre estas opciones):\n- \"De nada, que tengas un lindo d√≠a\"\n- \"Perfecto, que andes bien\"\n- \"Dale, que tengas buen d√≠a\"\n- \"B√°rbaro, nos vemos\"\n- \"Listo, que te vaya bien\"\n\n**SI EL USUARIO RESPONDE NUEVAMENTE** (\"gracias\", \"dale gracias\", \"chau\", etc.):\n\n**SEGUNDA DESPEDIDA** (m√°s breve, rotar entre):\n- \"¬°Chau!\"\n- \"¬°Saludos!\"\n- \"¬°Hasta luego!\"\n- \"¬°Que est√©s bien!\"\n- \"¬°Nos vemos!\"\n\n**SI INSISTE UNA TERCERA VEZ**:\n- Solo responder con emoji: \"üëã\"\n\n**L√ìGICA**:\n- **NUNCA** repetir la misma despedida consecutivamente\n- Usar despedidas m√°s cortas en respuestas subsiguientes\n- Despu√©s de 3 intercambios de despedida, solo emoji\n\n---\n\n## REGLAS CR√çTICAS\n\n1. **üö® INDISCUTIBLE**: **SIEMPRE** ejecutar `tool_think` PRIMERO - Sin excepciones, sin importar la situaci√≥n\n2. **NUNCA** asumir datos de conversaciones anteriores\n3. **VERIFICACI√ìN OBLIGATORIA** antes de agendar/reagendar:\n   - **EJECUTAR**: `get_turnos_disponibles` para verificar disponibilidad\n   - Si est√° ocupada ‚Üí informar y pedir alternativa\n   - Si est√° disponible ‚Üí proceder con la herramienta correspondiente\n4. **OBLIGATORIO** ejecutar las herramientas correspondientes:\n   - Para agendar ‚Üí ejecutar `tool_agendar` (despu√©s de verificar) ‚Üí responder solo `button_confirm`\n   - Para cancelar ‚Üí ejecutar `tool_cancelar` ‚Üí responder solo `button_confirm`\n   - Para reagendar ‚Üí ejecutar `tool_reagendar` (despu√©s de verificar) ‚Üí responder mensaje confirmatorio personalizado\n   - Para urgencias ‚Üí ejecutar `tool_urgencias`\n5. **RESPUESTAS DESPU√âS DE HERRAMIENTAS**:\n   - Agendar/Cancelar: solo `button_confirm`\n   - Reagendar: mensaje confirmatorio personalizado (NO button_confirm)\n6. **URGENCIAS** ‚Üí derivar a humano inmediatamente\n7. **DATOS FALTANTES** ‚Üí solicitarlos antes de ejecutar herramientas\n\n---\n\n## VALIDACI√ìN ANTES DE RESPONDER\n\n‚úì **üö® CR√çTICO**: ¬øEjecut√© `tool_think` PRIMERO antes que cualquier otra acci√≥n? (OBLIGATORIO - SIN EXCEPCIONES)\n‚úì ¬øTengo todos los datos necesarios?\n‚úì **¬øEjecut√© `get_turnos_disponibles` para verificar disponibilidad antes de agendar/reagendar?**\n‚úì ¬øEjecut√© la herramienta correcta?\n‚úì revisar siempre la fecha actual para no agendar sabados ni domingos, siempre antes de confirmar debes verificar de no agendar fines de semana siempre toma la fehca de hoy desde aca {{ $json.fecha }}\n‚úì Revisa el horarios, no se puede agendar sobre la hora, minimo 2 hs antes de un evento, si son las 8, puede agendar para 10, pero si son las 9 para las 10 no."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4384,
        1120
      ],
      "id": "de998f4a-1ce9-4552-8a89-e35071346984",
      "name": "Juli"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/presence",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "status",
              "value": "composing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6288,
        1104
      ],
      "id": "b61e74ec-4fc1-45f9-9780-4cf22c39174c",
      "name": "escribiendo...",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "description": "Llama a esta tool cuando tengas que agendar, runa visita",
        "workflowId": {
          "__rl": true,
          "value": "QMISSxd5iYUeehv5",
          "mode": "list",
          "cachedResultName": "AGENTE CITAS - Button confirm"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "nombre": "={{ $fromAI('nombre', ``, 'string') }}",
            "fecha": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fecha', `Utilizar formato iso`, 'string') }}",
            "hora": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('hora', ``, 'string') }}",
            "telefono": "={{ $('Variables globales').first().json.msg.telefono }}",
            "servicio": "={{ $fromAI('servicio', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "hora",
              "displayName": "hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "servicio",
              "displayName": "servicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4928,
        1568
      ],
      "id": "e2ce894a-87af-42f7-b05b-eca09648c4be",
      "name": "tool_agendar"
    },
    {
      "parameters": {
        "description": "Llama a esta tool cuando tengas que agendar, reprogramar o cancelar una visita",
        "workflowId": {
          "__rl": true,
          "value": "kSLafA6eMsulnKVE",
          "mode": "list",
          "cachedResultName": "AGENTE CITAS - CANCELAR"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Id": "={{ $('Variables globales').item.json.id_cliente }}",
            "numero": "={{ $('Variables globales').item.json.msg.telefono }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Id",
              "displayName": "Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5056,
        1488
      ],
      "id": "7962441b-da2c-49b4-be6c-532715c89e82",
      "name": "tool_cancelar"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=‚úÖ Listo, ya cancelamos el turno, si queres agendar para otro servicio, me avisas, Qu√© tengas un buen d√≠a."
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3600,
        2128
      ],
      "id": "3fe84736-136a-48dd-9ffb-07db9e4e24cb",
      "name": "Cancelar turno"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=‚úÖ Listo, ahi la cancele, ahora decime para que fecha queres el nuevo turno."
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3360,
        2736
      ],
      "id": "3659cda2-d67d-46ef-947b-975d96a7d022",
      "name": "Cancelar turno1"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "returnAll": true,
        "options": {
          "where": "=(TELEFONO,eq,{{ $('Variables globales').item.json.msg.telefono }})"
        }
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        4368,
        1664
      ],
      "id": "22d84a6d-f3c2-4fdb-a424-1d78652675d7",
      "name": "get_paciente",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {
          "frequencyPenalty": 0.3,
          "presencePenalty": 0.3,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        4160,
        1536
      ],
      "id": "ea13bc4a-ac93-432b-bd65-87ab554294ca",
      "name": "gemini2",
      "credentials": {
        "openRouterApi": {
          "id": "ADdm45cFSIFSG59w",
          "name": "Gemini"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Variables globales').first().json.msg.telefono }}",
        "sessionTTL": 1800
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        4240,
        1792
      ],
      "id": "971d03d1-40a8-46fb-9b76-96a0a4af8d92",
      "name": "memory1",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Id",
              "fieldValue": "={{ $json.id_cliente }}"
            },
            {
              "fieldName": "FECHA"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        3104,
        2736
      ],
      "id": "00a90908-f941-470b-949c-25cf7cf6e9f4",
      "name": "Elimina la cita - Reagendar",
      "alwaysOutputData": true,
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "insert",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.data.message.extendedTextMessage.text }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        4400,
        2448
      ],
      "id": "07e394c2-6759-4171-921c-d4ec17ea7da9",
      "name": "Chat Memory Manager"
    },
    {
      "parameters": {
        "description": "siempre llama a esta tool cuando debas ejecutar una tool"
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4080,
        1424
      ],
      "id": "2e5a776b-6628-42be-bda9-d930a69fa0c9",
      "name": "tool_think"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "delete",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "id": "={{ $('Webhook').first().json.body.data.msgContent.listResponseMessage.singleSelectReply.selectedRowId }}"
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        3104,
        2208
      ],
      "id": "5ffd4f5f-5a48-4bdb-8c0e-bda5642cd3b9",
      "name": "Cancelar",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=Ya cancelaste todos tus turnos"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3600,
        2304
      ],
      "id": "b60729bc-5ab7-4142-b32e-1961f80b72fa",
      "name": "Cancelar turno2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "97bcc786-58da-43a4-9ffe-659423816859",
              "leftValue": "={{ $json.Id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3296,
        2208
      ],
      "id": "21406c38-abad-49cd-bff5-4d2105c3fbeb",
      "name": "If2"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "=Id",
              "fieldValue": "={{ $('Variables globales').item.json.id_cliente }}"
            },
            {
              "fieldName": "FECHA",
              "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', `Fortamo de fecha ISO`, 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        5168,
        1424
      ],
      "id": "b25b0f0d-d35f-4974-aaae-2f4da202672d",
      "name": "tool_reagendar",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "returnAll": true,
        "options": {
          "where": "=(FECHA,eq,{{ $fromAI('FECHA','Fecha formato ISO 2025-08-06T10:00','string') }})"
        }
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        4512,
        1712
      ],
      "id": "d23c4dfb-bc91-45fc-b4a8-1f97a0bd4937",
      "name": "get_fechas",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Id",
              "fieldValue": "={{ $json.id_cliente }}"
            },
            {
              "fieldName": "CONFIRMACION_CITA",
              "fieldValue": "True"
            },
            {
              "fieldName": "RECORDATORIO_ENVIADO",
              "fieldValue": "True"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        3088,
        1680
      ],
      "id": "944f8f3a-e78b-41ee-a01b-f7d8551c2399",
      "name": "Turno confirmado",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "=5492254423359"
            },
            {
              "name": "text",
              "value": "=‚úÖ En una hora nos visita {{ $('Variables globales').item.json.clientebd.Paciente }} para {{ $('Variables globales').item.json.clientebd['0'].SERVICIO }}, acaba de confirmar el turno."
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3584,
        1680
      ],
      "id": "537fb032-66a2-4fe4-a4d7-4083a7c361fa",
      "name": "Confirmacion de turno"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=El paciente {{ $('Variables globales').item.json.clientebd.Paciente }} acaba de cancelar su turno de las {{ $('Variables globales').item.json.clientebd['0'].FECHA.split('T')[1] + ' hs' }} asique se libero este espacio"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3584,
        1872
      ],
      "id": "f642ead5-57a1-421e-924c-ab711095ec79",
      "name": "Turno eliminado"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "delete",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "id": "={{ $json.id_cliente }}"
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        3088,
        1872
      ],
      "id": "674bbceb-c4a7-415b-b8f8-b97ef1ab3266",
      "name": "DELETE TURNO",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "leftValue": "={{ $json.msg.grupo }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "id": "7f40e6df-dd87-470d-a108-679cd9e14fd6"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -848,
        1264
      ],
      "id": "b7e7807c-c9f8-49ff-80c4-229aed019831",
      "name": "Es Grupo?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "leftValue": "={{ $json.msg.from_me }}",
              "rightValue": "false",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "f0886197-f57c-431f-afe8-f597257ffddc"
            },
            {
              "id": "99bab74e-0c4c-45eb-bd1d-9418b3324a31",
              "leftValue": "={{ $json.msg.telefono }}",
              "rightValue": "=5492254423359",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ca8539e6-62e2-409d-809d-3390b730239c",
      "name": "From Me?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -576,
        1280
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "user_state",
        "key": "=user:{{ $('V1').item.json.msg.telefono }}:state",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        64,
        1232
      ],
      "id": "632a5dfc-504e-4f70-a7cf-f71366cf3670",
      "name": "Obtener Estado Usuario",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user:{{ $('V1').item.json.msg.telefono }}:state",
        "value": "active",
        "expire": true,
        "ttl": 3600
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        944,
        976
      ],
      "id": "a805cb74-e715-430e-b239-64f185b0c54a",
      "name": "Activar Usuario (24h)",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "incr",
        "key": "=user:{{ $('V1').item.json.msg.telefono }}:messages",
        "expire": true,
        "ttl": 3600
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1168,
        976
      ],
      "id": "d7cad34d-6e9e-4721-a96c-30d07721f85a",
      "name": "Contador Mensajes",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "leftValue": "={{ $json.user_state }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "f52e149b-f59b-4ea9-aa73-2ddf4e9805c2"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1008,
        1520
      ],
      "id": "582cd603-7818-43f6-885a-e5e4d6d1c8d2",
      "name": "Usuario Activo?"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "93rlsJqTd0Ntt2NC",
          "mode": "list",
          "cachedResultName": "AGENTE CITAS - GET CLIENTES"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "numero": "={{ $('V1').item.json.msg.telefono }}",
            "idTabla": "m9m2veegnrfeeza",
            "token": "3WY4UecQy9Nl522fe_DXDSHeQDVSQJpmDG7mMoFz",
            "servidor_db": "={{ $('V1').item.json.datos.server_db }}",
            "nombre_columna": "TELEFONO"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "servidor_db",
              "displayName": "servidor_db",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "idTabla",
              "displayName": "idTabla",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "token",
              "displayName": "token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nombre_columna",
              "displayName": "nombre_columna",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "pushname",
              "displayName": "pushname",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "servidor_evo",
              "displayName": "servidor_evo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "id_mensaje",
              "displayName": "id_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2080,
        1600
      ],
      "id": "bc4eb72f-26f7-4a7e-bb0d-df0147868dda",
      "name": "Validar Cliente y Continuar Bot"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message_count",
        "key": "=user:{{ $('V1').item.json.msg.telefono }}:messages",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1584,
        1504
      ],
      "id": "e1eee5e6-a541-42ae-8689-8777d6837e9e",
      "name": "Obtener Contador Mensajes",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message_count }}",
              "rightValue": 50,
              "operator": {
                "type": "number",
                "operation": "gte"
              },
              "id": "097c4f9b-deea-4907-b053-0801297931b9"
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1856,
        1504
      ],
      "id": "5a1f3766-3cfb-4e33-b864-4e83c958b2ef",
      "name": "L√≠mite Alcanzado?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('V1').item.json.datos.token }}/message/sendText/{{ $('V1').item.json.datos.token }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $('V1').item.json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "‚ö†Ô∏è Has alcanzado el l√≠mite de 50 mensajes en tu prueba.\n\nüíé Para continuar usando el bot, cont√°ctanos para obtener acceso completo."
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2080,
        1408
      ],
      "id": "2edfedbd-ce27-4c9b-b9b9-f50b99995261",
      "name": "Enviar L√≠mite Alcanzado"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f9ecf2fc-da2c-4f44-897a-5dc0a2f2f379",
              "name": "msg.telefono",
              "value": "={{ $json.body.data.key.remoteJid.replace(/\\D/g, '') }}",
              "type": "string"
            },
            {
              "id": "dab7ca54-c3d2-4a36-a9ca-a0ebbd375ef5",
              "name": "msg.pushname",
              "value": "={{ $json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "cc7dcfe1-8ad7-4fe8-93ec-8f643c7d08c7",
              "name": "msg.type",
              "value": "={{ $json.body.data.messageType }}",
              "type": "string"
            },
            {
              "id": "81612acf-1b66-4c8e-82e4-ce8c77b31334",
              "name": "msg.content",
              "value": "={{ $json?.body?.data?.msgContent?.extendedTextMessage?.contextInfo?.quotedMessage?.conversation || $json.body?.data?.msgContent?.extendedTextMessage?.text || $json?.body?.data?.fileBase64 || $json?.body?.data?.msgContent?.conversation || $json.body.data.msgContent.listResponseMessage.singleSelectReply.selectedRowId }}",
              "type": "string"
            },
            {
              "id": "01710423-6391-4a34-81e1-06d4779caf4d",
              "name": "msg.timestamp",
              "value": "={{ $json.body.data.messageTimestamp.toDateTime('s').toLocal().toISO()}}",
              "type": "string"
            },
            {
              "id": "ca81718f-74eb-4960-ac3a-5b59f39f8710",
              "name": "datos.server_db",
              "value": "https://db.qeva.xyz",
              "type": "string"
            },
            {
              "id": "7f846767-8866-43e5-845a-d1feda60451c",
              "name": "datos.token",
              "value": "B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410",
              "type": "string"
            },
            {
              "id": "b2193a26-668b-423d-9330-d3dd835f5466",
              "name": "msg.from_me",
              "value": "={{ $json.body.data.key.fromMe }}",
              "type": "string"
            },
            {
              "id": "6fedaf9c-efe8-46e5-bb61-b42525ddafa1",
              "name": "msg.grupo",
              "value": "={{ $json.body.data.isGroup }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "id": "b196eef5-02dd-47a5-88fd-171e92c0e5b2",
      "name": "V1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1104,
        1264
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "qeva",
        "options": {}
      },
      "id": "2b3c9b43-1f54-4922-b8c1-4c6c76baa741",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1472,
        1264
      ],
      "webhookId": "36468a80-94ad-4e4b-897e-732837a4a2da"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=üéâ Bienvenido a tu Asistente de Turnos odontologicos\n‚úÖ Tu prueba gratuita de 1 hora est√° activa\n\n¬øQu√© puedo hacer por ti?\n\nüìÖ Agendar - Reserva tu turno en segundos\nüîÑ Reprogramar - Cambia fecha y hora cuando lo necesites\n‚ùå Cancelar - Libera tu turno f√°cilmente\n‚è∞ Recordatorios - Te avisar√© 1 hora antes de tu cita\nüí¨ ¬øC√≥mo empezar?\n\nSimplemente escr√≠beme qu√© necesitas. Por ejemplo:\n\n\"Quiero agendar un turno\"\n\"Necesito cambiar mi cita\"\n\"Ver mis turnos programados\"\n\n‚ö° Para comenzar a utilizar el servicio luego de este mensaje hablame."
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1408,
        976
      ],
      "id": "be13cead-e52e-4316-a99d-fc4109c125cc",
      "name": "Confirmacion de turno2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "leftValue": "={{ $('V1').first().json.msg.content }}",
              "rightValue": "#inicio",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "7f40e6df-dd87-470d-a108-679cd9e14fd6"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        640,
        1040
      ],
      "id": "5a6f4370-3a8a-4a4e-8262-c2bb6714d8ab",
      "name": "Es Primera Vez y #inicio?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=‚ö†Ô∏è Para activar el bot de prueba, env√≠a #inicio"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        944,
        1184
      ],
      "id": "0d60aaaa-5ae3-49a7-91bd-6c2db6f21d7c",
      "name": "inicio"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0c476129-c2ca-4e67-bdda-dbf5708d6c4e",
              "leftValue": "={{ $json.user_state }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        336,
        1264
      ],
      "id": "17318747-8305-4adf-8465-25c235e7f708",
      "name": "If1"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "returnAll": true,
        "options": {
          "where": "=(TELEFONO,eq,{{ $('Variables globales').first().json.msg.telefono }})"
        }
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        4656,
        1680
      ],
      "id": "c36222dd-ec04-42a8-b6e0-b0f4ea0be216",
      "name": "get_turnos_agendados",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        4800,
        1632
      ],
      "id": "ab6925fd-de77-41c3-82ed-b933d0dd9613",
      "name": "get_turnos_disponibles",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "channels": "=__keyevent@0__:expired",
        "options": {
          "jsonParseBody": true,
          "onlyMessage": false
        }
      },
      "type": "n8n-nodes-base.redisTrigger",
      "typeVersion": 1,
      "position": [
        -1648,
        672
      ],
      "id": "5b399a83-8d82-4ce0-910c-b39101f6ba6e",
      "name": "Redis Trigger",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "65531767-f68e-4d48-bac5-9838136619b9",
              "leftValue": "={{ $json.message.match(/usuario:\\d+:ultimomsg/) !== null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1472,
        416
      ],
      "id": "44e54a51-c88d-4f1e-b0f8-55c9550793c8",
      "name": "If3"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=usuario:{{ $json.msg.telefono }}:ultimomsg",
        "value": "esperando",
        "expire": true,
        "ttl": 120
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -224,
        1232
      ],
      "id": "3c6ab488-2e0d-4d73-810e-6ff8df6eb84c",
      "name": "ultimoMsg",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c34ea9fc-ce79-478f-9c07-e4e6a6eed15d",
              "name": "usuario",
              "value": "={{ ($json.message.match(/usuario:(\\d+):ultimomsg/) || [])[1] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -848,
        512
      ],
      "id": "cec81e46-2730-448c-b864-dee01578dff2",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        -624,
        512
      ],
      "id": "6dc76c1d-975c-4cfe-99d6-6acde5320d1a",
      "name": "Chat Memory Manager1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e325c5b3-b99c-43da-a5c8-a478c9048312",
              "name": "msg",
              "value": "={{ $json.messages.slice(-2).map(m => 'Usuario: ' + m.human + '\\n\\nAgente: ' + m.ai).join('\\n\\n---\\n\\n') }}",
              "type": "string"
            },
            {
              "id": "98f4cd87-7d6e-4b0a-a2b3-190095da6110",
              "name": "telefono",
              "value": "={{ $('Edit Fields').item.json.usuario }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -272,
        512
      ],
      "id": "78a76b56-6432-48a7-b498-3ffa365a3399",
      "name": "limpiamos msg"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Conversacion previa: {{ $json.msg }}",
        "options": {
          "systemMessage": "=# PROMPT PARA SUB-AGENTE DE CONTINUIDAD DE CONVERSACI√ìN\n\n## REGLA ABSOLUTA:\n**SOLO devuelve \"FINALIZADO\" si el usuario se despidi√≥ expl√≠citamente con palabras como:**\n- \"chau\", \"adi√≥s\", \"hasta luego\", \"no gracias\", \"no necesito nada m√°s\", \"listo, gracias\"\n\n**EN TODOS LOS DEM√ÅS CASOS ‚Üí Genera un mensaje de seguimiento personalizado**\n\n## INSTRUCCIONES PASO A PASO:\n\n### PASO 1: Analiza los √∫ltimos mensajes\n- Lee el √∫ltimo mensaje del agente\n- Lee el √∫ltimo mensaje del usuario (si existe)\n\n### PASO 2: Decide qu√© responder\n\n#### CASO A: Si hay despedida expl√≠cita del usuario\n‚Üí Responde: FINALIZADO\n\n#### CASO B: TODO LO DEM√ÅS (99% de los casos)\n‚Üí Crea un mensaje corto y personalizado que:\n- Continue donde qued√≥ la conversaci√≥n\n- NO repita informaci√≥n ya dicha\n- NO repita saludos ni presentaciones\n- Sea directo y vaya al punto\n\n## EJEMPLOS DE MENSAJES PERSONALIZADOS:\n\n### Situaci√≥n 1: Agente salud√≥, usuario no respondi√≥\n- Agente: \"¬°Hola! Soy Juli. ¬øEn qu√© puedo ayudarte?\"\n- Usuario: (sin respuesta)\n‚Üí **Mensaje:** \"¬øNecesit√°s agendar un turno o consultar algo?\"\n\n### Situaci√≥n 2: Usuario pidi√≥ turno\n- Usuario: \"quiero un turno\"\n‚Üí **Mensaje:** \"¬øPara qu√© tratamiento lo necesit√°s?\"\n\n### Situaci√≥n 3: Usuario dio su nombre\n- Usuario: \"Mar√≠a\"\n‚Üí **Mensaje:** \"Perfecto Mar√≠a, ¬øqu√© servicio necesit√°s?\"\n\n### Situaci√≥n 4: Usuario eligi√≥ d√≠a\n- Usuario: \"el martes\"\n‚Üí **Mensaje:** \"¬øEn qu√© horario del martes te queda mejor?\"\n\n### Situaci√≥n 5: Pregunta sin responder\n- Agente: \"¬øQu√© d√≠a prefer√≠s?\"\n- Usuario: (sin respuesta)\n‚Üí **Mensaje:** \"¬øQu√© d√≠a te queda mejor para el turno?\"\n\n### Situaci√≥n 6: Usuario dijo \"ok\" o respuesta corta\n- Usuario: \"ok\"\n‚Üí **Mensaje:** \"¬øNecesit√°s algo m√°s o agendamos el turno?\"\n\n## FORMATO DE RESPUESTA:\n\n**Opci√≥n 1:** FINALIZADO (solo si hay despedida expl√≠cita)\n\n**Opci√≥n 2:** [Tu mensaje personalizado de 1-2 l√≠neas]\n\n## ERRORES A EVITAR:\n‚ùå NO repitas \"Hola, soy Juli\" si ya lo dijiste\n‚ùå NO uses \"disculpa la demora\"\n‚ùå NO menciones el tiempo\n‚ùå NO repitas la misma pregunta con las mismas palabras\n‚ùå NO devuelvas FINALIZADO sin despedida expl√≠cita\n\n## RECUERDA:\n- El 99% de las veces debes generar un mensaje personalizado\n- FINALIZADO es la excepci√≥n, no la regla\n- Si dudas ‚Üí genera un mensaje de seguimiento\n- Analiza el contexto y contin√∫a naturalmente"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -48,
        512
      ],
      "id": "beda6fdb-dd90-451c-ad01-d00cbfaf6b32",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -144,
        736
      ],
      "id": "1a3a0999-9a3d-4f13-8c3e-2de71a8c8fe5",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "ADdm45cFSIFSG59w",
          "name": "Gemini"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "=5492254596618"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7184,
        1824
      ],
      "id": "48cf9188-2e11-4325-93c9-ef32c3a3e803",
      "name": "send msg"
    },
    {
      "parameters": {
        "batchSize": "=1",
        "options": {
          "reset": false
        }
      },
      "id": "2f41d35d-57b0-432f-9bb6-4d0edcf8e58b",
      "name": "Loop Over Items1",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        976,
        512
      ],
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "fieldToSplitOut": "messages",
        "options": {}
      },
      "id": "7a3a80ce-2ec1-4796-89e9-2706db70be7d",
      "name": "Split Out1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        752,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "// --- Funciones de procesamiento de texto ---\n\n// Funci√≥n para dividir texto en fragmentos con tiempo de lectura\nfunction splitTextIntoChunks(text, maxChars = 200) {\n  // Si el texto es muy corto, devolvemos un solo fragmento\n  if (!text || text.length <= maxChars) {\n    return [{\n      parte: 1,\n      texto: text || '',\n      time: calculateReadingTime(text || '')\n    }];\n  }\n\n  const chunks = [];\n  let currentChunk = '';\n  let partNumber = 1;\n  \n  // Dividimos por palabras para no cortar palabras a la mitad\n  const words = text.split(' ');\n  \n  for (let i = 0; i < words.length; i++) {\n    const word = words[i];\n    const potentialChunk = currentChunk ? currentChunk + ' ' + word : word;\n    \n    // Si agregar la siguiente palabra excede el l√≠mite\n    if (potentialChunk.length > maxChars) {\n      // Si la palabra sola es m√°s larga que maxChars, la cortamos\n      if (word.length > maxChars) {\n        // Guardamos el chunk actual si tiene contenido\n        if (currentChunk) {\n          chunks.push({\n            parte: partNumber++,\n            texto: currentChunk.trim(),\n            time: calculateReadingTime(currentChunk.trim())\n          });\n        }\n        \n        // Cortamos la palabra larga en pedazos\n        let remainingWord = word;\n        while (remainingWord.length > maxChars) {\n          chunks.push({\n            parte: partNumber++,\n            texto: remainingWord.substring(0, maxChars),\n            time: calculateReadingTime(remainingWord.substring(0, maxChars))\n          });\n          remainingWord = remainingWord.substring(maxChars);\n        }\n        \n        // El resto de la palabra se convierte en el nuevo currentChunk\n        currentChunk = remainingWord;\n      } else {\n        // Guardamos el chunk actual y empezamos uno nuevo con esta palabra\n        chunks.push({\n          parte: partNumber++,\n          texto: currentChunk.trim(),\n          time: calculateReadingTime(currentChunk.trim())\n        });\n        currentChunk = word;\n      }\n    } else {\n      // Si cabe, agregamos la palabra al chunk actual\n      currentChunk = potentialChunk;\n    }\n  }\n  \n  // Agregar el √∫ltimo chunk si queda algo\n  if (currentChunk.trim()) {\n    chunks.push({\n      parte: partNumber,\n      texto: currentChunk.trim(),\n      time: calculateReadingTime(currentChunk.trim())\n    });\n  }\n  \n  return chunks;\n}\n\n// Funci√≥n para calcular el tiempo de lectura basado en la longitud del texto\nfunction calculateReadingTime(text) {\n  const length = text.length;\n  \n  if (length > 150) {\n    return 4; // segundos\n  } else if (length >= 50) {\n    return 3; // segundos\n  } else {\n    return 1; // segundo\n  }\n}\n\n// Funci√≥n para determinar si un texto necesita ser dividido\nfunction needsSplitting(text) {\n  if (!text || typeof text !== 'string') return false;\n  \n  // Criterios: m√°s de 500 caracteres o m√°s de 100 palabras\n  const charCount = text.length;\n  const wordCount = text.split(/\\s+/).filter(word => word.length > 0).length;\n  \n  return charCount > 500 || wordCount > 100;\n}\n\n// Funci√≥n para procesar el texto y dividirlo inteligentemente (funci√≥n original mejorada)\nfunction processAndSplitText(textInput) {\n  // Aseg√∫rate de que textInput sea un string o pueda ser convertido\n  let text = textInput;\n\n  // Si la entrada no es un string\n  if (typeof text !== 'string') {\n    // Si es null o undefined, simplemente devolvemos un array vac√≠o\n    if (text === null || text === undefined) {\n      return [];\n    }\n\n    // Si es un objeto, intentamos encontrar campos comunes que contengan texto\n    if (typeof text === 'object') {\n      if (text.text) {\n        text = text.text;\n      } else if (text.message) {\n        text = text.message;\n      } else if (text.type === 'text' && text.text) {\n        text = text.text;\n      } else if (text.output) {\n        // Si output es un string, lo usamos\n        if (typeof text.output === 'string') {\n          text = text.output;\n        } else {\n          // Si output es un objeto o array, intentamos extraer de ah√≠\n          const extracted = extractTextContent(text.output);\n          if (extracted) {\n            text = extracted;\n          } else {\n            // Si no pudimos extraer, intentamos convertir todo el objeto a string\n            try {\n              text = JSON.stringify(text);\n            } catch (e) {\n              console.error(\"No se pudo serializar el objeto a string:\", e);\n              return [];\n            }\n          }\n        }\n      } else {\n        // Si no encontramos campos de texto comunes ni 'output', intentamos convertir a string\n        try {\n          text = JSON.stringify(text);\n        } catch (e) {\n          console.error(\"No se pudo serializar el objeto a string:\", e);\n          return [];\n        }\n      }\n    } else {\n      // Si no es string, objeto, null o undefined, devolvemos vac√≠o\n      console.warn(\"Entrada a processAndSplitText no es string, objeto, null o undefined:\", typeof text);\n      return [];\n    }\n  }\n\n  // Si despu√©s de los intentos no tenemos un string v√°lido, devolvemos vac√≠o\n  if (typeof text !== 'string' || text.trim() === '') {\n    return [];\n  }\n\n  // Ahora que tenemos un string, procesamos el formato\n  const processedText = text\n    .replace(/\\*\\*(.+?)\\*\\*/g, '*$1*') // **texto** -> *texto*\n    .replace(/###\\s*/g, '')         // Elimina encabezados ###\n    .replace(/[¬°¬ø!]/g, '');         // Elimina signos de exclamaci√≥n e interrogaci√≥n iniciales y finales\n\n  // Divide en l√≠neas para an√°lisis\n  const lines = processedText.split('\\n');\n\n  // Grupos para almacenar los mensajes\n  const messages = [];\n  let currentMessage = [];\n  let inNumberedSection = false;\n  let currentSectionNumber = null;\n\n  // Detectar secciones numeradas y agrupables\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    // Detecta si la l√≠nea es un encabezado numerado (ej: \"1. Tipo de propiedad:\")\n    const numberedHeaderMatch = line.match(/^\\s*(\\d+)\\.\\s+([^:]+):/);\n\n    if (numberedHeaderMatch) {\n      const sectionNumber = parseInt(numberedHeaderMatch[1]);\n\n      // Si estamos empezando una nueva secci√≥n numerada O si el n√∫mero no es el siguiente esperado\n      if (!inNumberedSection || (inNumberedSection && sectionNumber !== currentSectionNumber + 1)) {\n        // Si tenemos contenido previo, guardamos como mensaje separado\n        if (currentMessage.length > 0) {\n          messages.push(currentMessage.join('\\n').trim());\n          currentMessage = [];\n        }\n        inNumberedSection = true;\n      }\n      currentSectionNumber = sectionNumber;\n      currentMessage.push(line);\n\n    } else if (line.trim() === '') {\n      // Una l√≠nea vac√≠a puede terminar una secci√≥n si hay contenido previo\n      if (currentMessage.length > 0) {\n        // Si no estamos en una secci√≥n numerada, una l√≠nea vac√≠a termina el mensaje actual\n        if (!inNumberedSection) {\n          messages.push(currentMessage.join('\\n').trim());\n          currentMessage = [];\n        } else {\n          // Si estamos en una secci√≥n numerada, una l√≠nea vac√≠a se agrega al mensaje actual\n          currentMessage.push(line);\n        }\n      }\n\n    } else {\n      // L√≠nea con contenido que no es un encabezado numerado\n      currentMessage.push(line);\n      inNumberedSection = false;\n    }\n  }\n\n  // Agregar el √∫ltimo mensaje si queda algo\n  if (currentMessage.length > 0) {\n    messages.push(currentMessage.join('\\n').trim());\n  }\n\n  // Filtrar mensajes vac√≠os y limpiar l√≠neas vac√≠as extra\n  return messages\n    .filter(msg => msg.length > 0)\n    .map(msg => {\n      // Eliminar l√≠neas vac√≠as m√∫ltiples dentro del mensaje\n      return msg.replace(/\\n{2,}/g, '\\n\\n');\n    });\n}\n\n// Funci√≥n para extraer texto de diferentes estructuras de datos\nfunction extractTextContent(data) {\n  // Si la data es null o undefined, retornamos null inmediatamente\n  if (data === null || data === undefined) {\n    return null;\n  }\n\n  // Si es un string, lo retornamos directamente\n  if (typeof data === 'string') {\n    return data;\n  }\n\n  // Si es un array\n  if (Array.isArray(data)) {\n    // Iteramos sobre el array e intentamos extraer texto de cada elemento\n    for (const item of data) {\n      const extracted = extractTextContent(item);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    return null;\n  }\n\n  // Si es un objeto\n  if (typeof data === 'object') {\n    // Priorizamos campos comunes que suelen contener texto\n    if (data.text) {\n      return data.text;\n    }\n    if (data.message) {\n      return data.message;\n    }\n    // Si tiene un campo 'output', intentamos extraer texto de √©l\n    if (data.output !== undefined && data.output !== null) {\n      const extracted = extractTextContent(data.output);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si tiene un campo 'response', intentamos extraer texto de √©l\n    if (data.response !== undefined && data.response !== null) {\n      const extracted = extractTextContent(data.response);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si tiene un campo 'json', intentamos extraer texto de √©l\n    if (data.json !== undefined && data.json !== null) {\n      const extracted = extractTextContent(data.json);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si no encontramos campos de texto comunes ni estructuras anidadas esperadas,\n    // intentamos convertir el objeto completo a string como √∫ltimo recurso\n    try {\n      return JSON.stringify(data);\n    } catch (e) {\n      console.error(\"No se pudo serializar el objeto a string en extractTextContent:\", e);\n      return null;\n    }\n  }\n\n  // Si el tipo de dato no es manejado, retornamos null\n  console.warn(\"Tipo de dato no manejado en extractTextContent:\", typeof data);\n  return null;\n}\n\n// --- L√≥gica Principal con manejo seguro de nodos ---\nlet textToProcess = null;\n\ntry {\n  // Verificar si el nodo \"Cancelar evento\" existe y tiene datos\n  let cancelarEventoData = null;\n  try {\n    // Usamos try-catch para capturar errores si el nodo no existe\n    cancelarEventoData = $('Cancelar evento');\n    if (cancelarEventoData && cancelarEventoData.first() && cancelarEventoData.first().json) {\n      if (cancelarEventoData.first().json.response !== undefined) {\n        textToProcess = extractTextContent(cancelarEventoData.first().json.response);\n      } else {\n        textToProcess = extractTextContent(cancelarEventoData.first().json);\n      }\n    }\n  } catch (e) {\n    // Silenciosamente ignoramos errores si el nodo no existe\n    console.log(\"Nodo 'Cancelar evento' no disponible o sin datos v√°lidos\");\n  }\n  \n  // Solo intentamos acceder a AGE3 si a√∫n no hemos encontrado texto para procesar\n  if (!textToProcess) {\n    try {\n      // Usamos try-catch para capturar errores si el nodo no existe\n      const age3Data = $('AGE3');\n      if (age3Data && age3Data.first() && age3Data.first().json) {\n        if (age3Data.first().json.output !== undefined) {\n          textToProcess = extractTextContent(age3Data.first().json.output);\n        } else {\n          textToProcess = extractTextContent(age3Data.first().json);\n        }\n      }\n    } catch (e) {\n      // Silenciosamente ignoramos errores si el nodo no existe\n      console.log(\"Nodo 'AGE3' no disponible o sin datos v√°lidos\");\n    }\n  }\n  \n  // Si no hemos encontrado datos en los nodos espec√≠ficos, intentamos con $input directamente\n  if (!textToProcess) {\n    try {\n      const inputItems = $input.all();\n      if (inputItems && inputItems.length > 0 && inputItems[0].json) {\n        textToProcess = extractTextContent(inputItems[0].json);\n      }\n    } catch (e) {\n      console.log(\"No se pudo acceder a los datos de entrada directamente:\", e.message);\n    }\n  }\n  \n  // Procesar y retornar el resultado\n  if (textToProcess) {\n    const textArray = processAndSplitText(textToProcess);\n    \n    // Procesar cada mensaje y dividirlo en chunks si es necesario\n    const processedMessages = [];\n    \n    for (const message of textArray) {\n      if (needsSplitting(message)) {\n        // Si el mensaje es largo, lo dividimos en chunks\n        const chunks = splitTextIntoChunks(message);\n        processedMessages.push(...chunks);\n      } else {\n        // Si el mensaje es corto, lo agregamos tal cual con tiempo de lectura\n        processedMessages.push({\n          parte: processedMessages.length + 1,\n          texto: message,\n          time: calculateReadingTime(message)\n        });\n      }\n    }\n    \n    // Re-numerar las partes para que sean consecutivas\n    processedMessages.forEach((msg, index) => {\n      msg.parte = index + 1;\n    });\n    \n    // Devolvemos la estructura con los mensajes procesados\n    return [{json: {messages: processedMessages, totalParts: processedMessages.length}}];\n  } else {\n    // Si no se pudo obtener ni procesar texto, devolvemos un array vac√≠o\n    return [{json: {messages: [], totalParts: 0}}];\n  }\n} catch (error) {\n  // Capturamos cualquier error no manejado y devolvemos un objeto con informaci√≥n del error\n  console.error(\"Error general en el nodo:\", error.message);\n  return [{json: {messages: [], totalParts: 0, error: error.message}}];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        512
      ],
      "id": "ee77de87-ef7a-4796-95cb-db19d4b9d971",
      "name": "Separa datos1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('limpiamos msg').item.json.telefono }}"
            },
            {
              "name": "text",
              "value": "={{ $('Loop Over Items1').item.json.texto }}"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1648,
        512
      ],
      "id": "fd9c15e5-e95f-4c5c-9049-1c8d43011bb1",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1424,
        432
      ],
      "id": "4f400e09-8901-4a6b-825b-24da93a86eef",
      "name": "Wait1",
      "webhookId": "aa8c0ee9-ac10-4c70-9b62-1402bc6d08f5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/presence",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "status",
              "value": "composing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1200,
        432
      ],
      "id": "e6941787-394c-43c3-8d07-9c2ce0acc0e6",
      "name": "escribiendo...1",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0b7bfc46-f915-40ce-b3d8-c4942809f4f1",
              "leftValue": "={{ $json.output }}",
              "rightValue": "FINALIZADO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        304,
        512
      ],
      "id": "5a649ea2-2cdf-490f-830f-912866536031",
      "name": "If4"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=user:{{ $('Edit Fields').item.json.usuario }}",
        "sessionTTL": 600
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        64,
        736
      ],
      "id": "d9bed46b-7ada-4a13-8a53-98e0f8ee2e1f",
      "name": "memory2",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Edit Fields').item.json.usuario }}",
        "sessionTTL": 1800
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        -736,
        784
      ],
      "id": "8569111f-cf16-4e6b-acda-8b8d834a11bf",
      "name": "memory",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b9c23b07-71b1-4888-849a-09ecb880aa5e",
                    "leftValue": "={{ $json.message.match(/usuario:\\d+:ultimomsg/) !== null }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Usuario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f68e054f-389b-4cec-a32a-c922fe60c99f",
                    "leftValue": "={{ $json.message.match(/user:\\d+:status/) !== null }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Reinicio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1344,
        672
      ],
      "id": "4dba5bf4-6ea8-4846-be05-f9dd14a2c2e2",
      "name": "Switch"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xe636258b15/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('limpiamos msg').item.json.telefono }}"
            },
            {
              "name": "text",
              "value": "={{ $('Loop Over Items1').item.json.texto }}"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -848,
        928
      ],
      "id": "6d28e24c-6f3f-4781-9a3b-b6628fa37c1e",
      "name": "HTTP Request1",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c34ea9fc-ce79-478f-9c07-e4e6a6eed15d",
              "name": "usuario",
              "value": "={{ ($json.message.match(/user:(\\d+):state/) || [])[1] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1136,
        816
      ],
      "id": "2f2424d5-77f1-44ef-9e52-6395840847d8",
      "name": "Edit Fields1"
    }
  ],
  "pinData": {
    "send msg": [
      {
        "json": {
          "status": 200,
          "data": {
            "key": {
              "remoteJid": "5492254596618@s.whatsapp.net",
              "fromMe": true,
              "id": "3EB08D773BB92FED68E171"
            },
            "message": {
              "extendedTextMessage": {
                "text": "‚è∞ *Tu per√≠odo de prueba ha finalizado*\n\nGracias por probar nuestro servicio! üôè\n\nEsperamos que hayas disfrutado de la experiencia. Si deseas continuar utilizando todas las funcionalidades, estaremos encantados de ayudarte.\n\nüìß *C√≥mo continuar?*\n- Cont√°ctanos por WhatsApp: +5492254423359\n- Env√≠anos un email: qeva.ai.solutionse@gmail.com\n- Visita nuestra web: www.web.qeva.xyz\n\nEsperamos verte pronto de vuelta! üöÄ"
              }
            },
            "messageTimestamp": "1754956315",
            "status": "PENDING"
          }
        }
      }
    ],
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8nw.qeva.xyz",
            "user-agent": "axios/1.11.0",
            "content-length": "751",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "instance-key": "2522xe636258b15",
            "x-forwarded-for": "144.126.133.227",
            "x-forwarded-host": "n8nw.qeva.xyz",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "7697b68d06c2",
            "x-real-ip": "144.126.133.227"
          },
          "params": {},
          "query": {},
          "body": {
            "instance": "2522xe636258b15",
            "type": "message",
            "data": {
              "messageId": "471184CDDC84B51BABC2A436B09BE34C",
              "jid": "5492254596618:41@s.whatsapp.net",
              "me": false,
              "isGroup": false,
              "remoteJid": "5492254423359",
              "pushName": "Fer { }",
              "key": {
                "remoteJid": "5492254423359@s.whatsapp.net",
                "fromMe": false,
                "id": "471184CDDC84B51BABC2A436B09BE34C"
              },
              "messageType": "conversation",
              "msgContent": {
                "conversation": "Hola",
                "messageContextInfo": {
                  "deviceListMetadata": {
                    "senderKeyHash": "mdrt64lZPf3MFg==",
                    "senderTimestamp": "1754931188",
                    "recipientKeyHash": "10c53GxlYru2XA==",
                    "recipientTimestamp": "1755092178"
                  },
                  "deviceListMetadataVersion": 2,
                  "messageSecret": "LAhnN/wBc6/9/LDp8cxDABGzHpwlwGhudCQ4vdbjiK4="
                }
              },
              "messageTimestamp": 1755092424,
              "source": "android",
              "broadcast": false,
              "isMedia": false
            }
          },
          "webhookUrl": "https://n8nw.qeva.xyz/webhook/qeva",
          "executionMode": "production"
        }
      }
    ],
    "Redis Trigger": [
      {
        "json": {
          "channel": "__keyevent@0__:expired",
          "message": "usuario:5492254423359:ultimomsg"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "errorWorkflow": "EBMwLGTBawYqkZM1",
    "timezone": "America/Argentina/Buenos_Aires",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2025-08-13T14:07:27.430Z",
  "versionId": "a3082568-8e19-404e-8358-565c4e35dd59"
}