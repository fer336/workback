{
  "active": true,
  "connections": {
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "escribiendo...",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Separa datos": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message Type": {
      "main": [
        [
          {
            "node": "Encolado de msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Encolado de msg",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Encolado de msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "chatInput",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Elimina la cita - Reagendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Cliente": {
      "main": [
        [
          {
            "node": "Variables globales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Encolado de msg": {
      "main": [
        [
          {
            "node": "Sort",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "chatInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "chatInput": {
      "main": [
        [
          {
            "node": "Juli",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Variables globales": {
      "main": [
        [
          {
            "node": "Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "From Me2": {
      "main": [
        [
          {
            "node": "Validar Cliente",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "V1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "Separa datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [],
        [
          {
            "node": "From Me2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "CreateCITA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreateCITA": {
      "main": [
        [
          {
            "node": "Turno creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Juli": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Turno creado": {
      "main": [
        []
      ]
    },
    "escribiendo...": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tool_agendar": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "tool_cancelar": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "get_paciente": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "gemini2": {
      "ai_languageModel": [
        [
          {
            "node": "Juli",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "memory1": {
      "ai_memory": [
        [
          {
            "node": "Juli",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Chat Memory Manager",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Elimina la cita - Reagendar": {
      "main": [
        [
          {
            "node": "Cancelar turno1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar turno": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar turno1": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tool_think": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "V1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Cancelar turno",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar turno2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar turno2": {
      "main": [
        [
          {
            "node": "Chat Memory Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "tool_reagendar": {
      "ai_tool": [
        [
          {
            "node": "Juli",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-31T09:00:57.428Z",
  "id": "Ock4eXE54PXnyjTD",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "AGENTE CITAS - MASTER testing 2",
  "nodes": [
    {
      "parameters": {
        "batchSize": "=1",
        "options": {
          "reset": false
        }
      },
      "id": "3404dd74-b136-4181-880a-ad78dbbbc6f8",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        6128,
        864
      ],
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "fieldToSplitOut": "messages",
        "options": {}
      },
      "id": "96d845be-462a-4390-b283-7ce8b1372dc4",
      "name": "Split Out",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        5616,
        912
      ]
    },
    {
      "parameters": {
        "jsCode": "// --- Funciones de procesamiento de texto ---\n\n// Función para dividir texto en fragmentos con tiempo de lectura\nfunction splitTextIntoChunks(text, maxChars = 200) {\n  // Si el texto es muy corto, devolvemos un solo fragmento\n  if (!text || text.length <= maxChars) {\n    return [{\n      parte: 1,\n      texto: text || '',\n      time: calculateReadingTime(text || '')\n    }];\n  }\n\n  const chunks = [];\n  let currentChunk = '';\n  let partNumber = 1;\n  \n  // Dividimos por palabras para no cortar palabras a la mitad\n  const words = text.split(' ');\n  \n  for (let i = 0; i < words.length; i++) {\n    const word = words[i];\n    const potentialChunk = currentChunk ? currentChunk + ' ' + word : word;\n    \n    // Si agregar la siguiente palabra excede el límite\n    if (potentialChunk.length > maxChars) {\n      // Si la palabra sola es más larga que maxChars, la cortamos\n      if (word.length > maxChars) {\n        // Guardamos el chunk actual si tiene contenido\n        if (currentChunk) {\n          chunks.push({\n            parte: partNumber++,\n            texto: currentChunk.trim(),\n            time: calculateReadingTime(currentChunk.trim())\n          });\n        }\n        \n        // Cortamos la palabra larga en pedazos\n        let remainingWord = word;\n        while (remainingWord.length > maxChars) {\n          chunks.push({\n            parte: partNumber++,\n            texto: remainingWord.substring(0, maxChars),\n            time: calculateReadingTime(remainingWord.substring(0, maxChars))\n          });\n          remainingWord = remainingWord.substring(maxChars);\n        }\n        \n        // El resto de la palabra se convierte en el nuevo currentChunk\n        currentChunk = remainingWord;\n      } else {\n        // Guardamos el chunk actual y empezamos uno nuevo con esta palabra\n        chunks.push({\n          parte: partNumber++,\n          texto: currentChunk.trim(),\n          time: calculateReadingTime(currentChunk.trim())\n        });\n        currentChunk = word;\n      }\n    } else {\n      // Si cabe, agregamos la palabra al chunk actual\n      currentChunk = potentialChunk;\n    }\n  }\n  \n  // Agregar el último chunk si queda algo\n  if (currentChunk.trim()) {\n    chunks.push({\n      parte: partNumber,\n      texto: currentChunk.trim(),\n      time: calculateReadingTime(currentChunk.trim())\n    });\n  }\n  \n  return chunks;\n}\n\n// Función para calcular el tiempo de lectura basado en la longitud del texto\nfunction calculateReadingTime(text) {\n  const length = text.length;\n  \n  if (length > 150) {\n    return 4; // segundos\n  } else if (length >= 50) {\n    return 3; // segundos\n  } else {\n    return 1; // segundo\n  }\n}\n\n// Función para determinar si un texto necesita ser dividido\nfunction needsSplitting(text) {\n  if (!text || typeof text !== 'string') return false;\n  \n  // Criterios: más de 500 caracteres o más de 100 palabras\n  const charCount = text.length;\n  const wordCount = text.split(/\\s+/).filter(word => word.length > 0).length;\n  \n  return charCount > 500 || wordCount > 100;\n}\n\n// Función para procesar el texto y dividirlo inteligentemente (función original mejorada)\nfunction processAndSplitText(textInput) {\n  // Asegúrate de que textInput sea un string o pueda ser convertido\n  let text = textInput;\n\n  // Si la entrada no es un string\n  if (typeof text !== 'string') {\n    // Si es null o undefined, simplemente devolvemos un array vacío\n    if (text === null || text === undefined) {\n      return [];\n    }\n\n    // Si es un objeto, intentamos encontrar campos comunes que contengan texto\n    if (typeof text === 'object') {\n      if (text.text) {\n        text = text.text;\n      } else if (text.message) {\n        text = text.message;\n      } else if (text.type === 'text' && text.text) {\n        text = text.text;\n      } else if (text.output) {\n        // Si output es un string, lo usamos\n        if (typeof text.output === 'string') {\n          text = text.output;\n        } else {\n          // Si output es un objeto o array, intentamos extraer de ahí\n          const extracted = extractTextContent(text.output);\n          if (extracted) {\n            text = extracted;\n          } else {\n            // Si no pudimos extraer, intentamos convertir todo el objeto a string\n            try {\n              text = JSON.stringify(text);\n            } catch (e) {\n              console.error(\"No se pudo serializar el objeto a string:\", e);\n              return [];\n            }\n          }\n        }\n      } else {\n        // Si no encontramos campos de texto comunes ni 'output', intentamos convertir a string\n        try {\n          text = JSON.stringify(text);\n        } catch (e) {\n          console.error(\"No se pudo serializar el objeto a string:\", e);\n          return [];\n        }\n      }\n    } else {\n      // Si no es string, objeto, null o undefined, devolvemos vacío\n      console.warn(\"Entrada a processAndSplitText no es string, objeto, null o undefined:\", typeof text);\n      return [];\n    }\n  }\n\n  // Si después de los intentos no tenemos un string válido, devolvemos vacío\n  if (typeof text !== 'string' || text.trim() === '') {\n    return [];\n  }\n\n  // Ahora que tenemos un string, procesamos el formato\n  const processedText = text\n    .replace(/\\*\\*(.+?)\\*\\*/g, '*$1*') // **texto** -> *texto*\n    .replace(/###\\s*/g, '')         // Elimina encabezados ###\n    .replace(/[¡¿!]/g, '');         // Elimina signos de exclamación e interrogación iniciales y finales\n\n  // Divide en líneas para análisis\n  const lines = processedText.split('\\n');\n\n  // Grupos para almacenar los mensajes\n  const messages = [];\n  let currentMessage = [];\n  let inNumberedSection = false;\n  let currentSectionNumber = null;\n\n  // Detectar secciones numeradas y agrupables\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    // Detecta si la línea es un encabezado numerado (ej: \"1. Tipo de propiedad:\")\n    const numberedHeaderMatch = line.match(/^\\s*(\\d+)\\.\\s+([^:]+):/);\n\n    if (numberedHeaderMatch) {\n      const sectionNumber = parseInt(numberedHeaderMatch[1]);\n\n      // Si estamos empezando una nueva sección numerada O si el número no es el siguiente esperado\n      if (!inNumberedSection || (inNumberedSection && sectionNumber !== currentSectionNumber + 1)) {\n        // Si tenemos contenido previo, guardamos como mensaje separado\n        if (currentMessage.length > 0) {\n          messages.push(currentMessage.join('\\n').trim());\n          currentMessage = [];\n        }\n        inNumberedSection = true;\n      }\n      currentSectionNumber = sectionNumber;\n      currentMessage.push(line);\n\n    } else if (line.trim() === '') {\n      // Una línea vacía puede terminar una sección si hay contenido previo\n      if (currentMessage.length > 0) {\n        // Si no estamos en una sección numerada, una línea vacía termina el mensaje actual\n        if (!inNumberedSection) {\n          messages.push(currentMessage.join('\\n').trim());\n          currentMessage = [];\n        } else {\n          // Si estamos en una sección numerada, una línea vacía se agrega al mensaje actual\n          currentMessage.push(line);\n        }\n      }\n\n    } else {\n      // Línea con contenido que no es un encabezado numerado\n      currentMessage.push(line);\n      inNumberedSection = false;\n    }\n  }\n\n  // Agregar el último mensaje si queda algo\n  if (currentMessage.length > 0) {\n    messages.push(currentMessage.join('\\n').trim());\n  }\n\n  // Filtrar mensajes vacíos y limpiar líneas vacías extra\n  return messages\n    .filter(msg => msg.length > 0)\n    .map(msg => {\n      // Eliminar líneas vacías múltiples dentro del mensaje\n      return msg.replace(/\\n{2,}/g, '\\n\\n');\n    });\n}\n\n// Función para extraer texto de diferentes estructuras de datos\nfunction extractTextContent(data) {\n  // Si la data es null o undefined, retornamos null inmediatamente\n  if (data === null || data === undefined) {\n    return null;\n  }\n\n  // Si es un string, lo retornamos directamente\n  if (typeof data === 'string') {\n    return data;\n  }\n\n  // Si es un array\n  if (Array.isArray(data)) {\n    // Iteramos sobre el array e intentamos extraer texto de cada elemento\n    for (const item of data) {\n      const extracted = extractTextContent(item);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    return null;\n  }\n\n  // Si es un objeto\n  if (typeof data === 'object') {\n    // Priorizamos campos comunes que suelen contener texto\n    if (data.text) {\n      return data.text;\n    }\n    if (data.message) {\n      return data.message;\n    }\n    // Si tiene un campo 'output', intentamos extraer texto de él\n    if (data.output !== undefined && data.output !== null) {\n      const extracted = extractTextContent(data.output);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si tiene un campo 'response', intentamos extraer texto de él\n    if (data.response !== undefined && data.response !== null) {\n      const extracted = extractTextContent(data.response);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si tiene un campo 'json', intentamos extraer texto de él\n    if (data.json !== undefined && data.json !== null) {\n      const extracted = extractTextContent(data.json);\n      if (extracted) {\n        return extracted;\n      }\n    }\n    // Si no encontramos campos de texto comunes ni estructuras anidadas esperadas,\n    // intentamos convertir el objeto completo a string como último recurso\n    try {\n      return JSON.stringify(data);\n    } catch (e) {\n      console.error(\"No se pudo serializar el objeto a string en extractTextContent:\", e);\n      return null;\n    }\n  }\n\n  // Si el tipo de dato no es manejado, retornamos null\n  console.warn(\"Tipo de dato no manejado en extractTextContent:\", typeof data);\n  return null;\n}\n\n// --- Lógica Principal con manejo seguro de nodos ---\nlet textToProcess = null;\n\ntry {\n  // Verificar si el nodo \"Cancelar evento\" existe y tiene datos\n  let cancelarEventoData = null;\n  try {\n    // Usamos try-catch para capturar errores si el nodo no existe\n    cancelarEventoData = $('Cancelar evento');\n    if (cancelarEventoData && cancelarEventoData.first() && cancelarEventoData.first().json) {\n      if (cancelarEventoData.first().json.response !== undefined) {\n        textToProcess = extractTextContent(cancelarEventoData.first().json.response);\n      } else {\n        textToProcess = extractTextContent(cancelarEventoData.first().json);\n      }\n    }\n  } catch (e) {\n    // Silenciosamente ignoramos errores si el nodo no existe\n    console.log(\"Nodo 'Cancelar evento' no disponible o sin datos válidos\");\n  }\n  \n  // Solo intentamos acceder a AGE3 si aún no hemos encontrado texto para procesar\n  if (!textToProcess) {\n    try {\n      // Usamos try-catch para capturar errores si el nodo no existe\n      const age3Data = $('AGE3');\n      if (age3Data && age3Data.first() && age3Data.first().json) {\n        if (age3Data.first().json.output !== undefined) {\n          textToProcess = extractTextContent(age3Data.first().json.output);\n        } else {\n          textToProcess = extractTextContent(age3Data.first().json);\n        }\n      }\n    } catch (e) {\n      // Silenciosamente ignoramos errores si el nodo no existe\n      console.log(\"Nodo 'AGE3' no disponible o sin datos válidos\");\n    }\n  }\n  \n  // Si no hemos encontrado datos en los nodos específicos, intentamos con $input directamente\n  if (!textToProcess) {\n    try {\n      const inputItems = $input.all();\n      if (inputItems && inputItems.length > 0 && inputItems[0].json) {\n        textToProcess = extractTextContent(inputItems[0].json);\n      }\n    } catch (e) {\n      console.log(\"No se pudo acceder a los datos de entrada directamente:\", e.message);\n    }\n  }\n  \n  // Procesar y retornar el resultado\n  if (textToProcess) {\n    const textArray = processAndSplitText(textToProcess);\n    \n    // Procesar cada mensaje y dividirlo en chunks si es necesario\n    const processedMessages = [];\n    \n    for (const message of textArray) {\n      if (needsSplitting(message)) {\n        // Si el mensaje es largo, lo dividimos en chunks\n        const chunks = splitTextIntoChunks(message);\n        processedMessages.push(...chunks);\n      } else {\n        // Si el mensaje es corto, lo agregamos tal cual con tiempo de lectura\n        processedMessages.push({\n          parte: processedMessages.length + 1,\n          texto: message,\n          time: calculateReadingTime(message)\n        });\n      }\n    }\n    \n    // Re-numerar las partes para que sean consecutivas\n    processedMessages.forEach((msg, index) => {\n      msg.parte = index + 1;\n    });\n    \n    // Devolvemos la estructura con los mensajes procesados\n    return [{json: {messages: processedMessages, totalParts: processedMessages.length}}];\n  } else {\n    // Si no se pudo obtener ni procesar texto, devolvemos un array vacío\n    return [{json: {messages: [], totalParts: 0}}];\n  }\n} catch (error) {\n  // Capturamos cualquier error no manejado y devolvemos un objeto con información del error\n  console.error(\"Error general en el nodo:\", error.message);\n  return [{json: {messages: [], totalParts: 0, error: error.message}}];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5408,
        912
      ],
      "id": "7e6e667c-3852-4a08-988a-fbeb788f00d7",
      "name": "Separa datos"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c203e3f3-cdae-4308-b7ca-2300800248e7"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0cb14635-2673-408e-86db-ce9e0373674b",
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "462a2dc9-b455-4b67-a55b-15ce1554f0e8",
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "reply",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "button"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "61909e38-68a6-46cc-9287-bd79d0b95854",
                    "leftValue": "={{ $json.msg.type }}",
                    "rightValue": "extendedTextMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "extendedTextMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "89191595-e9ab-4d53-881b-ed5247811e44",
                    "leftValue": "={{ $json.msg.content === 'Quiero cambiar mi fecha' }}",
                    "rightValue": "Quiero cambiar mi fecha",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Modificar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d1365037-6336-4f42-ad67-111b60828b07",
                    "leftValue": "={{ $('Webhook1').first().json.body.data.msgContent.listResponseMessage.contextInfo.quotedMessage.listMessage.buttonText === 'Confirmar ✅' }}",
                    "rightValue": "Confirmar ✅",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirmar ✅"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "06ff860d-976d-4fdc-9dd3-8c9483137f8d",
                    "leftValue": "={{ $('Webhook1').first().json.body.data.msgContent.listResponseMessage.contextInfo.quotedMessage.listMessage.buttonText === 'Cancelar turno ❌' }}",
                    "rightValue": " ❌ Cancelar cita",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b64bdc33-47da-4c94-988d-1ba19386a5a2",
                    "leftValue": "={{ $('Webhook1').first().json.body.data.msgContent.listResponseMessage.contextInfo.quotedMessage.listMessage.buttonText === '📋 REAGENDAR CONSULTA'}}",
                    "rightValue": "📆 Elegir cita",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Reprogramar"
            }
          ]
        },
        "options": {}
      },
      "id": "0ce62641-268b-43bb-914c-76cd93ab85b6",
      "name": "Message Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1872,
        1472
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "93rlsJqTd0Ntt2NC",
          "mode": "list",
          "cachedResultName": "AGENTE CITAS - GET CLIENTES"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "numero": "={{ $('V1').item.json.msg.telefono }}",
            "idTabla": "m9m2veegnrfeeza",
            "token": "3WY4UecQy9Nl522fe_DXDSHeQDVSQJpmDG7mMoFz",
            "servidor_db": "={{ $('V1').item.json.datos.server_db }}",
            "nombre_columna": "TELEFONO"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "servidor_db",
              "displayName": "servidor_db",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "idTabla",
              "displayName": "idTabla",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "token",
              "displayName": "token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "nombre_columna",
              "displayName": "nombre_columna",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "pushname",
              "displayName": "pushname",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "servidor_evo",
              "displayName": "servidor_evo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "id_mensaje",
              "displayName": "id_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1072,
        1504
      ],
      "id": "c5ab87b0-a7b0-4888-a119-b947b4cdc145",
      "name": "Validar Cliente"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "tD2EBk1RhsCBSSkb",
          "mode": "list",
          "cachedResultName": "SUB TAREA - ENLOCAR MSG Citas"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "mode": "each",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2240,
        1360
      ],
      "id": "b0a3baea-a6b0-41fa-bd73-621752c626cb",
      "name": "Encolado de msg"
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        2480,
        1360
      ],
      "id": "57e833c9-a45c-4567-9112-6c9030b0cde2",
      "name": "Sort"
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "text",
              "renameField": true,
              "outputFieldName": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        2720,
        1360
      ],
      "id": "d56f06da-58f6-4a29-9401-6c8c3708f463",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0fae28c9-d30a-4250-9a50-5b68c61164cf",
              "name": "message",
              "value": "={{ $json?.text?.join(\"\\n\") || $json.msg.content }}",
              "type": "string"
            },
            {
              "id": "d5b09385-d3b2-4a98-ab34-48b786de7354",
              "name": "fecha",
              "value": "={{ $now.setLocale('es').toFormat('EEEE d \\'de\\' MMMM yyyy \\'a las\\' H:mm') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2944,
        1360
      ],
      "id": "c74f07ad-996e-42fe-a227-ab4098286316",
      "name": "chatInput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "79a702ff-5f8c-4814-bddf-5e3acb5a5f2e",
              "name": "msg",
              "value": "={{ JSON.stringify($('V1').first().json.msg)}}",
              "type": "object"
            },
            {
              "id": "9337176e-e568-4efa-8c05-3bdb12ecfb61",
              "name": "id_cliente",
              "value": "={{ $json.list.Id }}",
              "type": "string"
            },
            {
              "id": "08b235c8-58cc-48d1-a1c4-dd76a89ea7cc",
              "name": "clientebd",
              "value": "={{ JSON.stringify($json.list) }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "b98cd3ee-0f46-4ca4-97c9-5567b29db768",
      "name": "Variables globales",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1472,
        1504
      ],
      "notesInFlow": true
    },
    {
      "parameters": {
        "content": "## Variables de BD",
        "height": 380,
        "width": 340,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        928,
        1344
      ],
      "typeVersion": 1,
      "id": "87dec40f-8ed5-46bf-aeec-9ab6874d5c91",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "94746291-c0f3-44f3-b635-1fe696d7d74e",
              "leftValue": "={{ $json.msg.from_me }}",
              "rightValue": "false",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "7216b3e8-2aeb-4512-bf22-8ad17559b9f5",
              "leftValue": "={{ $json.msg.telefono }}",
              "rightValue": "5492254596618",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a1f4af36-41b4-4acd-ac08-9f4161346528",
      "name": "From Me2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        736,
        1504
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f9ecf2fc-da2c-4f44-897a-5dc0a2f2f379",
              "name": "msg.telefono",
              "value": "={{ $json.body.data.key.remoteJid.replace(/\\D/g, '') }}",
              "type": "string"
            },
            {
              "id": "dab7ca54-c3d2-4a36-a9ca-a0ebbd375ef5",
              "name": "msg.pushname",
              "value": "={{ $json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "cc7dcfe1-8ad7-4fe8-93ec-8f643c7d08c7",
              "name": "msg.type",
              "value": "={{ $json.body.data.messageType }}",
              "type": "string"
            },
            {
              "id": "81612acf-1b66-4c8e-82e4-ce8c77b31334",
              "name": "msg.content",
              "value": "={{ $json?.body?.data?.msgContent?.extendedTextMessage?.contextInfo?.quotedMessage?.conversation || $json.body?.data?.msgContent?.extendedTextMessage?.text || $json?.body?.data?.fileBase64 || $json?.body?.data?.msgContent?.conversation || $json.body.data.msgContent.listResponseMessage.singleSelectReply.selectedRowId }}",
              "type": "string"
            },
            {
              "id": "01710423-6391-4a34-81e1-06d4779caf4d",
              "name": "msg.timestamp",
              "value": "={{ $json.body.data.messageTimestamp.toDateTime('s').toLocal().toISO()}}",
              "type": "string"
            },
            {
              "id": "2dfc64f4-b222-4ea7-b095-fdd96d9fcb95",
              "name": "msg.idmsg",
              "value": "={{ $json.body.data.key.id }}",
              "type": "string"
            },
            {
              "id": "ca81718f-74eb-4960-ac3a-5b59f39f8710",
              "name": "datos.server_db",
              "value": "https://db.qeva.xyz",
              "type": "string"
            },
            {
              "id": "be83160a-e151-4f62-bfde-590af142ae74",
              "name": "db.table_clientes",
              "value": "mydefkz038xyn3g",
              "type": "string"
            },
            {
              "id": "c85ab512-ca17-401b-b025-4b6fc11ac818",
              "name": "db.token_db",
              "value": "3WY4UecQy9Nl522fe_DXDSHeQDVSQJpmDG7mMoFz",
              "type": "string"
            },
            {
              "id": "6fedaf9c-efe8-46e5-bb61-b42525ddafa1",
              "name": "msg.grupo",
              "value": "={{ $json.body.data.isGroup }}",
              "type": "boolean"
            },
            {
              "id": "7f846767-8866-43e5-845a-d1feda60451c",
              "name": "datos.token",
              "value": "B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410",
              "type": "string"
            },
            {
              "id": "b2193a26-668b-423d-9330-d3dd835f5466",
              "name": "msg.from_me",
              "value": "={{ $json.body.data.key.fromMe }}",
              "type": "string"
            },
            {
              "id": "49aecbc3-3d0e-4836-bcfa-dc79599cc53e",
              "name": "button.confirm",
              "value": "={{ $json.body.data.msgContent.templateButtonReplyMessage.selectedId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d8d36f05-4341-4df9-b609-f4fb2107baa9",
      "name": "V1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -176,
        1488
      ],
      "notesInFlow": true
    },
    {
      "parameters": {
        "content": "## Variables globales",
        "height": 380,
        "width": 340,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1344,
        1344
      ],
      "typeVersion": 1,
      "id": "b4b1482a-aa97-4609-8ed2-22de72f31af4",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9a858fa6-8f70-4ce7-a956-8c0209fbb10f",
              "leftValue": "={{ $json.output }}",
              "rightValue": "button_confirm",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5040,
        912
      ],
      "id": "fbe2965f-d40d-4261-871b-b7bbb8f0e867",
      "name": "If"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dedeb630-ea71-4ac7-808d-7401688ff128",
              "leftValue": "={{ $json.msg.grupo }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        400,
        1488
      ],
      "id": "65fd2d50-ced7-4369-a225-5fac8dab1049",
      "name": "If1"
    },
    {
      "parameters": {
        "content": "## RESET BBDD",
        "height": 240,
        "width": 260,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3104,
        944
      ],
      "typeVersion": 1,
      "id": "d44129c9-f75f-49a5-b47d-7e851ba57c53",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "5492254596618"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3184,
        1024
      ],
      "id": "9e4dd2d0-6ca8-4527-86cf-16f662e01065",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Variables globales colocar las que necesites de cada api utilizada",
        "height": 260,
        "width": 340,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -288,
        1408
      ],
      "typeVersion": 1,
      "id": "dd729165-949b-4bde-9422-6084aa323478",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "={{ $('Split Out').item.json.texto }}"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6912,
        960
      ],
      "id": "97b1cca0-7af9-47c8-b11e-ba24a8d70794",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "jsCode": "// OBTENER EL TEXTO DEL MENSAJE\nconst messageText = $input.first().json.msg.content;\n\n// FUNCIÓN PARA LIMPIAR TEXTO\nfunction cleanText(text) {\n  return text.replace(/\\s+/g, ' ').trim();\n}\n\n// OBTENER ID Y TELÉFONO DESDE EL INPUT\nfunction obtenerDatosInput() {\n  const inputData = $input.first().json;\n  return {\n    id: inputData.id_cliente || '1',\n    telefono: inputData.telefono || ''\n  };\n}\n\n// PARSEAR EL MENSAJE DE CONFIRMACIÓN\nfunction parseConfirmationMessage(text) {\n  // El formato es: ✅ CONFIRMADO - [nombre] | [fecha]T[hora] | [servicio]\n  \n  // Remover el emoji y \"CONFIRMADO -\"\n  const sinEmoji = text.replace(/✅\\s*CONFIRMADO\\s*-\\s*/, '');\n  \n  // Dividir por el pipe (|)\n  const partes = sinEmoji.split('|').map(parte => parte.trim());\n  \n  if (partes.length >= 3) {\n    // Extraer nombre\n    const nombre = partes[0];\n    \n    // Extraer fecha y hora (mantener el formato ISO completo: YYYY-MM-DDThh:mm)\n    const fechaHora = partes[1];\n    \n    // Extraer servicio\n    const servicio = partes[2];\n    \n    return {\n      nombre: nombre,\n      fecha: fechaHora, // Mantener el formato completo ISO\n      servicio: servicio\n    };\n  }\n  \n  // Si el formato no coincide, retornar valores vacíos\n  return {\n    nombre: '',\n    fecha: '',\n    servicio: ''\n  };\n}\n\n// PROCESAR LOS DATOS\nconst datosExtraidos = parseConfirmationMessage(messageText);\nconst datosInput = obtenerDatosInput();\n\n// RETORNAR LOS DATOS EN EL FORMATO ESPERADO PARA NOCODB\nconst resultado = {\n  NOMBRE: datosExtraidos.nombre,\n  ID_USUARIO: datosInput.id,\n  FECHA: datosExtraidos.fecha, // Ahora contiene fecha y hora: \"2025-08-01T10:00\"\n  SERVICIO: datosExtraidos.servicio,\n  CONFIRMACION_CITA: messageText, // El mensaje completo\n  TELEFONO: datosInput.telefono\n};\n\n// LOG PARA DEBUGGING\nconsole.log('Mensaje recibido:', messageText);\nconsole.log('Datos extraídos:', resultado);\n\nreturn [{ json: resultado }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2224,
        1680
      ],
      "id": "2bb0d3a5-c3af-402d-afa4-4e61afd44d4e",
      "name": "Code"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "create",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "TELEFONO",
              "fieldValue": "={{ $('Variables globales').first().json.msg.telefono }}"
            },
            {
              "fieldName": "NOMBRE",
              "fieldValue": "={{ $json.NOMBRE }}"
            },
            {
              "fieldName": "FECHA",
              "fieldValue": "={{ $json.FECHA }}"
            },
            {
              "fieldName": "SERVICIO",
              "fieldValue": "={{ $json.SERVICIO }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        2480,
        1680
      ],
      "id": "850e3ce7-4929-4da4-af83-94c27ff4ec86",
      "name": "CreateCITA",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=✅ Perfecto {{ $json.NOMBRE.split(' ')[0] }} ya quedo agendado el turno, te estaremos enviando un mensajito unas horas antes para la confirmación. Qué tengas un lindo dia"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2720,
        1680
      ],
      "id": "30af8255-0446-4a9c-92ac-831add95af46",
      "name": "Turno creado"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        6688,
        944
      ],
      "id": "a1cff4fe-47dd-438b-a817-42bbdf4f778a",
      "name": "Wait",
      "webhookId": "92d16c1c-444a-424b-ab29-9fde09415c74"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json?.message || $json.chatInput }}",
        "options": {
          "systemMessage": "=## JULI - RECEPCIONISTA VIRTUAL ODONTOLÓGICA\n\nEres **Juli**, recepcionista virtual de consultorio odontológico.\n\n## HOY ES: {{ $json.fecha }}\n\n**PERSONALIDAD**: Mujer simpática, profesional, voseo argentino. Sin \"che\", sin emojis.\n\n---\n\n## FLUJOS DE ACCIÓN RÁPIDA\n\n### 🔧 AGENDAR TURNO\n**Cuando el usuario quiere agendar:**\n1. Mostrar servicios disponibles\n2. Recolectar: NOMBRE + SERVICIO + FECHA + HORA\n3. **LÓGICA INTELIGENTE**:\n   - Si solo dice DÍA → preguntar \"¿Para qué hora?\"\n   - Si solo dice HORA → preguntar \"¿Para qué día?\"\n   - Si da ambos → continuar\n4. Una vez que tengas todos los datos → **EJECUTAR**: `tool_agendar`\n5. **RESPONDER SOLO**: `button_confirm`\n\n**Servicios disponibles:**\n```\n✅ Limpieza\n✅ Blanqueamiento  \n✅ Tratamiento de caries\n✅ Extracción\n✅ Consulta general\n✅ Revisión\n✅ Ortodoncia\n✅ Endodoncia\n✅ Implante\n✅ Prótesis\n```\n\n### ❌ CANCELAR TURNO\n**Cuando el usuario quiere cancelar:**\n1. **AUTOMÁTICAMENTE** preguntar: \"Dale, ¿querés que te pase las fechas agendadas?\"\n2. Si dice SÍ → **EJECUTAR**: `tool_cancelar` (esto mostrará las fechas disponibles)\n3. Usuario elige cuál cancelar → **EJECUTAR**: `tool_cancelar` con la fecha específica luego devuelve solo `button_confirm`\n\n\n### 🔄 REPROGRAMAR TURNO\n**Cuando el usuario quiere reprogramar:**\n1. **AUTOMÁTICAMENTE** preguntar: \"Dale, ¿para qué fecha querés cambiarlo?\"\n2. Usuario da nueva fecha → **CONVERTIR** a formato ISO\n3. **EJECUTAR**: `tool_reagendar` con JSON:\n```json\n{\n  \"FECHA\": \"2025-08-15T14:00\"\n}\n```\n**Ejemplo conversión:**\n- Usuario dice: \"viernes 15 de agosto a las 2\"\n- Juli convierte: `{\"FECHA\": \"2025-08-15T14:00\"}`\n4. **RESPONDER**: \"Listo, {nombre}, ahí ya cambié tu turno para el [nueva fecha]. ¿Necesitás algo más?\"\n\n### 🚨 URGENCIAS MÉDICAS\n**Cuando el usuario tiene urgencia médica:**\n1. **DETECTAR** palabras clave: dolor intenso, sangrado, urgencia, emergencia\n2. **EJECUTAR**: `tool_urgencias` inmediatamente\n3. **RESPONDER**: \"Entiendo. Voy a pasarte con recepción para que puedan ayudarte de inmediato.\"\n\n---\n\n## HERRAMIENTAS DISPONIBLES\n\n- **SIEMPRE usar primero**: `tool_think`\n- **Para obtener datos del paciente**: `get_paciente`\n- **Para reagendar turno**: `update_fecha`\n- **Para agendar turno**: `tool_agendar`\n- **Para cancelar turno**: `tool_cancelar`\n- **Para urgencias médicas**: `tool_urgencias`\n\n\n---\n\n## DATOS REQUERIDOS PARA AGENDAR\n\n- **NOMBRE**: Nombre completo\n- **SERVICIO**: De la lista disponible\n- **FECHA**: Formato DD-MM-AAAA (convertir expresiones como \"mañana\", \"próximo jueves\")\n- **HORA**: Formato HH:MM\n\n**LÓGICA DE RECOLECCIÓN**:\n- Si usuario dice solo \"jueves\" → preguntar \"¿Para qué hora?\"\n- Si usuario dice solo \"10:30\" → preguntar \"¿Para qué día?\"\n- Si usuario dice \"jueves a las 10:30\" → continuar con confirmación\n\n**Horarios**: Lunes-Viernes 08:00-13:00 y 15:00-19:00 (turnos de 30 min)\n\n---\n\n## CONVERSIÓN DE FECHAS\n\n### Interpretación de fechas relativas\n\nSi el paciente usa expresiones vagas que abarcan varios días (ej.: \"la semana que viene\", \"la próxima semana\"), Juli debe pedir un día específico:  \n«Perfecto, ¿qué día de la próxima semana te vendría bien?»\n\nJuli entiende expresiones como \"mañana\", \"pasado mañana\", \"la semana que viene\", \"el martes que viene\", \"el jueves que viene\", etc., y las traduce a la fecha concreta en formato DD-MM-AAAA tomando como referencia la fecha actual disponible en `{{ $json.fecha }}`.\n\n**Expresiones del usuario → Fecha exacta:**\n- \"Mañana\" → calcular desde {{ $json.fecha }}\n- \"Próximo jueves\" → buscar próximo jueves disponible\n- \"La semana que viene\" → pedir día específico\n\n**Para reprogramar → Formato JSON ISO:**\n- Usuario: \"viernes 15 de agosto a las 2\" → `{\"FECHA\": \"2025-08-15T14:00\"}`\n- Usuario: \"martes que viene a las 10:30\" → `{\"FECHA\": \"2025-XX-XXT10:30\"}`\n- Usuario: \"el 12 de mayo a las 10\" → `{\"FECHA\": \"2025-05-12T10:00\"}`\n\n---\n\n## EJEMPLOS DE DIÁLOGO\n\n### 1. Agendar\n\nPaciente: Hola, me gustaría pedir un turno.\nJuli: Hola, ¿cómo estás? Sí, contame para qué necesitabas el turno. Te podemos ayudar con lo siguiente:\n```\n. Limpieza\n. Blanqueamiento\n. Extracción\n. Tratamiento de caries\n```\nPaciente: Para limpieza.\nJuli: Perfecto. ¿Me pasas tu nombre completo?\nPaciente: Lucía Fernández.\nJuli: Gracias, Lucía. ¿Qué día y hora te vendría bien?\nPaciente: El próximo jueves.\nJuli: ¿Para qué hora?\nPaciente: 10:30.\n*(Juli ejecuta `tool_agendar`)*\nJuli:\n```\nbutton_confirm\n```\n\n### 1b. Agendar (usuario da solo hora)\n\nPaciente: Quiero un turno para limpieza.\nJuli: Perfecto. ¿Me pasas tu nombre completo?\nPaciente: Fernando Cassera.\nJuli: Gracias, Fernando. ¿Qué día y hora te vendría bien?\nPaciente: A las 2 de la tarde.\nJuli: ¿Para qué día?\nPaciente: El viernes que viene.\n*(Juli ejecuta `tool_agendar`)*\nJuli:\n```\nbutton_confirm\n```\n\n### 2. Cancelar\n\nPaciente: Quiero cancelar un turno.\nJuli: Dale, ¿querés que te pase las fechas agendadas?\nPaciente: Sí.\nJuli: [Ejecuta tool_cancelar - muestra fechas disponibles]\nluego devuelve solo `button_confirm`\n\n### 3. Reprogramar\n\nPaciente: Necesito cambiar mi turno.\nJuli: Dale, ¿para qué fecha querés cambiarlo?\nPaciente: Para el viernes 15 de agosto a las 2 de la tarde.\n*(Juli ejecuta `tool_reagendar` con {\"FECHA\": \"2025-08-15T14:00\"})*\nJuli: Listo, Fernando, ahí ya cambié tu turno para el 15 de agosto a las 14:00. ¿Necesitás algo más?\n\n### 4. Reprogramar (alternativo)\n\nPaciente: Necesito cambiar mi turno del martes.\nJuli: Dale, ¿para qué fecha querés cambiarlo?\nPaciente: Para el jueves a las 10.\n*(Juli ejecuta `tool_reagendar` con {\"FECHA\": \"2025-XX-XXT10:00\"})*\nJuli: Listo, María, ahí ya cambié tu turno para el jueves a las 10:00. ¿Necesitás algo más?\n\n### 5. Actualizar teléfono\n\nPaciente: Cambié mi número de teléfono.\nJuli: Claro, ¿cuál es tu nuevo teléfono?\nPaciente: 11‑3456‑7890.\nJuli: dale ahi lo cambié. Gracias por avisar\n\n### 6. Urgencia\n\nPaciente: Me duele muchísimo una muela, necesito que me atiendan ya.\n*(Juli ejecuta `tool_urgencias`)*\nJuli: Entiendo. Voy a pasarte con recepción para que puedan ayudarte de inmediato.\n\n---\n\n## REGLAS CRÍTICAS\n\n1. **SIEMPRE** ejecutar `tool_think` primero\n2. **NUNCA** asumir datos de conversaciones anteriores\n3. **OBLIGATORIO** ejecutar las herramientas correspondientes:\n   - Para agendar → ejecutar `tool_agendar`\n   - Para cancelar → ejecutar `tool_cancelar`\n   - Para reagendar → ejecutar `tool_reagendar`\n   - Para urgencias → ejecutar `tool_urgencias`\n4. **DESPUÉS** de ejecutar herramientas → responder solo `button_confirm`\n5. **URGENCIAS** → derivar a humano inmediatamente\n6. **DATOS FALTANTES** → solicitarlos antes de ejecutar herramientas\n\n---\n\n## VALIDACIÓN ANTES DE RESPONDER\n\n✓ ¿Ejecuté `tool_think`?\n✓ ¿Tengo todos los datos necesarios?\n✓ ¿Ejecuté la herramienta correcta?\n✓ ¿Respondí solo con `button_confirm` después de Vero?"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4464,
        1360
      ],
      "id": "e532a2a9-8832-4762-a416-a6511d3a6578",
      "name": "Juli"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/presence",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "status",
              "value": "composing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6464,
        880
      ],
      "id": "5a885cf7-f0af-4442-bef4-d2625fa22ab9",
      "name": "escribiendo..."
    },
    {
      "parameters": {
        "description": "Llama a esta tool cuando tengas que agendar, runa visita",
        "workflowId": {
          "__rl": true,
          "value": "QMISSxd5iYUeehv5",
          "mode": "list",
          "cachedResultName": "AGENTE CITAS - Button confirm"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "nombre": "={{ $fromAI('nombre', ``, 'string') }}",
            "fecha": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fecha', `Utilizar formato iso`, 'string') }}",
            "hora": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('hora', ``, 'string') }}",
            "telefono": "={{ $('Variables globales').first().json.msg.telefono }}",
            "servicio": "={{ $fromAI('servicio', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "hora",
              "displayName": "hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "servicio",
              "displayName": "servicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4880,
        1792
      ],
      "id": "05288089-c83b-4718-ba6e-4936739fff13",
      "name": "tool_agendar"
    },
    {
      "parameters": {
        "description": "Llama a esta tool cuando tengas que agendar, reprogramar o cancelar una visita",
        "workflowId": {
          "__rl": true,
          "value": "kSLafA6eMsulnKVE",
          "mode": "list",
          "cachedResultName": "AGENTE CITAS - CANCELAR"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Id": "={{ $('Variables globales').item.json.id_cliente }}",
            "numero": "={{ $('Variables globales').item.json.msg.telefono }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Id",
              "displayName": "Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5008,
        1792
      ],
      "id": "49c6499a-fe8d-4c33-b00d-5cd9f70731b6",
      "name": "tool_cancelar"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=✅ Listo, ya cancelamos el turno, si queres agendar para otro servicio, me avisas, Qué tengas un buen día."
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2720,
        1872
      ],
      "id": "03fd461e-c352-4afd-9c25-d82682282f49",
      "name": "Cancelar turno"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=✅ Listo, ahi la cancele, ahora decime para que fecha queres el nuevo turno."
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2480,
        2256
      ],
      "id": "df7080c5-db06-46fd-9bea-9ae50c34b5f6",
      "name": "Cancelar turno1"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "projectId": "pg80f80zr77phub",
        "table": "mydefkz038xyn3g",
        "returnAll": true,
        "options": {
          "where": "=(TELEFONO,eq,{{ $('Variables globales').item.json.msg.telefono }})"
        }
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        4464,
        1856
      ],
      "id": "0d4900c8-9afa-45d6-8a23-e8d1aac57268",
      "name": "get_paciente",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {
          "frequencyPenalty": 0.3,
          "presencePenalty": 0.3,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        4288,
        1536
      ],
      "id": "4fd8a825-c262-4d8c-b549-fda46c7578ec",
      "name": "gemini2",
      "credentials": {
        "openRouterApi": {
          "id": "ADdm45cFSIFSG59w",
          "name": "Gemini"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Variables globales').first().json.msg.telefono }}",
        "sessionTTL": 1800
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        3504,
        2384
      ],
      "id": "ff4a4b1f-e147-430d-af39-96010c83cc07",
      "name": "memory1",
      "credentials": {
        "redis": {
          "id": "f1mfRViKXHypdB9h",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Id",
              "fieldValue": "={{ $json.id_cliente }}"
            },
            {
              "fieldName": "FECHA"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        2224,
        2256
      ],
      "id": "8c60509d-7f13-41de-b908-00bbbb7de030",
      "name": "Elimina la cita - Reagendar",
      "alwaysOutputData": true,
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "insert",
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.data.message.extendedTextMessage.text }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        3168,
        2048
      ],
      "id": "832c84e7-2312-467e-9041-7d1ee70d9191",
      "name": "Chat Memory Manager"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://us.api-wa.me/2522xaf8359c21b/message/{{ $json.data.key.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3056,
        1584
      ],
      "id": "f04e1927-5289-4f1d-bc94-c1a464256581",
      "name": "Delete lista"
    },
    {
      "parameters": {
        "description": "siempre llama a esta tool cuando debas ejecutar una tool"
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4960,
        1504
      ],
      "id": "92a761d0-f5c1-4b2c-b21f-36fa56bde144",
      "name": "tool_think"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "f33",
        "options": {}
      },
      "id": "ca741c62-a356-40d2-a609-bac27382bfdb",
      "name": "Webhook1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -544,
        1488
      ],
      "webhookId": "6eb916de-b3fd-48f2-b749-5db6a011d8ba"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "delete",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "id": "={{ $('Webhook1').first().json.body.data.msgContent.listResponseMessage.singleSelectReply.selectedRowId }}"
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        2224,
        1952
      ],
      "id": "8e967101-49ad-47d1-a474-8f6e797a26d7",
      "name": "Cancelar",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false,
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://us.api-wa.me/2522xaf8359c21b/message/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "*/*"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $('V1').first().json.msg.telefono }}"
            },
            {
              "name": "text",
              "value": "=Ya cancelaste todos tus turnos"
            },
            {
              "name": "status",
              "value": "recording"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2720,
        2048
      ],
      "id": "75a1ff38-11be-4cfe-9939-8e8d3dd347fb",
      "name": "Cancelar turno2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "97bcc786-58da-43a4-9ffe-659423816859",
              "leftValue": "={{ $json.Id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2416,
        1952
      ],
      "id": "8c8384bc-ac93-4a63-9c6d-3b33df9a376a",
      "name": "If2"
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "update",
        "projectId": "p95q7ph2qlpkvjj",
        "table": "m9m2veegnrfeeza",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "=Id",
              "fieldValue": "={{ $('Validar Cliente').item.json.list.Id }}"
            },
            {
              "fieldName": "FECHA",
              "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', `Fortamo de fecha ISO`, 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        5136,
        1792
      ],
      "id": "2aa27a68-9b49-4ca6-9ce4-1cfb0c3cdc01",
      "name": "tool_reagendar",
      "credentials": {
        "nocoDbApiToken": {
          "id": "KRVylWU1iQ1qxa6v",
          "name": "Qeva BD"
        }
      }
    }
  ],
  "pinData": {
    "Webhook1": [
      {
        "json": {
          "headers": {
            "host": "n8nw.qeva.xyz",
            "user-agent": "axios/1.11.0",
            "content-length": "773",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "instance-key": "2522xaf8359c21b",
            "x-forwarded-for": "144.126.133.227",
            "x-forwarded-host": "n8nw.qeva.xyz",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "7697b68d06c2",
            "x-real-ip": "144.126.133.227"
          },
          "params": {},
          "query": {},
          "body": {
            "instance": "2522xaf8359c21b",
            "type": "message",
            "data": {
              "messageId": "1B892286FBFF029DFA3EADB2127E79B1",
              "jid": "5492254423359:97@s.whatsapp.net",
              "me": false,
              "isGroup": false,
              "remoteJid": "5492254596618",
              "pushName": "Automátizaciones AI",
              "key": {
                "remoteJid": "5492254596618@s.whatsapp.net",
                "fromMe": false,
                "id": "1B892286FBFF029DFA3EADB2127E79B1"
              },
              "messageType": "conversation",
              "msgContent": {
                "conversation": "Tenés libre?",
                "messageContextInfo": {
                  "deviceListMetadata": {
                    "senderKeyHash": "F1tkbDhHhKbugw==",
                    "senderTimestamp": "1753523520",
                    "recipientKeyHash": "iVJZBUf9o9GNyA==",
                    "recipientTimestamp": "1753698939"
                  },
                  "deviceListMetadataVersion": 2,
                  "messageSecret": "PI9ksd2xE2fo2k04j7rYQfdpMd+CKWt/FzxVWTCYoxk="
                }
              },
              "messageTimestamp": 1753994848,
              "source": "android",
              "broadcast": false,
              "isMedia": false
            }
          },
          "webhookUrl": "https://n8nw.qeva.xyz/webhook/f33",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "errorWorkflow": "EBMwLGTBawYqkZM1",
    "timezone": "America/Argentina/Buenos_Aires",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-07-31T20:48:59.040Z",
  "versionId": "91b0c6f3-eaa0-481c-9c4c-16eb51651a4f"
}