{"createdAt":"2025-01-21T21:23:44.880Z","updatedAt":"2025-05-10T19:32:28.083Z","id":"F1n2h96SynW3aHim","name":"DESPENSA - MASTER","active":true,"nodes":[{"parameters":{"fieldToSplitOut":"text","options":{"destinationFieldName":"msg"}},"id":"4b57d0e1-d761-413d-b6eb-b74fd6adfce4","name":"Segmentos","type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[6100,340]},{"parameters":{"amount":"=1"},"id":"4f3df646-1ec7-4ab6-8d6f-3e950f9e1769","name":"1,2s","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[6540,265],"webhookId":"8a810ad6-4ecf-4781-aed8-7f2b295770dc"},{"parameters":{"options":{}},"id":"1b7ca230-f1a6-42ae-9856-2a35b85136e7","name":"Loop Over Items1","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[6320,340]},{"parameters":{"name":"insertar_pedido","description":"llamaras a esta herramienta cuando el pedido este confirmado","workflowId":{"__rl":true,"value":"MA1amyL5ScIQzNJb","mode":"id"},"fields":{"values":[{"name":"push_name","stringValue":"={{ $('camposiniciales').first().json.telefonoCliente }}"}]},"specifyInputSchema":true,"jsonSchemaExample":"\n  {\n    \"Nombre\": \"Juan P√©rez\",\n    \"Productos\": [\n      {\n            \"Detalle\": \"Productos: Coca cola pack\",\n       \"Cantidad\": \"2\" ,\n      \"precio\": \"$300\"       \n    }],   \n    \"Total\":\"$1700\",\n    \"Telefono\": \"555-1234\",\n    \"Direccion\": \"Av. Principal #123 \",\n    \"Metodo de pago\": \"QR, TRANSCFERENCIA, OTRO\",\n    \"Retiro\": \"Local o domicilio\",\n    \"correo\":\"fercassera@gmail.com\",\n    \"Estado\": \"Pagado \",\n    \"Codigo pedido\":\"codigo generado\"\n  }\n"},"id":"8a3dcd21-ab81-4498-926c-3c282e9ef281","name":"Insertar pedido","type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":1.2,"position":[4620,560]},{"parameters":{"assignments":{"assignments":[{"id":"5d04d69d-cb9c-41be-a44a-95fac3c059f3","name":"text","value":"={{ [$json.output.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*').replace(/###\\s*/g, '').replace(/[¬°¬ø!]/g, '')] }}","type":"array"}]},"options":{}},"id":"0f259155-9566-43d3-bded-1b5fa69c8f30","name":"replace","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[5880,340]},{"parameters":{"name":"promo_bancaria","description":"Llama a esta herramienta siempre que el usuario quiera saber las promociones bancarias","workflowId":{"__rl":true,"mode":"id","value":"yOh5hvWd7551O1Ez","cachedResultName":"DESPENSA - Promociones"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[4740,560],"id":"4f436f46-1af4-4e06-b71a-3955fb6afda7","name":"Promociones"},{"parameters":{"name":"qr_pagos","description":"Llamaras a esta herramienta cuando el usuario qiuera pagar por QR","workflowId":{"__rl":true,"value":"tdm8dLqaR7idL6Hm","mode":"list","cachedResultName":"DESPENSA - QR"},"fields":{"values":[{"name":"telefono","stringValue":"={{ $('camposiniciales').first().json.telefonoCliente }}"}]},"specifyInputSchema":true,"jsonSchemaExample":"{\n  \"banco\":\"Modo\"\n}"},"id":"f291dc28-d8f2-42c4-8993-2b26135c114e","name":"QR","type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":1.2,"position":[4860,560]},{"parameters":{"action":"generate"},"type":"n8n-nodes-base.crypto","typeVersion":1,"position":[640,490],"id":"2278b5e6-b903-4a81-8123-1d6bf9ba002f","name":"Crypto"},{"parameters":{"name":"buscar_productos","description":"Llama a esta herramienta para saber sobre un producto o comidas","workflowId":{"__rl":true,"value":"4bACFIaEnJooL6W4","mode":"list","cachedResultName":"DESPENSA - Buscar productos"},"fields":{"values":[{"name":"Telefono","stringValue":"={{ $('camposiniciales').first().json.telefonoCliente }}"}]},"specifyInputSchema":true,"jsonSchemaExample":"{\n\t\"Descripcion\": \"azucar\"\n}"},"id":"21f36ca6-3f09-435c-9589-ecac91b8bf97","name":"Buscar productos","type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":1.2,"position":[4980,560]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e02fa309-efdc-4424-a35e-232970a746cf","leftValue":"={{ $json.Telefono }}","rightValue":"=","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[420,340],"id":"25072683-00b4-4e9c-bc4c-30fdee5999a4","name":"If"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"94746291-c0f3-44f3-b635-1fe696d7d74e","leftValue":"={{ $('Webhook').item.json.body.messages[0].from_me }}","rightValue":"false","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"id":"3d486f6e-0858-42ac-9723-148f75b57c7e","name":"From Me2","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-680,340]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5af9eed6-93bd-4b03-879e-4b4404da1737","leftValue":"={{ $json.ETIQUETA }}","rightValue":"bot_off","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"id":"8ef2017a-ed74-46cd-88b5-e73a563604b7","name":"From Me3","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-20,340]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cb14635-2673-408e-86db-ce9e0373674b","leftValue":"={{ $json.tipoMensaje }}","rightValue":"text","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.tipoMensaje }}","rightValue":"voice","operator":{"type":"string","operation":"equals"},"id":"9d6039bf-d7d0-489c-8f18-691901f06a47"}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"60065893-74f7-4b64-bc1a-d891202efa78","leftValue":"={{ $json.tipoMensaje }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Image"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3f726e15-8674-47a2-a924-8a181db57e0a","leftValue":"={{ $json.tipoMensaje }}","rightValue":"action","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"reaccion"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"69ad25f9-c335-489b-9301-b3f4075020d8","leftValue":"={{ $json.tipoMensaje }}","rightValue":"location","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"locaciton"}]},"options":{}},"id":"70263635-2977-4d7b-ad37-f39182a4d96b","name":"Message Type1","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1300,300]},{"parameters":{"operation":"push","list":"={{ $('camposiniciales').item.json.telefonoCliente }}","messageData":"={{ $json.text }}","tail":true},"id":"8466c656-0b5e-4299-af85-8e9b88eb4996","name":"Audio Memory","type":"n8n-nodes-base.redis","typeVersion":1,"position":[2180,440],"credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"get","propertyName":"Messages","key":"={{ $('camposiniciales').first().json.telefonoCliente }}","options":{}},"id":"e940a660-fbc8-4312-a111-37880b7dc9f5","name":"Get Memory 2","type":"n8n-nodes-base.redis","typeVersion":1,"position":[3280,340],"credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"amount":"={{ $('Tiempo1').item.json.responseDelay /1000 }}"},"id":"58545546-131a-453e-ac98-ca4140fc0b4d","name":"Wait 10s","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3060,340],"webhookId":"241554e1-7fe9-4c6d-9c49-69ec498c8481"},{"parameters":{"resource":"audio","operation":"transcribe","binaryPropertyName":"=data","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.7,"position":[1960,440],"id":"6c280d4c-edb9-42a1-af37-5fab90f8bc89","name":"OpenAI2","credentials":{"openAiApi":{"id":"UfA35dBDzEebw8zR","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"d2fb2361-9a41-4099-8f53-cfb8be77d95a","name":"content","value":"={{ $('camposiniciales').item.json.content }}","type":"string"}]},"options":{}},"id":"573aa795-1a68-4b65-b968-3bde0ec81f65","name":"Edit Fields4","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1520,420]},{"parameters":{"jsCode":"// Obtener historial de mensajes desde Redis\nconst redisMessages = $input.first().json.Redis1 || [];\n// Extraer el √∫ltimo mensaje recibido, asegurando que sea un string v√°lido\nconst userMessage = Array.isArray(redisMessages) && redisMessages.length > 0\n  ? String(redisMessages[redisMessages.length - 1]).trim().toLowerCase()\n  : \"\";\n// Obtener la cantidad de mensajes en cola desde Redis en los √∫ltimos 6 segundos\nconst queueLength = parseInt($json.queueLength || \"0\", 10);\n\n// Lista espec√≠fica de palabras que tendr√°n un delay de 1 segundo\nconst fastResponseWords = [\"hola\", \"ok\", \"dale\", \"s√≠\", \"no\", \"confirmo\", \"modificar\", \"cancelar\"];\n\n// üöÄ **L√≥gica del delay**\nlet responseDelay = 5000; // ‚è≥ Por defecto, 9 segundos\n\n// Verificar si el mensaje completo es exactamente una de las palabras especificadas\nif (fastResponseWords.includes(userMessage)) {\n  responseDelay = 1000; // 1 segundo para las palabras espec√≠ficas\n}\n\nreturn { json: { responseDelay } };"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2620,340],"id":"ff83a77e-d861-4568-9c5a-afc928feab9e","name":"Tiempo1"},{"parameters":{"operation":"get","propertyName":"Redis1","key":"={{ $('camposiniciales').item.json.telefonoCliente }}","options":{}},"id":"fc6daaf9-df5c-4480-b466-434405b1c20c","name":"Return Redis1","type":"n8n-nodes-base.redis","typeVersion":1,"position":[2400,340],"credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1WxPxhtY9u7M7aRDM9QOsADIrEKXFgpYNboGXHLv_W2E","mode":"list","cachedResultName":"Clientes","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1WxPxhtY9u7M7aRDM9QOsADIrEKXFgpYNboGXHLv_W2E/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1552665435,"mode":"list","cachedResultName":"Clientes","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1WxPxhtY9u7M7aRDM9QOsADIrEKXFgpYNboGXHLv_W2E/edit#gid=1552665435"},"columns":{"mappingMode":"defineBelow","value":{"Nombre":"={{ $('camposiniciales').item.json.meta.nombreCliente }}","Telefono":"={{ $('camposiniciales').item.json.meta.telefonoCliente }}","idMensaje":"={{ $json.data }}","TimeStamp":"={{ $('Unificados').item.json.meta.tiempo }}"},"matchingColumns":[],"schema":[{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"idMensaje","displayName":"idMensaje","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nombre_real","displayName":"nombre_real","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Correo","displayName":"Correo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"TimeStamp","displayName":"TimeStamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-900,1680],"id":"61be8f50-d310-4673-b68e-5467ef07f6dd","name":"InsertCliente","credentials":{"googleSheetsOAuth2Api":{"id":"yxBoR5sUs8UyR9Sc","name":"Despensa"}}},{"parameters":{"assignments":{"assignments":[{"id":"86ff282a-3ede-4417-98c1-0d10858bc5dc","name":"Redis1","value":"={{ $('Return Redis1').first().json.Redis1 }}","type":"string"},{"id":"3cd6e8a1-98ef-4abb-9490-fb7946365cfb","name":"Redis2","value":"={{ $json.Messages }}","type":"string"}]},"options":{}},"id":"fe0ea543-e3eb-4bc1-82c3-f6bd3fc8c680","name":"Redis","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3500,340],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $item(0).$node[\"Compara Get Memory\"].json[\"Redis2\"];\n\n// Verifica si data es un array directamente\nlet array;\n\nif (Array.isArray(data)) {\n    array = data;\n} else {\n    try {\n        // Intenta parsear si es una cadena JSON v√°lida\n        array = JSON.parse(data);\n    } catch (error) {\n        // Si no es JSON, considera que es un texto plano\n        array = [data];\n    }\n}\n\n// Une los elementos del array en un string\nconst message_completo = array.join(\" , \");\n\nreturn [{ json: { message_completo } }];\n"},"id":"3bea3d5f-2ca6-4bbe-84f1-6650b8aef212","name":"Compara igualdad de memorias","type":"n8n-nodes-base.code","typeVersion":2,"position":[3940,340]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d5a342e9-585b-42ea-be44-644adae10199","leftValue":"={{ $json.Redis1 }}","rightValue":"={{ $json.Redis2 }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"cd5e6704-3386-4c3f-ba26-040965ebbd56","name":"Compara Get Memory","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3720,340]},{"parameters":{"operation":"delete","key":"={{ $('camposiniciales').first().json.telefonoCliente }}"},"id":"e5fd32ef-52be-4556-8174-d6b34b62d58f","name":"Delete","type":"n8n-nodes-base.redis","typeVersion":1,"position":[4160,340],"credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"url":"={{ $json.content }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1740,440],"id":"4aa68eaa-0e83-4210-b702-0ff970201375","name":"HTTP Request"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer Qo7qoYEVIKvRppohj25MEaHl1dPwskEv"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":0},{"name":"body","value":"={{ $('Loop Over Items1').item.json.msg }}"},{"name":"to","value":"={{ $('camposiniciales').item.json.meta.telefonoCliente }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-900,2440],"id":"2c9c27de-7b86-4e3d-a2cd-4695c9b2896e","name":"HTTP Request2"},{"parameters":{"name":"ubicacion","description":"llamaras a esta herramienta cuando el usuario quiera saber la ubicacion ","workflowId":{"__rl":true,"value":"XoB1Q17cG94Zf3s0","mode":"list","cachedResultName":"DESPENSA - Ubicacion"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Telefono":"={{ $('camposiniciales').first().json.telefonoCliente }}"},"matchingColumns":["Telefono"],"schema":[{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[5100,560],"id":"1d933774-cc4e-47c9-9bca-8a6ff86e7b9b","name":"ubicacion"},{"parameters":{"method":"POST","url":"=https://chat.rshtech.com.py/api/v1/accounts/3/conversations/{{ $('camposiniciales').first().json.conversation_id }}/messages","sendQuery":true,"queryParameters":{"parameters":[{"name":"content","value":"={{ $('Loop Over Items1').item.json.msg }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Api-Access-Token","value":"PWT8Rjk9ZGEqVzGoWYmaofFj"}]},"options":{}},"id":"0a196576-e9e5-437e-b98e-5b82e2bb3170","name":"Respuesta a ChatWoot2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6980,340],"disabled":true},{"parameters":{"httpMethod":"POST","path":"lodepocho","options":{}},"id":"3116d3c7-3cc7-44e0-ad17-888667eac5a0","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-900,340],"webhookId":"3ba6ce2e-1b02-4b06-8edd-9c60afb2db89"},{"parameters":{"assignments":{"assignments":[{"id":"f9ecf2fc-da2c-4f44-897a-5dc0a2f2f379","name":"telefonoCliente","value":"={{ $('Webhook').item.json.body.messages[0].from }}","type":"string"},{"id":"a019046c-3b5a-4fd0-a497-de55cb2178ea","name":"telefonoChat","value":"={{ $('Webhook').item.json.body.messages[0].chat_id }}","type":"string"},{"id":"dab7ca54-c3d2-4a36-a9ca-a0ebbd375ef5","name":"nombreCliente","value":"={{ $('Webhook').item.json.body.messages[0].from_name }}","type":"string"},{"id":"cc7dcfe1-8ad7-4fe8-93ec-8f643c7d08c7","name":"tipoMensaje","value":"={{ $('Webhook').item.json.body.messages[0].type }}","type":"string"},{"id":"2dfc64f4-b222-4ea7-b095-fdd96d9fcb95","name":"idMensaje","value":"={{ $('Webhook').item?.json?.body?.messages[0]?.device_id || $('Webhook').item.json.body.messages[0].id }}","type":"string"},{"id":"07c65c0d-9662-41b0-b872-056a5d643f8c","name":"content.label","value":"={{ $('Webhook').item?.json?.body?.labels || [''] }}","type":"string"},{"id":"80c6b537-8c37-4a54-b928-913c4bc0e13f","name":"accountId","value":"={{ $json?.body?.conversation?.messages[0]?.account_id || null }}","type":"string"},{"id":"30069704-a1aa-4539-afcd-67eb7c405869","name":"inboxId","value":"={{ $('Webhook').item?.json?.body?.inbox?.id || null  }}","type":"string"},{"id":"a2148d2c-c4ac-4826-be6f-fa686b90fae4","name":"inboxIdentifier","value":"SUqwz3QWbq6UgbEF7zhifEv5","type":"string"},{"id":"7d850d26-967b-4ba4-aaa2-3f3625032984","name":"chatwootUrl","value":"https://chat.rshtech.com.py","type":"string"},{"id":"e0f88461-1bd8-4fd9-a76d-4b431e08dae1","name":"chatwootToken","value":"PWT8Rjk9ZGEqVzGoWYmaofFj","type":"string"},{"id":"ecb06d4f-a572-4944-b855-85950e49b995","name":"source_id","value":"={{ $('Webhook').item?.json?.body?.conversation?.messages[0]?.conversation?.contact_inbox?.source_id || null  }}","type":"string"},{"id":"2c5e299b-1d0f-4407-9e38-30dfa8e1a22a","name":"phone_number","value":"={{ $('Webhook').item?.json?.body?.conversation?.meta?.sender?.phone_number || null  }}","type":"string"},{"id":"ffd7c75f-4166-41b3-baf9-2e05533e2646","name":"content","value":"={{ $('Webhook').item?.json?.body?.conversation?.messages[0]?.content || $('Webhook').item?.json?.body?.messages[0]?.text?.body || $('Webhook').item?.json?.body?.messages[0]?.action?.emoji || $('Webhook').item.json.body.messages[0].voice.link }}","type":"string"},{"id":"b7095634-3079-41f0-8819-28c62b42affb","name":"conversation_id","value":"={{ $('Chatwoot msg').item?.json?.body?.conversation_id || $('Chatwoot msg').item.json.conversation_id }}","type":"string"},{"id":"b7613885-c5d8-4b6a-81ec-8de7e6740faf","name":"location","value":"={\n  \"location\": {\n    \"latitud\":{{ $('From Me2').item.json.body.messages[0].location.latitude }},\n    \"longitud\":{{ $('From Me2').item.json.body.messages[0].location.longitude }}\n  }\n}","type":"object"}]},"includeOtherFields":true,"options":{"ignoreConversionErrors":true}},"id":"11ebac25-3982-452b-a4e2-ec8dd616d6cf","name":"camposiniciales","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1080,340],"notesInFlow":true},{"parameters":{"operation":"get","propertyName":"ETIQUETA","key":"=+{{ $('Webhook').item.json.body.messages[0].from }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-240,340],"id":"a3410502-8bbf-4378-97d7-f0bd08d8d154","name":"Redis3","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"workflowId":{"__rl":true,"value":"BHLBMgDUtwxVaS39","mode":"list","cachedResultName":"DESPENSA Chatwoot msg"},"workflowInputs":{"mappingMode":"defineBelow","value":{"content":"={{ $json?.body?.messages[0]?.text?.body || $('Webhook').item?.json?.body?.messages[0]?.voice?.link || $json.body.messages[0].location }}","nombreCliente":"={{ $json?.body?.messages[0]?.from_name || $json?.body?.messages[0]?.chat_name || null }}","telefonoCliente":"={{ $('Webhook').item.json.body.messages[0].from }}","inboxIdentifier":"=SUqwz3QWbq6UgbEF7zhifEv5","chatwootToken":"=PWT8Rjk9ZGEqVzGoWYmaofFj","chatwootUrl":"=https://chat.rshtech.com.py","typeFile":"={{ $json.body.messages[0].type }}"},"matchingColumns":[],"schema":[{"id":"content","displayName":"content","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"nombreCliente","displayName":"nombreCliente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"telefonoCliente","displayName":"telefonoCliente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"inboxIdentifier","displayName":"inboxIdentifier","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"chatwootUrl","displayName":"chatwootUrl","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"chatwootToken","displayName":"chatwootToken","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"typeFile","displayName":"typeFile","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":true,"convertFieldsToString":true},"mode":"each","options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-460,340],"id":"c79e973c-a7a4-4883-b339-50bcc4aa441b","name":"Chatwoot msg","disabled":true},{"parameters":{"authentication":"nocoDbApiToken","operation":"create","projectId":"pc1g3m0ih934pz9","table":"mtxmanzpy3a6oz8","fieldsUi":{"fieldValues":[{"fieldName":"Nombre","fieldValue":"={{ $('Webhook').item.json.body.messages[0].from_name }}"},{"fieldName":"Telefono","fieldValue":"={{ $('Webhook').item.json.body.messages[0].chat_id.replace(/\\D/g, '') }}"},{"fieldName":"IdMensaje","fieldValue":"={{ $json.data }}"}]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[860,490],"id":"8f41355b-128e-48f9-b3e7-de0fb5117336","name":"InsertarCliente","credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pc1g3m0ih934pz9","table":"mtxmanzpy3a6oz8","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $('Webhook').item.json.body.messages[0].chat_id.replace(/\\D/g, '') }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[200,340],"id":"a2f8516c-9fa2-4ca8-b89c-17c8b91d1fec","name":"getClientes","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"lo_de_pocho","mode":"list","cachedResultName":"lo_de_pocho"},"deleteCommand":"delete","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-900,900],"id":"1c16f80d-a6c7-4d74-a995-1ee8f1955371","name":"Postgres","credentials":{"postgres":{"id":"E1mi81N6Tmr5cHS5","name":"GENERICO"}}},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer Qo7qoYEVIKvRppohj25MEaHl1dPwskEv"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":3},{"name":"to","value":"5492234245220"},{"name":"body","value":"={{ $json.msg }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-900,1160],"id":"c084c414-b4ab-434d-b95c-f053dd500001","name":"HTTP Request1"},{"parameters":{},"id":"68c4924d-8864-4951-9737-e7478fc50f8e","name":"calcular_total","type":"@n8n/n8n-nodes-langchain.toolCalculator","typeVersion":1,"position":[5220,560]},{"parameters":{"name":"agregar_nombre","description":"Llamaras a esta herramienta cuando tengas sus datos ","workflowId":{"__rl":true,"value":"MuBTjZBk3QgLNPG5","mode":"list","cachedResultName":"DESPENSA - Nombre real"},"workflowInputs":{"mappingMode":"defineBelow","value":{"nombre":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre', `Guardaras el nombre real del usuario`, 'string') }}","telefono":"={{ $('camposiniciales').first().json.telefonoCliente }}","correo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('correo', `envia el correo`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"nombre","displayName":"nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Id","displayName":"Id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"correo","displayName":"correo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[5340,560],"id":"b769de56-c438-4c10-8d1b-7e03f0e24e72","name":"Nombre"},{"parameters":{"method":"PUT","url":"=https://gate.whapi.cloud/presences/{{ $('camposiniciales').first().json.Telefono }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"=Bearer Qo7qoYEVIKvRppohj25MEaHl1dPwskEv"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"presence","value":"typing"},{"name":"delay","value":"={{1200}}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2840,340],"id":"949cbf10-b430-4c20-a3ef-0fb306a491ed","name":"Escribiendo"},{"parameters":{"name":"buscar_promo"},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[-900,1940],"id":"d96b0227-3f64-4fb2-8f53-17b70b1fbc33","name":"Buscar promocion","disabled":true},{"parameters":{"name":"buscar_comida","description":"Utilizaras esta herramienta siempre que un usuario quiera sobre las comidas que vendemos, empandas, sandwiches, tartas, ensaldas etc si son productos de despensa no ingresar","workflowId":{"__rl":true,"value":"95iu7FwWHLs11Vkc","mode":"list","cachedResultName":"DESPENSA - Comidas"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Telefono":"={{ $('camposiniciales').first().json.telefonoCliente }}","descripcion":"={{ $('Delete').item.json.message_completo }}"},"matchingColumns":[],"schema":[{"id":"descripcion","displayName":"descripcion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[5460,560],"id":"17dbb49e-55ef-4f12-be89-46f818c0a2ea","name":"Buscar comida"},{"parameters":{"modelName":"models/gemini-2.5-flash-preview-04-17","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[4380,560],"id":"7a2f3ab1-2fe2-4e2b-826e-18e1f279f7f2","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"9O8uUWkp7h4KwsVD","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","sendQuery":true,"queryParameters":{"parameters":[{"name":"key"}]},"sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"contents\": [\n    {\n      \"parts\": [\n        {\n          \"text\": \"How does AI work?\"\n        }\n      ]\n    }\n  ]\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-900,1420],"id":"31bb78ef-ea30-4859-93ed-6ce4236a8775","name":"HTTP Request5"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('camposiniciales').first().json.telefonoCliente }}","tableName":"lo_de_pocho","contextWindowLength":15},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[4500,560],"id":"f7f3eb4f-0e20-4d1c-ba40-8ab9b8361c2d","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"E1mi81N6Tmr5cHS5","name":"GENERICO"}}},{"parameters":{"promptType":"define","text":"={{ $('Compara igualdad de memorias').first().json.message_completo  }}","hasOutputParser":true,"options":{"systemMessage":"=# Pocho ‚Äì Asistente Virtual (Optimizado para Gemini Flash 2.5)\n\nHOY ES :{{ $now.format('yyyy-MM-dd') }}\n\n## Identidad\n- Soy **Pocho**, asistente de Lo de Pocho (Neuqu√©n 2098, Mar del Plata)\n- Respuestas: cortas, argentinas, pr√°cticas\n- M√≠nimo para delivery: $30.000\n\n---\n\n## Promo Alfajores Chocotorta\n```\npromo_activa = true\n```\n\n### IMPORTANTE: GESTI√ìN DE RESERVAS ALFAJORES CHOCOTORTA:\n- **SIEMPRE**: Enviar Mensaje Principal EN LA BIENVENIDA\n- **Precio**: 3 alfajores por $4000 o $1500 cada uno\n- **Retiro**: Lunes pr√≥ximo a partir de las 12hs en Bol√≠var y Neuqu√©n\n\n### Mensaje Principal (INCLUIR EN CADA SALUDO INICIAL)\n```\nüç´ ¬°ALFAJORES DE CHOCOTORTA! üç´\n¬°Hac√© tu reserva HOY!\n‚Ä¢ 3 x $4000 üí∞\n‚Ä¢ $1500 cada uno\n‚û°Ô∏è Retir√° el lunes desde las 12hs en Bol√≠var y Neuqu√©n\n¬øCu√°ntos quer√©s reservar?\n```\n\n### Flujo de reserva\n1. Usuario solicita alfajores\n2. Preguntar cantidad\n3. Solicitar datos: nombre completo\n4. Solicitar n√∫mero de celular\n5. Ejecutar herramienta `insertar_pedido` con los datos recopilados\n6. Confirmar reserva: \"¬°Listo! Tu reserva est√° confirmada. Retir√° el lunes desde las 12hs en Bol√≠var y Neuqu√©n\"\n\n> **Importante**: Para completar la reserva, siempre usar la herramienta `insertar_pedido` con el nombre completo, n√∫mero de celular y cantidad de alfajores solicitados.\n\n## Bienvenida\n```\nüõí ¬°BIENVENIDO A LO DE POCHO! üõí\n\n¬°Hola! Soy Pocho, tu asistente virtual de Lo de Pocho (Neuqu√©n 2098, Mar del Plata).\n\n`INICIO PROMOCI√ìN (mostrar si promo_activa = true)`\n\nüç´ ¬°ALFAJORES DE CHOCOTORTA! üç´\n¬°Hac√© tu reserva HOY! ‚ö°Ô∏è\n‚Ä¢ 3 x $4000 üí∞\n‚Ä¢ $1500 cada uno\n‚û°Ô∏è Retir√° el lunes desde las 12hs en Bol√≠var y Neuqu√©n\n¬øCu√°ntos quer√©s reservar? ü§î`\n\nüì± C√ìMO HACER TU PEDIDO\n\n1Ô∏è‚É£ BUSC√Å PRODUCTOS ESPEC√çFICOS ü§î\n\n* \"¬øTen√©s leche?\" \"Quiero fideos\" \"Necesito aceite\"\n* Para elegir: \"2 x1, 5 x3\" (n√∫mero y cantidad)\n\n2Ô∏è‚É£ COMPLET√Å TUS DATOS üìä \n\n* Nombre, tel√©fono, ubicacion y email\n* Compart√≠ tu ubicaci√≥n para verificar zona de delivery\n\n3Ô∏è‚É£ PAG√Å F√ÅCIL y REINTEGROS üòâ ‚úÖ\n\n* Efectivo, transferencia o QR\n* M√≠nimo para delivery: $30.000\nüí° RECORD√Å\n\nBusc√° productos espec√≠ficos, no categor√≠as\n\nPara orientarte pregunt√° \"¬øQu√© tienen?\"\n\nüî•Consult√° por promos especiales usando \"¬øQu√© promociones tienen?\" üî•\n\n¬øEn qu√© puedo ayudarte hoy?\n```\n\n## REGLAS CR√çTICAS\n1. SIEMPRE mostrar el Mensaje Principal de promo 1-Mayo si es 1 de mayo (05-01) EN CADA PRIMER MENSAJE\n2. SIEMPRE usar herramientas para cada acci√≥n\n3. SIEMPRE usar `buscar_productos` para CADA consulta (nueva o repetida)\n4. NUNCA responder de memoria sobre productos, precios o stock\n5. Para preguntas generales (\"¬øQu√© tienen?\"), responder:\n   > \"En Lo de Pocho tenemos todo tipo de productos de despensa: l√°cteos, almac√©n, bebidas, limpieza, perfumer√≠a y m√°s. ¬øQu√© est√°s buscando en particular? üòä\"\n6. Temas fuera de despensa:\n   > \"Disculpame üôè, solo puedo ayudarte con productos, precios, env√≠os y pagos. ¬øTe doy una mano con la despensa? üõí\"\n\n## Herramientas\n- `buscar_productos`: OBLIGATORIO para TODA consulta de productos\n- `calcular_total`: Para sumar carrito (-$5.000 si promo_activa y ‚â•$40.000)\n- `verificar_elegibilidad_envio`: Confirma si pedido supera $30.000\n- `buscar_comida`: Para milanesas, sandwiches, bu√±uelos, tartas\n- `qr_pagos`: Genera QR seg√∫n billetera\n- `insertar_pedido`: Guarda pedido y genera c√≥digo\n- `promo_productos`: Consulta y muestra todas las promociones activas cuando usuario menciona: ofertas, promos, descuentos\n\n## Ejemplos de uso OBLIGATORIO de `buscar_productos`\n- \"¬øTen√©s leche?\" ‚Üí `buscar_productos` con \"leche\"\n- \"¬øA cu√°nto est√° el queso?\" ‚Üí `buscar_productos` con \"queso\"\n- \"¬øQu√© tienen disponible?\" ‚Üí Responder con lista general de categor√≠as\n- \"Quiero fideos\" ‚Üí `buscar_productos` con \"fideos\"\n- \"Mandame aceite\" ‚Üí `buscar_productos` con \"aceite\"\n\n## Promociones y activaci√≥n de promo_productos\n- `promo_productos`: ACTIVAR cuando el usuario mencione: \"promos\", \"promociones\", \"ofertas\", \"descuentos\", \"especiales\", \"qu√© hay de oferta\", \"tienen algo en oferta\", \"hay alguna promo\"\n- SIEMPRE mostrar promo del 1-Mayo cuando `promo_activa = true`\n\n## Ejemplos de activaci√≥n de promociones\n- \"¬øQu√© promociones tienen?\" ‚Üí `promo_productos`\n- \"¬øHay ofertas ahora?\" ‚Üí `promo_productos`\n- \"¬øTienen descuentos?\" ‚Üí `promo_productos`\n- \"Me interesa saber si hay promos\" ‚Üí `promo_productos`\n- \"¬øQu√© cosas est√°n en oferta?\" ‚Üí `promo_productos`\n\n## Formato de respuesta para promociones\n```\nüî• PROMOCIONES ACTIVAS üî•\n\n[Resultado de `promo_productos`]\n\n--- INICIO PROMOCI√ìN (mostrar si promo_activa = true) ---\nüéÅ PROMO ESPECIAL DEL D√çA DEL TRABAJADOR (1-MAYO) üéÅ\n‚ú® ¬°Te REGALAMOS $5.000 en tu compra de $40.000 o m√°s!\n‚ú® V√°lido SOLO HOY üóìÔ∏è\n--- FIN PROMOCI√ìN ---\n\nüí¨ ¬øQu√© productos te interesan?\n```\n\n## Integraci√≥n con flujo de pedido\n- Si usuario pregunta por promos y luego quiere productos ‚Üí seguir flujo normal con `buscar_productos`\n- Si compra supera $40.000 y `promo_activa == true` ‚Üí recordar aplicaci√≥n de descuento\n- Ejemplo de recordatorio: \"¬°Genial! Tu compra supera los $40.000, as√≠ que te aplicamos el descuento de $5.000 por el D√≠a del Trabajador üéâ\"\n\n## Verificaci√≥n de ubicaci√≥n para delivery\n- Cuando el usuario comparta ubicaci√≥n: usar `verificar_rango_delivery` con coordenadas\n- Cuando el usuario escriba una direcci√≥n: usar `verificar_rango_delivery` con direcci√≥n \n- SIEMPRE VERIFICAR ubicaci√≥n ANTES de confirmar delivery\n- Respuestas:\n  ‚Ä¢ Si est√° en rango: \"¬°Genial! Tu ubicaci√≥n est√° dentro de nuestra zona de delivery.\"\n  ‚Ä¢ Si NO est√° en rango: \"Lo siento, tu ubicaci√≥n est√° fuera de nuestra zona de delivery. Pod√©s retirar tu pedido en el local: Neuqu√©n 2098, Mar del Plata.\"\n- Si el usuario manda su ubicaci√≥n por WhatsApp, responder inmediatamente verificando si est√° en rango\n\n## Flujo r√°pido\n1. B√∫squeda: `buscar_productos` con t√©rmino exacto\n2. Cantidad: \"¬øCu√°ntas unidades quer√©s?\"\n3. Datos: SIEMPRE solicitar y validar TODOS estos datos:\n   - Nombre: \"¬øCu√°l es tu nombre completo?\"\n   - Tel√©fono: \"¬øMe pas√°s tu n√∫mero de tel√©fono?\"\n   - Direcci√≥n: \"¬øCu√°l es tu ubicacion?, compartimela y la analizo (Le das a compartir ubicacion y me la envias)\"\n   - Correo: \"¬øMe dec√≠s tu correo electr√≥nico?\"\n   - Si falta alg√∫n dato: \"Para completar tu pedido necesito todos tus datos\"\n   - Si ya tiene datos previos: \"Tengo estos datos: [mostrar todos] ¬øEst√°n correctos?\"\n4. Verificar ubicaci√≥n: `verificar_rango_delivery` con la direcci√≥n\n   - Si est√° fuera de rango: \"Tu direcci√≥n est√° fuera de nuestra zona de delivery. ¬øPrefer√≠s retirar en el local?\"\n5. Total y env√≠o: `calcular_total` y `verificar_elegibilidad_envio`\n   - <$30.000 ‚Üí solo retiro\n   - ‚â•$30.000 Y en rango ‚Üí env√≠o disponible\n   - ‚â•$30.000 PERO fuera de rango ‚Üí solo retiro\n6. Pago: \"¬øC√≥mo vas a pagar? üíµ Efectivo / üè¶ Transferencia / üì≤ QR\"\n7. Confirmar: Mostrar resumen COMPLETO y confirmar\n\n## Formato de Productos (EXACTO)\n```\nüßÄ L√°cteos\n1. ‚ú® Queso Cremoso 500g ‚Äì $2.500\n2. ‚ú® Leche Entera 1L ‚Äì $1.250\n\nüçù Almac√©n\n3. ‚ú® Fideos 500g ‚Äì $900\n4. ‚ú® Arroz 1kg ‚Äì $1.100\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüí¨ Pedime el n√∫mero y cantidad. Ej.: \"3 x2, 4 x1\"\n```\n\n## QR y pagos\n- Si pide QR sin especificar: \"Tenemos QR de: MODO, Banco Naci√≥n, Franc√©s, Cuenta DNI, Mercado Pago\"\n- Si elige banco: `qr_pagos` con ese banco ‚Üí responder SOLO \"qr_enviado\"\n- Transferencia: \"Transfer√≠ al alias **Antofiginillull**\"\n- Efectivo: \"Pag√°s al retirar o recibir\"\n\n## Resumen final\n```\nResumen de tu pedido:\n  Nombre: {Nombre}\n  Tel√©fono: {Tel√©fono}\n  Direcci√≥n: {Direcci√≥n}\n  Correo: {Correo}\n  Modalidad: {Env√≠o/Retiro}\n  Productos:\n    - {producto1} ‚Äì ${precio1}\n    - {producto2} ‚Äì ${precio2}\n    - ...\n  Total: ${total}\n  Pago: {m√©todo_pago}\n```\n> \"‚úÖ ¬øConfirm√°s que todo est√° bien y quer√©s finalizar?\"\n\nSIEMPRE incluir TODOS los datos (Nombre, Tel√©fono, Direcci√≥n, Correo) en el resumen.\nSi dice \"s√≠\": `insertar_pedido` ‚Üí \"üéâ Listo, {Nombre}. Tu pedido qued√≥ confirmado. C√≥digo: *{codigo}*.\"\nSi dice \"no\": \"¬øQu√© quer√©s modificar?\" y corregir lo necesario."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[4840,340],"id":"dbf21b06-d762-412b-b6ad-7d9966bcd5d7","name":"Pocho"},{"parameters":{"operation":"push","list":"={{ $('camposiniciales').item.json.telefonoCliente }}","messageData":"={{ $json?.content || $json.response }}","tail":true},"id":"6073ceaa-ea69-4aa7-bf3d-1049aa7de22b","name":"apilaTexto","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1900,620],"credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"f06e3084-8cb9-4f87-ad09-c55455696615","leftValue":"={{ $json?.output ||  JSON.stringify($json.output[0].text)   }}","rightValue":"qr_enviado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[5660,340],"id":"fb8a394b-f78b-44c1-95ef-f00b33a200c6","name":"If1"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer Qo7qoYEVIKvRppohj25MEaHl1dPwskEv"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"={{ $json.msg.replace(/\\n/g,'\\n').replace(/\\\"/g,'\\'') }}"},{"name":"to","value":"={{ $('camposiniciales').first().json.telefonoCliente }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[6760,265],"id":"1347c2b6-663a-45d7-b21b-eff486ff5c50","name":"Texto"},{"parameters":{"operation":"set","key":"=follow_up:{{ $('camposiniciales').item.json.telefonoCliente }}","value":"={{$now}}","expire":true},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-900,2180],"id":"403cc44f-9fbd-4f4d-9b8c-519a3473e6c1","name":"Follow","credentials":{"redis":{"id":"JMklVOvkU7koL2UG","name":"Redis"}}},{"parameters":{"workflowId":{"__rl":true,"value":"fPuzUHak5Qv9RB8I","mode":"list","cachedResultName":"DESPENSA - verificar_elegibilidad_envio"},"workflowInputs":{"mappingMode":"defineBelow","value":{"location":"={{ $json.location.location }}"},"matchingColumns":[],"schema":[{"id":"direccion","displayName":"direccion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"location","displayName":"location","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"object"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[1540,760],"id":"a3af08d7-a703-40a2-80a0-388a8aea6771","name":"Execute Workflow"},{"parameters":{"name":"promo_productos","description":"Llama a esta herramienta siempre que un usuario quiera ver las promociones de productos","workflowId":{"__rl":true,"value":"HAtUjKa7vn5tm7K1","mode":"list","cachedResultName":"DESPENSA - Promociones_productos"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Telefono":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Telefono', ``, 'string') }}","descripcion":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('descripcion', ``, 'string') }}"},"matchingColumns":[],"schema":[{"id":"descripcion","displayName":"descripcion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[5600,560],"id":"989a1c4e-d65c-42fc-8b44-b04358238590","name":"promociones"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1700,240],"id":"fef8c5df-7343-44e1-895e-5bc34aaa0beb","name":"Merge"}],"connections":{"Segmentos":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"1,2s":{"main":[[{"node":"Texto","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"1,2s","type":"main","index":0}]]},"Insertar pedido":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"replace":{"main":[[{"node":"Segmentos","type":"main","index":0}]]},"Promociones":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"QR":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"Crypto":{"main":[[{"node":"InsertarCliente","type":"main","index":0}]]},"Format JSON":{"main":[[{"node":"Response","type":"main","index":0},{"node":"If123","type":"main","index":0},{"node":"vars","type":"main","index":0}]]},"Buscar productos":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"If":{"main":[[{"node":"camposiniciales","type":"main","index":0}],[{"node":"Crypto","type":"main","index":0}]]},"From Me2":{"main":[[{"node":"Chatwoot msg","type":"main","index":0}]]},"From Me3":{"main":[[],[{"node":"getClientes","type":"main","index":0}]]},"Message Type1":{"main":[[{"node":"Merge","type":"main","index":0}],[{"node":"Edit Fields4","type":"main","index":0}],[],[],[{"node":"Execute Workflow","type":"main","index":0}]]},"Audio Memory":{"main":[[{"node":"Return Redis1","type":"main","index":0}]]},"Get Memory 2":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Wait 10s":{"main":[[{"node":"Get Memory 2","type":"main","index":0}]]},"OpenAI2":{"main":[[{"node":"Audio Memory","type":"main","index":0}]]},"Edit Fields4":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Tiempo1":{"main":[[{"node":"Escribiendo","type":"main","index":0}]]},"Return Redis1":{"main":[[{"node":"Tiempo1","type":"main","index":0}]]},"InsertCliente":{"main":[[]]},"Redis":{"main":[[{"node":"Compara Get Memory","type":"main","index":0}]]},"Compara igualdad de memorias":{"main":[[{"node":"Delete","type":"main","index":0}]]},"Compara Get Memory":{"main":[[{"node":"Compara igualdad de memorias","type":"main","index":0}],[]]},"Delete":{"main":[[{"node":"Pocho","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"OpenAI2","type":"main","index":0}]]},"HTTP Request2":{"main":[[]]},"ubicacion":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"Respuesta a ChatWoot2":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"From Me2","type":"main","index":0}]]},"camposiniciales":{"main":[[{"node":"Message Type1","type":"main","index":0}]]},"Redis3":{"main":[[{"node":"From Me3","type":"main","index":0}]]},"Chatwoot msg":{"main":[[{"node":"Redis3","type":"main","index":0}]]},"InsertarCliente":{"main":[[{"node":"camposiniciales","type":"main","index":0}]]},"getClientes":{"main":[[{"node":"If","type":"main","index":0}]]},"calcular_total":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"Nombre":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"Escribiendo":{"main":[[{"node":"Wait 10s","type":"main","index":0}]]},"Buscar promocion":{"ai_tool":[[]]},"Buscar comida":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Pocho","type":"ai_languageModel","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"Pocho","type":"ai_memory","index":0}]]},"Pocho":{"main":[[{"node":"If1","type":"main","index":0}]]},"apilaTexto":{"main":[[{"node":"Return Redis1","type":"main","index":0}]]},"If1":{"main":[[],[{"node":"replace","type":"main","index":0}]]},"Texto":{"main":[[{"node":"Respuesta a ChatWoot2","type":"main","index":0}]]},"Execute Workflow":{"main":[[{"node":"Merge","type":"main","index":1}]]},"promociones":{"ai_tool":[[{"node":"Pocho","type":"ai_tool","index":0}]]},"Merge":{"main":[[{"node":"apilaTexto","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","errorWorkflow":"2kOn0Oz7c2uvczPK","callerPolicy":"workflowsFromSameOwner","timezone":"America/Argentina/Buenos_Aires"},"staticData":{"node:File Created":{"lastTimeChecked":"2025-01-24T00:40:06Z"},"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.innovasoftpro.dev","content-length":"328","accept":"application/json","content-type":"application/json","x-forwarded-for":"65.21.161.42","x-forwarded-host":"n8n.innovasoftpro.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"575dad520f0e","x-real-ip":"65.21.161.42","accept-encoding":"gzip"},"params":{},"query":{},"body":{"messages":[{"id":"LJtNlkBN8qSX9xnCX9LO9g-gLUE_sLLqiU","from_me":false,"type":"text","chat_id":"5492236331557@s.whatsapp.net","timestamp":1746892566,"source":"mobile","text":{"body":"Leche crema galletitas etc"},"from":"5492236331557","from_name":"Romi"}],"event":{"type":"messages","event":"post"},"channel_id":"GROOTT-ZSFJB"},"webhookUrl":"https://n8n.innovasoftpro.dev/webhook/lodepocho","executionMode":"production"}}]},"versionId":"d8c78e7c-e59a-4f7d-a4ef-c1868c6cdb8d","triggerCount":1,"tags":[{"createdAt":"2025-01-19T21:20:51.336Z","updatedAt":"2025-01-19T21:20:51.336Z","id":"dgrS6et84MZNe4W0","name":"POCHO"}]}