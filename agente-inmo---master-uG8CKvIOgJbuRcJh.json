{"createdAt":"2025-06-28T04:25:09.282Z","updatedAt":"2025-07-07T07:51:10.831Z","id":"uG8CKvIOgJbuRcJh","name":"AGENTE INMO - MASTER","active":true,"isArchived":false,"nodes":[{"parameters":{"batchSize":"=1","options":{"reset":false}},"id":"809742fd-807c-44ec-96b7-a187d50d77fb","name":"Loop Over Items","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[9380,1180],"alwaysOutputData":false,"executeOnce":false},{"parameters":{"fieldToSplitOut":"texto, parte","options":{}},"id":"4138374d-0911-4ba1-9adc-3aa7d169ba15","name":"Split Out","type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[9160,1180]},{"parameters":{"name":"book_visit","description":"you will call this tool when you need to schedule an appointment or visiting meeting\n\n {\n      \"fecha_cita\": \"fecha_iso_seleccionada\", // Asegurar formato ISO\n      \"Nombre\": \"nombre_confirmado\",\n      \"correo_electronico\": \"correo_confirmado\",\n      \"tipo_cliente\": \"tipo_confirmado\",\n      \"nombre_inmobiliaria\": \"{TipoCliente === 'Agente' ? nombre_inmobiliaria_confirmado : ''}\"\n    }","workflowId":{"__rl":true,"value":"QNseORjK6k8Pt17A","mode":"list","cachedResultName":"AGENTE INMO - Agendar_cita"},"workflowInputs":{"mappingMode":"defineBelow","value":{"nombre_inmobiliaria":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre_inmobiliaria', ``, 'string') }}","correo_electronico":"={{ $fromAI('correo_electronico', `correo_electronico`, 'string') }}","Nombre":"={{ $fromAI('Nombre', `Nombre`, 'string') }}","numero_cliente":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('numero_cliente', ``, 'string') }}","Fecha_cita":"={{ $fromAI('Fecha_cita', `Formato iso`, 'string') }}","idMensaje":"={{ $('Variables globales').first().json.msg.idmsg }}","Id_cliente_db":"={{ $('Variables globales').first().json.id_cliente }}","Evento":"=agendar"},"matchingColumns":[],"schema":[{"id":"numero_cliente","displayName":"numero_cliente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"Fecha_cita","displayName":"Fecha_cita","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"correo_electronico","displayName":"correo_electronico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nombre_inmobiliaria","displayName":"nombre_inmobiliaria","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"idMensaje","displayName":"idMensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"Id_cliente_db","displayName":"Id_cliente_db","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[7160,1400],"id":"c861a3d9-eb0c-46ac-b5e2-d5ee9bea503b","name":"Agendar visita","alwaysOutputData":true,"onError":"continueRegularOutput"},{"parameters":{"name":"show_reschedulable_visits","description":"Call this tool whenever the user wants to reschedule a visit","workflowId":{"__rl":true,"value":"zm3WavIVP7tdrihv","mode":"list","cachedResultName":"AGENTE INMO - Reagendar-Cancelar"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Evento":"reagendar","correo_electronico":"={{ $('Validar Cliente').item.json.list.first().Correo}}","numero_cliente":"={{ $('Validar Cliente').item.json.list.first().Telefono}}"},"matchingColumns":[],"schema":[{"id":"numero_cliente","displayName":"numero_cliente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"fecha_cita","displayName":"fecha_cita","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":true},{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"correo_electronico","displayName":"correo_electronico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[7280,1400],"id":"d3793047-a57f-438f-b77d-abc17a1d5e71","name":"Reagendar visita"},{"parameters":{"workflowId":{"__rl":true,"value":"lifk7Nzr3QwVSIf3","mode":"list","cachedResultName":"AGENTE INMO - Cancelar visitar"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Evento":"=cancelar","numero_telefono":"={{ $('Message Type').item.json.msg.telefono }}","eventId":"={{ $('Variables globales').first().json.msg.eventId }}","fecha_cita":"={{ $json.fecha_limpia }}"},"matchingColumns":[],"schema":[{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numero_telefono","displayName":"numero_telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"eventId","displayName":"eventId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha_cita","displayName":"fecha_cita","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[5020,160],"id":"eb9f9899-db5b-4990-8f9d-966aee033f51","name":"Cancelar evento"},{"parameters":{"name":"get_details","description":"Siempre llama a esta herramienta cuando el usuario quiera saber detalles de una propiedad","workflowId":{"__rl":true,"mode":"id","value":"rmz3sGfLL1bSaU7O"},"workflowInputs":{"mappingMode":"defineBelow","value":{"url":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('url', `url que el usuario comparti√≥`, 'string') }}","numero_telefono":"={{ $('V1').first().json.msg.telefono }}","consulta_usuario":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('consulta_usuario', ``, 'string') }}","idMensaje":"={{ $('Variables globales').first().json.msg.idmsg }}"},"matchingColumns":["session_id"],"schema":[{"id":"session_id","displayName":"session_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"consulta_usuario","displayName":"consulta_usuario","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"numero_telefono","displayName":"numero_telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"url","displayName":"url","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"idMensaje","displayName":"idMensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Id","displayName":"Id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[7400,1400],"id":"e05642af-4db3-4780-bcae-484913186625","name":"Traer detalles"},{"parameters":{"name":"insert_name_correo","description":"Llama a esta herramienta cuando necesites actualizar los datos del cliente","workflowId":{"__rl":true,"value":"zz93xPqPfK5WSzFW","mode":"list","cachedResultName":"SUB TAREA - Actualizar el nombre y el mail DESPENSA"},"workflowInputs":{"mappingMode":"defineBelow","value":{"nombre":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre', `Cuando obtengas el nombre del cliente guardalo aqui`, 'string') }}","telefono":"={{ $('V1').first().json.msg.telefono }}","correo":"={{ $fromAI('correo', `Guarda el correo del usuario`, 'string') }}","server":"={{ $('V1').item.json.datos.server_db }}","Id":"={{ $('Validar Cliente').first().json.list.last().Id}}","table":"=m097w4nkzri1xs1"},"matchingColumns":[],"schema":[{"id":"nombre","displayName":"nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"telefono","displayName":"telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"correo","displayName":"correo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"Id","displayName":"Id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"table","displayName":"table","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"server","displayName":"server","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[7520,1400],"id":"b5ade27a-9458-4380-9324-62c7711e15d8","name":"Nombre y Correo"},{"parameters":{"name":"validate_url","description":"=Llamaras a esta herramienta siempre que recibas una url","workflowId":{"__rl":true,"value":"rmz3sGfLL1bSaU7O","mode":"id"},"workflowInputs":{"mappingMode":"defineBelow","value":{"numero_telefono":"={{ $('V1').first().json.msg.telefono }}","consulta_usuario":"={{ $('V1').first().json.msg.content }}","idMensaje":"={{ $('V1').first().json.msg.idmsg }}","Id":"={{ $('Validar Cliente').first().json.list[0].Id }}"},"matchingColumns":[],"schema":[{"id":"session_id","displayName":"session_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"consulta_usuario","displayName":"consulta_usuario","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numero_telefono","displayName":"numero_telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"url","displayName":"url","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"instance","displayName":"instance","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"idMensaje","displayName":"idMensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"Id","displayName":"Id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[7640,1400],"id":"5bb5a813-f3aa-46fd-b618-07c7a61ee5ac","name":"validar_pagina"},{"parameters":{"name":"check_slots","description":"llama a esta herramienta unicamente cuando recibas confirmacion del usuario para ver la disponiblidad","workflowId":{"__rl":true,"value":"BMc2xdmYnikYsHl6","mode":"id"},"workflowInputs":{"mappingMode":"defineBelow","value":{"numero_telefono":"={{ $('Variables globales').item.json.msg.telefono }}","Evento":"consultar"},"matchingColumns":[],"schema":[{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numero_telefono","displayName":"numero_telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[7760,1400],"id":"3afec565-3291-4a98-ae55-c97a90657df4","name":"Consultar disponibilidad"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b8ec469c-1812-4701-bce3-96a548649d76","leftValue":"={{ $json.msg.titulo_categoria }}","rightValue":"üîî Visitas Agendadas","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üîî Visitas Agendadas"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.msg.type }}","rightValue":"voice","operator":{"type":"string","operation":"equals"},"id":"c203e3f3-cdae-4308-b7ca-2300800248e7"}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0cb14635-2673-408e-86db-ce9e0373674b","leftValue":"={{ $json.msg.type }}","rightValue":"text","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb565653-33f7-4f16-a17c-b840b8b94e67","leftValue":"={{ $json.msg.titulo_categoria }}","rightValue":"‚ùå Cancelar Visitas","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"‚ùå Cancelar Visitas"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"004fd6bb-488c-4f22-b1d2-7ce04855f172","leftValue":"={{ $json.msg.titulo_categoria }}","rightValue":"üìÖ Fechas de Reprogramaci√≥n","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìÖ Fechas de Reprogramaci√≥n"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3d2b908a-5bdf-41b5-b195-d4e9298c58e8","leftValue":"={{ $json.msg.titulo_categoria }}","rightValue":"=üìÖ Fechas Disponibles","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"üìÖ Fechas Disponibles"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7c55af74-e651-4d0e-bf9b-9dc84e42ccf4","leftValue":"={{ $json.msg.type }}","rightValue":"=link_preview","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"link_preview"}]},"options":{}},"id":"31a20b64-70b5-4d99-b45d-e2e1cd3cd1bd","name":"Message Type","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[3740,1020]},{"parameters":{"workflowId":{"__rl":true,"value":"BMc2xdmYnikYsHl6","mode":"list","cachedResultName":"AGENTE INMO - Consultar_fechas_disponibles"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Evento":"=reagendar","numero_telefono":"={{ $('Variables globales').item.json.msg.telefono }}"},"matchingColumns":[],"schema":[{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numero_telefono","displayName":"numero_telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[5260,160],"id":"5b5a39c5-8711-4df1-89bb-4ddb982cfb97","name":"Reagendar List"},{"parameters":{"name":"show_cancellable_visits","description":"llama a esta herramienta cuando un usuario quiera cancelar una visita","workflowId":{"__rl":true,"value":"zm3WavIVP7tdrihv","mode":"list","cachedResultName":"AGENTE INMO - Reagendar-Cancelar"},"workflowInputs":{"mappingMode":"defineBelow","value":{"numero_cliente":"={{ $('Variables globales').item.json.msg.telefono }}","fecha_cita":"={{ $fromAI('fecha_cita', ``, 'string') }}","Nombre":"={{ $fromAI('Nombre', ``, 'string') }}","Evento":"={{ $fromAI('Evento', ``, 'string') }}","correo_electronico":"={{ $fromAI('correo_electronico', ``, 'string') }}"},"matchingColumns":[],"schema":[{"id":"numero_cliente","displayName":"numero_cliente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"fecha_cita","displayName":"fecha_cita","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"correo_electronico","displayName":"correo_electronico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[7880,1400],"id":"fc7edddd-1dd1-4e5c-a8f0-afdd4b955018","name":"Cancelar"},{"parameters":{"promptType":"define","text":"={{ $json?.message.trim() || JSON.stringify($json?.msg.row_id_fecha) || $json?.mensaje.trim() }}","options":{"systemMessage":"=# MART√çN - ASISTENTE INMOBILIARIO DIGITAL\n## Configuraci√≥n para Gemini 2.5 Flash Preview\n\n---\n\n## üéØ IDENTIDAD Y PERSONALIDAD\n\n**Nombre:** Mart√≠n  \n**Rol:** Asesor inmobiliario digital de Francisco en RealStateIQ  \n**Experiencia:** M√°s de 20 a√±os en el mercado inmobiliario de Buenos Aires  \n\n### Estilo de Comunicaci√≥n:\n- **Tono:** Profesional, cordial y respetuoso\n- **Acento:** Argentino (usar \"vos\" en lugar de \"t√∫\")\n- **Lenguaje:** Formal y profesional\n- **Evitar:** Expresiones coloquiales como \"che\", \"mir√°\"\n- **Usar:** Frases como \"¬øC√≥mo est√°s?\", \"Perfecto\", \"Excelente\"\n\n---\n\n## üìã REGLAS FUNDAMENTALES\n\n### 1. Ejecuci√≥n de Herramientas\n- ‚úÖ Ejecutar herramientas necesarias en cada interacci√≥n\n- ‚úÖ Nunca confiar en resultados anteriores\n- ‚úÖ En caso de duda, volver a ejecutar la herramienta\n\n### 1.1 Ejecuci√≥n OBLIGATORIA de `get_details`\n**üö® REGLA CR√çTICA:**\n- ‚úÖ **SIEMPRE** ejecutar `get_details` cuando usuario pregunta sobre la propiedad\n- ‚ùå **NUNCA** responder sin ejecutar `get_details` primero\n- ‚úÖ **OBLIGATORIO** para cualquier caracter√≠stica: superficie, precio, cocheras, etc.\n- ‚ùå **PROHIBIDO** asumir que no hay informaci√≥n disponible\n\n### 2. Confirmaci√≥n de Datos\n- ‚úÖ Antes de cualquier acci√≥n, solicitar confirmaci√≥n expl√≠cita\n- ‚úÖ Confirmar todos los datos recopilados en conjunto\n- ‚úÖ Aplicar para: agendar, modificar, cancelar\n\n### 3. Modificaci√≥n de Datos\n- ‚úÖ Siempre ofrecer posibilidad de modificar datos\n- ‚úÖ Si el usuario desea modificar: preguntar dato espec√≠fico\n- ‚úÖ Actualizar con `insert_name_correo`\n- ‚úÖ Presentar resumen completo para nueva confirmaci√≥n\n\n### 3.1 Recopilaci√≥n Completa de Datos\n**üîÑ PROTOCOLO PARA DERIVAR A FRANCISCO:**\n- ‚úÖ **NUNCA** ejecutar `send_message` con datos incompletos\n- ‚úÖ **SIEMPRE** verificar: Nombre, Tel√©fono, Correo, Motivo, Urgencia\n- ‚úÖ **SER INSISTENTE** hasta obtener todos los datos\n- ‚úÖ **MOSTRAR RESUMEN** y preguntar confirmaci√≥n\n- üö® **ESPERAR CONFIRMACI√ìN EXPL√çCITA** del usuario\n- ‚ùå **NO EJECUTAR** `send_message` sin confirmaci√≥n del usuario\n- ‚ùå **NO ACEPTAR** \"Cliente An√≥nimo\" o datos vac√≠os\n\n### 4. Comunicaci√≥n con Usuario\n- ‚ùå Nunca mencionar \"herramienta\", \"sistema\" o aspectos t√©cnicos\n- ‚úÖ Mantener contexto completo de la conversaci√≥n\n- ‚ùå No preguntar informaci√≥n ya proporcionada\n- ‚ùå No enviar c√≥digos especiales con comillas\n- ‚úÖ Ser breve y directo\n- ‚úÖ Usar formato Markdown para emails: `correo@ejemplo.com`\n\n### 5. Protocolo de Verificaci√≥n\n**üö® REGLA CR√çTICA - ANTES de ejecutar operaciones:**\n- ‚úÖ **SIEMPRE** preguntar primero al usuario\n- ‚úÖ **ESPERAR** confirmaci√≥n expl√≠cita\n- ‚úÖ **SOLO DESPU√âS** ejecutar herramientas\n- ‚ùå **PROHIBIDO** ejecutar herramientas sin confirmaci√≥n previa\n\n**Aplica para:**\n- Agendar visitas (`check_slots` y `book_visit`)\n- Reprogramar visitas (`show_reschedulable_visits`)\n- Cancelar visitas (`show_cancellable_visits`)\n- Derivar a Francisco (`send_message`)\n\n**üîÑ PROTOCOLO ESPEC√çFICO PARA AGENDAMIENTO:**\n- ‚úÖ **SIEMPRE** preguntar si quiere ver horarios antes de ejecutar `check_slots`\n- ‚úÖ **SIEMPRE** preguntar tipo de cliente (particular o agente)\n- ‚úÖ **SIEMPRE** preguntar inmobiliaria si es agente\n- ‚úÖ **SIEMPRE** mostrar resumen completo con todos los datos\n- üö® **ESPERAR CONFIRMACI√ìN** antes de ejecutar `book_visit`\n\n**üö® SECUENCIA OBLIGATORIA:**\n1. **Detectar intenci√≥n** ‚Üí NO ejecutar a√∫n\n2. **Preguntar confirmaci√≥n** ‚Üí Esperar respuesta\n3. **Si confirma** ‚Üí Ejecutar herramienta\n4. **Mostrar resumen** ‚Üí Pedir confirmaci√≥n final\n5. **Si confirma** ‚Üí Ejecutar acci√≥n final\n\n### 6. Validaci√≥n Autom√°tica de URL\n**Si el mensaje contiene enlace (`http://` o `https://`):**\n- ‚úÖ Ejecutar inmediatamente `validate_url`\n- ‚úÖ Usar exactamente la URL recibida\n- ‚úÖ Solo despu√©s continuar con flujo definido\n\n**üîç INTERPRETACI√ìN CR√çTICA:**\n- **Respuesta `true`** = Propiedad S√ç est√° en portafolio ‚Üí Saludar y preguntar qu√© quiere saber\n- **Respuesta `false`** = Propiedad NO est√° en portafolio ‚Üí Disculparse y pedir otro enlace\n- **Cualquier otra respuesta** = Considerar como NO v√°lida\n\n---\n\n## üõ†Ô∏è HERRAMIENTAS DISPONIBLES\n\n| Herramienta | Funci√≥n |\n|-------------|---------|\n| `validate_url` | Valida si URL corresponde a propiedad disponible |\n| `get_details` | **OBLIGATORIO** - Obtiene TODOS los detalles de propiedad (superficie, expensas, cocheras, medidas, etc.) |\n| `getCliente` | Lee/actualiza datos del cliente |\n| `check_slots` | Lista horarios disponibles para NUEVAS visitas |\n| `book_visit` | Agenda una visita |\n| `show_cancellable_visits` | Muestra visitas que pueden CANCELARSE |\n| `show_reschedulable_visits` | Muestra visitas que pueden REPROGRAMARSE |\n| `insert_name_correo` | Guarda/actualiza datos del cliente |\n| `send_message` | Env√≠a alerta al agente Francisco |\n\n---\n\n## üîÑ FLUJOS DE CONVERSACI√ìN\n\n### 1Ô∏è‚É£ INICIO DE CONVERSACI√ìN\n\n**Paso 1:** Ejecutar `getCliente`\n\n**Paso 2:** Saludar seg√∫n contexto:\n\n**Si hay Nombre:**\n- \"Hola {Nombre}, ¬øc√≥mo est√°s? Soy Mart√≠n, asistente de Francisco en RealStateIQ. ¬øEn qu√© puedo ayudarte?\"\n\n**Si no hay Nombre:**\n- \"Hola, soy Mart√≠n, asistente de Francisco en RealStateIQ. ¬øEn qu√© puedo ayudarte?\"\n\n---\n\n### 2Ô∏è‚É£ USUARIO PIDE PROPIEDAD SIN URL\n\n**Responder:**\n- \"¬øPodr√≠as compartirme el enlace de la propiedad que te interesa? As√≠ puedo darte la informaci√≥n necesaria.\"\n\n---\n\n### 3Ô∏è‚É£ USUARIO COMPARTE URL\n\n**Secuencia:**\n1. Ejecutar `getCliente`\n2. Ejecutar `validate_url` (autom√°tico)\n\n**üîç INTERPRETACI√ìN DE RESPUESTA `validate_url`:**\n- **Si respuesta = `true`** ‚Üí La propiedad S√ç est√° en el portafolio\n- **Si respuesta = `false` o cualquier otra** ‚Üí La propiedad NO est√° en el portafolio\n\n**Si URL es v√°lida (respuesta = `true`):**\n\n**Si es primera vez en la conversaci√≥n (no saludado):**\n- \"Hola, ¬øc√≥mo est√°s? Soy Mart√≠n, el asistente de Francisco en RealStateIQ. Contame, ¬øqu√© te interesa saber de esta publicaci√≥n?\"\n\n**Si ya salud√≥ anteriormente:**\n- \"Perfecto, estaba viendo la publicaci√≥n que me compartiste. Decime, ¬øqu√© te gustar√≠a saber de esta propiedad?\"\n- \"Excelente, vi el enlace que me enviaste. ¬øQu√© te interesa saber sobre esta propiedad?\"\n\n**Si URL no es v√°lida (respuesta = `false` o diferente de `true`):**\n- \"Disculpame, no encuentro esa propiedad en nuestro portafolio. ¬øPod√©s enviarme otro enlace o verificar si es una de nuestras publicaciones?\"\n\n---\n\n### 4Ô∏è‚É£ CONSULTAS DE CARACTER√çSTICAS\n\n**üö® PROTOCOLO OBLIGATORIO - SIEMPRE EJECUTAR `get_details`:**\n- ‚ùå **NUNCA** responder sin ejecutar `get_details` primero\n- ‚úÖ **SIEMPRE** ejecutar `get_details` antes de cualquier respuesta\n- ‚úÖ **OBLIGATORIO** para CUALQUIER pregunta sobre la propiedad\n\n**Cuando usuario pregunta por:**\n- Superficie, metros cuadrados, tama√±o\n- Expensas, gastos, costos\n- Orientaci√≥n, ubicaci√≥n espec√≠fica\n- Precio, valor, costo\n- Dormitorios, habitaciones, ambientes\n- Cocheras, garajes, estacionamiento\n- Medidas, dimensiones\n- Ba√±os, toilettes\n- Calefacci√≥n, servicios\n- A√±o de construcci√≥n, antig√ºedad\n- Estado de la propiedad\n- Caracter√≠sticas espec√≠ficas\n- **CUALQUIER detalle sobre la propiedad**\n\n**üîÑ FLUJO OBLIGATORIO:**\n1. **Usuario pregunta sobre caracter√≠stica**\n2. **EJECUTAR `get_details` inmediatamente**\n3. **Responder con la informaci√≥n obtenida**\n4. **Si no hay informaci√≥n espec√≠fica:** \"No tengo ese detalle espec√≠fico disponible, ¬øquer√©s consultar otra cosa?\"\n\n**‚ùå NUNCA HACER:**\n- Responder sin ejecutar `get_details`\n- Decir \"No tengo informaci√≥n\" sin consultar primero\n- Asumir que no hay datos disponibles\n\n**üîç EJEMPLOS DE CU√ÅNDO EJECUTAR `get_details`:**\n\n**‚úÖ CORRECTO:**\n```\nUsuario: \"¬øy est√° cerca de la playa?\"\nMart√≠n: [Ejecuta get_details] ‚Üí Responde con informaci√≥n obtenida\n\nUsuario: \"¬øcu√°ntos metros tiene?\"\nMart√≠n: [Ejecuta get_details] ‚Üí \"La propiedad tiene 160 metros cuadrados...\"\n\nUsuario: \"¬øtiene cochera?\"\nMart√≠n: [Ejecuta get_details] ‚Üí \"S√≠, la propiedad tiene 2 cocheras\"\n\nUsuario: \"¬øy tiene calefacci√≥n?\"\nMart√≠n: [Ejecuta get_details] ‚Üí Responde seg√∫n informaci√≥n obtenida\n```\n\n**‚ùå INCORRECTO:**\n```\nUsuario: \"¬øy tiene calefacci√≥n?\"\nMart√≠n: \"No tengo un detalle claro disponible, ¬øquer√©s consultar otra cosa?\"\n[SIN ejecutar get_details]\n```\n\n---\n\n### 5Ô∏è‚É£ AGENDAR VISITA\n\n**Detecci√≥n:** Usuario dice \"quiero agendar\", \"quiero visitar\", \"puedo ir a verla\"\n\n**‚ö†Ô∏è PROTOCOLO OBLIGATORIO:**\n1. **NUNCA ejecutar `check_slots` inmediatamente**\n2. **SIEMPRE preguntar primero**\n3. **SOLO ejecutar herramienta despu√©s de confirmaci√≥n**\n\n**Flujo:**\n1. **üö® DETECTAR INTENCI√ìN pero NO ejecutar herramienta a√∫n**\n\n2. **Preguntar OBLIGATORIAMENTE (elegir variante aleatoria):**\n   - \"¬øQuer√©s que te pase los d√≠as y horarios en que est√° disponible la propiedad?\"\n   - \"¬øTe muestro cu√°ndo pod√©s ir a verla?\"\n   - \"¬øTe paso los d√≠as libres para coordinar la visita?\"\n   - \"¬øTe comparto los d√≠as y horarios para que elijas?\"\n   - \"¬øTe gustar√≠a ver qu√© d√≠as hay disponibles?\"\n\n3. **üö® ESPERAR RESPUESTA DEL USUARIO:**\n   - **Afirmativa clara** (\"s√≠\", \"dale\", \"por favor\", \"correcto\", \"quiero ver\") ‚Üí Continuar al paso 4\n   - **Negativa o ambigua** ‚Üí NO ejecutar herramienta, seguir conversaci√≥n normal\n\n4. **Validar correo si falta:**\n   - Si vac√≠o ‚Üí pedir y guardar con `insert_name_correo`\n\n5. **SOLO DESPU√âS de confirmaci√≥n del usuario: Ejecutar `check_slots`**\n\n6. **Responder √öNICAMENTE:** `LISTA_ENVIADA`\n   - Sin comillas\n   - Sin texto adicional\n   - Solo esa palabra\n\n**üö® EJEMPLO DE FLUJO CORRECTO:**\n```\nUsuario: \"Vi esta publicaci√≥n y quer√≠a ver la pod√≠a pasar a verla\"\nMart√≠n: \"¬øQuer√©s que te pase los d√≠as y horarios disponibles?\"\nUsuario: \"S√≠\"\nMart√≠n: [Ejecuta check_slots] ‚Üí \"LISTA_ENVIADA\"\n```\n\n**‚ùå FLUJO INCORRECTO:**\n```\nUsuario: \"Vi esta publicaci√≥n y quer√≠a ver la pod√≠a pasar a verla\"\nMart√≠n: [Ejecuta check_slots inmediatamente] ‚Üí \"LISTA_ENVIADA\"\n```\n\n**Post-LISTA_ENVIADA:**\n\n**‚ö†Ô∏è PROTOCOLO OBLIGATORIO PARA AGENDAR:**\n- ‚ùå **NUNCA** ejecutar `book_visit` sin datos completos\n- ‚ùå **NUNCA** ejecutar `book_visit` sin confirmaci√≥n del usuario\n- ‚úÖ **SIEMPRE** verificar: Nombre, Correo, Tipo de Cliente, Inmobiliaria (si es agente)\n- üö® **ESPERAR CONFIRMACI√ìN EXPL√çCITA** antes de agendar\n\n**Flujo Paso a Paso:**\n\n1. **Usuario selecciona fecha/hora**\n\n2. **Ejecutar `getCliente` para datos actualizados**\n\n3. **Recopilar/Verificar NOMBRE:**\n   - Si no hay nombre: \"¬øCu√°l es tu nombre completo?\"\n   - Si hay nombre: \"¬øConfirm√°s que tu nombre es {Nombre}?\"\n   - Guardar con `insert_name_correo` si es necesario\n\n4. **Recopilar/Verificar CORREO:**\n   - Si no hay correo: \"¬øCu√°l es tu correo electr√≥nico?\"\n   - Si hay correo: \"¬øConfirm√°s que tu correo es {Correo}?\"\n   - Guardar con `insert_name_correo` si es necesario\n\n5. **Recopilar TIPO DE CLIENTE (OBLIGATORIO):**\n   - **SIEMPRE preguntar:** \"¬øSos particular o agente inmobiliario?\"\n   - Guardar con `insert_name_correo`\n\n6. **Si es AGENTE, recopilar INMOBILIARIA:**\n   - Preguntar: \"¬øDe qu√© inmobiliaria sos?\"\n   - Guardar con `insert_name_correo`\n\n7. **üö® MOSTRAR RESUMEN COMPLETO OBLIGATORIO:**\n   - Todos los datos recopilados\n   - Fecha y hora seleccionada\n   - Preguntar: \"¬øEst√° todo correcto para confirmar la visita?\"\n\n8. **üö® ESPERAR CONFIRMACI√ìN DEL USUARIO:**\n   - ‚úÖ **Respuesta afirmativa** (\"s√≠\", \"correcto\", \"dale\", \"perfecto\", \"confirmo\") ‚Üí Continuar al paso 9\n   - ‚ùå **Respuesta negativa** ‚Üí Preguntar qu√© modificar y volver a recopilar\n\n9. **SOLO DESPU√âS de confirmaci√≥n expl√≠cita: Ejecutar `book_visit`**\n\n**‚ö†Ô∏è NUNCA AGENDAR SIN:**\n- ‚ùå Mostrar resumen completo\n- ‚ùå Preguntar confirmaci√≥n\n- ‚ùå Esperar respuesta del usuario\n- ‚ùå Recibir confirmaci√≥n expl√≠cita\n\n**Ejemplos de resumen para confirmaci√≥n:**\n\n**Si es PARTICULAR:**\n```\nPara confirmar tu visita:\n‚Ä¢ Nombre: {Nombre}\n‚Ä¢ Correo: {Correo}\n‚Ä¢ Tipo: Particular\n‚Ä¢ Fecha: {fecha} a las {hora} hs\n‚Ä¢ Tel√©fono: {Tel√©fono}\n\n¬øEst√° todo correcto para confirmar la visita?\n```\n\n**Si es AGENTE INMOBILIARIO:**\n```\nPara confirmar tu visita:\n‚Ä¢ Nombre: {Nombre}\n‚Ä¢ Correo: {Correo}\n‚Ä¢ Tipo: Agente Inmobiliario\n‚Ä¢ Inmobiliaria: {NombreInmobiliaria}\n‚Ä¢ Fecha: {fecha} a las {hora} hs\n‚Ä¢ Tel√©fono: {Tel√©fono}\n\n¬øEst√° todo correcto para confirmar la visita?\n```\n\n**üö® REGLAS CR√çTICAS:**\n- ‚úÖ **SIEMPRE** preguntar tipo de cliente, aunque ya exista en la base\n- ‚úÖ **SIEMPRE** preguntar inmobiliaria si es agente\n- ‚úÖ **SIEMPRE** mostrar resumen completo\n- ‚úÖ **SIEMPRE** esperar confirmaci√≥n antes de `book_visit`\n- ‚ùå **NUNCA** agendar sin confirmaci√≥n del usuario\n\n---\n\n### 6Ô∏è‚É£ REPROGRAMAR VISITA\n\n**Detecci√≥n:** \"reprogramar\", \"cambiar fecha\", \"mover turno\"\n\n**‚ö†Ô∏è PROTOCOLO OBLIGATORIO:**\n1. **NUNCA ejecutar `show_reschedulable_visits` inmediatamente**\n2. **SIEMPRE preguntar primero**\n3. **SOLO ejecutar herramienta despu√©s de confirmaci√≥n**\n\n**Flujo:**\n1. **Preguntar OBLIGATORIAMENTE:** \"¬øQuer√©s reprogramar alguna visita que ya ten√≠as?\"\n\n2. **Esperar respuesta del usuario:**\n   - **Afirmativa clara** (\"s√≠\", \"dale\", \"por favor\", \"correcto\", \"quiero reprogramar\") ‚Üí Continuar al paso 3\n   - **Negativa o ambigua** ‚Üí NO ejecutar herramienta, seguir conversaci√≥n\n\n3. **Validar correo:**\n   - Si vac√≠o ‚Üí preguntar: \"¬øMe pas√°s tu correo electr√≥nico?\" y guardar con `insert_name_correo`\n   - Si existe ‚Üí preguntar: \"¬øConfirm√°s que tu correo es {Correo}?\"\n\n4. **SOLO DESPU√âS de confirmaci√≥n: Ejecutar `show_reschedulable_visits`**\n\n5. **Responder √öNICAMENTE:** `LISTA_ENVIADA`\n   - Sin comillas\n   - Sin texto adicional\n   - Solo esa palabra\n\n**Formato de par√°metros:**\n```json\n{\n  \"correo_electronico\": \"correo@ejemplo.com\",\n  \"Nombre\": \"Nombre Del Cliente\",\n  \"Evento\": \"reagendar\"\n}\n```\n\n---\n\n### 7Ô∏è‚É£ CANCELAR VISITA\n\n**Detecci√≥n:** \"cancelar\", \"anular visita\", \"dar de baja\"\n\n**‚ö†Ô∏è PROTOCOLO OBLIGATORIO:**\n1. **NUNCA ejecutar `show_cancellable_visits` inmediatamente**\n2. **SIEMPRE preguntar primero**\n3. **SOLO ejecutar herramienta despu√©s de confirmaci√≥n**\n\n**Flujo:**\n1. **Preguntar OBLIGATORIAMENTE:** \"¬øQuer√©s cancelar alguna de tus visitas programadas?\"\n\n2. **Esperar respuesta del usuario:**\n   - **Afirmativa clara** (\"s√≠\", \"dale\", \"por favor\", \"correcto\", \"quiero cancelar\") ‚Üí Continuar al paso 3\n   - **Negativa o ambigua** ‚Üí NO ejecutar herramienta, seguir conversaci√≥n\n\n3. **Validar correo:**\n   - Si vac√≠o ‚Üí preguntar: \"¬øMe pas√°s tu correo electr√≥nico?\" y guardar con `insert_name_correo`\n   - Si existe ‚Üí preguntar: \"¬øConfirm√°s que tu correo es {Correo}?\"\n\n4. **SOLO DESPU√âS de confirmaci√≥n: Ejecutar `show_cancellable_visits`**\n\n5. **Responder √öNICAMENTE:** `LISTA_ENVIADA`\n   - Sin comillas\n   - Sin texto adicional\n   - Solo esa palabra\n\n**Formato de par√°metros:**\n```json\n{\n  \"correo_electronico\": \"correo@ejemplo.com\",\n  \"Nombre\": \"Nombre Del Cliente\",\n  \"Evento\": \"cancelar\"\n}\n```\n\n---\n\n### 8Ô∏è‚É£ DERIVAR AL AGENTE FRANCISCO\n\n**Detecci√≥n:** Usuario quiere hablar con Francisco\n\n**‚ö†Ô∏è PROTOCOLO OBLIGATORIO - RECOPILAR TODOS LOS DATOS:**\n- ‚ùå **NUNCA** ejecutar `send_message` sin datos completos\n- ‚ùå **NUNCA** ejecutar `send_message` sin confirmaci√≥n del usuario\n- ‚úÖ **SIEMPRE** verificar que tiene: Nombre, Tel√©fono, Correo, Motivo, Urgencia\n- ‚úÖ **SER REITERATIVO** hasta obtener toda la informaci√≥n\n- üö® **ESPERAR CONFIRMACI√ìN EXPL√çCITA** antes de contactar a Francisco\n\n**Flujo Paso a Paso:**\n\n1. **Preguntar intenci√≥n:** \"¬øQuer√©s que le pase tu consulta a Francisco para que se comunique con vos?\"\n\n2. **Si afirmativo, ejecutar `getCliente` para datos actualizados**\n\n3. **Recopilar/Verificar NOMBRE:**\n   - Si no hay nombre: \"¬øCu√°l es tu nombre completo?\"\n   - Si hay nombre: \"¬øConfirm√°s que tu nombre es {Nombre}?\"\n   - Guardar con `insert_name_correo` si es necesario\n\n4. **Recopilar/Verificar TEL√âFONO:**\n   - Si no hay tel√©fono: \"¬øMe pas√°s tu n√∫mero de tel√©fono para que Francisco se comunique con vos?\"\n   - Si hay tel√©fono: \"¬øConfirm√°s que tu tel√©fono es {Tel√©fono}?\"\n   - Guardar con `insert_name_correo` si es necesario\n\n5. **Recopilar/Verificar CORREO:**\n   - Si no hay correo: \"¬øCu√°l es tu correo electr√≥nico?\"\n   - Si hay correo: \"¬øConfirm√°s que tu correo es {Correo}?\"\n   - Guardar con `insert_name_correo` si es necesario\n\n6. **Recopilar MOTIVO ESPEC√çFICO:**\n   - \"¬øCu√°l es el motivo espec√≠fico de tu consulta para Francisco?\"\n   - \"¬øQu√© necesit√°s que Francisco te explique o resuelva?\"\n   - Ser espec√≠fico, no aceptar respuestas vagas\n\n7. **Recopilar URGENCIA:**\n   - \"¬øCon qu√© urgencia necesit√°s que Francisco se comunique con vos?\"\n   - \"¬øEs urgente, puede ser ma√±ana, o no hay apuro?\"\n   - Clasificar como: \"alta\", \"media\", \"baja\"\n\n8. **VERIFICAR DATOS COMPLETOS:**\n   - Mostrar resumen completo de todos los datos\n   - Preguntar: \"¬øEst√° todo correcto para que Francisco se comunique con vos?\"\n   - **üö® ESPERAR RESPUESTA DEL USUARIO**\n   - Permitir modificaciones si es necesario\n\n9. **SOLO DESPU√âS de confirmaci√≥n del usuario: Ejecutar `send_message`**\n   - ‚úÖ **Respuesta afirmativa** (\"s√≠\", \"correcto\", \"dale\", \"perfecto\") ‚Üí Ejecutar `send_message`\n   - ‚ùå **Respuesta negativa o modificaci√≥n** ‚Üí Volver a recopilar datos\n   - ‚ùå **NUNCA ejecutar sin confirmaci√≥n expl√≠cita del usuario**\n\n**Ejemplo de verificaci√≥n final:**\n```\nPara confirmar antes de contactar a Francisco:\n‚Ä¢ Nombre: {Nombre}\n‚Ä¢ Tel√©fono: {Tel√©fono}\n‚Ä¢ Correo: {Correo}\n‚Ä¢ Motivo: {Motivo espec√≠fico}\n‚Ä¢ Urgencia: {alta/media/baja}\n‚Ä¢ Propiedad consultada: {URL si aplica}\n\n¬øEst√° todo correcto para que Francisco se comunique con vos?\n```\n\n**üîÑ EJEMPLOS DE REITERACI√ìN:**\n\n**Si falta nombre:**\n- \"Para que Francisco se comunique con vos, necesito tu nombre completo. ¬øC√≥mo te llam√°s?\"\n\n**Si falta tel√©fono:**\n- \"Francisco va a necesitar tu n√∫mero de tel√©fono para contactarte. ¬øMe lo pas√°s?\"\n\n**Si falta correo:**\n- \"Tambi√©n necesito tu correo electr√≥nico para el contacto. ¬øCu√°l es?\"\n\n**Si motivo es vago:**\n- \"¬øPodr√≠as contarme m√°s espec√≠ficamente qu√© necesit√°s que Francisco te explique?\"\n- \"¬øQu√© pregunta puntual ten√©s para Francisco?\"\n\n**Si falta urgencia:**\n- \"¬øNecesit√°s que Francisco se comunique hoy, ma√±ana, o no hay apuro?\"\n\n**üö® FLUJO DE CONFIRMACI√ìN OBLIGATORIO:**\n\n1. **Mostrar resumen completo**\n2. **Preguntar confirmaci√≥n:** \"¬øEst√° todo correcto para que Francisco se comunique con vos?\"\n3. **ESPERAR respuesta del usuario**\n4. **Si respuesta afirmativa:** Ejecutar `send_message`\n5. **Si respuesta negativa:** Preguntar qu√© modificar y volver a recopilar\n\n**Respuestas afirmativas v√°lidas:**\n- \"S√≠\", \"Correcto\", \"Dale\", \"Perfecto\", \"Est√° bien\", \"Confirmo\"\n\n**Respuestas que NO permiten ejecutar:**\n- \"No\", \"Falta algo\", \"Quiero cambiar...\", \"Modificar...\", cualquier duda\n\n**Formato de par√°metros:**\n```json\n{\n  \"nombre_cliente\": \"{Nombre}\",\n  \"telefono\": \"{Tel√©fono}\",\n  \"motivo_contacto\": \"{Descripci√≥n espec√≠fica}\",\n  \"propiedad_consultada\": \"{URL si aplica}\",\n  \"urgencia\": \"alta|media|baja\",\n  \"telefono_francisco\": \"5492254423359\"\n}\n```\n\n---\n\n## üö´ RESTRICCIONES\n\n**Temas prohibidos:**\n- Salud, pol√≠tica, clima, chistes, recomendaciones de productos, drogas, religi√≥n\n\n**Respuesta est√°ndar:**\n- \"Disculpame, pero sobre ese tema puntualmente no te puedo hablar.\"\n\n---\n\n## üìä VARIABLES DEL SISTEMA\n\n```javascript\n{Nombre} = {{ $('Cliente Guardado').first().json.cliente.nombre }}\n{Correo} = {{ $('Cliente Guardado').first().json.cliente.correo }}\n{Tel√©fono} = {{ $('Cliente Guardado').first().json.cliente.telefono }}\n{Tipo} = {{ $('Cliente Guardado').first().json.cliente.tipo || null }}\n{Inmobiliaria} = {{ $('Cliente Guardado').first().json.cliente.inmobiliaria || null }}\n```\n\n## ü§ù CONTROL DE SALUDO\n\n**Reglas para determinar si ya salud√≥:**\n- ‚úÖ **Primera interacci√≥n** ‚Üí Siempre saludar\n- ‚úÖ **Ya salud√≥ en conversaci√≥n anterior** ‚Üí No volver a saludar, ir directo al tema\n- ‚úÖ **URL v√°lida + no saludado** ‚Üí Saludar + preguntar sobre propiedad\n- ‚úÖ **URL v√°lida + ya saludado** ‚Üí Directo a preguntar sobre propiedad\n\n**Ejemplos de respuestas:**\n- **No saludado:** \"Hola, ¬øc√≥mo est√°s? Soy Mart√≠n, el asistente de Francisco en RealStateIQ. Contame, ¬øqu√© te interesa saber de esta publicaci√≥n?\"\n- **Ya saludado:** \"Perfecto, estaba viendo la publicaci√≥n que me compartiste. Decime, ¬øqu√© te gustar√≠a saber de esta propiedad?\"\n\n---\n\n## üéØ C√ìDIGOS ESPECIALES\n\n**`LISTA_ENVIADA`** ‚Üí Usar √öNICAMENTE despu√©s de ejecutar:\n- `check_slots`\n- `show_reschedulable_visits`\n- `show_cancellable_visits`\n\n**‚ö†Ô∏è REGLAS CR√çTICAS:**\n- ‚úÖ Enviar SOLO la palabra `LISTA_ENVIADA`\n- ‚ùå NO usar comillas\n- ‚ùå NO agregar texto adicional\n- ‚ùå NO explicar qu√© es o para qu√© sirve\n- ‚úÖ Representa un punto de \"reset de flujo\"\n\n**Formato correcto:**\n```\nLISTA_ENVIADA\n```\n\n**Formato INCORRECTO:**\n```\n\"LISTA_ENVIADA\"\nPerfecto, te muestro cu√°ndo pod√©s ir a verla. LISTA_ENVIADA\n```\n\n---\n\n## ‚úÖ REGLAS DE FORMATO\n\n### Nombres de Usuario\n- ‚úÖ Usar solo primer nombre\n- ‚ùå Nunca nombre completo\n\n### Emails\n- ‚úÖ Formato Markdown: `correo@ejemplo.com`\n- ‚ùå Nunca texto plano\n\n### Confirmaciones\n- ‚úÖ Siempre mostrar resumen completo\n- ‚úÖ Solicitar confirmaci√≥n expl√≠cita\n- ‚úÖ Permitir modificaciones antes de confirmar "}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[7420,1180],"id":"c46c1c97-d106-4b18-b790-cec5b67c3574","name":"Tester Prompt"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=agente:{{ $('V1').first().json.msg.telefono }}","sessionTTL":3600,"contextWindowLength":6},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[7040,1400],"id":"2ef580e7-d9a3-4dcf-a372-4595a4d0bb22","name":"Redis Chat Memory","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"2Sx5bbnQ0BLOq2rG","mode":"list","cachedResultName":"SUB TAREA - OBTENER NOMBRE O INSERTAR"},"workflowInputs":{"mappingMode":"defineBelow","value":{"idTabla":"m097w4nkzri1xs1","servidor_db":"https://db.qeva.xyz","token":"H5FXmjHG-r5pWcJ4ufilIni7XQLDeHjmufz51Cwv","numero":"={{ $('V1').first().json.msg.telefono }}","id_mensaje":"={{ $('V1').first().json.msg.idmsg }}","pushname":"={{ $('Webhook').first().json.body.messages[0].from_name }}","nombre_columna":"Telefono"},"matchingColumns":[],"schema":[{"id":"servidor_db","displayName":"servidor_db","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"idTabla","displayName":"idTabla","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"token","displayName":"token","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numero","displayName":"numero","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"nombre_columna","displayName":"nombre_columna","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"pushname","displayName":"pushname","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"servidor_evo","displayName":"servidor_evo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"id_mensaje","displayName":"id_mensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[960,1400],"id":"3389958a-29ce-4edd-a578-7776efe4bc61","name":"Validar Cliente"},{"parameters":{"content":"## Validacion de cliente en base de datos","height":380,"width":340,"color":7},"type":"n8n-nodes-base.stickyNote","position":[420,1260],"typeVersion":1,"id":"8d18dd53-5432-4927-bfb0-14a642a65dd7","name":"Sticky Note"},{"parameters":{"workflowId":{"__rl":true,"value":"dg5lZhcTnBAZzVc4","mode":"list","cachedResultName":"SUB TAREA - ENLOCAR MSG"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"mode":"each","options":{"waitForSubWorkflow":true}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[4800,400],"id":"023eb111-6023-463d-b6fc-120c927a3d6d","name":"Encolado de msg"},{"parameters":{"sortFieldsUi":{"sortField":[{"fieldName":"timestamp"}]},"options":{}},"type":"n8n-nodes-base.sort","typeVersion":1,"position":[5020,400],"id":"36080f3c-f888-4af9-926e-b8ec0166dafb","name":"Sort"},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"text","renameField":true,"outputFieldName":"text"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[5260,400],"id":"0f8709e2-05e0-4ff4-a6f1-d2eedd7c7429","name":"Aggregate"},{"parameters":{"assignments":{"assignments":[{"id":"0fae28c9-d30a-4250-9a50-5b68c61164cf","name":"message","value":"={{ $json?.text?.join(\"\\n\") || $json?.msg?.content || $('fecha_iso').item?.json?.msg?.row_id_fecha }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[6740,1180],"id":"e054ec13-efbf-48a8-9c04-6f8ff76b34c0","name":"chatInput"},{"parameters":{"assignments":{"assignments":[{"id":"79a702ff-5f8c-4814-bddf-5e3acb5a5f2e","name":"msg","value":"={{ JSON.stringify($('V1').first().json.msg)}}","type":"object"},{"id":"9337176e-e568-4efa-8c05-3bdb12ecfb61","name":"id_cliente","value":"={{ $('Validar Cliente').first().json.list[0].Id }}","type":"number"},{"id":"0c48213e-ec73-4b20-b547-c3beffc38bf7","name":"msg.cliente","value":"={{ $('Validar Cliente').item.json.list }}","type":"string"}]},"options":{}},"id":"29925d2e-be6d-49c7-bd4d-f19172a9f575","name":"Variables globales","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3160,1300],"notesInFlow":true},{"parameters":{"jsCode":"// Obtener datos de entrada\nconst row_id_fecha = $input.first().json.msg.row_id_fecha;\nconst eventId = $input.first().json.msg.eventId || $json.eventid || \"\";\n\n// Obtener el t√≠tulo del webhook\nconst title = $('Webhook').first().json.body.messages[0].reply.list_reply.title;\n\n// Funci√≥n para convertir nombre de mes a n√∫mero\nfunction mesANumero(nombreMes) {\n  const meses = {\n    'enero': '01', 'febrero': '02', 'marzo': '03', 'abril': '04',\n    'mayo': '05', 'junio': '06', 'julio': '07', 'agosto': '08',\n    'septiembre': '09', 'octubre': '10', 'noviembre': '11', 'diciembre': '12'\n  };\n  return meses[nombreMes.toLowerCase()] || '01';\n}\n\n// Funci√≥n para extraer fecha ISO del t√≠tulo\nfunction extraerFechaISODelTitulo(title) {\n  // Ejemplo: \"üìÖ 30 de Mayo : 12:00 a 12:30\"\n  const regex = /üìÖ\\s*(\\d+)\\s*de\\s*(\\w+)\\s*:\\s*(\\d{2}):(\\d{2})/i;\n  const match = title.match(regex);\n  \n  if (match) {\n    const dia = match[1].padStart(2, '0'); // \"30\" -> \"30\"\n    const mes = mesANumero(match[2]); // \"Mayo\" -> \"05\"\n    const hora = match[3]; // \"12\"\n    const minutos = match[4]; // \"00\"\n    \n    // Obtener el a√±o actual (puedes modificar esto si necesitas otro a√±o)\n    const anioActual = new Date().getFullYear();\n    \n    // Formar la fecha ISO: 2025-05-30T12:00\n    return `${anioActual}-${mes}-${dia}T${hora}:${minutos}`;\n  }\n  \n  return null;\n}\n\n// Extraer la fecha ISO del row_id_fecha (m√©todo original)\nconst partes = row_id_fecha.split(\":\");\nconst fechaISOOriginal = partes[partes.length - 1];\n\n// Extraer la fecha ISO del t√≠tulo\nconst fechaISODelTitulo = extraerFechaISODelTitulo(title);\n\n// Usar la fecha ISO del t√≠tulo si est√° disponible, sino usar la original\nconst fechaISO = fechaISODelTitulo || fechaISOOriginal;\n\n// Armar el mensaje\nconst mensaje = `Fecha seleccionada para agendar nuevamente:\\n${fechaISO}\\n\\nID del evento:\\n${eventId}\\n\\nT√≠tulo original:\\n${title}`;\n\n// Devolver resultado\nreturn [{\n  json: {\n    fechaISO,\n    eventId,\n    mensaje,\n    title,\n    fechaISODelTitulo,\n    fechaISOOriginal\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[5240,1440],"id":"083a17a3-fc60-4246-aa3c-f60031ec81f3","name":"DistinguirTipoSeleccion"},{"parameters":{"content":"## Variables Generales y necesarias","height":380,"width":340,"color":7},"type":"n8n-nodes-base.stickyNote","position":[0,1260],"typeVersion":1,"id":"71653387-2afa-4c34-857a-c74d413b3a50","name":"Sticky Note8"},{"parameters":{"content":"## Variables de BD","height":380,"width":340,"color":7},"type":"n8n-nodes-base.stickyNote","position":[860,1260],"typeVersion":1,"id":"257ab8e6-b1f2-4dfd-a672-47243d97b32f","name":"Sticky Note9"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pavs050wnuapn49","table":"m097w4nkzri1xs1","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $('V1').first().json.msg.telefono }})"}},"type":"n8n-nodes-base.nocoDbTool","typeVersion":3,"position":[8000,1400],"id":"edb8b3b6-b1c5-4d1b-b302-9f07e64ae13a","name":"GetCliente","credentials":{"nocoDbApiToken":{"id":"KRVylWU1iQ1qxa6v","name":"Qeva BD"}}},{"parameters":{"operation":"delete","key":"agente:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[8580,2440],"id":"2f35bf81-a99a-48db-83aa-596ed78d12fc","name":"Redis1","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"jsCode":"// Obtener la fecha desde el input\nconst fechaOriginal = $input.first().json.msg.row_id_fecha;\n\n// Funci√≥n para limpiar la fecha y extraer solo el formato ISO\nfunction limpiarFecha(fechaString) {\n  if (!fechaString || typeof fechaString !== 'string') {\n    return null;\n  }\n  \n  // Buscar el patr√≥n de fecha ISO en el string (YYYY-MM-DDTHH:MM)\n  const match = fechaString.match(/(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2})/);\n  \n  if (match) {\n    return match[1]; // Retorna solo la parte de la fecha ISO\n  }\n  \n  return null;\n}\n\n// Limpiar la fecha\nconst fechaLimpia = limpiarFecha(fechaOriginal);\n\n// Crear la variable del evento\nconst evento = \"cancelar\";\n\n// Log para verificar\nconsole.log(\"Fecha original:\", fechaOriginal);\nconsole.log(\"Fecha limpia:\", fechaLimpia);\nconsole.log(\"Evento:\", evento);\n\n// Retornar el resultado\nreturn [{\n  json: {\n    fecha_original: fechaOriginal,\n    fecha_limpia: fechaLimpia,\n    evento: evento\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4800,160],"id":"6da46274-61d5-4ed9-9cb0-1dc0d6718c9e","name":"DistinguirTipoSeleccion1"},{"parameters":{"method":"POST","url":"={{ $('V1').first().json.datos.server_whapi }}/messages/text","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{3}}"},{"name":"body","value":"={{ $json.texto.replace(/\\n/g,'\\n').replace(/\\\"/g,'\\'') }}"},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[9600,1180],"id":"fc31a5e7-b479-4eab-9abb-596647e1bf0c","name":"Texto","credentials":{"httpHeaderAuth":{"id":"ekaTMbiKps3wYx80","name":"Whapi - Agente inmobiliario"}}},{"parameters":{"jsCode":"// 1) Obten√©s los datos principales\nconst datosCliente = $('Validar Cliente').first().json.list[0] || {};\nconst nombre = datosCliente.Nombre || '';\nconst correo = datosCliente.Correo || '';\nconst telefono = datosCliente.Telefono || '';\n\n// 2) Obten√©s la fecha original y el ID del evento\nconst row_id_fecha = $input.first().json.msg.row_id_fecha || '';\nconst eventid = $input.first().json.msg.eventId || '';\n\n// 3) Formate√°s la fecha ISO\nconst partes = row_id_fecha.split(':');\nconst fechaISO = partes.length > 1 \n  ? partes.slice(-2).join(':') \n  : row_id_fecha;\n\n// 4) Arm√°s el mensaje\nconst mensaje = `Fecha seleccionada para agendar nuevamente:\\n${fechaISO}`;\n\n// 5) Devolv√©s todo en la salida\nreturn [{\n  json: {\n    row_id_fecha_original: row_id_fecha,\n    fechaISO,\n    mensaje,\n    correo,\n    nombre,\n    telefono,\n    eventid,\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4580,2500],"id":"596cd08f-5026-46b2-8392-831e628398ed","name":"DetectorFechas"},{"parameters":{"assignments":{"assignments":[{"id":"c6f2449a-a8b4-423d-ae78-f783977ed460","name":"msg.row_id_fecha","value":"={{ $('V1').first().json.msg.row_id_fecha.match(/(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}[-+]\\d{2}:\\d{2})/)?.[1] }}","type":"string"},{"id":"d85e8dab-ff11-460a-9ab4-83ff62869e71","name":"msg.titulo_categoria","value":"={{ $('V1').first().json.msg.titulo_categoria }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[5160,2000],"id":"bfdaf10b-237f-4858-b9a3-82025ffdb332","name":"fecha_iso"},{"parameters":{"operation":"delete","key":"=msg:{{ $('Variables globales').item.json.msg.telefono }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[5400,2000],"id":"c4058af9-212a-430b-8d32-014a16e5b9d6","name":"Redis","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=list:{{ $('V1').first().json.msg.telefono }}","value":"={{ $('V1').first().json.msg.row_id_fecha }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4940,2000],"id":"1e82ba2b-14ae-4b10-b542-0587d86c6929","name":"Lista de fechas","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"Lista","key":"=list:{{ $('V1').first().json.msg.telefono }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4260,1500],"id":"e3b8c4a6-d1a5-4fd9-8cb4-5d6a588962d4","name":"Redis2","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9428093a-b316-4189-8923-cac5f49ffc70","leftValue":"={{ $('Variables globales').item.json.msg.row_id_fecha }}","rightValue":"={{ $json.Lista }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4480,1500],"id":"bdf76422-e535-41ae-ba12-ef6c15ae046d","name":"If2"},{"parameters":{"method":"POST","url":"={{ $('V1').first().json.datos.server_whapi }}/messages/text","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"=Esta fecha ya no se puede elegir"},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4700,1500],"id":"3decb6ff-76c6-470e-8b1c-793896a3ef54","name":"Texto1","credentials":{"httpHeaderAuth":{"id":"ekaTMbiKps3wYx80","name":"Whapi - Agente inmobiliario"}}},{"parameters":{"name":"send_message","description":"llama a esta herramienta cuando  el usuario esta interesado en comprar o alquilar","workflowId":{"__rl":true,"value":"GdA7h4vtZ4cVtdMf","mode":"list","cachedResultName":"AGENTE INMO - Send MSG agente"},"workflowInputs":{"mappingMode":"defineBelow","value":{"numero":"={{$('Variables globales').first().json.msg.telefono}}","msg":"={{ $fromAI('msg', ``, 'string') }}"},"matchingColumns":[],"schema":[{"id":"numero","displayName":"numero","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"msg","displayName":"msg","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.1,"position":[8120,1400],"id":"23aff5a9-23f0-4c8f-a2fb-5f737fc5eea8","name":"msg agente"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"94746291-c0f3-44f3-b635-1fe696d7d74e","leftValue":"={{ $('Webhook').item.json.body.messages[0].from_me }}","rightValue":"false","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"id":"93ee8261-f67f-4774-bfcf-63be6beec742","name":"From Me2","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-300,1080]},{"parameters":{"httpMethod":"POST","path":"solutions","options":{}},"id":"1d4ce6e5-ac95-4470-820f-08e0100f309b","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1000,1080],"webhookId":"3ba6ce2e-1b02-4b06-8edd-9c60afb2db89"},{"parameters":{"operation":"delete","key":"=bot:{{ $json.msg.telefono }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[720,440],"id":"967ca9c7-a603-4333-ac9f-e98ff125d8d9","name":"Redis4","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"predefinedCredentialType","nodeCredentialType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"={{ $json.msg.off }}"},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1180,-20],"id":"087e4aa1-435f-4b58-8078-1a849e2aef29","name":"Texto2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7c646201-9638-4381-ba78-8b2ede680b4d","leftValue":"={{ $('Webhook').item.json.body.messages[0].from }}","rightValue":"5492254596618","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"60e15f5b-bbc9-47ea-a160-5df35f39a4a9","leftValue":"={{ $('Webhook').item.json.body.messages[0].text.body.toLowerCase() === 'off' }}","rightValue":"={{pausar}}","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,300],"id":"ad354ce7-d6bd-49e7-ac1b-dec23ab80491","name":"If4"},{"parameters":{"assignments":{"assignments":[{"id":"f9ecf2fc-da2c-4f44-897a-5dc0a2f2f379","name":"msg.telefono","value":"={{ $json.body.messages[0].chat_id.replace(/\\D/g, '') }}","type":"string"},{"id":"dab7ca54-c3d2-4a36-a9ca-a0ebbd375ef5","name":"msg.nombre","value":"={{ $json.body.messages[0].chat_name }}","type":"string"},{"id":"cc7dcfe1-8ad7-4fe8-93ec-8f643c7d08c7","name":"msg.type","value":"={{ $json.body.messages[0].type }}","type":"string"},{"id":"a3d07914-3c39-47d8-a122-9c1f6062c940","name":"msg.ListaResponse","value":"={{ $('Webhook').item?.json?.body?.data?.message?.listResponseMessage?.title || \"\" }}\n{{ $('Webhook').item?.json?.body?.data?.message?.listResponseMessage?.description || \"\" }}","type":"string"},{"id":"81612acf-1b66-4c8e-82e4-ce8c77b31334","name":"msg.content","value":"={{ $json?.body?.messages[0]?.text?.body || $json?.body?.messages[0]?.voice?.link || $json?.body?.messages[0]?.link_preview.url ||  $json?.body?.messages[0]?.voice.id }}\n\n{{ $json.body.messages[0].context.quoted_content.body }}","type":"string"},{"id":"01710423-6391-4a34-81e1-06d4779caf4d","name":"msg.timestamp","value":"={{ $json.body.messages[0].timestamp.toDateTime('s').toLocal().toISO() }}","type":"string"},{"id":"2dfc64f4-b222-4ea7-b095-fdd96d9fcb95","name":"msg.idmsg","value":"={{ $json.body.messages[0].id }}","type":"string"},{"id":"ca81718f-74eb-4960-ac3a-5b59f39f8710","name":"datos.server_db","value":"https://db.qeva.xyz","type":"string"},{"id":"be83160a-e151-4f62-bfde-590af142ae74","name":"db.table_clientes","value":"m097w4nkzri1xs1","type":"string"},{"id":"c85ab512-ca17-401b-b025-4b6fc11ac818","name":"db.token_db","value":"H5FXmjHG-r5pWcJ4ufilIni7XQLDeHjmufz51Cwv","type":"string"},{"id":"74ee121e-f109-4425-9b1e-ff7b6c49ae45","name":"datos.tabla","value":"mwk4ui7lirmxc8h","type":"string"},{"id":"82426625-5ed5-49a9-abb1-d4ed246fddf2","name":"msg.row_id_fecha","value":"={{ $json.body.messages[0].reply.list_reply.id }}","type":"string"},{"id":"6fedaf9c-efe8-46e5-bb61-b42525ddafa1","name":"grupo","value":"={{ $json.body.messages[0].chat_id.endsWith('@g.us') }}","type":"boolean"},{"id":"7f846767-8866-43e5-845a-d1feda60451c","name":"datos.token","value":"B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410","type":"string"},{"id":"865ae94f-3e98-4b1b-943c-fafa6c059e45","name":"msg.titulo_categoria","value":"={{ $json?.body?.messages[0]?.context?.quoted_content?.header || \"\"}}","type":"string"},{"id":"f71f1502-02e3-4de1-a62a-232537d8f402","name":"datos.server_whapi","value":"https://gate.whapi.cloud","type":"string"},{"id":"2ccc2ae6-79a4-4998-8ef8-681fbb4876cc","name":"msg.eventId","value":"={{ $json.body.messages[0].context.quoted_id }}","type":"string"},{"id":"47fcf50c-9216-4f7f-b5f4-b6d25b049891","name":"","value":"","type":"string"},{"id":"95001dea-1bf9-41f7-b41f-4a5bd23719cf","name":"msg.location.latitude","value":"={{ $json.body.messages[0].location.latitude }}","type":"number"},{"id":"1a6f4720-d9db-4093-9d7e-2fa585ad07bc","name":"msg.location.longitude","value":"={{ $json.body.messages[0].location.longitude }}","type":"number"},{"id":"3551b7d9-4ced-4fba-889e-e8a1342fc6c7","name":"msg.off","value":"=üü¢ Derivacion con un representante, a partir de ahora hablar√° con una persona real üü¢","type":"string"},{"id":"9314a63a-e7f7-47f1-89c2-198e36a61785","name":"msg.on","value":"üü†  Derivaci√≥n con un Agente IA, a partir de ahora hablar√° con Mart√≠n üü†","type":"string"}]},"options":{}},"id":"4404f2a6-33e0-4882-b0ed-909eda8c8a23","name":"V1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-620,1080],"notesInFlow":true},{"parameters":{"operation":"set","key":"=bot:{{ $json.msg.telefono }}","value":"off","expire":true,"ttl":360},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[300,120],"id":"a756ced4-3c59-43fa-9dea-372382105526","name":"Redis5","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"estado","key":"=bot:{{ $json.msg.telefono }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[120,1420],"id":"6b1b0079-71a5-40d7-beb0-1b5ff94855f0","name":"Redis6","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a96a483c-e241-46d6-a5c0-6d5a315c6ca5","leftValue":"={{ $json.estado }}","rightValue":"off","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[520,1420],"id":"b2173b28-5fac-4dd0-a72b-58fb2a09397b","name":"If5"},{"parameters":{"operation":"set","key":"=bot:{{ $json.msg.telefono }}","value":"on"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[520,300],"id":"877a4aab-f6c5-4e6f-bf67-1c47846b6f08","name":"Redis7","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c39920c3-e5a7-48d6-b1ed-31b94ae55381","leftValue":"={{ $json.msg.content.toLowerCase() }}","rightValue":"on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[300,520],"id":"3e7b2935-fb7a-47e5-ae08-382048b1d5ff","name":"If6"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"=Apartir de ahora la comunicacion sera con *Francisco*"},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[520,-60],"id":"09b614e9-bb2d-4a6c-818f-74ab89f31097","name":"Texto3","credentials":{"httpBearerAuth":{"id":"TekfCqpe7HxChnhx","name":"Whapi - Agente inmobiliario"}}},{"parameters":{"content":"## Intervencion Humana\n","height":800,"width":1520,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-140,-100],"typeVersion":1,"id":"b8f370e9-353d-4da9-b142-b76012e59267","name":"Sticky Note1"},{"parameters":{"method":"DELETE","url":"=https://gate.whapi.cloud/messages/{{ $('V1').item.json.msg.idmsg }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1180,440],"id":"be9a4d1a-36d9-4b46-8ea4-4ec0d0c2f395","name":"HTTP Request"},{"parameters":{"method":"DELETE","url":"=https://gate.whapi.cloud/messages/{{ $('V1').item.json.msg.idmsg }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[760,80],"id":"cd00e15d-5430-47c3-a063-8d4ca7442610","name":"HTTP Request1","credentials":{"httpBearerAuth":{"id":"TekfCqpe7HxChnhx","name":"Whapi - Agente inmobiliario"}}},{"parameters":{"method":"DELETE","url":"=https://gate.whapi.cloud/messages/{{ $('V1').item.json.msg.idmsg }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1180,220],"id":"15027e4f-6fb4-41fb-af33-e4749522ff9d","name":"HTTP Request2"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"=Apartir de ahora sigues la conversacion con *Martin*."},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[940,440],"id":"d70625e9-fc3d-47ef-b339-9ae762eb5fd4","name":"Texto4"},{"parameters":{"operation":"push","list":"=agente:{{ $('V1').first().json.msg.telefono }}"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1660,80],"id":"b07b5add-80a8-4eb4-b11d-d675109b4929","name":"Redis8","disabled":true},{"parameters":{"model":"google/gemini-2.5-flash-preview-05-20","options":{"frequencyPenalty":2,"temperature":0.2}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[6920,1400],"id":"e2d75e26-1a38-4ad7-a167-7480f64f2f47","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"ADdm45cFSIFSG59w","name":"Gemini"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"685c1637-b88b-4f30-bea8-ba24b6816548","leftValue":"={{\n  [\"si\", \"s√≠\", \"no\", \"ok\", \"confirmo\",\"Hola\"].includes($json.msg.content.toLowerCase().trim())\n}}\n","rightValue":"true","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4580,1000],"id":"5e19b3f2-8ba4-4827-93f5-29f5fe54fca5","name":"If"},{"parameters":{"operation":"get","propertyName":"bot_etiqueta","key":"=status:{{ $('V1').first().json.msg.telefono }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2540,1480],"id":"5608ec52-6ecb-4038-b3f1-7030603cfb1e","name":"GetEtiqueta","alwaysOutputData":true,"credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Obtener mensaje y sessionId\nconst mensaje = $('Webhook').first().json?.body?.messages[0]?.text?.body || $('V1').first().json.msg.content;\nconst sessionId = $('Webhook').first().json.body.messages[0].id;\n\n// Expresi√≥n regular para encontrar URLs en el texto\nconst urlRegex = /(https?:\\/\\/[^\\s,]+)/g;\nconst matches = mensaje.match(urlRegex);\n\n// Inicializar variables\nlet urlLimpia = '';\nlet esUrlPropiedad = false;\n\n// Si hay URL, extraerla y marcar como URL de propiedad\nif (matches && matches.length > 0) {\n  urlLimpia = matches[0]; // Tomar la primera URL encontrada\n  esUrlPropiedad = true;  // Cualquier URL se considera como propiedad\n}\n\n// Retornar resultado\nreturn {\n  session_id: sessionId,\n  mensaje_usuario: esUrlPropiedad ? urlLimpia : mensaje, // Si es URL, usar la URL, sino el mensaje original\n  es_url_propiedad: esUrlPropiedad\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1580,1400],"name":"Determinar Tipo de Mensaje","id":"a0ee7bbd-2f26-4f84-981b-18c7bc0a1430"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5ddc4988-d75c-4aa8-a12f-1023dfd992cb","leftValue":"={{ $json.bot_etiqueta == 'off'}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"4f503a15-0435-4f28-bb3a-8996bc04e678","leftValue":"={{ $json.es_url_propiedad }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1860,1400],"id":"d6d732f4-5f0b-4cc4-9107-2c9625ecc6d4","name":"es url?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dbc05b9a-8398-4de9-87ae-8308ffe2e3ab","leftValue":"={{ $json.mensaje_usuario.startsWith('https://') }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2240,1320],"id":"42857728-65d0-4c1d-a38a-d2ca59f76b46","name":"is Https?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6efb0d4d-7b7d-4572-9d3e-7b3fbffbe7ca","leftValue":"={{ $json.bot_etiqueta }}","rightValue":"on","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2760,1480],"id":"c335ee4f-93a7-40c3-8761-6f77adacbf80","name":"If1"},{"parameters":{"workflowId":{"__rl":true,"value":"lifk7Nzr3QwVSIf3","mode":"list","cachedResultName":"AGENTE INMO - Cancelar visitar"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Evento":"cancelar","fecha_cita":"={{ $json.fechaISO }}","eventId":"={{ $json.eventId }}","numero_telefono":"={{ $('Variables globales').item.json.msg.telefono }}"},"matchingColumns":[],"schema":[{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numero_telefono","displayName":"numero_telefono","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"eventId","displayName":"eventId","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"fecha_cita","displayName":"fecha_cita","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":true,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[5440,1440],"id":"7287dd89-2661-4d06-8e44-e2fd24d64a22","name":"Cancelar eventoo"},{"parameters":{"workflowId":{"__rl":true,"value":"QNseORjK6k8Pt17A","mode":"list","cachedResultName":"AGENTE INMO - Agendar_cita"},"workflowInputs":{"mappingMode":"defineBelow","value":{"Evento":"agendar","numero_cliente":"={{ $('DetectorFechas').item.json.telefono }}","Fecha_cita":"={{ $('DetectorFechas').item.json.fechaISO }}","Nombre":"={{ $('DetectorFechas').item.json.nombre }}","Id_cliente_db":"={{ $('Validar Cliente').first().json.list[0].Id.toString() }}","correo_electronico":"={{ $('DetectorFechas').item.json.correo }}"},"matchingColumns":[],"schema":[{"id":"numero_cliente","displayName":"numero_cliente","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"Fecha_cita","displayName":"Fecha_cita","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"Evento","displayName":"Evento","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"correo_electronico","displayName":"correo_electronico","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nombre_inmobiliaria","displayName":"nombre_inmobiliaria","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"idMensaje","displayName":"idMensaje","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":true},{"id":"Id_cliente_db","displayName":"Id_cliente_db","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[5240,2600],"id":"0aa5312e-cd69-4032-937f-4d44eb3929cc","name":"Agenda cuando reprograma"},{"parameters":{"assignments":{"assignments":[{"id":"c0ee2204-c289-4cbb-96a4-2702f79dadc4","name":"response","value":"Listo, ya quedo reprogramada la visita.","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[5680,2600],"id":"970cbaa5-aeea-4feb-838f-72255360b4e8","name":"registro de visita"},{"parameters":{"operation":"set","key":"=lista:{{ $('DetectorFechas').item.json.telefono }}","value":"={{ $('DetectorFechas').item.json.row_id_fecha_original }}","expire":true,"ttl":3600},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[5460,2600],"id":"7078a423-907d-4b44-877f-737cf7c1c589","name":"ya existe?","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"lista","key":"=lista:{{ $('DetectorFechas').item.json.telefono }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[4800,2500],"id":"5b024d4b-1ffc-48aa-a329-1b87a5c562af","name":"Obtenemos la fecha","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"09b2b082-f8a5-454b-9691-e4a09be51255","leftValue":"={{ $json.lista }}","rightValue":"={{ $('DetectorFechas').item.json.row_id_fecha_original }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[5020,2500],"id":"cfb5ceca-95ba-47c6-8ee7-b88ba7726d78","name":"If3"},{"parameters":{"method":"POST","url":"={{ $('V1').first().json.datos.server_whapi }}/messages/text","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"=Ya seleccionaste esta fecha no podes volver a selecionarla."},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5240,2400],"id":"1c512db0-6eeb-4617-a8ea-55b10bd162e9","name":"Texto5","credentials":{"httpHeaderAuth":{"id":"ekaTMbiKps3wYx80","name":"Whapi - Agente inmobiliario"}}},{"parameters":{"operation":"delete","key":"=propiedades_historial_analisis"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7740,2440],"id":"2106e1a7-e71b-45aa-8634-d9a199772f4e","name":"Historial de analisis","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=propiedades:5492254423359:contador"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7580,2440],"id":"4a75e7e2-b39e-422a-862f-69a4c5181ddf","name":"Delete contador","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[7360,2440],"id":"2e5f43a2-77ac-4e73-a38c-c46953472d52","name":"When clicking ‚ÄòTest workflow‚Äô"},{"parameters":{"operation":"delete","key":"status:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[8400,2440],"id":"2223e9bc-eac6-43ad-a36c-fe929eaf6c0b","name":"Redis3","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"=urls"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[7900,2440],"id":"82ad49c9-4a53-4acb-a6dc-14d7bd8aa1b1","name":"Redis9","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"urls"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[8060,2440],"id":"8604c979-7052-43fe-a614-6d98f4c692c9","name":"Redis10","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"contador:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[8220,2440],"id":"c3f21ab4-c00b-4d03-b19b-fac037d3442b","name":"Redis11","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"content":"## Resteo de variables","height":420,"width":1880,"color":7},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[7320,2280],"id":"0c146e21-4218-4e3d-839f-2bc9aafd530c","name":"Sticky Note2"},{"parameters":{"assignments":{"assignments":[{"id":"86b172a4-375a-47f2-8d27-f9a9d4106871","name":"cliente.telefono","value":"={{ $json.list[0].Telefono }}","type":"string"},{"id":"b8c611e9-332e-4bdc-bd0e-9af29b1fc86a","name":"cliente.pushname","value":"={{ $json.list[0].pushname }}","type":"string"},{"id":"92b8dfb3-94eb-4479-809e-c4135aa789ae","name":"cliente.correo","value":"={{ $json.list[0].Correo }}","type":"string"},{"id":"513d48e5-f3a6-4181-ade7-b81a2c80c771","name":"cliente.nombre","value":"={{ $json.list[0].Nombre }}","type":"string"},{"id":"b57bad55-09db-479e-b4d5-55847d6ba1df","name":"cliente.tipo","value":"","type":"string"},{"id":"885aec58-4de1-46a9-a387-545b9b39c389","name":"cliente.inmobiliaria","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1280,1400],"id":"36b03b6c-3d01-4761-89ea-cca9a06a4a21","name":"Cliente Guardado"},{"parameters":{"method":"POST","url":"https://gate.whapi.cloud/messages/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"},{"name":"authorization","value":"Bearer B2v6DZyi27qmgYXOnvrYLEJ4l8KgN410"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"=Debes enviar una url valida para poder hablar."},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3700,1580],"id":"2ca87c89-36b3-4dbe-b0fb-0f66db8aed5d","name":"Texto6"},{"parameters":{"operation":"delete","key":"list:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[8760,2440],"id":"500824ba-cb3f-4d95-a4b4-9cb0cd06b26c","name":"Redis12","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"get","propertyName":"msg","key":"cont","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3140,1620],"id":"4c81ea2c-407e-4473-b38f-b82bbae52bcd","name":"Redis13","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"operation":"incr","key":"=cont:{{ $('V1').item.json.msg.telefono }}","expire":true,"ttl":1200},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3940,1760],"id":"3cd14f23-99da-44c7-b3aa-a99a36129fde","name":"red","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"995b9557-b1b6-4a52-a535-420a3d9734d5","leftValue":"={{ $json.msg }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3420,1760],"id":"9b1052a4-db44-4934-b2be-1ae169718caf","name":"If7"},{"parameters":{"operation":"delete","key":"cont:5492254423359"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[8920,2440],"id":"6cc828a1-3159-4792-af4c-27129a70b727","name":"Redis14","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a1008ad7-af6d-46c1-8775-82cd2eecc2b6","leftValue":"={{ $json.output }}","rightValue":"LISTA_ENVIADA","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[8020,1140],"id":"d8015d53-e88d-498d-a602-e110dd7103f9","name":"If8"},{"parameters":{"jsCode":"// üß† Script para particionar un mensaje largo en partes m√°s humanas y fluidas\n// Divide por doble salto de l√≠nea o por signos de puntuaci√≥n fuertes (., ?, !)\n// Luego organiza en partes de no m√°s de 180 caracteres si es posible\n// Remueve signos de apertura de cualquier palabra o texto\n\nconst entrada = $input.first().json.output\nfunction limpiarSignosApertura(texto) {\n  // Verificar que el texto no sea undefined o null\n  if (!texto || typeof texto !== 'string') {\n    return '';\n  }\n  // Remover signos de apertura comunes\n  return texto.replace(/[¬ø¬°¬´\"'`‚Äû‚Äö'‚Äπ]/g, '');\n}\n\nfunction particionarTexto(texto) {\n  // Verificar que el texto sea v√°lido\n  if (!texto || typeof texto !== 'string') {\n    return [];\n  }\n  \n  // Primero limpiamos los signos de apertura\n  const textoLimpio = limpiarSignosApertura(texto);\n  \n  // Dividir por doble salto de l√≠nea o fin de oraci√≥n seguido de espacio\n  const bloques = textoLimpio.split(/(?:\\n{2,}|(?<=[.!?])\\s+)/g);\n  const partes = [];\n  let buffer = '';\n  \n  for (const bloque of bloques) {\n    // Saltar bloques vac√≠os\n    if (!bloque.trim()) continue;\n    \n    const candidata = buffer + (buffer ? ' ' : '') + bloque;\n    if (candidata.length > 180) {\n      if (buffer) partes.push(buffer.trim());\n      buffer = bloque;\n    } else {\n      buffer = candidata;\n    }\n  }\n  \n  if (buffer) partes.push(buffer.trim());\n  \n  // Si una parte contiene una pregunta, dividirla justo despu√©s\n  const refinadas = [];\n  for (const parte of partes) {\n    if (parte.includes('?') && parte.length > 60) {\n      const subpartes = parte.split(/(?<=\\?)\\s*/);\n      refinadas.push(...subpartes.map(p => p.trim()).filter(Boolean));\n    } else {\n      refinadas.push(parte);\n    }\n  }\n  \n  // Filtrar partes vac√≠as y devolver solo las que tengan contenido\n  return refinadas.filter(parte => parte && parte.trim().length > 0);\n}\n\ntry {\n  const resultado = particionarTexto(entrada);\n  return resultado.map((parte, i) => ({ \n    json: { \n      parte: i + 1, \n      texto: parte,\n      longitud: parte.length \n    } \n  }));\n} catch (error) {\n  console.error('Error al procesar el texto:', error);\n  return [{ json: { error: 'Error al procesar el texto', mensaje: error.message } }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[8940,1180],"id":"15a300e6-eff1-4815-9aec-6303bb6495c9","name":"Separa datos2"},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"GPT-4.1-MINI"},"messages":{"values":[{"content":"=## Instrucciones del Sistema\n\nSos un reformulador experto en adaptar textos neutros o rob√≥ticos al estilo conversacional argentino, manteniendo un tono profesional y c√°lido.\n\n### Tu Tarea Principal\n1. Recibir una respuesta generada por otro agente (en espa√±ol neutro o rob√≥tico)\n2. Reformularla en un tono m√°s humano y natural, con expresiones t√≠picamente argentinas y profesionales\n3. Utilizar **√∫nicamente** las siguientes expresiones aprobadas:\n\n### üìã Expresiones Autorizadas (Solo usar estas)\n- \"Dale\"\n- \"Perfecto\" \n- \"Genial\"\n- \"Buen√≠simo\"\n- \"B√°rbaro\"\n- \"Todo bien\"\n- \"Te paso\"\n- \"Quedate tranquilo\"\n- \"Un momento\"\n- \"Ya lo veo\"\n- \"Vamos viendo\"\n- \"Estoy en eso\"\n- \"Avisame\"\n- \"Contame\"\n- \"Te cuento\"\n- \"¬øTen√©s dudas?\"\n- \"Lo charlamos\"\n- \"¬øQuer√©s que te lo aclare?\"\n- \"Ah√≠ te lo paso\"\n- \"Te ayudo con eso\"\n- \"Lo agendamos\"\n- \"Ya lo anoto\"\n- \"¬øTe parece?\"\n- \"En un rato te cuento\"\n- \"Quedamos as√≠\"\n- \"Cualquier cosa, escribime\"\n\n### üåü Objetivo\nReformular cada mensaje manteniendo su sentido original, pero con un estilo argentino m√°s emp√°tico, conversacional y profesional. El texto debe sonar como si lo dijera un profesional argentino con trato c√°lido y fluido.\n\n### üìå Reglas Estrictas\n- **NO agregues contenido nuevo**\n- **NO cambies el significado**\n- **NO uses frases gen√©ricas o rob√≥ticas** como \"Estoy ac√° para ayudarte\", \"su consulta ha sido recibida\", \"procesando solicitud\", etc.\n- **USA √∫nicamente las expresiones de la lista autorizada**\n- **Incluye al menos una o dos expresiones argentinas** de la lista en cada reformulaci√≥n\n- **Cuando el mensaje incluya nombre y apellido, us√° solo el nombre de pila en la respuesta**\n- **No utilices la expresi√≥n \"dar una mano\". Siempre prefer√≠ \"poder ayudarte\" o \"asistirte\".**\n\n### ‚úÖ Ejemplos de Transformaci√≥n (con variantes)\n\n**Entrada:**\n> \"Procesando su solicitud. Por favor, espere unos segundos.\"\n\n**Variantes de salida:**\n- \"Dale, ya lo estoy viendo. En un momento te paso lo que encontr√©.\"\n- \"Genial, lo reviso y te aviso enseguida.\"\n- \"Tranquilo, ya estoy en eso. En un rato te cuento.\"\n- \"Buen√≠simo, lo estoy viendo ahora. Ya te digo.\"\n\n**Entrada:**\n> \"Estoy ac√° para ayudarte con tu consulta.\"\n\n**Variantes de salida:**\n- \"Perfecto, te ayudo con eso. Contame qu√© necesit√°s.\"\n- \"B√°rbaro, contame qu√© ten√©s en mente y lo vemos.\"\n- \"Dale, avisame si necesit√°s que te asista con eso.\"\n- \"Genial, si ten√©s dudas, contame tranquilo y lo charlamos.\"\n\n**Entrada:**\n> \"Su mensaje ha sido recibido correctamente.\"\n\n**Variantes de salida:**\n- \"Dale, perfecto. Te cuento en un rato c√≥mo seguimos.\"\n- \"Buen√≠simo, ya me lleg√≥. Vamos viendo los pasos.\"\n- \"Genial, ya lo tengo. Lo reviso y te aviso.\"\n\n**Entrada:**\n> \"Perfecto Fernando, tu visita para el 07/07/2025 a las 13:00 ha sido agendada con √©xito. Te hemos enviado un correo a 'fercassera@outlook.com' con todos los detalles de la reserva.\"\n\n**Variantes de salida (respondiendo solo por el nombre):**\n- \"Listo, Fernando. Ya quedo agendada para el 7 de julio a las 13:00 hs. En un momento te paso un mail con todos los detalles.\"\n- \"Perfecto, Fernando. Ten√©s todo confirmado para el 7 de julio a las 13 hs. Te paso un correo con los detalles.\"\n- \"Buen√≠simo, Fernando. La visita qued√≥ agendada. Enseguida te llega un mail con la info que hablamos\"\n\n---\n\n### üóìÔ∏è Agendamiento de visitas (8 variantes profesionales)\n- \"Perfecto, ¬øquer√©s que te comparta los d√≠as y horarios disponibles para coordinar la visita?\"\n- \"Con gusto, ¬øte paso la disponibilidad para agendar la visita?\"\n- \"¬øTe gustar√≠a que revisemos qu√© d√≠as ten√©s para conocer la propiedad?\"\n- \"Si quer√©s, te puedo mostrar los horarios disponibles para que elijas el que te convenga.\"\n- \"¬øTe parece bien si te comparto los turnos disponibles para visitarla?\"\n- \"Avisame si quer√©s que te env√≠e las opciones de agenda para coordinar una visita.\"\n- \"¬øTe paso los d√≠as libres para coordinar la visita?\"\n- \"Estoy viendo la agenda, ¬øte muestro los horarios disponibles para esa propiedad?\"\n\n### ‚ü≤ Reagendamiento de visitas (6 variantes profesionales)\n- \"Entiendo, ¬øquer√©s que revisemos otras fechas disponibles para tu visita?\"\n- \"Si necesit√°s cambiar la cita, te puedo mostrar qu√© otros turnos hay disponibles.\"\n- \"¬øQuer√©s que te comparta la lista de visitas que pod√©s reprogramar?\"\n- \"Podemos cambiar la fecha sin problema. ¬øTe paso las opciones disponibles?\"\n- \"¬øQuer√©s ver qu√© horarios ten√©s para reprogramar tu visita?\"\n- \"Te puedo ayudar con eso, ¬øvemos qu√© otro momento te queda mejor?\"\n\n### ‚ùå Cancelaci√≥n de visitas (6 variantes profesionales)\n- \"Entiendo, ¬øquer√©s que te comparta la lista de visitas que se pueden cancelar?\"\n- \"Puedo mostrarte los turnos activos que ten√©s agendados. ¬øQuer√©s cancelar alguno?\"\n- \"¬øQuer√©s revisar qu√© visitas est√°n activas para poder cancelar la que corresponda?\"\n- \"Te paso las visitas que est√°n vigentes para que indiques cu√°l quer√©s cancelar.\"\n- \"¬øTe muestro las visitas que ten√©s confirmadas para evaluar si quer√©s cancelar alguna?\"\n- \"Si prefer√≠s cancelar la visita, te puedo compartir las opciones que est√°n activas.\"\n\n---\n\n### üëã Inicio de conversaci√≥n tras validar propiedad (10 variantes estilo Mart√≠n)\n- \"Hola, ¬øc√≥mo est√°s? Estuve viendo la publicaci√≥n, ¬øqu√© parte te interes√≥ m√°s?\"\n- \"¬øC√≥mo est√°s? Reci√©n estaba repasando la propiedad, contame qu√© quer√©s saber.\"\n- \"Hola, ya estuve viendo la publicaci√≥n, ¬øquer√©s que te cuente un poco m√°s?\"\n- \"¬øQu√© tal? Ah√≠ estuve revisando el enlace, ¬øen qu√© te puedo asistir?\"\n- \"Hola, vi la propiedad que compartiste, ¬øqu√© detalle quer√©s que veamos?\"\n- \"¬øC√≥mo est√°s? Estaba mirando la propiedad, contame qu√© te llam√≥ la atenci√≥n.\"\n- \"Hola, ya vi la publicaci√≥n. ¬øTe interesa saber sobre ubicaci√≥n, precio o algo puntual?\"\n- \"¬øC√≥mo est√°s? Estuve viendo la info, ¬øquer√©s que te aclare algo?\"\n- \"Hola, revis√© la propiedad. ¬øTe gustar√≠a que vayamos viendo los detalles?\"\n- \"¬øQu√© tal? Estuve chequeando la publicaci√≥n, decime qu√© te gustar√≠a saber primero.\"\n\n---\n\n","role":"system"},{"content":"={{ $json.output }}","role":"assistant"}]},"simplify":false,"options":{"frequency_penalty":1,"temperature":0.5}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[8360,1640],"id":"8520ce32-bd98-40ab-942f-c0781c808240","name":"Message a model","credentials":{"openAiApi":{"id":"tpho37KNAAX388pI","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"={{ $('V1').first().json.datos.server_whapi }}/messages/text","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"={{ $json.response }}"},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5640,1440],"id":"226e0702-ecd2-4fc7-b127-e9fe34fe57ca","name":"Texto7","credentials":{"httpHeaderAuth":{"id":"ekaTMbiKps3wYx80","name":"Whapi - Agente inmobiliario"}}},{"parameters":{"content":"## I'm root\n### Delete Visita Calendar y BBDD","height":280,"width":720,"color":3},"type":"n8n-nodes-base.stickyNote","position":[5140,1340],"typeVersion":1,"id":"53d5b2dc-ba07-4a90-bc87-3c25f9d72f56","name":"Sticky Note3"},{"parameters":{"content":"## I'm root\n### Delete Visita Calendar y BBDD","height":460,"width":1640,"color":5},"type":"n8n-nodes-base.stickyNote","position":[4500,2340],"typeVersion":1,"id":"fe3f3849-ce8d-4b10-b7c8-7a6ee646d94d","name":"Sticky Note4"},{"parameters":{"method":"POST","url":"={{ $('V1').first().json.datos.server_whapi }}/messages/text","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"typing_time","value":"={{1}}"},{"name":"body","value":"={{ $json.response }}"},{"name":"to","value":"={{ $('V1').first().json.msg.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5920,2600],"id":"6d52a40f-ae4a-47e8-aadb-5fc3cfacc57c","name":"Texto9","credentials":{"httpHeaderAuth":{"id":"ekaTMbiKps3wYx80","name":"Whapi - Agente inmobiliario"}}},{"parameters":{"chatId":"164729397","text":"Error en una tool -> Agente inmobiliario","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[9580,260],"id":"fcc65c9e-cd20-476a-a8f6-85051ae2a7a8","name":"Send a text message","webhookId":"0670c7ed-c545-4244-85de-eef41dd12e00","credentials":{"telegramApi":{"id":"LpTnRsVaNB0JfyAR","name":"Debugger"}}},{"parameters":{"content":"## I'm root\n### Humanizador","height":460,"width":1640,"color":5},"type":"n8n-nodes-base.stickyNote","position":[8220,960],"typeVersion":1,"id":"33b469b6-8aeb-4a52-b812-2578536ae261","name":"Sticky Note5"},{"parameters":{"descriptionType":"manual","toolDescription":"Obtene informacion de esta tool cuando el usuario comparta un codigo de la propiedadpor ejemplo GAP6720345","operation":"get","propertyName":"Propiedad","key":"=codigo:{{ $('chatInput').item.message }}","options":{}},"type":"n8n-nodes-base.redisTool","typeVersion":1,"position":[7660,920],"id":"d32fe36f-e3aa-4d25-9321-2ab45c6c350b","name":"Propiedades","credentials":{"redis":{"id":"f1mfRViKXHypdB9h","name":"Redis account"}}}],"connections":{"Loop Over Items":{"main":[[],[{"node":"Texto","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Agendar visita":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"Reagendar visita":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"Cancelar evento":{"main":[[{"node":"Reagendar List","type":"main","index":0}]]},"Traer detalles":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"Nombre y Correo":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"validar_pagina":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"Consultar disponibilidad":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"Message Type":{"main":[[{"node":"DistinguirTipoSeleccion1","type":"main","index":0}],[{"node":"Encolado de msg","type":"main","index":0}],[{"node":"If","type":"main","index":0}],[{"node":"DistinguirTipoSeleccion","type":"main","index":0}],[{"node":"DetectorFechas","type":"main","index":0}],[{"node":"Redis2","type":"main","index":0}],[{"node":"chatInput","type":"main","index":0}]]},"Cancelar":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"Tester Prompt":{"main":[[{"node":"If8","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"Tester Prompt","type":"ai_memory","index":0}]]},"Validar Cliente":{"main":[[{"node":"Cliente Guardado","type":"main","index":0}]]},"Encolado de msg":{"main":[[{"node":"Sort","type":"main","index":0}]]},"Sort":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"chatInput","type":"main","index":0}]]},"chatInput":{"main":[[{"node":"Tester Prompt","type":"main","index":0}]]},"Variables globales":{"main":[[{"node":"Message Type","type":"main","index":0}]]},"DistinguirTipoSeleccion":{"main":[[{"node":"Cancelar eventoo","type":"main","index":0}]]},"GetCliente":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"DistinguirTipoSeleccion1":{"main":[[{"node":"Cancelar evento","type":"main","index":0}]]},"Texto":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"DetectorFechas":{"main":[[{"node":"Obtenemos la fecha","type":"main","index":0}]]},"fecha_iso":{"main":[[{"node":"Redis","type":"main","index":0}]]},"Redis":{"main":[[{"node":"chatInput","type":"main","index":0}]]},"Lista de fechas":{"main":[[{"node":"fecha_iso","type":"main","index":0}]]},"Redis2":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"Texto1","type":"main","index":0}],[{"node":"Lista de fechas","type":"main","index":0}]]},"msg agente":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]},"From Me2":{"main":[[{"node":"If4","type":"main","index":0}],[{"node":"Redis6","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"V1","type":"main","index":0}]]},"Redis4":{"main":[[{"node":"Texto4","type":"main","index":0}]]},"If4":{"main":[[{"node":"Redis5","type":"main","index":0}],[{"node":"If6","type":"main","index":0}]]},"V1":{"main":[[{"node":"From Me2","type":"main","index":0}]]},"Redis5":{"main":[[{"node":"Texto3","type":"main","index":0}]]},"Redis6":{"main":[[{"node":"If5","type":"main","index":0}]]},"If5":{"main":[[{"node":"Validar Cliente","type":"main","index":0}]]},"Redis7":{"main":[[{"node":"Redis4","type":"main","index":0}]]},"If6":{"main":[[{"node":"Redis7","type":"main","index":0}]]},"Texto3":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"Texto4":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"Tester Prompt","type":"ai_languageModel","index":0}]]},"If":{"main":[[{"node":"Encolado de msg","type":"main","index":0}],[{"node":"chatInput","type":"main","index":0}]]},"GetEtiqueta":{"main":[[{"node":"If1","type":"main","index":0}]]},"Determinar Tipo de Mensaje":{"main":[[{"node":"es url?","type":"main","index":0}]]},"es url?":{"main":[[],[{"node":"is Https?","type":"main","index":0}]]},"is Https?":{"main":[[{"node":"Variables globales","type":"main","index":0}],[{"node":"GetEtiqueta","type":"main","index":0}]]},"If1":{"main":[[{"node":"Variables globales","type":"main","index":0}],[{"node":"Redis13","type":"main","index":0}]]},"Cancelar eventoo":{"main":[[{"node":"Texto7","type":"main","index":0}]]},"Agenda cuando reprograma":{"main":[[{"node":"ya existe?","type":"main","index":0}]]},"registro de visita":{"main":[[{"node":"Texto9","type":"main","index":0}]]},"ya existe?":{"main":[[{"node":"registro de visita","type":"main","index":0}]]},"Obtenemos la fecha":{"main":[[{"node":"If3","type":"main","index":0}]]},"If3":{"main":[[{"node":"Texto5","type":"main","index":0}],[{"node":"Agenda cuando reprograma","type":"main","index":0}]]},"Historial de analisis":{"main":[[{"node":"Redis9","type":"main","index":0}]]},"Delete contador":{"main":[[{"node":"Historial de analisis","type":"main","index":0}]]},"When clicking ‚ÄòTest workflow‚Äô":{"main":[[{"node":"Delete contador","type":"main","index":0}]]},"Redis9":{"main":[[{"node":"Redis10","type":"main","index":0}]]},"Redis10":{"main":[[{"node":"Redis11","type":"main","index":0}]]},"Redis11":{"main":[[{"node":"Redis3","type":"main","index":0}]]},"Redis3":{"main":[[{"node":"Redis1","type":"main","index":0}]]},"Cliente Guardado":{"main":[[{"node":"Determinar Tipo de Mensaje","type":"main","index":0}]]},"Redis1":{"main":[[{"node":"Redis12","type":"main","index":0}]]},"Redis13":{"main":[[{"node":"If7","type":"main","index":0}]]},"Texto6":{"main":[[{"node":"red","type":"main","index":0}]]},"If7":{"main":[[{"node":"Texto6","type":"main","index":0}]]},"Redis12":{"main":[[{"node":"Redis14","type":"main","index":0}]]},"If8":{"main":[[],[{"node":"Separa datos2","type":"main","index":0}]]},"Separa datos2":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Message a model":{"main":[[]]},"Propiedades":{"ai_tool":[[{"node":"Tester Prompt","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Argentina/Buenos_Aires","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"uG8CKvIOgJbuRcJh"},"staticData":null,"meta":null,"pinData":{"DetectorFechas":[{"json":{"row_id_fecha_original":"ListV3:2025-07-10T13:00","fechaISO":"2025-07-10T13:00","mensaje":"Fecha seleccionada para agendar nuevamente:\n2025-07-10T13:00","correo":"fercassera@outlook.com","nombre":"Fernando cassera","telefono":"5492254423359","eventid":"Psr0ROXFH_xKGAA-wC8E_sPfuT8"}}],"Obtenemos la fecha":[{"json":{"lista":null}}],"Webhook":[{"json":{"headers":{"host":"n8nw.qeva.xyz","content-length":"1104","accept":"application/json","content-type":"application/json","x-forwarded-for":"37.27.140.235","x-forwarded-host":"n8nw.qeva.xyz","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"73f96af33264","x-real-ip":"37.27.140.235","accept-encoding":"gzip"},"params":{},"query":{},"body":{"messages":[{"id":"H1Ww.r1nX5XcLzb0loRiyw-gK0E_sPfuT8","from_me":false,"type":"reply","chat_id":"5492254423359@s.whatsapp.net","timestamp":1751874085,"source":"mobile","reply":{"type":"list_reply","list_reply":{"id":"ListV3:2025-07-09T09:30","title":"üìÖ 9 de Julio : 09:30 a 10:30","description":"üìç Pinamar, Provincia de Buenos Aires, Argentina\nüë§ Fernando Ariel\nüè† C√≥digo: GAP6720345"}},"context":{"quoted_id":"Psqb32tkFeWUmTc-wBwE_sPfuT8","quoted_author":"5492254606018","quoted_content":{"header":"‚ùå Cancelar Visitas","body":"Seleccion√° una visita para cancelar\nüïí Cada visita tiene una duraci√≥n de 30 minutos aprox.","label":"Seleccion√° üëÜ","footer":"üî¥ Seleccion√° la visita que dese√°s cancelar","sections":[{"title":"‚ùÑÔ∏è Julio","rows":[{"id":"ListV3:2025-07-09T09:30","title":"üìÖ 9 de Julio : 09:30 a 10:30","description":"üìç Pinamar, Provincia de Buenos Aires, Argentina\nüë§ Fernando Ariel\nüè† C√≥digo: GAP6720345"}]}]},"quoted_type":"list"},"from":"5492254423359","from_name":"Fer { }"}],"event":{"type":"messages","event":"post"},"channel_id":"DRSTRG-R2GAJ"},"webhookUrl":"https://n8nw.qeva.xyz/webhook/solutions","executionMode":"production"}}]},"versionId":"575c5939-7d64-4c5f-8c1a-b18baf4fdb79","triggerCount":1,"tags":[]}