{"createdAt":"2025-03-01T03:30:23.649Z","updatedAt":"2025-03-05T16:38:55.062Z","id":"3a61HYHMALHrZB84","name":"WHATSAPP-QR","active":false,"nodes":[{"parameters":{"inputSource":"passthrough"},"id":"dcda0937-c4d3-431d-aa63-d3b2056a74f4","typeVersion":1.1,"name":"Execute Workflow trigger","type":"n8n-nodes-base.executeWorkflowTrigger","position":[-1720,100]},{"parameters":{"assignments":{"assignments":[{"id":"d401de90-98a8-4bb5-a02d-8f453007edcc","name":"response","value":"Ya existe una instancia creada","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-800,-120],"id":"4ac9eb24-924d-4625-859e-819e56ea3612","name":"response"},{"parameters":{"method":"POST","url":"={{ $('Execute Workflow trigger').item.json.whatsapp.evo.server_url }}/message/sendMedia/QEVA AI","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=454444F88F77-4A37-B753-FFAAB4664C16"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('Execute Workflow trigger').item.json.telefono }}"},{"name":"mediatype","value":"image"},{"name":"mimetype","value":"image/png"},{"name":"caption","value":"Escanea el siguiente codigo"},{"name":"media","value":"=https://db.innovasoftpro.dev/{{ $json.QR[0].path }}"},{"name":"fileName","value":"qr-sign.png"}]},"options":{"redirect":{"redirect":{}}}},"id":"0ee0951b-f4f9-4649-b0f8-28d988babb18","name":"Envia QR","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[880,-40],"retryOnFail":true,"waitBetweenTries":5000},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"00ec6f37-9362-42b0-940d-484d6d4778c2","leftValue":"={{ $json.instance.state }}","rightValue":"open","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1060,100],"id":"d74cc2ea-218b-4376-b4e8-e3f25eabc8f3","name":"If"},{"parameters":{"url":"={{ $('Execute Workflow trigger').item.json.whatsapp.evo.server_url }}/instance/connect/{{ $('Execute Workflow trigger').item.json.whatsapp.evo.nombreInstancia }}","sendQuery":true,"queryParameters":{"parameters":[{"name":"number","value":"={{ $('Execute Workflow trigger').item.json.telefono }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $('Execute Workflow trigger').item.json.apikey }}"}]},"options":{}},"id":"3cd984fe-ad3d-4726-9072-c387c09790e8","name":"Genera QR","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-800,160],"retryOnFail":true,"waitBetweenTries":5000},{"parameters":{"url":"={{ $json.whatsapp.evo.server_url }}/instance/connectionState/{{ $json.whatsapp.evo.nombreInstancia }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $json.apikey }}"}]},"options":{}},"id":"b931a6df-ba1e-4b77-90af-d81cbd515b6e","name":"MESSAGE4","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1400,100]},{"parameters":{"authentication":"nocoDbApiToken","operation":"create","projectId":"pbuulhqs2q8m9di","table":"my5hno520npeiye","fieldsUi":{"fieldValues":[{"fieldName":"Telefono","fieldValue":"={{ $('Execute Workflow trigger').item.json.telefono }}"},{"fieldName":"Nombre","fieldValue":"={{ $('Execute Workflow trigger').item.json.whatsapp.evo.nombreInstancia }}"},{"fieldName":"QR","binaryData":true,"binaryProperty":"=file"}]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[320,340],"id":"7c41864b-6410-4261-965d-f6a73cc95892","name":"NocoDB","credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a2316deb-eb04-4bb5-9e7e-493ec4c9c203","leftValue":"={{ $('Execute Workflow trigger').item.json.telefono }}","rightValue":"={{ $json.Telefono }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-180,160],"id":"d8fc1502-1e83-4f67-b84d-72eeae4ac95c","name":"If1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pbuulhqs2q8m9di","table":"my5hno520npeiye","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $('Execute Workflow trigger').item.json.telefono }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-480,160],"id":"a97c52ee-df60-4f87-a9ee-5f01343f0c7e","name":"getCliente","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Función para convertir base64 a PNG en Node.js (n8n)\nconst base64ToPng = (base64String) => {\n  // Remover el prefijo del data URL si existe\n  let base64Data = base64String;\n  if (base64String.includes(';base64,')) {\n    base64Data = base64String.split(';base64,').pop();\n  }\n  \n  // Convertir base64 a buffer (representación binaria de la imagen)\n  const imageBuffer = Buffer.from(base64Data, 'base64');\n  \n  return imageBuffer;\n};\n\n// Obtener el dato base64 del nodo \"Genera QR\"\nconst base64Input = $('Genera QR').first().json.base64;\nif (!base64Input) {\n  return [{ json: { error: \"No se proporcionó un string base64\", success: false } }];\n}\n\ntry {\n  // Convertir a PNG\n  const pngBuffer = base64ToPng(base64Input);\n  \n  // Devolver en el formato que n8n espera para NocoDB\n  return [{\n    json: {\n      success: true\n    },\n    // Estructura binaria para n8n - asegúrate de que coincida con lo que espera NocoDB\n    binary: {\n      // Usa una clave que NocoDB reconozca - prueba con 'file' o 'data'\n      file: {\n        mimeType: 'image/png',\n        data: pngBuffer.toString('base64'),\n        fileName: 'qr-code.png'\n      }\n    }\n  }];\n} catch (error) {\n  return [{ json: { error: error.message, success: false } }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[60,-40],"id":"8811e841-433f-4235-b64c-fa5a0a1921a8","name":"Code1"},{"parameters":{"authentication":"nocoDbApiToken","operation":"update","projectId":"pbuulhqs2q8m9di","table":"my5hno520npeiye","fieldsUi":{"fieldValues":[{"fieldName":"Id","fieldValue":"={{ $('getCliente').item.json.Id }}"},{"fieldName":"QR","binaryData":true,"binaryProperty":"file"}]}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[320,-40],"id":"26a34567-3231-4f0a-bbb6-1f826f5569a1","name":"Actualiza QR","credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}}},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pbuulhqs2q8m9di","table":"my5hno520npeiye","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $('Execute Workflow trigger').item.json.telefono }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[600,-40],"id":"b182aa06-6742-460f-b186-a5313c19fd3c","name":"getCliente1","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}},"onError":"continueRegularOutput"},{"parameters":{"method":"POST","url":"={{ $('Execute Workflow trigger').item.json.whatsapp.evo.server_url }}/message/sendReaction/QEVA AI","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=454444F88F77-4A37-B753-FFAAB4664C16"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={   \n    \"key\": {\n        \"remoteJid\": \"5492254423359\",\n        \"fromMe\":{{ $json.key.fromMe }} ,\n        \"id\": \"{{ $json.key.id }}\"\n    },\n    \"reaction\": \"⏰\"\n} ","options":{}},"id":"796c9656-75ee-45c3-b223-b751166d0bfb","name":"MESSAGE","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1140,-40]},{"parameters":{"method":"POST","url":"={{ $('Execute Workflow trigger').item.json.whatsapp.evo.server_url }}/message/sendMedia/QEVA AI","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=454444F88F77-4A37-B753-FFAAB4664C16"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $('Execute Workflow trigger').item.json.telefono }}@s.whatsapp.net"},{"name":"mediatype","value":"image"},{"name":"mimetype","value":"image/png"},{"name":"caption","value":"Escanea el siguiente codigo para iniciar sesion"},{"name":"media","value":"=https://db.innovasoftpro.dev/{{ $json.QR[0].path }}"},{"name":"fileName","value":"qr-sign.png"}]},"options":{"redirect":{"redirect":{}}}},"id":"a7faea2e-6036-4cea-8508-b6443fb420b9","name":"Envia QR1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[900,340],"retryOnFail":true,"waitBetweenTries":5000},{"parameters":{"method":"POST","url":"={{ $('Execute Workflow trigger').item.json.whatsapp.evo.server_url }}/message/sendReaction/QEVA AI","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=454444F88F77-4A37-B753-FFAAB4664C16"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={   \n    \"key\": {\n        \"remoteJid\": \"{{ $json.key.remoteJid }}\",\n        \"fromMe\":{{ $json.key.fromMe }} ,\n        \"id\": \"{{ $json.key.id }}\"\n    },\n    \"reaction\": \"✅\"\n} ","options":{}},"id":"1a2e5f6a-575e-45f4-a3f7-c41029e596e5","name":"MESSAGE2","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1160,340]},{"parameters":{"jsCode":"// Función para convertir base64 a PNG en Node.js (n8n)\nconst base64ToPng = (base64String) => {\n  // Remover el prefijo del data URL si existe\n  let base64Data = base64String;\n  if (base64String.includes(';base64,')) {\n    base64Data = base64String.split(';base64,').pop();\n  }\n  \n  // Convertir base64 a buffer (representación binaria de la imagen)\n  const imageBuffer = Buffer.from(base64Data, 'base64');\n  \n  return imageBuffer;\n};\n\n// Obtener el dato base64 del nodo \"Genera QR\"\nconst base64Input = $('Genera QR').first().json.base64;\nif (!base64Input) {\n  return [{ json: { error: \"No se proporcionó un string base64\", success: false } }];\n}\n\ntry {\n  // Convertir a PNG\n  const pngBuffer = base64ToPng(base64Input);\n  \n  // Devolver en el formato que n8n espera para NocoDB\n  return [{\n    json: {\n      success: true\n    },\n    // Estructura binaria para n8n - asegúrate de que coincida con lo que espera NocoDB\n    binary: {\n      // Usa una clave que NocoDB reconozca - prueba con 'file' o 'data'\n      file: {\n        mimeType: 'image/png',\n        data: pngBuffer.toString('base64'),\n        fileName: 'qr-code.png'\n      }\n    }\n  }];\n} catch (error) {\n  return [{ json: { error: error.message, success: false } }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[60,340],"id":"14e236c3-e5d5-4ddf-8b62-65f5a5b67c1f","name":"Code"},{"parameters":{"authentication":"nocoDbApiToken","operation":"getAll","projectId":"pbuulhqs2q8m9di","table":"my5hno520npeiye","returnAll":true,"options":{"where":"=(Telefono,eq,{{ $('Execute Workflow trigger').item.json.telefono }})"}},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[600,340],"id":"51a378ef-833e-4ccc-b981-f0ba415157c6","name":"getCliente2","alwaysOutputData":true,"credentials":{"nocoDbApiToken":{"id":"CawnXo6TfhLoivTw","name":"NocoDB Token account"}},"onError":"continueRegularOutput"}],"connections":{"Execute Workflow trigger":{"main":[[{"node":"MESSAGE4","type":"main","index":0}]]},"Envia QR":{"main":[[{"node":"MESSAGE","type":"main","index":0}]]},"If":{"main":[[{"node":"response","type":"main","index":0}],[{"node":"Genera QR","type":"main","index":0}]]},"Genera QR":{"main":[[{"node":"getCliente","type":"main","index":0}]]},"MESSAGE4":{"main":[[{"node":"If","type":"main","index":0}]]},"getCliente":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"Code1","type":"main","index":0}],[{"node":"Code","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Actualiza QR","type":"main","index":0}]]},"Actualiza QR":{"main":[[{"node":"getCliente1","type":"main","index":0}]]},"getCliente1":{"main":[[{"node":"Envia QR","type":"main","index":0}]]},"MESSAGE":{"main":[[]]},"Envia QR1":{"main":[[{"node":"MESSAGE2","type":"main","index":0}]]},"NocoDB":{"main":[[{"node":"getCliente2","type":"main","index":0}]]},"Code":{"main":[[{"node":"NocoDB","type":"main","index":0}]]},"getCliente2":{"main":[[{"node":"Envia QR1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"2kOn0Oz7c2uvczPK"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Execute Workflow trigger":[{"json":{"query":{"numero a donde llegara el qr":"5492254423359"},"telefono":"5492235466830","apikey":"B8105B5C8C6B-4F2A-820D-A9B9859C077B","whatsapp":{"evo":{"nombreInstancia":"POCHO","server_url":"https://evo.innovasoftpro.dev"}},"content":{"mensaje":"2254423359"},"meta":{"tiempo":"2025-03-01T00:35:09.130Z"},"id":"9206F2BCF9F1EF60D0A080607FB4D030"}}]},"versionId":"ceba670b-9d12-4afb-b628-b86edf8744e8","triggerCount":0,"tags":[]}